<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Admin Profile - SMAN 1 Belitang</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#334155", // Adjusted to match dashboard slate theme
                        "background-light": "#f6f7f8",
                        "background-dark": "#1e293b",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        body {
            font-family: 'Inter', sans-serif;
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-slate-800 dark:text-white font-display antialiased">
    <div
        class="relative flex h-screen w-full flex-col overflow-hidden max-w-md mx-auto bg-white dark:bg-slate-900 shadow-2xl">
        <!-- TopAppBar -->
        <div
            class="flex items-center bg-white dark:bg-slate-900 p-4 pb-2 justify-between safe-top border-b border-slate-100 dark:border-slate-800">
            <a href="dashboard-admin.html" aria-label="Go back"
                class="text-slate-500 flex size-12 shrink-0 items-center cursor-pointer hover:text-slate-800 transition-colors">
                <span class="material-symbols-outlined">arrow_back_ios</span>
            </a>
            <h2
                class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">
                Profil Admin</h2>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto pb-32">
            <!-- Tabs -->
            <div class="pb-3 sticky top-0 bg-white dark:bg-slate-900 z-10">
                <div
                    class="flex border-b border-slate-200 dark:border-slate-800 px-4 gap-8 overflow-x-auto no-scrollbar justify-center">
                    <a class="flex flex-col items-center justify-center border-b-[3px] border-primary text-primary pb-[13px] pt-4 whitespace-nowrap"
                        href="#">
                        <p class="text-sm font-bold leading-normal tracking-[0.015em]">Profile</p>
                    </a>
                </div>
            </div>

            <!-- Profile Header -->
            <div class="flex p-4 w-full flex-col gap-4 items-center">
                <div class="flex gap-4 flex-col items-center">
                    <div class="relative group cursor-pointer" onclick="document.getElementById('fileInput').click()">
                        <div id="profileImage"
                            class="bg-center bg-no-repeat aspect-square bg-cover rounded-full min-h-32 w-32 border-4 border-slate-100 shadow-sm"
                            style='background-image: url("https://ui-avatars.com/api/?name=Admin&background=334155&color=fff");'>
                        </div>
                        <div
                            class="absolute bottom-0 right-0 bg-primary p-2 rounded-full border-4 border-white dark:border-slate-900 shadow-lg text-white">
                            <span class="material-symbols-outlined text-sm">edit</span>
                        </div>
                        <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="uploadAvatar(this)">
                    </div>
                    <div class="flex flex-col items-center justify-center">
                        <p id="display-name"
                            class="text-slate-900 dark:text-white text-[22px] font-bold leading-tight tracking-[-0.015em] text-center">
                            Administrator</p>
                        <p class="text-slate-500 dark:text-slate-400 text-base font-normal leading-normal text-center">
                            Panel Administrator</p>
                    </div>
                </div>
            </div>

            <!-- Form Fields -->
            <div class="flex flex-col gap-2 max-w-[480px] mx-auto px-4">
                <!-- TextField Name -->
                <div class="flex flex-col gap-2 py-2">
                    <label class="text-slate-700 dark:text-white text-sm font-medium">Nama Lengkap</label>
                    <input id="input-fullname"
                        class="w-full rounded-xl border border-slate-200 bg-slate-50 dark:bg-slate-800 dark:border-slate-700 px-4 py-3 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
                        placeholder="Nama Administrator" value="Administrator" />
                </div>

                <!-- TextField Email -->
                <div class="flex flex-col gap-2 py-2">
                    <label class="text-slate-700 dark:text-white text-sm font-medium">Email Address</label>
                    <input id="input-email"
                        class="w-full rounded-xl border border-slate-200 bg-slate-100 dark:bg-slate-800 dark:border-slate-700 px-4 py-3 text-slate-500 cursor-not-allowed"
                        placeholder="email@example.com" value="" readonly />
                    <p class="text-[10px] text-slate-400">Email tidak dapat diubah secara langsung.</p>
                </div>

                <!-- TextField Username -->
                <div class="flex flex-col gap-2 py-2">
                    <label class="text-slate-700 dark:text-white text-sm font-medium">Username</label>
                    <input id="input-username"
                        class="w-full rounded-xl border border-slate-200 bg-slate-100 dark:bg-slate-800 dark:border-slate-700 px-4 py-3 text-slate-500 cursor-not-allowed"
                        placeholder="Username" value="" readonly />
                </div>
            </div>
        </div>

        <!-- Fixed Footer Actions -->
        <div
            class="fixed bottom-0 left-0 right-0 max-w-md mx-auto p-4 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 flex gap-3 pb-8 safe-bottom shadow-[0_-10px_20px_rgba(0,0,0,0.05)]">
            <a href="dashboard-admin.html"
                class="flex-1 flex cursor-pointer items-center justify-center overflow-hidden rounded-xl h-14 px-4 bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white text-sm font-bold hover:bg-slate-200 transition-colors">
                Batal
            </a>
            <button onclick="saveProfile()" id="btn-save"
                class="flex-[2] flex cursor-pointer items-center justify-center overflow-hidden rounded-xl h-14 px-4 bg-primary text-white text-sm font-bold shadow-lg shadow-primary/30 hover:brightness-110 active:scale-95 transition-all">
                Simpan Perubahan
            </button>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // WARNING: SERVICE KEY INCLUDED FOR ADMIN DASHBOARD USE AS REQUESTED.
        const supabaseUrl = 'https://jnsqqswpkigyzewnbvaf.supabase.co';
        const supabaseServiceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impuc3Fxc3dwa2lneXpld25idmFmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTY2MDc0MiwiZXhwIjoyMDg1MjM2NzQyfQ.sJN3LkaB2nmykbItVxWWQPJExeiKBBbWZlgTLeuNo24';
        const adminClient = supabase.createClient(supabaseUrl, supabaseServiceKey);

        let currentUser = null;

        async function init() {
            const { data: { session } } = await adminClient.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = session.user;
            loadProfileData();
        }

        async function loadProfileData() {
            // Get latest user data including metadata
            const { data: { user }, error } = await adminClient.auth.getUser();
            if (error || !user) return;

            currentUser = user;
            const meta = user.user_metadata;

            // Populate Fields
            document.getElementById('input-fullname').value = meta.full_name || '';
            document.getElementById('input-email').value = user.email || '';
            document.getElementById('input-username').value = meta.username || '';

            document.getElementById('display-name').textContent = meta.full_name || 'Administrator';

            // Avatar
            if (meta.avatar_url) {
                document.getElementById('profileImage').style.backgroundImage = `url('${meta.avatar_url}')`;
            } else {
                document.getElementById('profileImage').style.backgroundImage = `url('https://ui-avatars.com/api/?name=${meta.full_name || 'Admin'}&background=334155&color=fff')`;
            }
        }

        async function saveProfile() {
            const btn = document.getElementById('btn-save');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="material-symbols-outlined animate-spin">sync</span>';
            btn.disabled = true;

            const newName = document.getElementById('input-fullname').value;

            try {
                // Update User Metadata
                const { data, error } = await adminClient.auth.updateUser({
                    data: { full_name: newName }
                });

                if (error) throw error;

                // Also update profiles table
                const { error: profileError } = await adminClient
                    .from('profiles')
                    .update({ full_name: newName })
                    .eq('id', currentUser.id);

                if (profileError) throw profileError;

                alert('✅ Profil berhasil diperbarui!');
                loadProfileData(); // Reload UI

            } catch (err) {
                console.error(err);
                alert('Gagal menyimpan: ' + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function uploadAvatar(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            const fileExt = file.name.split('.').pop();
            const fileName = `${currentUser.id}-${Math.random()}.${fileExt}`;
            const filePath = `avatars/${fileName}`;

            // Show loading state
            document.getElementById('display-name').textContent = 'Mengupload foto...';

            try {
                // Upload to Supabase Storage
                const { error: uploadError } = await adminClient.storage
                    .from('avatars')
                    .upload(filePath, file);

                if (uploadError) throw uploadError;

                // Get Public URL
                const { data: { publicUrl } } = adminClient.storage
                    .from('avatars')
                    .getPublicUrl(filePath);

                // Update Metadata
                const { error: updateError } = await adminClient.auth.updateUser({
                    data: { avatar_url: publicUrl }
                });

                if (updateError) throw updateError;

                // Also update profiles table
                await adminClient
                    .from('profiles')
                    .update({ avatar_url: publicUrl }) // Assuming column exists, or ignored
                    .eq('id', currentUser.id);

                alert('✅ Foto profil berhasil diubah!');
                loadProfileData();

            } catch (error) {
                console.error(error);
                alert('Gagal upload: ' + error.message);
                loadProfileData(); // Reset Text
            }
        }

        window.addEventListener('load', init);
    </script>
</body>

</html>