<!DOCTYPE html>
<html class="light" lang="id">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Dashboard Admin - SMAN 1 Belitang</title>
    <link rel="icon" href="./logo-sekolah.png" type="image/png">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <style type="text/tailwindcss">
        @layer base {
            body { @apply font-sans bg-slate-900 text-slate-100; }
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 48;
        }
        .tab-btn.active {
            @apply bg-emerald-500 text-white shadow-lg shadow-emerald-500/20;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>

<body class="min-h-screen">
    <div class="max-w-4xl mx-auto p-4 sm:p-6 space-y-6">
        <!-- Header -->
        <header
            class="bg-slate-800 p-6 rounded-[2.5rem] shadow-xl border border-slate-700 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="text-center sm:text-left">
                <h1 class="text-2xl font-bold text-white tracking-tight">Admin Control Center</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-[0.3em] mt-1">SMAN 1 BELITANG •
                    MANAGEMENT SYSTEM</p>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="window.location.href='index.html'"
                    class="size-12 bg-slate-700 rounded-2xl flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-600 transition-all shadow-lg active:scale-90">
                    <span class="material-symbols-outlined">home</span>
                </button>
            </div>
        </header>

        <!-- Tab Navigation (iOS Style) -->
        <div
            class="bg-slate-800/50 p-1.5 rounded-2xl border border-slate-700 backdrop-blur-md sticky top-4 z-[100] flex overflow-x-auto no-scrollbar gap-1">
            <button onclick="switchTab('overview')" id="tab-overview"
                class="tab-btn active px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider text-slate-400 hover:text-white transition-all whitespace-nowrap">Overview</button>
            <button onclick="switchTab('koordinator')" id="tab-koordinator"
                class="tab-btn px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider text-slate-400 hover:text-white transition-all whitespace-nowrap">Koordinator</button>
            <button onclick="switchTab('fasilitator')" id="tab-fasilitator"
                class="tab-btn px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider text-slate-400 hover:text-white transition-all whitespace-nowrap">Fasilitator</button>
            <button onclick="switchTab('siswa')" id="tab-siswa"
                class="tab-btn px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider text-slate-400 hover:text-white transition-all whitespace-nowrap">Siswa</button>
            <button onclick="switchTab('laporan')" id="tab-laporan"
                class="tab-btn px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider text-slate-400 hover:text-white transition-all whitespace-nowrap">Laporan</button>
        </div>

        <!-- TAB CONTENT: OVERVIEW -->
        <div id="view-overview" class="tab-view space-y-6 animate-in fade-in duration-300">
            <!-- STATISTIK KEUANGAN SEKOLAH -->
            <section class="bg-slate-800 p-8 rounded-[2.5rem] shadow-xl border border-slate-700 space-y-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xs font-black text-emerald-500 uppercase tracking-[0.3em] mb-1">Financial
                            Summary</h2>
                        <h3 class="text-xl font-bold text-white">Kas & Laba Sekolah</h3>
                    </div>
                    <span
                        class="px-3 py-1 bg-emerald-500/10 text-emerald-500 rounded-full text-[10px] font-black uppercase tracking-widest border border-emerald-500/20">HARI
                        3</span>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div
                        class="p-6 bg-slate-900 shadow-inner rounded-3xl border border-slate-700/50 ring-1 ring-white/5">
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Total Omzet</p>
                        <h3 class="text-2xl font-black text-white" id="totalOmzetAdmin">Rp 0</h3>
                    </div>
                    <div
                        class="p-6 bg-slate-900 shadow-inner rounded-3xl border border-slate-700/50 ring-1 ring-white/5">
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Total Laba
                            Bersih</p>
                        <h3 class="text-2xl font-black text-emerald-500" id="totalProfitAdmin">Rp 0</h3>
                    </div>
                    <div
                        class="p-6 bg-slate-900 shadow-inner rounded-3xl border border-slate-700/50 ring-1 ring-white/5">
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Total Modal</p>
                        <h3 class="text-2xl font-black text-white" id="totalCapitalAdmin">Rp 0</h3>
                    </div>
                    <div
                        class="p-6 bg-slate-900 shadow-inner rounded-3xl border border-slate-700/50 ring-1 ring-white/5">
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">ROI Rata-rata
                        </p>
                        <h3 class="text-2xl font-black text-blue-500" id="avgRoiAdmin">0%</h3>
                    </div>
                </div>
                <button onclick="loadGlobalFinancialStats(); loadClassSummaries();"
                    class="w-full py-4 bg-slate-700 rounded-2xl text-xs font-black uppercase text-white hover:bg-slate-600 transition-all border border-slate-600 shadow-lg active:scale-[0.98]">
                    Refresh Financial Data
                </button>
            </section>

            <!-- RINGKASAN PRE-ORDER PER KELAS -->
            <section class="bg-slate-800 p-8 rounded-[2.5rem] shadow-xl border border-slate-700 space-y-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xs font-black text-blue-500 uppercase tracking-[0.3em] mb-1">Pre-Order Summary
                        </h2>
                        <h3 class="text-xl font-bold text-white">Distribusi PO per Kelas</h3>
                    </div>
                    <span
                        class="px-3 py-1 bg-blue-500/10 text-blue-500 rounded-full text-[10px] font-black uppercase tracking-widest border border-blue-500/20">HARI
                        2</span>
                </div>
                <div class="bg-slate-900 rounded-3xl border border-slate-700 overflow-hidden shadow-inner">
                    <table class="w-full text-left text-sm">
                        <thead
                            class="bg-slate-900/50 border-b border-slate-700 text-[10px] font-black uppercase tracking-widest text-slate-500">
                            <tr>
                                <th class="p-4">Kelas</th>
                                <th class="p-4 text-center">PO Makanan</th>
                                <th class="p-4 text-center">PO Minuman</th>
                                <th class="p-4 text-right">Total Kelas</th>
                            </tr>
                        </thead>
                        <tbody id="poSummaryBody" class="divide-y divide-slate-700/50">
                            <tr>
                                <td colspan="4"
                                    class="p-8 text-center text-slate-600 text-[10px] font-black uppercase animate-pulse">
                                    Memuat data PO...</td>
                            </tr>
                        </tbody>
                        <tfoot id="poSummaryFoot" class="bg-slate-900/80 font-bold text-white"></tfoot>
                    </table>
                </div>
            </section>

            <!-- RINGKASAN LAPORAN AKHIR PER KELAS -->
            <section class="bg-slate-800 p-8 rounded-[2.5rem] shadow-xl border border-slate-700 space-y-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xs font-black text-amber-500 uppercase tracking-[0.3em] mb-1">Final Report
                            Summary</h2>
                        <h3 class="text-xl font-bold text-white">Laporan Keuangan per Kelas</h3>
                    </div>
                    <span
                        class="px-3 py-1 bg-amber-500/10 text-amber-500 rounded-full text-[10px] font-black uppercase tracking-widest border border-amber-500/20">HARI
                        3</span>
                </div>
                <div class="bg-slate-900 rounded-3xl border border-slate-700 overflow-hidden shadow-inner">
                    <table class="w-full text-left text-sm">
                        <thead
                            class="bg-slate-900/50 border-b border-slate-700 text-[10px] font-black uppercase tracking-widest text-slate-500">
                            <tr>
                                <th class="p-4">Kelas</th>
                                <th class="p-4 text-right">Omzet</th>
                                <th class="p-4 text-right">Modal</th>
                                <th class="p-4 text-right">Laba</th>
                            </tr>
                        </thead>
                        <tbody id="financeSummaryBody" class="divide-y divide-slate-700/50">
                            <tr>
                                <td colspan="4"
                                    class="p-8 text-center text-slate-600 text-[10px] font-black uppercase animate-pulse">
                                    Memuat data laporan...</td>
                            </tr>
                        </tbody>
                        <tfoot id="financeSummaryFoot" class="bg-slate-900/80 font-bold text-white"></tfoot>
                    </table>
                </div>
            </section>
        </div>

        <!-- TAB CONTENT: KOORDINATOR -->
        <div id="view-koordinator"
            class="tab-view hidden space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="bg-slate-800 p-8 rounded-[2.5rem] border border-slate-700 text-center py-20">
                <span class="material-symbols-outlined text-5xl text-slate-600 mb-4">groups</span>
                <p class="text-slate-400 font-medium">Monitoring Koordinator sedang disiapkan...</p>
            </div>
        </div>

        <!-- TAB CONTENT: FASILITATOR -->
        <div id="view-fasilitator"
            class="tab-view hidden space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="bg-slate-800 p-8 rounded-[2.5rem] border border-slate-700 text-center py-20">
                <span class="material-symbols-outlined text-5xl text-slate-600 mb-4">engineering</span>
                <p class="text-slate-400 font-medium">Monitoring Fasilitator sedang disiapkan...</p>
            </div>
        </div>

        <!-- TAB CONTENT: SISWA -->
        <div id="view-siswa" class="tab-view hidden space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <!-- Search Section -->
            <section class="bg-slate-800 p-8 rounded-[2.5rem] shadow-xl border border-slate-700 space-y-6">
                <div>
                    <h2 class="text-xs font-black text-emerald-500 uppercase tracking-[0.3em] mb-1">Database Siswa</h2>
                    <h3 class="text-xl font-bold text-white">Cari & Manajemen Siswa</h3>
                </div>
                <div class="flex gap-3">
                    <div class="flex-1 relative">
                        <span
                            class="material-symbols-outlined absolute left-5 top-1/2 -translate-y-1/2 text-slate-500">search</span>
                        <input type="text" id="studentSearch" placeholder="Masukkan nama atau NISN..."
                            class="w-full bg-slate-900 border-slate-700 rounded-2xl pl-14 pr-6 py-4 text-sm text-white focus:ring-4 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all placeholder:text-slate-600 font-medium border">
                    </div>
                    <button onclick="searchStudent()"
                        class="px-8 bg-emerald-600 text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg shadow-emerald-900/40 hover:bg-emerald-500 hover:scale-105 active:scale-95 transition-all">
                        Cari
                    </button>
                </div>
                <div id="searchLoading" class="hidden text-center py-8">
                    <div class="animate-spin inline-block size-8 border-4 border-emerald-500 border-t-transparent rounded-full"
                        role="status"></div>
                </div>
                <div id="searchResult" class="grid grid-cols-1 gap-3">
                    <!-- Result Cards -->
                </div>
            </section>
        </div>

        <!-- TAB CONTENT: LAPORAN -->
        <div id="view-laporan" class="tab-view hidden space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <section class="bg-slate-800 p-8 rounded-[2.5rem] shadow-xl border border-slate-700 space-y-8">
                <div>
                    <h2 class="text-xs font-black text-emerald-500 uppercase tracking-[0.3em] mb-1">Reports & Export
                    </h2>
                    <h3 class="text-xl font-bold text-white">Laporan Hasil & Penilaian</h3>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Export Nilai Akhir per Kelas -->
                    <div class="p-6 bg-slate-900 rounded-3xl border border-slate-700 space-y-4">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="material-symbols-outlined text-emerald-500">description</span>
                            <h4 class="font-bold text-white">Ekspor Nilai Akhir</h4>
                        </div>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Pilih kelas untuk
                            mengunduh rekap nilai (CSV)</p>
                        <div class="flex gap-2">
                            <select id="exportClassSelect"
                                class="flex-1 bg-slate-800 border-slate-700 rounded-xl text-xs text-white p-3 focus:ring-emerald-500 outline-none">
                                <option value="">Pilih Kelas...</option>
                                <!-- Will be populated -->
                            </select>
                            <button onclick="exportFinalGrades()"
                                class="px-6 py-3 bg-emerald-600 text-white rounded-xl text-[10px] font-black uppercase hover:bg-emerald-500 transition-all shadow-lg shadow-emerald-900/40">Export</button>
                        </div>
                    </div>

                    <!-- Laporan Keuangan per Kelas -->
                    <div class="p-6 bg-slate-900 rounded-3xl border border-slate-700 space-y-4">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="material-symbols-outlined text-blue-500">payments</span>
                            <h4 class="font-bold text-white">Laporan Keuangan</h4>
                        </div>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Pantau detail omzet &
                            laba per kelas</p>
                        <div class="flex gap-2">
                            <select id="reportClassSelect"
                                class="flex-1 bg-slate-800 border-slate-700 rounded-xl text-xs text-white p-3 focus:ring-blue-500 outline-none">
                                <option value="">Pilih Kelas...</option>
                                <!-- Will be populated -->
                            </select>
                            <button onclick="viewClassFinancialReport()"
                                class="px-6 py-3 bg-blue-600 text-white rounded-xl text-[10px] font-black uppercase hover:bg-blue-500 transition-all shadow-lg shadow-blue-900/40">Pantau</button>
                        </div>
                    </div>
                </div>

                <!-- Result Area for Financial Report -->
                <div id="reportResultArea" class="hidden animate-in fade-in duration-500">
                    <div class="p-8 bg-slate-900 rounded-[2rem] border border-slate-700 space-y-6">
                        <div class="flex justify-between items-center border-b border-slate-700 pb-4">
                            <h4 class="font-bold text-white text-lg" id="reportResultTitle">Laporan Kelas</h4>
                            <button onclick="document.getElementById('reportResultArea').classList.add('hidden')"
                                class="text-slate-500 hover:text-white"><span
                                    class="material-symbols-outlined">close</span></button>
                        </div>
                        <div id="reportResultContent" class="space-y-4">
                            <!-- Detail content here -->
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Reset Detail Modal (Floating) -->
        <div id="resetModal"
            class="fixed inset-0 z-[1000] hidden items-center justify-center bg-slate-950/90 p-4 backdrop-blur-xl">
            <div
                class="bg-slate-800 w-full max-w-lg rounded-[3rem] shadow-2xl overflow-hidden border border-slate-700 animate-in zoom-in-95 duration-300 flex flex-col max-h-[85vh]">
                <div
                    class="p-8 border-b border-slate-700 flex justify-between items-center bg-slate-800/80 sticky top-0 z-10">
                    <div>
                        <h3 class="text-2xl font-black text-white" id="modalStudentName">Nama Siswa</h3>
                        <p class="text-[10px] text-slate-500 font-black uppercase tracking-[0.3em] mt-1"
                            id="modalStudentClass">Kelas Detail</p>
                    </div>
                    <button onclick="closeResetModal()"
                        class="size-12 bg-slate-700/50 rounded-2xl flex items-center justify-center text-slate-400 hover:text-white transition-all ring-1 ring-slate-600">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div class="p-8 overflow-y-auto no-scrollbar space-y-4" id="modalResponseList">
                    <!-- Responses will list here -->
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://jnsqqswpkigyzewnbvaf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impuc3Fxc3dwa2lneXpld25idmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NjA3NDIsImV4cCI6MjA4NTIzNjc0Mn0.RrjPnddC55Xv9CLCtG8-1RyDmEkYg_04tHeKqRE7pok';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // --- NAVIGATION LOGIC ---
        async function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');

            document.querySelectorAll('.tab-view').forEach(view => view.classList.add('hidden'));
            document.getElementById('view-' + tabId).classList.remove('hidden');

            if (tabId === 'overview') { loadOverviewStats(); loadClassSummaries(); }
            if (tabId === 'koordinator') loadCoordinatorList();
            if (tabId === 'fasilitator') loadFacilitatorList();
            if (tabId === 'laporan') loadReportOptions();
        }

        // --- OVERVIEW TAB ---
        async function loadOverviewStats() {
            loadGlobalFinancialStats();
            loadClassSummaries();
            try {
                const { data: profiles, error } = await supabaseClient.from('profiles').select('role');
                if (error) throw error;

                const counts = {
                    koordinator: profiles.filter(p => p.role === 'koordinator').length,
                    fasilitator: profiles.filter(p => p.role === 'fasilitator').length,
                    siswa: profiles.filter(p => p.role === 'siswa').length
                };

                let userStatsSection = document.getElementById('userQuickStats');
                if (!userStatsSection) {
                    userStatsSection = document.createElement('div');
                    userStatsSection.id = 'userQuickStats';
                    userStatsSection.className = 'grid grid-cols-3 gap-4 mt-6';
                    document.getElementById('view-overview').prepend(userStatsSection);
                }

                userStatsSection.innerHTML = `
                    <div class="p-6 bg-slate-800 rounded-3xl border border-slate-700 shadow-xl">
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Koordinator</p>
                        <h3 class="text-2xl font-black text-white">${counts.koordinator}</h3>
                    </div>
                    <div class="p-6 bg-slate-800 rounded-3xl border border-slate-700 shadow-xl">
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Fasilitator</p>
                        <h3 class="text-2xl font-black text-white">${counts.fasilitator}</h3>
                    </div>
                    <div class="p-6 bg-slate-800 rounded-3xl border border-slate-700 shadow-xl">
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Total Siswa</p>
                        <h3 class="text-2xl font-black text-white">${counts.siswa}</h3>
                    </div>
                `;
            } catch (err) { console.error(err); }
        }

        async function loadGlobalFinancialStats() {
            try {
                const { data: responses, error } = await supabaseClient
                    .from('module_responses')
                    .select('answers')
                    .eq('module_type', 'laporan_akhir')
                    .eq('day_id', 3);

                if (error) throw error;

                let totalOmzet = 0, totalCapital = 0, totalProfit = 0;
                responses.forEach(r => {
                    try {
                        const answers = JSON.parse(r.answers[0]);
                        const cap = parseFloat(answers.modal_kelas || answers.total_biaya || 0) || 0;
                        const laba = parseFloat(answers.laba || answers.laba_rugi || 0) || 0;
                        const rugi = parseFloat(answers.rugi || 0) || 0;
                        totalCapital += cap;
                        totalProfit += (laba - rugi);
                        totalOmzet += (cap + laba - rugi);
                    } catch (e) { }
                });

                document.getElementById('totalOmzetAdmin').textContent = 'Rp ' + totalOmzet.toLocaleString('id-ID');
                document.getElementById('totalProfitAdmin').textContent = 'Rp ' + totalProfit.toLocaleString('id-ID');
                document.getElementById('totalCapitalAdmin').textContent = 'Rp ' + totalCapital.toLocaleString('id-ID');
                const avgRoi = totalCapital > 0 ? (totalProfit / totalCapital * 100) : 0;
                document.getElementById('avgRoiAdmin').textContent = avgRoi.toFixed(1) + '%';
            } catch (err) { console.error(err); }
        }

        async function loadClassSummaries() {
            try {
                const { data: students, error: sErr } = await supabaseClient.from('students').select('id, kelas');
                if (sErr) throw sErr;
                const studentClassMap = {};
                students.forEach(s => studentClassMap[s.id] = s.kelas);

                const { data: poRes, error: poErr } = await supabaseClient
                    .from('module_responses')
                    .select('student_id, answers, updated_at')
                    .eq('module_type', 'bep_analisis')
                    .eq('day_id', 2);
                if (poErr) throw poErr;

                const { data: finRes, error: finErr } = await supabaseClient
                    .from('module_responses')
                    .select('student_id, answers, updated_at')
                    .eq('module_type', 'laporan_akhir')
                    .eq('day_id', 3);
                if (finErr) throw finErr;

                const poDataByClass = {};
                const finDataByClass = {};

                poRes.forEach(r => {
                    const classId = studentClassMap[r.student_id];
                    if (!classId) return;
                    if (!poDataByClass[classId] || new Date(r.updated_at) > new Date(poDataByClass[classId].updated_at)) {
                        try {
                            const ans = JSON.parse(r.answers[0]);
                            poDataByClass[classId] = {
                                food: parseInt(ans.po_makanan_qty) || 0,
                                drink: parseInt(ans.po_minuman_qty) || 0,
                                updated_at: r.updated_at
                            };
                        } catch (e) { }
                    }
                });

                finRes.forEach(r => {
                    const classId = studentClassMap[r.student_id];
                    if (!classId) return;
                    if (!finDataByClass[classId] || new Date(r.updated_at) > new Date(finDataByClass[classId].updated_at)) {
                        try {
                            const ans = JSON.parse(r.answers[0]);
                            const omzet = parseFloat(ans.total_penjualan || (parseFloat(ans.penjualan_makanan_rp || 0) + parseFloat(ans.penjualan_minuman_rp || 0))) || 0;
                            const modal = parseFloat(ans.total_biaya || (parseFloat(ans.biaya_prod_makan || 0) + parseFloat(ans.biaya_prod_minum || 0) + parseFloat(ans.biaya_tetap || 0))) || 0;
                            const laba = parseFloat(ans.laba_rugi || ans.laba || 0) || 0;
                            finDataByClass[classId] = { omzet, modal, laba, updated_at: r.updated_at };
                        } catch (e) { }
                    }
                });

                const poBody = document.getElementById('poSummaryBody');
                const poFoot = document.getElementById('poSummaryFoot');
                let poHtml = '', totalFood = 0, totalDrink = 0;
                Object.keys(poDataByClass).sort().forEach(cls => {
                    const d = poDataByClass[cls];
                    totalFood += d.food; totalDrink += d.drink;
                    poHtml += `<tr class="hover:bg-slate-800/50 transition-colors"><td class="p-4 font-bold text-white text-xs">${cls}</td><td class="p-4 text-center text-slate-300 text-xs">${d.food}</td><td class="p-4 text-center text-slate-300 text-xs">${d.drink}</td><td class="p-4 text-right font-black text-blue-500 text-xs">${d.food + d.drink}</td></tr>`;
                });
                poBody.innerHTML = poHtml || '<tr><td colspan="4" class="p-8 text-center text-slate-500 text-[10px] font-black uppercase">Belum ada data PO</td></tr>';
                poFoot.innerHTML = poHtml ? `<tr class="border-t-2 border-slate-700 bg-slate-800/50"><td class="p-4 text-[10px] uppercase tracking-widest text-slate-400">Total Seluruh Kelas</td><td class="p-4 text-center text-xs font-black">${totalFood}</td><td class="p-4 text-center text-xs font-black">${totalDrink}</td><td class="p-4 text-right text-xs font-black text-blue-400">${totalFood + totalDrink}</td></tr>` : '';

                const finBody = document.getElementById('financeSummaryBody');
                const finFoot = document.getElementById('financeSummaryFoot');
                let finHtml = '', tOmzet = 0, tModal = 0, tLaba = 0;
                Object.keys(finDataByClass).sort().forEach(cls => {
                    const d = finDataByClass[cls];
                    tOmzet += d.omzet; tModal += d.modal; tLaba += d.laba;
                    finHtml += `<tr class="hover:bg-slate-800/50 transition-colors"><td class="p-4 font-bold text-white text-xs">${cls}</td><td class="p-4 text-right text-slate-300 text-xs">Rp ${d.omzet.toLocaleString('id-ID')}</td><td class="p-4 text-right text-slate-300 text-xs">Rp ${d.modal.toLocaleString('id-ID')}</td><td class="p-4 text-right font-black ${d.laba >= 0 ? 'text-emerald-500' : 'text-red-500'} text-xs">Rp ${d.laba.toLocaleString('id-ID')}</td></tr>`;
                });
                finBody.innerHTML = finHtml || '<tr><td colspan="4" class="p-8 text-center text-slate-500 text-[10px] font-black uppercase">Belum ada data laporan</td></tr>';
                finFoot.innerHTML = finHtml ? `<tr class="border-t-2 border-slate-700 bg-slate-800/50"><td class="p-4 text-[10px] uppercase tracking-widest text-slate-400">Total Seluruh Kelas</td><td class="p-4 text-right text-xs font-black text-white">Rp ${tOmzet.toLocaleString('id-ID')}</td><td class="p-4 text-right text-xs font-black text-white">Rp ${tModal.toLocaleString('id-ID')}</td><td class="p-4 text-right text-xs font-black text-amber-400">Rp ${tLaba.toLocaleString('id-ID')}</td></tr>` : '';
            } catch (e) { console.error("Summary Load Error:", e); }
        }

        // --- USER LISTS ---
        async function loadCoordinatorList() {
            const cont = document.getElementById('view-koordinator');
            cont.innerHTML = '<div class="flex justify-center py-20"><div class="animate-spin size-8 border-4 border-emerald-500 border-t-transparent rounded-full"></div></div>';
            try {
                const { data, error } = await supabaseClient.from('profiles').select('*').eq('role', 'koordinator').order('full_name');
                if (error) throw error;
                let html = '<div class="bg-slate-800 rounded-[2.5rem] border border-slate-700 overflow-hidden shadow-xl"><table class="w-full text-left text-sm"><thead class="bg-slate-900/50 border-b border-slate-700 text-[10px] font-black uppercase tracking-widest text-slate-500"><tr><th class="p-6">Nama Koordinator</th><th class="p-6">Email</th><th class="p-6 text-right">Aksi</th></tr></thead><tbody class="divide-y divide-slate-700/50">';
                data.forEach(p => {
                    html += `<tr class="hover:bg-slate-700/30 transition-colors"><td class="p-6"><p class="font-bold text-white">${p.full_name}</p><p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Koordinator Kokulikuler</p></td><td class="p-6 text-slate-400 font-medium">${p.email || '-'}</td><td class="p-6 text-right font-black uppercase text-[10px] text-emerald-500"><button class="hover:underline">Detail</button></td></tr>`;
                });
                html += '</tbody></table></div>';
                cont.innerHTML = html;
            } catch (err) { cont.innerHTML = `<p class="text-red-500 text-center py-20">${err.message}</p>`; }
        }

        async function loadFacilitatorList() {
            const cont = document.getElementById('view-fasilitator');
            cont.innerHTML = '<div class="flex justify-center py-20"><div class="animate-spin size-8 border-4 border-emerald-500 border-t-transparent rounded-full"></div></div>';
            try {
                const { data, error } = await supabaseClient.from('profiles').select('*').eq('role', 'fasilitator').order('full_name');
                if (error) throw error;
                let html = '<div class="bg-slate-800 rounded-[2.5rem] border border-slate-700 overflow-hidden shadow-xl"><table class="w-full text-left text-sm"><thead class="bg-slate-900/50 border-b border-slate-700 text-[10px] font-black uppercase tracking-widest text-slate-500"><tr><th class="p-6">Nama Fasilitator</th><th class="p-6">Email</th><th class="p-6 text-right">Aksi</th></tr></thead><tbody class="divide-y divide-slate-700/50">';
                data.forEach(p => {
                    html += `<tr class="hover:bg-slate-700/30 transition-colors"><td class="p-6"><p class="font-bold text-white">${p.full_name}</p><p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Guru Pembimbing</p></td><td class="p-6 text-slate-400 font-medium">${p.email || '-'}</td><td class="p-6 text-right font-black uppercase text-[10px] text-emerald-500"><button class="hover:underline">Detail</button></td></tr>`;
                });
                html += '</tbody></table></div>';
                cont.innerHTML = html;
            } catch (err) { cont.innerHTML = `<p class="text-red-500 text-center py-20">${err.message}</p>`; }
        }

        // --- STUDENT SEARCH & RESET ---
        async function searchStudent() {
            const query = document.getElementById('studentSearch').value.trim();
            if (query.length < 3) return alert('Masukkan minimal 3 karakter');
            const loader = document.getElementById('searchLoading'), resultCont = document.getElementById('searchResult');
            loader.classList.remove('hidden'); resultCont.innerHTML = '';
            try {
                const { data, error } = await supabaseClient.from('students').select('*').or(`nama.ilike.%${query}%,nisn.ilike.%${query}%`).limit(10);
                if (error) throw error;
                if (!data.length) { resultCont.innerHTML = '<p class="text-center text-slate-500 py-4 font-bold uppercase text-[10px]">Data tidak ditemukan</p>'; return; }
                data.forEach(s => {
                    resultCont.innerHTML += `<div onclick="openStudentReset('${s.id}', '${s.nama.replace(/'/g, "\\'")}', '${s.kelas}')" class="bg-slate-900/50 p-4 rounded-2xl border border-slate-700 flex items-center justify-between group cursor-pointer hover:border-emerald-500 transition-all"><div class="flex items-center gap-4"><div class="size-10 bg-slate-800 rounded-xl flex items-center justify-center text-slate-400 group-hover:bg-emerald-500 group-hover:text-white transition-all"><span class="material-symbols-outlined">person</span></div><div><p class="text-sm font-black text-white">${s.nama}</p><p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">${s.kelas} • ${s.nisn}</p></div></div><span class="material-symbols-outlined text-slate-600 group-hover:text-emerald-500">arrow_forward</span></div>`;
                });
            } catch (e) { alert(e.message); } finally { loader.classList.add('hidden'); }
        }

        async function openStudentReset(sid, sname, skelas) {
            document.getElementById('modalStudentName').textContent = sname;
            document.getElementById('modalStudentClass').textContent = skelas;
            document.getElementById('resetModal').classList.remove('hidden');
            document.getElementById('resetModal').classList.add('flex');
            loadResponses(sid, sname);
        }

        async function loadResponses(sid, sname) {
            const cont = document.getElementById('modalResponseList');
            cont.innerHTML = '<p class="text-center text-slate-500 py-6 animate-pulse font-bold uppercase text-[10px]">Memuat jawaban...</p>';
            try {
                const { data, error } = await supabaseClient.from('module_responses').select('*').eq('student_id', sid).order('day_id', { ascending: true });
                if (error) throw error;
                if (!data.length) { cont.innerHTML = '<p class="text-center text-slate-600 py-10 font-bold uppercase text-[10px]">Belum ada jawaban</p>'; return; }
                const labels = { 'pemantik': 'Pemantik', 'materi': 'Materi', 'video': 'Video', 'lkpd': 'LKPD', 'kuis': 'Assessment', 'dokumentasi': 'Dokumentasi', 'glosarium': 'Glosarium', 'refleksi': 'Refleksi', 'laporan_akhir': 'Laporan Akhir' };
                let html = '';
                data.forEach(r => {
                    html += `<div class="bg-slate-900 border border-slate-700 p-4 rounded-2xl flex items-center justify-between"><div><p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">HARI ${r.day_id} • ${labels[r.module_type] || r.module_type.toUpperCase()}</p><div class="flex items-center gap-2 mt-1"><span class="size-1.5 bg-${r.status === 'reviewed' ? 'emerald' : 'amber'}-500 rounded-full"></span><p class="text-xs font-bold text-white uppercase">${r.status}</p></div></div><button onclick="resetAction('${r.id}', '${sname.replace(/'/g, "\\'")}', '${labels[r.module_type] || r.module_type.toUpperCase()}', ${r.day_id})" class="size-10 bg-red-600/20 text-red-500 rounded-xl flex items-center justify-center hover:bg-red-600 hover:text-white transition-all"><span class="material-symbols-outlined">delete</span></button></div>`;
                });
                cont.innerHTML = html;
            } catch (e) { cont.innerHTML = e.message; }
        }

        async function resetAction(rid, sname, mLabel, dayId) {
            if (!confirm(`Hapus permanen ${mLabel} milik ${sname}?`)) return;
            try {
                const { error } = await supabaseClient.from('module_responses').delete().eq('id', rid);
                if (error) throw error;
                alert('Berhasil!');
                document.getElementById('resetModal').classList.add('hidden');
            } catch (e) { alert(e.message); }
        }

        function closeResetModal() {
            document.getElementById('resetModal').classList.add('hidden');
            document.getElementById('resetModal').classList.remove('flex');
        }

        // --- REPORTS & EXPORT ---
        async function loadReportOptions() {
            try {
                const { data, error } = await supabaseClient.from('students').select('kelas');
                if (error) throw error;
                const classes = [...new Set(data.map(s => s.kelas))].sort();
                ['exportClassSelect', 'reportClassSelect'].forEach(id => {
                    const sel = document.getElementById(id);
                    sel.innerHTML = '<option value="">Pilih Kelas...</option>';
                    classes.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c; opt.textContent = 'Kelas ' + c; sel.appendChild(opt);
                    });
                });
            } catch (err) { console.error(err); }
        }

        async function exportFinalGrades() {
            const cls = document.getElementById('exportClassSelect').value;
            if (!cls) return alert("Pilih kelas");
            try {
                const { data: students, error: sErr } = await supabaseClient.from('students').select('id, nama, nisn').eq('kelas', cls);
                if (sErr) throw sErr;
                const ids = students.map(s => s.id);
                const { data: res, error: rErr } = await supabaseClient.from('module_responses').select('student_id, stars').in('student_id', ids).eq('module_type', 'laporan_akhir');
                if (rErr) throw rErr;
                const rMap = {}; res.forEach(r => rMap[r.student_id] = r);
                let csv = 'No,Nama,NISN,Predikat,Bintang\n';
                students.sort((a, b) => a.nama.localeCompare(b.nama)).forEach((s, i) => {
                    const r = rMap[s.id];
                    let p = 'Belum Dinilai', stars = r ? (r.stars || 0) : 0;
                    if (stars >= 5) p = 'Mahir'; else if (stars >= 4) p = 'Cakap'; else if (stars >= 1) p = 'Berkembang';
                    csv += `${i + 1},"${s.nama}","${s.nisn}",${p},${stars}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `Rekap_Nilai_${cls}.csv`;
                link.click();
            } catch (err) { alert(err.message); }
        }

        async function viewClassFinancialReport() {
            const cls = document.getElementById('reportClassSelect').value;
            if (!cls) return alert("Pilih kelas");
            const area = document.getElementById('reportResultArea'), cont = document.getElementById('reportResultContent'), title = document.getElementById('reportResultTitle');
            title.textContent = `Laporan Keuangan: Kelas ${cls}`;
            area.classList.remove('hidden');
            cont.innerHTML = '<div class="flex justify-center py-10"><div class="animate-spin size-6 border-4 border-blue-500 border-t-transparent rounded-full font-bold"></div></div>';
            try {
                const { data: students, error: sErr } = await supabaseClient.from('students').select('id').eq('kelas', cls);
                if (sErr) throw sErr;
                const ids = students.map(s => s.id);
                const { data: responses, error } = await supabaseClient.from('module_responses').select('answers').in('student_id', ids).eq('module_type', 'laporan_akhir');
                if (error) throw error;
                let tO = 0, tC = 0, tP = 0, count = 0;
                responses.forEach(r => {
                    try {
                        const a = JSON.parse(r.answers[0]);
                        const cap = parseFloat(a.modal_kelas) || 0, laba = parseFloat(a.laba) || 0, rugi = parseFloat(a.rugi) || 0;
                        tC += cap; tP += (laba - rugi); tO += (cap + laba - rugi); count++;
                    } catch (e) { }
                });
                cont.innerHTML = `
                    <div class="grid grid-cols-3 gap-4">
                        <div class="p-4 bg-slate-800 rounded-2xl border border-slate-700">
                            <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Total Laba</p>
                            <p class="text-sm font-black text-emerald-500">Rp ${tP.toLocaleString('id-ID')}</p>
                        </div>
                        <div class="p-4 bg-slate-800 rounded-2xl border border-slate-700">
                            <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Total Modal</p>
                            <p class="text-sm font-black text-white">Rp ${tC.toLocaleString('id-ID')}</p>
                        </div>
                        <div class="p-4 bg-slate-800 rounded-2xl border border-slate-700">
                            <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Entry Laporan</p>
                            <p class="text-sm font-black text-blue-500">${count} Grup</p>
                        </div>
                    </div>
                `;
            } catch (err) { cont.innerHTML = err.message; }
        }

        // Initial Load
        loadOverviewStats();
        document.getElementById('studentSearch').addEventListener('keypress', (e) => { if (e.key === 'Enter') searchStudent(); });

    </script>
</body>

</html>