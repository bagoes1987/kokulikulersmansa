<!DOCTYPE html>
<html class="light" lang="id">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Dashboard Kegiatan - SMAN 1 Belitang</title>
    <!-- v1.1.0 - Fix Day 3 Documentation Ganti Foto -->
    <link rel="icon" href="./logo-sekolah.png" type="image/png">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <!-- Deployment Trigger v1.1.0 -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "emerald-custom": "#10B981",
                        "terracotta": "#E2725B",
                        "bg-main": "#F8FAFB",
                    },
                    fontFamily: {
                        "sans": ["Inter", "sans-serif"]
                    }
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        @layer base {
            body {
                @apply font-sans bg-bg-main text-slate-800;
            }
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 48;
        }

        .ios-shadow {
            box-shadow: 0 4px 20px -1px rgba(0, 0, 0, 0.05);
        }

        .circular-progress {
            background: conic-gradient(#10B981 0deg, #E2E8F0 0deg);
            transition: background 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body class="min-h-screen">
    <div class="relative flex min-h-screen w-full flex-col max-w-md mx-auto bg-bg-main overflow-x-hidden pb-24">
        <!-- Header -->
        <header
            class="sticky top-0 z-50 bg-white/80 backdrop-blur-lg border-b border-slate-100 px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="h-16 w-16 rounded-full bg-cover bg-center border-2 border-slate-100 shadow-sm"
                    id="studentPhoto"
                    style='background-image: url("https://ui-avatars.com/api/?name=Siswa&background=13ec6d&color=fff&size=256");'>
                </div>
                <div>
                    <h1 class="text-lg font-black text-slate-900 leading-tight" id="headerStudentName">Memuat...</h1>
                    <p class="text-[13px] text-slate-500 font-bold mt-0.5">
                        <span id="headerClass">...</span> • SMAN 1 BELITANG
                    </p>
                    <div class="mt-2.5 flex flex-col gap-1.5">
                        <div class="flex items-start gap-1 text-[11px] leading-tight">
                            <span class="text-slate-400 font-medium w-[38px] shrink-0">Koord:</span>
                            <span id="headerCoord" class="text-slate-700 font-bold">-</span>
                        </div>
                        <div class="flex items-start gap-1 text-[11px] leading-tight">
                            <span class="text-slate-400 font-medium w-[38px] shrink-0">Fasil:</span>
                            <span id="headerFasil" class="text-slate-700 font-bold">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="relative flex items-center justify-center">
                <div class="circular-progress h-14 w-14 rounded-full flex items-center justify-center"
                    id="progressCircle">
                    <div class="h-11 w-11 bg-white rounded-full flex items-center justify-center">
                        <span class="text-[12px] font-bold text-emerald-custom" id="progressPercent">0%</span>
                    </div>
                </div>
                <!-- Checkmark muncul jika 100% -->
                <div class="absolute -bottom-2 -right-1 bg-white rounded-full p-0.5 shadow-sm hidden"
                    id="progressCheck">
                    <span class="material-symbols-outlined !text-xs text-emerald-custom">check_circle</span>
                </div>
            </div>
        </header>

        <!-- Day Tabs -->
        <div class="px-6 py-6">
            <div class="bg-slate-200/50 p-1 rounded-2xl flex items-center">
                <button onclick="switchDay(1)"
                    class="flex-1 py-3 rounded-xl text-base font-semibold bg-white text-emerald-custom shadow-sm transition-all"
                    id="tab-day1">Hari 1</button>
                <button onclick="switchDay(2)"
                    class="flex-1 py-3 rounded-xl text-base font-semibold text-slate-500 hover:text-slate-700 transition-all"
                    id="tab-day2">Hari 2</button>
                <button onclick="switchDay(3)"
                    class="flex-1 py-3 rounded-xl text-base font-semibold text-slate-500 hover:text-slate-700 transition-all"
                    id="tab-day3">Hari 3</button>
                <button onclick="switchDay('nilai')"
                    class="flex-1 py-3 rounded-xl text-base font-semibold text-slate-500 hover:text-slate-700 transition-all"
                    id="tab-nilai">Nilai</button>
            </div>
        </div>

        <!-- Title -->
        <div class="px-6 mb-4">
            <h2 class="text-2xl font-bold text-slate-900" id="dashboardTitle">Dasbor Kegiatan</h2>
            <p class="text-base text-slate-500" id="dashboardSubtitle">Selesaikan modul hari ini</p>
        </div>

        <!-- Module Grid -->
        <div id="module-grid-container" class="animate-fade-in block">
            <div class="grid grid-cols-2 gap-4 px-6">
                <!-- Pertanyaan Pemantik -->
                <div id="module-pemantik" onclick="handleModuleClick('pemantik')"
                    class="bg-amber-50/50 p-4 rounded-[24px] ios-shadow border border-amber-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-amber-400 flex items-center justify-center text-white shadow-lg shadow-amber-200">
                        <span class="material-symbols-outlined !text-2xl">lightbulb</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Pertanyaan Pemantik</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-pemantik">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-pemantik">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>

                <!-- Materi Belajar -->
                <div id="module-materi" onclick="handleModuleClick('materi')"
                    class="bg-blue-50/50 p-4 rounded-[24px] ios-shadow border border-blue-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-blue-500 flex items-center justify-center text-white shadow-lg shadow-blue-200">
                        <span class="material-symbols-outlined !text-2xl">description</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Materi Belajar</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-materi">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-materi">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>

                <!-- Analisis Produk (Day 2 Only) -->
                <div id="module-bep" onclick="handleModuleClick('bep')" style="display: none;"
                    class="bg-pink-50/50 p-4 rounded-[24px] ios-shadow border border-pink-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-pink-500 flex items-center justify-center text-white shadow-lg shadow-pink-200">
                        <span class="material-symbols-outlined !text-2xl">analytics</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Laporan Modal</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-bep">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-bep">Belum Selesai</span>
                        </div>
                    </div>
                </div>



                <!-- Laporan Akhir (Day 3 Only) -->
                <div id="module-laporan-akhir" onclick="openLaporanAkhirModal()" style="display: none;"
                    class="bg-emerald-50/50 p-4 rounded-[24px] ios-shadow border border-emerald-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-emerald-500 flex items-center justify-center text-white shadow-lg shadow-emerald-200">
                        <span class="material-symbols-outlined !text-2xl">assignment_turned_in</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Laporan Akhir</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-laporan-akhir">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-laporan-akhir">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>

                <!-- Video Belajar -->
                <div id="module-video" onclick="handleModuleClick('video')"
                    class="bg-red-50/50 p-4 rounded-[24px] ios-shadow border border-red-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-red-500 flex items-center justify-center text-white shadow-lg shadow-red-200">
                        <span class="material-symbols-outlined !text-2xl">play_circle</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Video Belajar</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-video">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-video">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>

                <!-- LKPD Digital -->
                <div id="module-lkpd" onclick="handleModuleClick('lkpd')"
                    class="bg-orange-50/50 p-4 rounded-[24px] ios-shadow border border-orange-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-terracotta flex items-center justify-center text-white shadow-lg shadow-terracotta/30">
                        <span class="material-symbols-outlined !text-2xl">edit_note</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">LKPD Digital</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-lkpd">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-lkpd">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>

                <!-- Asesmen -->
                <div id="module-asesmen" onclick="handleModuleClick('asesmen')"
                    class="bg-purple-50/50 p-4 rounded-[24px] ios-shadow border border-purple-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-purple-500 flex items-center justify-center text-white shadow-lg shadow-purple-200">
                        <span class="material-symbols-outlined !text-2xl">task_alt</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Assessment</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-asesmen">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-asesmen">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>

                <!-- Dokumentasi Foto -->
                <div id="module-dokumentasi" onclick="handleModuleClick('dokumentasi')"
                    class="bg-indigo-50/50 p-4 rounded-[24px] ios-shadow border border-indigo-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-indigo-500 flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                        <span class="material-symbols-outlined !text-2xl">photo_camera</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Dokumentasi Foto</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-dokumentasi">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-dokumentasi">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>

                <!-- Glosarium -->
                <div id="module-glosarium" onclick="openGlosariumModal()"
                    class="bg-cyan-50/50 p-4 rounded-[24px] ios-shadow border border-cyan-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-cyan-500 flex items-center justify-center text-white shadow-lg shadow-cyan-200">
                        <span class="material-symbols-outlined !text-2xl">dictionary</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Glosarium</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-glosarium">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-glosarium">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>

                <!-- Refleksi Akhir (Day 3 Only) -->
                <div id="module-refleksi-akhir" onclick="openRefleksiAkhirModal()" style="display: none;"
                    class="bg-rose-50/50 p-4 rounded-[24px] ios-shadow border border-rose-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-rose-500 flex items-center justify-center text-white shadow-lg shadow-rose-200">
                        <span class="material-symbols-outlined !text-2xl">history_edu</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Refleksi Akhir</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-refleksi-akhir">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-refleksi-akhir">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>

                <!-- Cerita Kecilku Hari Ini (Day 3 Only) -->
                <div id="module-cerita-kecil" onclick="handleModuleClick('cerita-kecil')" style="display: none;"
                    class="bg-indigo-50/50 p-4 rounded-[24px] ios-shadow border border-indigo-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-indigo-500 flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                        <span class="material-symbols-outlined !text-2xl">auto_stories</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Cerita Kecilku Hari Ini</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-cerita-kecil">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-cerita-kecil">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>


                <!-- Refleksi -->
                <div id="module-refleksi" onclick="openRefleksiModal()"
                    class="bg-rose-50/50 p-4 rounded-[24px] ios-shadow border border-rose-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-rose-500 flex items-center justify-center text-white shadow-lg shadow-rose-200">
                        <span class="material-symbols-outlined !text-2xl">self_improvement</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Refleksi</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-refleksi">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-refleksi">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nilai Final / Report Card Section -->
        <div id="nilai-report-container" class="hidden animate-slide-up px-6 pb-24">
            <div
                class="bg-white rounded-[2.5rem] p-8 shadow-xl border border-slate-100 text-center relative overflow-hidden">
                <!-- Decorative BG -->
                <div
                    class="absolute top-0 left-0 w-full h-24 bg-gradient-to-br from-emerald-500/10 to-teal-500/10 rounded-b-[50%] -z-0">
                </div>

                <div class="relative z-10">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Nilai Kokurikuler
                    </p>

                    <div id="final-star-display" class="mb-4">
                        <div class="flex justify-center gap-1 text-4xl mb-2">
                            <span class="material-symbols-outlined text-slate-200"
                                style="font-variation-settings: 'FILL' 1">star</span>
                            <span class="material-symbols-outlined text-slate-200"
                                style="font-variation-settings: 'FILL' 1">star</span>
                            <span class="material-symbols-outlined text-slate-200"
                                style="font-variation-settings: 'FILL' 1">star</span>
                            <span class="material-symbols-outlined text-slate-200"
                                style="font-variation-settings: 'FILL' 1">star</span>
                            <span class="material-symbols-outlined text-slate-200"
                                style="font-variation-settings: 'FILL' 1">star</span>
                        </div>
                        <p class="text-xs text-slate-400 font-bold" id="final-total-score">Belum Dinilai</p>
                    </div>

                    <div id="final-badge-container" class="my-6">
                        <div class="inline-block px-8 py-3 bg-slate-50 rounded-full border border-slate-200">
                            <span class="text-sm font-black text-slate-400">MENUNGGU PENILAIAN</span>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100 text-left">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Deskripsi
                            Capaian</p>
                        <p class="text-xs text-slate-600 font-medium leading-relaxed text-justify"
                            id="final-description">
                            Fasilitator belum mempublikasikan nilai akhir projekmu. Silakan selesaikan semua tugas Hari
                            1-3.
                        </p>
                    </div>

                    <div id="final-feedback-section" class="mt-4 hidden">
                        <div class="bg-amber-50 p-6 rounded-3xl border border-amber-100 text-left">
                            <p class="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-2">Catatan
                                Fasilitator</p>
                            <p class="text-xs text-slate-700 font-medium leading-relaxed italic text-justify"
                                id="final-feedback-text">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="switchDay(3)" id="btn-back-to-task"
                class="w-full mt-6 py-4 rounded-2xl bg-slate-800 text-white font-bold shadow-lg shadow-slate-200 active:scale-95 transition-transform">
                Kembali ke Tugas
            </button>
        </div>

        <!-- Bottom Navigation -->
        <nav
            class="fixed bottom-0 w-full max-w-md bg-white/90 backdrop-blur-xl border-t border-slate-100 px-8 py-3 pb-8 flex justify-between items-center z-[100]">
            <button onclick="window.location.href='index.html'"
                class="flex flex-col items-center gap-1 text-slate-400 transition-transform active:scale-90">
                <span class="material-symbols-outlined !text-2xl">home</span>
                <span class="text-[12px] font-medium">Beranda</span>
            </button>
            <button onclick="window.location.href='dashboard-kegiatan.html'"
                class="flex flex-col items-center gap-1 text-emerald-custom transition-transform active:scale-90">
                <span class="material-symbols-outlined !text-2xl">grid_view</span>
                <span class="text-[12px] font-bold">Dasbor</span>
            </button>
            <button onclick="window.location.href='pengaturan-akun.html'"
                class="flex flex-col items-center gap-1 text-slate-400 transition-transform active:scale-90">
                <span class="material-symbols-outlined !text-2xl">person</span>
                <span class="text-[12px] font-medium">Profil</span>
            </button>
            <button onclick="logout()"
                class="flex flex-col items-center gap-1 text-slate-400 transition-transform active:scale-90 hover:text-red-500">
                <span class="material-symbols-outlined !text-2xl">logout</span>
                <span class="text-[12px] font-medium">Keluar</span>
            </button>
        </nav>

        <!-- Modal Dokumentasi 5 Kategori untuk Hari 2 -->
        <div id="modal-dokumentasi-day2"
            class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4 animate-fade-in">
            <div
                class="bg-white rounded-[2.5rem] w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
                <!-- Header -->
                <div class="p-6 border-b flex justify-between items-center bg-white z-10">
                    <div class="flex items-center gap-4">
                        <div
                            class="size-12 rounded-2xl bg-indigo-600 text-white flex items-center justify-center shadow-lg shadow-indigo-200">
                            <span class="material-symbols-outlined !text-2xl">photo_library</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-black text-slate-800 leading-tight">Upload Foto Kegiatan</h2>
                            <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mt-0.5">HARI 2 • 5
                                KATEGORI</p>
                        </div>
                    </div>
                    <button onclick="closeDokumentasiDay2Modal()"
                        class="size-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-all">
                        <span class="material-symbols-outlined !text-xl">close</span>
                    </button>
                </div>

                <!-- Content -->
                <div class="p-6 space-y-6 overflow-y-auto no-scrollbar flex-1 bg-slate-50/50">
                    <!-- Info -->
                    <div class="p-4 rounded-2xl bg-indigo-50 border border-indigo-100 flex gap-3 items-start">
                        <span class="material-symbols-outlined text-indigo-500 text-lg mt-0.5">info</span>
                        <p class="text-[11px] font-medium text-indigo-800 leading-relaxed">
                            Silakan upload 1 foto terbaik untuk setiap aktivitas di bawah ini. Foto akan otomatis
                            dikompres agar hemat kuota.
                        </p>
                    </div>

                    <!-- Category 1: Makanan (Orange) -->
                    <div
                        class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden group transition-all hover:shadow-md">
                        <div class="px-5 py-3 bg-orange-50/50 flex items-center gap-3 border-b border-orange-100/50">
                            <div
                                class="size-8 rounded-full bg-white flex items-center justify-center text-orange-500 shadow-sm">
                                <span class="material-symbols-outlined text-lg">restaurant</span>
                            </div>
                            <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">1. Proses
                                Pembuatan Makanan</span>
                        </div>

                        <div class="p-5">
                            <input type="file" id="doc-makanan" accept="image/*"
                                onchange="handleCategoryPhoto('makanan', this)" class="hidden">

                            <div id="upload-area-makanan"
                                class="w-full py-8 border-2 border-dashed border-orange-200 bg-orange-50/30 rounded-2xl flex flex-col items-center justify-center text-center cursor-pointer hover:bg-orange-50 transition-colors group/upload"
                                onclick="document.getElementById('doc-makanan').click()">
                                <div
                                    class="size-12 rounded-full bg-white text-orange-500 flex items-center justify-center mb-3 shadow-sm group-hover/upload:scale-110 transition-transform">
                                    <span class="material-symbols-outlined">add_a_photo</span>
                                </div>
                                <p class="text-[10px] font-black text-orange-400 uppercase tracking-widest">Pilih Foto
                                    Makanan</p>
                            </div>

                            <div id="preview-area-makanan" class="hidden relative animate-fade-in">
                                <div class="relative rounded-2xl overflow-hidden border-4 border-white shadow-lg">
                                    <img id="preview-makanan" src="" alt="Preview" class="w-full h-48 object-cover">
                                    <div
                                        class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                                    </div>

                                    <!-- Delete Button -->
                                    <button onclick="removeCategoryPhoto('makanan')"
                                        class="absolute top-3 right-3 size-9 bg-white/90 backdrop-blur text-red-500 rounded-full flex items-center justify-center shadow-lg hover:bg-red-500 hover:text-white active:scale-90 transition-all z-10"
                                        title="Hapus Foto">
                                        <span class="material-symbols-outlined text-lg">delete</span>
                                    </button>
                                </div>
                                <div id="status-makanan"
                                    class="mt-3 flex items-center gap-2 text-[10px] font-bold text-emerald-600 bg-emerald-50 px-3 py-2 rounded-xl w-fit">
                                    <span class="material-symbols-outlined text-sm">check_circle</span> Foto siap
                                    dikirim
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Category 2: Minuman (Blue) -->
                    <div
                        class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden group transition-all hover:shadow-md">
                        <div class="px-5 py-3 bg-blue-50/50 flex items-center gap-3 border-b border-blue-100/50">
                            <div
                                class="size-8 rounded-full bg-white flex items-center justify-center text-blue-500 shadow-sm">
                                <span class="material-symbols-outlined text-lg">local_bar</span>
                            </div>
                            <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">2. Proses
                                Pembuatan Minuman</span>
                        </div>

                        <div class="p-5">
                            <input type="file" id="doc-minuman" accept="image/*"
                                onchange="handleCategoryPhoto('minuman', this)" class="hidden">

                            <div id="upload-area-minuman"
                                class="w-full py-8 border-2 border-dashed border-blue-200 bg-blue-50/30 rounded-2xl flex flex-col items-center justify-center text-center cursor-pointer hover:bg-blue-50 transition-colors group/upload"
                                onclick="document.getElementById('doc-minuman').click()">
                                <div
                                    class="size-12 rounded-full bg-white text-blue-500 flex items-center justify-center mb-3 shadow-sm group-hover/upload:scale-110 transition-transform">
                                    <span class="material-symbols-outlined">add_a_photo</span>
                                </div>
                                <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest">Pilih Foto
                                    Minuman</p>
                            </div>

                            <div id="preview-area-minuman" class="hidden relative animate-fade-in">
                                <div class="relative rounded-2xl overflow-hidden border-4 border-white shadow-lg">
                                    <img id="preview-minuman" src="" alt="Preview" class="w-full h-48 object-cover">
                                    <button onclick="removeCategoryPhoto('minuman')"
                                        class="absolute top-3 right-3 size-9 bg-white/90 backdrop-blur text-red-500 rounded-full flex items-center justify-center shadow-lg hover:bg-red-500 hover:text-white active:scale-90 transition-all z-10">
                                        <span class="material-symbols-outlined text-lg">delete</span>
                                    </button>
                                </div>
                                <div id="status-minuman"
                                    class="mt-3 flex items-center gap-2 text-[10px] font-bold text-emerald-600 bg-emerald-50 px-3 py-2 rounded-xl w-fit">
                                    <span class="material-symbols-outlined text-sm">check_circle</span> Foto siap
                                    dikirim
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Category 3: Stand Booth (Purple) -->
                    <div
                        class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden group transition-all hover:shadow-md">
                        <div class="px-5 py-3 bg-purple-50/50 flex items-center gap-3 border-b border-purple-100/50">
                            <div
                                class="size-8 rounded-full bg-white flex items-center justify-center text-purple-500 shadow-sm">
                                <span class="material-symbols-outlined text-lg">storefront</span>
                            </div>
                            <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">3. Proses
                                Pembuatan Stand Booth</span>
                        </div>

                        <div class="p-5">
                            <input type="file" id="doc-stand" accept="image/*"
                                onchange="handleCategoryPhoto('stand', this)" class="hidden">

                            <div id="upload-area-stand"
                                class="w-full py-8 border-2 border-dashed border-purple-200 bg-purple-50/30 rounded-2xl flex flex-col items-center justify-center text-center cursor-pointer hover:bg-purple-50 transition-colors group/upload"
                                onclick="document.getElementById('doc-stand').click()">
                                <div
                                    class="size-12 rounded-full bg-white text-purple-500 flex items-center justify-center mb-3 shadow-sm group-hover/upload:scale-110 transition-transform">
                                    <span class="material-symbols-outlined">add_a_photo</span>
                                </div>
                                <p class="text-[10px] font-black text-purple-400 uppercase tracking-widest">Pilih Foto
                                    Booth</p>
                            </div>

                            <div id="preview-area-stand" class="hidden relative animate-fade-in">
                                <div class="relative rounded-2xl overflow-hidden border-4 border-white shadow-lg">
                                    <img id="preview-stand" src="" alt="Preview" class="w-full h-48 object-cover">
                                    <button onclick="removeCategoryPhoto('stand')"
                                        class="absolute top-3 right-3 size-9 bg-white/90 backdrop-blur text-red-500 rounded-full flex items-center justify-center shadow-lg hover:bg-red-500 hover:text-white active:scale-90 transition-all z-10">
                                        <span class="material-symbols-outlined text-lg">delete</span>
                                    </button>
                                </div>
                                <div id="status-stand"
                                    class="mt-3 flex items-center gap-2 text-[10px] font-bold text-emerald-600 bg-emerald-50 px-3 py-2 rounded-xl w-fit">
                                    <span class="material-symbols-outlined text-sm">check_circle</span> Foto siap
                                    dikirim
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Category 4: Iklan (Rose) -->
                    <div
                        class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden group transition-all hover:shadow-md">
                        <div class="px-5 py-3 bg-rose-50/50 flex items-center gap-3 border-b border-rose-100/50">
                            <div
                                class="size-8 rounded-full bg-white flex items-center justify-center text-rose-500 shadow-sm">
                                <span class="material-symbols-outlined text-lg">campaign</span>
                            </div>
                            <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">4. Proses
                                Pembuatan Iklan</span>
                        </div>

                        <div class="p-5">
                            <input type="file" id="doc-iklan" accept="image/*"
                                onchange="handleCategoryPhoto('iklan', this)" class="hidden">

                            <div id="upload-area-iklan"
                                class="w-full py-8 border-2 border-dashed border-rose-200 bg-rose-50/30 rounded-2xl flex flex-col items-center justify-center text-center cursor-pointer hover:bg-rose-50 transition-colors group/upload"
                                onclick="document.getElementById('doc-iklan').click()">
                                <div
                                    class="size-12 rounded-full bg-white text-rose-500 flex items-center justify-center mb-3 shadow-sm group-hover/upload:scale-110 transition-transform">
                                    <span class="material-symbols-outlined">add_a_photo</span>
                                </div>
                                <p class="text-[10px] font-black text-rose-400 uppercase tracking-widest">Pilih Foto
                                    Iklan</p>
                            </div>

                            <div id="preview-area-iklan" class="hidden relative animate-fade-in">
                                <div class="relative rounded-2xl overflow-hidden border-4 border-white shadow-lg">
                                    <img id="preview-iklan" src="" alt="Preview" class="w-full h-48 object-cover">
                                    <button onclick="removeCategoryPhoto('iklan')"
                                        class="absolute top-3 right-3 size-9 bg-white/90 backdrop-blur text-red-500 rounded-full flex items-center justify-center shadow-lg hover:bg-red-500 hover:text-white active:scale-90 transition-all z-10">
                                        <span class="material-symbols-outlined text-lg">delete</span>
                                    </button>
                                </div>
                                <div id="status-iklan"
                                    class="mt-3 flex items-center gap-2 text-[10px] font-bold text-emerald-600 bg-emerald-50 px-3 py-2 rounded-xl w-fit">
                                    <span class="material-symbols-outlined text-sm">check_circle</span> Foto siap
                                    dikirim
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Category 5: Presentasi (Cyan) -->
                    <div
                        class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden group transition-all hover:shadow-md">
                        <div class="px-5 py-3 bg-cyan-50/50 flex items-center gap-3 border-b border-cyan-100/50">
                            <div
                                class="size-8 rounded-full bg-white flex items-center justify-center text-cyan-500 shadow-sm">
                                <span class="material-symbols-outlined text-lg">co_present</span>
                            </div>
                            <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">5. Presentasi
                                Produk Dengan Fasil</span>
                        </div>

                        <div class="p-5">
                            <input type="file" id="doc-presentasi" accept="image/*"
                                onchange="handleCategoryPhoto('presentasi', this)" class="hidden">

                            <div id="upload-area-presentasi"
                                class="w-full py-8 border-2 border-dashed border-cyan-200 bg-cyan-50/30 rounded-2xl flex flex-col items-center justify-center text-center cursor-pointer hover:bg-cyan-50 transition-colors group/upload"
                                onclick="document.getElementById('doc-presentasi').click()">
                                <div
                                    class="size-12 rounded-full bg-white text-cyan-500 flex items-center justify-center mb-3 shadow-sm group-hover/upload:scale-110 transition-transform">
                                    <span class="material-symbols-outlined">add_a_photo</span>
                                </div>
                                <p class="text-[10px] font-black text-cyan-400 uppercase tracking-widest">Pilih Foto
                                    Presentasi</p>
                            </div>

                            <div id="preview-area-presentasi" class="hidden relative animate-fade-in">
                                <div class="relative rounded-2xl overflow-hidden border-4 border-white shadow-lg">
                                    <img id="preview-presentasi" src="" alt="Preview" class="w-full h-48 object-cover">
                                    <button onclick="removeCategoryPhoto('presentasi')"
                                        class="absolute top-3 right-3 size-9 bg-white/90 backdrop-blur text-red-500 rounded-full flex items-center justify-center shadow-lg hover:bg-red-500 hover:text-white active:scale-90 transition-all z-10">
                                        <span class="material-symbols-outlined text-lg">delete</span>
                                    </button>
                                </div>
                                <div id="status-presentasi"
                                    class="mt-3 flex items-center gap-2 text-[10px] font-bold text-emerald-600 bg-emerald-50 px-3 py-2 rounded-xl w-fit">
                                    <span class="material-symbols-outlined text-sm">check_circle</span> Foto siap
                                    dikirim
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-6 bg-white border-t border-slate-100 z-10">
                    <button id="btnSubmitAllDocs" onclick="submitAllDocumentation()" disabled
                        class="w-full py-4 rounded-2xl bg-indigo-600 text-white font-black shadow-lg shadow-indigo-200 disabled:bg-slate-200 disabled:text-slate-400 disabled:shadow-none transition-all active:scale-95 flex items-center justify-center gap-2">
                        <span>Kirim Semua Dokumentasi</span>
                        <span class="material-symbols-outlined text-sm">send</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Dokumentasi 5 Kategori untuk Hari 3 -->
        <div id="modal-dokumentasi-day3"
            class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-[2rem] w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">
                <!-- Header -->
                <div class="sticky top-0 bg-white border-b border-slate-100 p-6 rounded-t-[2rem] z-10">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="h-12 w-12 rounded-2xl bg-indigo-500 flex items-center justify-center">
                                <span class="material-symbols-outlined text-white !text-2xl">photo_camera</span>
                            </div>
                            <div>
                                <h2 class="text-lg font-black text-slate-900">Dokumentasi Foto</h2>
                                <p class="text-xs text-slate-500 font-bold">HARI 3 - PUNCAK ACARA</p>
                            </div>
                        </div>
                        <button onclick="closeDokumentasiDay3Modal()" class="text-slate-400 hover:text-slate-600">
                            <span class="material-symbols-outlined !text-2xl">close</span>
                        </button>
                    </div>
                </div>

                <!-- Content -->
                <div class="p-6 space-y-6">
                    <!-- Info -->
                    <div class="p-4 rounded-2xl bg-indigo-50 border border-indigo-100">
                        <p class="text-xs font-bold text-indigo-700">
                            📸 Puncak Acara (Bazaar/Pameran). Upload 1 foto untuk setiap kategori (total 5 foto).
                        </p>
                    </div>

                    <!-- Category 1: Stand & Produk -->
                    <div class="bg-white rounded-[1.5rem] p-6 shadow-sm border border-slate-100 mb-6">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center">
                                <span class="material-symbols-outlined text-indigo-500 text-xl">storefront</span>
                            </div>
                            <h3 class="text-sm font-black text-slate-700 uppercase tracking-wide">1. Display Stand
                                Booth Kelas dengan Produk Makanan & Minuman</h3>
                        </div>

                        <input type="file" id="doc-day3-stand" accept="image/*"
                            onchange="handleCategoryPhotoDay3('stand', this)" class="hidden">

                        <div id="upload-area-day3-stand"
                            class="group border-2 border-dashed border-indigo-200 bg-indigo-50/20 hover:bg-indigo-50 rounded-[1.5rem] p-6 text-center cursor-pointer transition-all"
                            onclick="document.getElementById('doc-day3-stand').click()">
                            <div
                                class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                                <span class="material-symbols-outlined text-indigo-500">add_a_photo</span>
                            </div>
                            <p class="font-black text-indigo-400 text-xs tracking-wider mt-3">PILIH FOTO STAND</p>
                        </div>

                        <div id="preview-area-day3-stand" class="hidden mt-4 relative group">
                            <div class="relative rounded-2xl overflow-hidden border-4 border-white shadow-lg">
                                <img id="preview-day3-stand" src="" alt="Preview" class="w-full h-48 object-cover">
                                <button onclick="removeCategoryPhotoDay3('stand')"
                                    class="absolute top-3 right-3 size-9 bg-white/90 backdrop-blur text-red-500 rounded-full flex items-center justify-center shadow-lg hover:bg-red-500 hover:text-white active:scale-90 transition-all z-10"
                                    title="Hapus Foto">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                            <p id="status-day3-stand" class="text-xs mt-2"></p>
                        </div>
                    </div>

                    <!-- Category 2: Label & Gizi -->
                    <div class="bg-white rounded-[1.5rem] p-6 shadow-sm border border-slate-100 mb-6">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center">
                                <span class="material-symbols-outlined text-indigo-500 text-xl">nutrition</span>
                            </div>
                            <h3 class="text-sm font-black text-slate-700 uppercase tracking-wide">2. Label Kemasan
                                Makanan & Minuman (Komposisi & Nilai Gizi)</h3>
                        </div>

                        <input type="file" id="doc-day3-gizi" accept="image/*"
                            onchange="handleCategoryPhotoDay3('gizi', this)" class="hidden">

                        <div id="upload-area-day3-gizi"
                            class="group border-2 border-dashed border-indigo-200 bg-indigo-50/20 hover:bg-indigo-50 rounded-[1.5rem] p-6 text-center cursor-pointer transition-all"
                            onclick="document.getElementById('doc-day3-gizi').click()">
                            <div
                                class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                                <span class="material-symbols-outlined text-indigo-500">add_a_photo</span>
                            </div>
                            <p class="font-black text-indigo-400 text-xs tracking-wider mt-3">PILIH FOTO KEMASAN</p>
                        </div>

                        <div id="preview-area-day3-gizi" class="hidden mt-4 relative group">
                            <img id="preview-day3-gizi" src="" alt="Preview"
                                class="w-full rounded-2xl border-4 border-slate-200 shadow-md">
                            <button onclick="removeCategoryPhotoDay3('gizi')"
                                class="absolute top-2 right-2 w-8 h-8 rounded-full bg-red-500 text-white shadow-lg flex items-center justify-center hover:bg-red-600 transition-all transform hover:scale-105"
                                title="Hapus Foto">
                                <span class="material-symbols-outlined !text-[18px]">delete</span>
                            </button>
                            <p id="status-day3-gizi" class="text-xs mt-2"></p>
                        </div>
                    </div>

                    <!-- Category 3: Aksi Jajanan -->
                    <div class="bg-white rounded-[1.5rem] p-6 shadow-sm border border-slate-100 mb-6">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center">
                                <span class="material-symbols-outlined text-indigo-500 text-xl">shopping_bag</span>
                            </div>
                            <h3 class="text-sm font-black text-slate-700 uppercase tracking-wide">3. Aksi Jajanan
                                (Foto Makanan & Minuman Hasil Belanja Stand Lain)</h3>
                        </div>

                        <input type="file" id="doc-day3-jajan" accept="image/*"
                            onchange="handleCategoryPhotoDay3('jajan', this)" class="hidden">

                        <div id="upload-area-day3-jajan"
                            class="group border-2 border-dashed border-indigo-200 bg-indigo-50/20 hover:bg-indigo-50 rounded-[1.5rem] p-6 text-center cursor-pointer transition-all"
                            onclick="document.getElementById('doc-day3-jajan').click()">
                            <div
                                class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                                <span class="material-symbols-outlined text-indigo-500">add_a_photo</span>
                            </div>
                            <p class="font-black text-indigo-400 text-xs tracking-wider mt-3">PILIH FOTO JAJANAN</p>
                        </div>

                        <div id="preview-area-day3-jajan" class="hidden mt-4 relative group">
                            <img id="preview-day3-jajan" src="" alt="Preview"
                                class="w-full rounded-2xl border-4 border-slate-200 shadow-md">
                            <button onclick="removeCategoryPhotoDay3('jajan')"
                                class="absolute top-2 right-2 w-8 h-8 rounded-full bg-red-500 text-white shadow-lg flex items-center justify-center hover:bg-red-600 transition-all transform hover:scale-105"
                                title="Hapus Foto">
                                <span class="material-symbols-outlined !text-[18px]">delete</span>
                            </button>
                            <p id="status-day3-jajan" class="text-xs mt-2"></p>
                        </div>
                    </div>

                    <!-- Category 4: Suasana Acara -->
                    <div class="bg-white rounded-[1.5rem] p-6 shadow-sm border border-slate-100 mb-6">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center">
                                <span class="material-symbols-outlined text-indigo-500 text-xl">celebration</span>
                            </div>
                            <h3 class="text-sm font-black text-slate-700 uppercase tracking-wide">4. Suasana Puncak
                                Acara (Bazaar/Pameran)</h3>
                        </div>

                        <input type="file" id="doc-day3-acara" accept="image/*"
                            onchange="handleCategoryPhotoDay3('acara', this)" class="hidden">

                        <div id="upload-area-day3-acara"
                            class="group border-2 border-dashed border-indigo-200 bg-indigo-50/20 hover:bg-indigo-50 rounded-[1.5rem] p-6 text-center cursor-pointer transition-all"
                            onclick="document.getElementById('doc-day3-acara').click()">
                            <div
                                class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                                <span class="material-symbols-outlined text-indigo-500">add_a_photo</span>
                            </div>
                            <p class="font-black text-indigo-400 text-xs tracking-wider mt-3">PILIH FOTO SUASANA</p>
                        </div>

                        <div id="preview-area-day3-acara" class="hidden mt-4 relative group">
                            <img id="preview-day3-acara" src="" alt="Preview"
                                class="w-full rounded-2xl border-4 border-slate-200 shadow-md">
                            <button onclick="removeCategoryPhotoDay3('acara')"
                                class="absolute top-2 right-2 w-8 h-8 rounded-full bg-red-500 text-white shadow-lg flex items-center justify-center hover:bg-red-600 transition-all transform hover:scale-105"
                                title="Hapus Foto">
                                <span class="material-symbols-outlined !text-[18px]">delete</span>
                            </button>
                            <p id="status-day3-acara" class="text-xs mt-2"></p>
                        </div>
                    </div>

                    <!-- Category 5: Kenangan Bersama -->
                    <div class="bg-white rounded-[1.5rem] p-6 shadow-sm border border-slate-100 mb-6">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center">
                                <span class="material-symbols-outlined text-indigo-500 text-xl">groups</span>
                            </div>
                            <h3 class="text-sm font-black text-slate-700 uppercase tracking-wide">5. Kenangan
                                Bersama (Siswa, Fasil & Koordinator)</h3>
                        </div>

                        <input type="file" id="doc-day3-bersama" accept="image/*"
                            onchange="handleCategoryPhotoDay3('bersama', this)" class="hidden">

                        <div id="upload-area-day3-bersama"
                            class="group border-2 border-dashed border-indigo-200 bg-indigo-50/20 hover:bg-indigo-50 rounded-[1.5rem] p-6 text-center cursor-pointer transition-all"
                            onclick="document.getElementById('doc-day3-bersama').click()">
                            <div
                                class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                                <span class="material-symbols-outlined text-indigo-500">add_a_photo</span>
                            </div>
                            <p class="font-black text-indigo-400 text-xs tracking-wider mt-3">PILIH FOTO BERSAMA</p>
                        </div>

                        <div id="preview-area-day3-bersama" class="hidden mt-4 relative group">
                            <img id="preview-day3-bersama" src="" alt="Preview"
                                class="w-full rounded-2xl border-4 border-slate-200 shadow-md">
                            <button onclick="removeCategoryPhotoDay3('bersama')"
                                class="absolute top-2 right-2 w-8 h-8 rounded-full bg-red-500 text-white shadow-lg flex items-center justify-center hover:bg-red-600 transition-all transform hover:scale-105"
                                title="Hapus Foto">
                                <span class="material-symbols-outlined !text-[18px]">delete</span>
                            </button>
                            <p id="status-day3-bersama" class="text-xs mt-2"></p>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button id="btnSubmitAllDocsDay3" onclick="submitAllDocumentationDay3()" disabled
                        class="w-full py-4 rounded-2xl bg-indigo-500 text-white font-black shadow-lg disabled:bg-slate-200 disabled:text-slate-400 transition-all active:scale-95">
                        Kirim Semua Dokumentasi Hari 3
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Refleksi (Standard) -->
    <div id="modalRefleksi"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="sticky top-0 bg-white border-b border-slate-100 p-6 rounded-t-[2rem] z-10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="h-12 w-12 rounded-2xl bg-rose-500 flex items-center justify-center">
                            <span class="material-symbols-outlined text-white !text-2xl">self_improvement</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-black text-slate-900">Refleksi Harian</h2>
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-widest">Evaluasi Dirimu
                            </p>
                        </div>
                    </div>
                    <button onclick="closeRefleksiModal()" class="text-slate-400 hover:text-slate-600">
                        <span class="material-symbols-outlined !text-2xl">close</span>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="refleksiForm" class="space-y-4">
                    <!-- Questions will be dynamically loaded or use standard fields -->
                    <div id="refleksi-questions-container" class="space-y-4">
                        <!-- Standard fields for compatibility -->
                        <div class="space-y-2">
                            <label class="text-sm font-bold text-slate-700">Ceritakan pengalamanmu hari ini</label>
                            <textarea name="refleksi_q1" required
                                class="w-full p-4 rounded-xl bg-slate-50 border-none text-sm min-h-[100px]"></textarea>
                        </div>
                        <!-- ... (Simplified for restoration, logic handles the rest) ... -->
                    </div>
                    <button type="button" onclick="submitRefleksi()"
                        class="w-full py-4 rounded-xl bg-rose-500 text-white font-bold shadow-lg shadow-rose-200">Kirim
                        Refleksi</button>
                </form>
            </div>
        </div>
    </div>



    <!-- Modal Refleksi Akhir (The New One) -->
    <div id="modal-refleksi-akhir"
        class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[250] hidden flex items-center justify-center p-4 animate-fade-in">
        <div class="bg-white rounded-[2.5rem] w-full max-w-xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
            <!-- Header -->
            <div class="p-6 border-b flex justify-between items-center bg-white z-10">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-rose-500 text-white flex items-center justify-center shadow-lg shadow-rose-200">
                        <span class="material-symbols-outlined !text-2xl">history_edu</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-black text-slate-800 leading-tight">Refleksi Akhir Projek</h2>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mt-0.5">3 HARI •
                            10
                            PERTANYAAN NARATIF</p>
                    </div>
                </div>
                <button onclick="closeRefleksiAkhirModal()"
                    class="size-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-all">
                    <span class="material-symbols-outlined !text-xl">close</span>
                </button>
            </div>

            <!-- Content -->
            <div class="p-6 space-y-6 overflow-y-auto no-scrollbar flex-1 bg-slate-50/50">
                <form id="refleksiAkhirForm" class="space-y-6">
                    <!-- Q1 -->
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                        <label class="block text-sm font-bold text-slate-800 mb-2">1. Kilas Balik Emosi</label>
                        <p class="text-[11px] text-slate-500 mb-3 leading-relaxed">Apa perasaan pertamamu saat
                            memulai projek ini di Hari 1, dan bagaimana perasaan itu berubah setelah mencapai Hari
                            3?</p>
                        <textarea name="ra_q1" required placeholder="Ceritakan perasaanmu..."
                            class="w-full p-4 rounded-2xl bg-slate-50 border-none text-sm placeholder:text-slate-400 focus:ring-2 focus:ring-rose-500 min-h-[100px]"></textarea>
                    </div>

                    <!-- Q2 -->
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                        <label class="block text-sm font-bold text-slate-800 mb-2">2. Momen "AHA!"</label>
                        <p class="text-[11px] text-slate-500 mb-3 leading-relaxed">Dari semua materi yang
                            dipelajari, hal baru apa yang paling membuatmu terkejut atau mengubah cara pandangmu
                            tentang kewirausahaan?</p>
                        <textarea name="ra_q2" required placeholder="Bagikan momen inspirasimu..."
                            class="w-full p-4 rounded-2xl bg-slate-50 border-none text-sm placeholder:text-slate-400 focus:ring-2 focus:ring-rose-500 min-h-[100px]"></textarea>
                    </div>

                    <!-- Q3 -->
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                        <label class="block text-sm font-bold text-slate-800 mb-2">3. Lembah Tantangan</label>
                        <p class="text-[11px] text-slate-500 mb-3 leading-relaxed">Ceritakan momen paling sulit yang
                            kelompokmu hadapi saat proses pembuatan produk di Hari 2. Bagaimana kalian solusinya?
                        </p>
                        <textarea name="ra_q3" required placeholder="Jelaskan tantangan dan solusinya..."
                            class="w-full p-4 rounded-2xl bg-slate-50 border-none text-sm placeholder:text-slate-400 focus:ring-2 focus:ring-rose-500 min-h-[100px]"></textarea>
                    </div>

                    <!-- Q4 -->
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                        <label class="block text-sm font-bold text-slate-800 mb-2">4. Sang Inspirator</label>
                        <p class="text-[11px] text-slate-500 mb-3 leading-relaxed">Siapa orang (teman/guru/fasil)
                            yang paling memberimu inspirasi selama projek ini, dan apa satu hal darinya yang paling
                            kamu ingat?</p>
                        <textarea name="ra_q4" required placeholder="Tuliskan apresiasimu..."
                            class="w-full p-4 rounded-2xl bg-slate-50 border-none text-sm placeholder:text-slate-400 focus:ring-2 focus:ring-rose-500 min-h-[100px]"></textarea>
                    </div>

                    <!-- Q5 -->
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                        <label class="block text-sm font-bold text-slate-800 mb-2">5. Andai Bisa Mengulang</label>
                        <p class="text-[11px] text-slate-500 mb-3 leading-relaxed">Jika kamu punya "mesin waktu" ke
                            Hari 1, apa satu hal yang ingin kamu lakukan secara berbeda agar hasil projekmu lebih
                            keren?</p>
                        <textarea name="ra_q5" required placeholder="Andai saja..."
                            class="w-full p-4 rounded-2xl bg-slate-50 border-none text-sm placeholder:text-slate-400 focus:ring-2 focus:ring-rose-500 min-h-[100px]"></textarea>
                    </div>

                    <!-- Q6 -->
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                        <label class="block text-sm font-bold text-slate-800 mb-2">6. Panggung Puncak</label>
                        <p class="text-[11px] text-slate-500 mb-3 leading-relaxed">Bagaimana rasanya saat produkmu
                            akhirnya dipamerkan di bazar Hari 3? Apa satu komentar pengunjung yang paling membuatmu
                            bangga?</p>
                        <textarea name="ra_q6" required placeholder="Gambarkan suasana bazar..."
                            class="w-full p-4 rounded-2xl bg-slate-50 border-none text-sm placeholder:text-slate-400 focus:ring-2 focus:ring-rose-500 min-h-[100px]"></textarea>
                    </div>

                    <!-- Q7 -->
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                        <label class="block text-sm font-bold text-slate-800 mb-2">7. Satu Skill Baru</label>
                        <p class="text-[11px] text-slate-500 mb-3 leading-relaxed">Sebutkan satu keahlian (misal:
                            desain, negosiasi, atau masak) yang kamu rasa jauh lebih jago sekarang dibanding sebelum
                            projek dimulai.</p>
                        <textarea name="ra_q7" required placeholder="Apa skill barumu?"
                            class="w-full p-4 rounded-2xl bg-slate-50 border-none text-sm placeholder:text-slate-400 focus:ring-2 focus:ring-rose-500 min-h-[100px]"></textarea>
                    </div>

                    <!-- Q8 -->
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                        <label class="block text-sm font-bold text-slate-800 mb-2">8. Dinamika Tim</label>
                        <p class="text-[11px] text-slate-500 mb-3 leading-relaxed">Apa pelajaran terpenting tentang
                            kerja tim yang kamu dapatkan? Apakah ada konflik yang justru membuat kalian makin
                            kompak?</p>
                        <textarea name="ra_q8" required placeholder="Ceritakan kerja sama timmu..."
                            class="w-full p-4 rounded-2xl bg-slate-50 border-none text-sm placeholder:text-slate-400 focus:ring-2 focus:ring-rose-500 min-h-[100px]"></textarea>
                    </div>

                    <!-- Q9 -->
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                        <label class="block text-sm font-bold text-slate-800 mb-2">9. Nilai Kebanggaan</label>
                        <p class="text-[11px] text-slate-500 mb-3 leading-relaxed">Seberapa bangga kamu dengan hasil
                            akhir projekmu (skala 1-10)? Jelaskan alasan di balik angka tersebut.</p>
                        <div class="flex items-center gap-4 mb-3">
                            <input type="number" name="ra_q9_score" min="1" max="10" step="1" value="10"
                                class="w-24 p-4 rounded-2xl bg-slate-50 border-none text-sm font-black text-rose-500 focus:ring-2 focus:ring-rose-500 text-center">
                            <span class="text-xs font-bold text-slate-400">/ 10 SKALA</span>
                        </div>
                        <textarea name="ra_q9" required placeholder="Jelaskan alasanmu..."
                            class="w-full p-4 rounded-2xl bg-slate-50 border-none text-sm placeholder:text-slate-400 focus:ring-2 focus:ring-rose-500 min-h-[100px]"></textarea>
                    </div>

                    <!-- Q10 -->
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                        <label class="block text-sm font-bold text-slate-800 mb-2">10. Ide Semester Depan</label>
                        <p class="text-[11px] text-slate-500 mb-3 leading-relaxed">Apa ide cemerlangmu untuk tema
                            kegiatan kokurikuler di semester depan? Topik apa yang menurutmu paling asyik untuk
                            dijadikan projek bersama?</p>
                        <textarea name="ra_q10" required placeholder="Tuliskan ide kreatifmu..."
                            class="w-full p-4 rounded-2xl bg-slate-50 border-none text-sm placeholder:text-slate-400 focus:ring-2 focus:ring-rose-500 min-h-[100px]"></textarea>
                    </div>
                </form>
            </div>

            <!-- Footer -->
            <div class="p-6 bg-white border-t border-slate-100 z-10">
                <button id="btnSubmitRefleksiAkhir" onclick="submitRefleksiAkhir()"
                    class="w-full py-4 rounded-2xl bg-rose-500 text-white font-black shadow-lg shadow-rose-200 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <span>Simpan & Kirim Refleksi</span>
                    <span class="material-symbols-outlined text-sm">send</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Cerita Kecilku Hari Ini (REBUILT) -->
    <div id="modalCeritaKecil"
        class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[250] hidden flex items-center justify-center p-4 animate-fade-in">
        <div class="bg-white rounded-[2.5rem] w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
            <!-- Header -->
            <div class="p-6 border-b flex justify-between items-center bg-white z-10">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-indigo-500 text-white flex items-center justify-center shadow-lg shadow-indigo-200">
                        <span class="material-symbols-outlined !text-2xl">auto_stories</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-black text-slate-800 leading-tight">Cerita Kecilku Hari Ini</h2>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mt-0.5">HARI 3 •
                            KENANGAN TERBAIK</p>
                    </div>
                </div>
                <button onclick="closeCeritaKecilModal()"
                    class="size-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-all">
                    <span class="material-symbols-outlined !text-xl">close</span>
                </button>
            </div>

            <!-- Content -->
            <div class="p-6 space-y-6 overflow-y-auto no-scrollbar flex-1 bg-slate-50/50">
                <!-- Photo Area -->
                <div class="group relative">
                    <input type="file" id="inputCeritaPhoto" accept="image/*" onchange="handleCeritaPhoto(this)"
                        class="hidden">

                    <div id="areaUploadCerita" onclick="document.getElementById('inputCeritaPhoto').click()"
                        class="aspect-[4/3] w-full border-2 border-dashed border-indigo-200 bg-indigo-50/30 rounded-3xl flex flex-col items-center justify-center text-center cursor-pointer hover:bg-indigo-50 transition-all group">
                        <div
                            class="size-16 rounded-full bg-white text-indigo-500 flex items-center justify-center mb-3 shadow-md group-hover:scale-110 transition-transform">
                            <span class="material-symbols-outlined text-4xl">add_a_photo</span>
                        </div>
                        <p class="text-xs font-black text-indigo-400 uppercase tracking-widest">Ambil/Pilih Foto
                            Kenangan</p>
                    </div>

                    <div id="areaPreviewCerita" class="hidden relative animate-fade-in">
                        <div class="relative rounded-3xl overflow-hidden border-4 border-white shadow-xl">
                            <img id="previewCeritaImage" src="" alt="Preview" class="w-full h-64 object-cover">
                            <button onclick="resetCeritaPhoto()" id="btnResetCeritaPhoto"
                                class="absolute top-4 right-4 size-10 bg-white/90 backdrop-blur text-red-500 rounded-full flex items-center justify-center shadow-lg hover:bg-red-500 hover:text-white active:scale-90 transition-all">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Story Area -->
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm space-y-3">
                    <label class="block text-[13px] font-black text-slate-700 uppercase tracking-wider">Tulis Cerita
                        Singkatmu</label>
                    <textarea id="textCerita" oninput="updateCeritaCounter()"
                        class="w-full p-4 rounded-2xl bg-slate-50 border-none text-sm placeholder:text-slate-400 focus:ring-2 focus:ring-indigo-500 min-h-[150px]"
                        placeholder="Apa momen paling berkesan hari ini? Tuliskan di sini..."></textarea>
                    <div class="flex justify-between items-center px-1">
                        <div class="flex gap-3 text-[10px] font-black uppercase tracking-widest text-slate-400">
                            <span>Karakter: <span id="charCount">0</span>/50</span>
                            <span>Kata: <span id="wordCount">0</span></span>
                        </div>
                        <p id="charStatus" class="text-[10px] text-red-400 font-bold italic">*Minimal 50 karakter</p>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-6 bg-white border-t border-slate-100 z-10">
                <button id="btnSaveCerita" onclick="submitCeritaKecil()"
                    class="w-full py-4 rounded-2xl bg-indigo-500 text-white font-black shadow-lg shadow-indigo-200 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <span>Simpan Kenangan</span>
                    <span class="material-symbols-outlined text-sm">auto_stories</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Dynamic Content Data -->
    <script src="data/assessment_data.js"></script>
    <script src="data/workshop_content.js"></script>

    <script>
        // Inisialisasi Supabase
        const supabaseUrl = 'https://jnsqqswpkigyzewnbvaf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impuc3Fxc3dwa2lneXpld25idmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NjA3NDIsImV4cCI6MjA4NTIzNjc0Mn0.RrjPnddC55Xv9CLCtG8-1RyDmEkYg_04tHeKqRE7pok';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // Versi Storage untuk pembaruan paksa (Naik ke 2.4 untuk Cerita Kecil)
        const STORAGE_VERSION = '2.4';
        let currentDay = 1;

        // Struktur data progress default (Cleaned up for Day 2 & 3)
        // Day 1: 8 Modul (Pemantik, Materi, Video, LKPD, Asesmen, Dokumentasi, Glosarium, Refleksi)
        // Day 2: 4 Modul (Pemantik, Materi, Analisis Modal/BEP, Dokumentasi)
        // Day 3: 3 Modul (Pemantik, Dokumentasi, Laporan Akhir)
        const defaultProgress = {
            day1: { pemantik: false, materi: false, video: false, lkpd: false, asesmen: false, dokumentasi: false, glosarium: false, refleksi: false },
            day2: { pemantik: false, materi: false, bep: false, dokumentasi: false },
            day3: { pemantik: false, dokumentasi: false, 'laporan-akhir': false, 'refleksi-akhir': false, 'cerita-kecil': false }
        };

        let studentProgress = JSON.parse(JSON.stringify(defaultProgress));

        // State for Day 2 & 3 photos
        window.day2Photos = {
            makanan: null, minuman: null, stand: null, iklan: null, presentasi: null
        };
        window.day3Photos = {
            stand: null, gizi: null, jajan: null, acara: null, bersama: null
        };

        // Load student data
        async function loadStudentData() {
            try {
                // 1. CEK SESSION AUTH (HANYA INI YANG BOLEH REDIRECT KE LOGIN)
                const { data: { session }, error: authError } = await supabaseClient.auth.getSession();

                if (authError || !session) {
                    console.warn('No session found or auth error, redirecting to login.');
                    window.location.href = 'login-siswa.html';
                    return;
                }

                // 2. LOGIKA INTERNAL DASHBOARD (DIBUNGKUS AGAR TIDAK LOOP REDIRECT)
                try {
                    const studentDataStr = localStorage.getItem('student_data');

                    if (studentDataStr && studentDataStr !== "undefined") {
                        const studentData = JSON.parse(studentDataStr);
                        if (studentData) {
                            // Update Header Info (Nama & Kelas)
                            if (document.getElementById('headerStudentName')) document.getElementById('headerStudentName').textContent = studentData.nama || 'Siswa';
                            if (document.getElementById('headerClass')) document.getElementById('headerClass').textContent = studentData.kelas || 'X.1';

                            // Update header photo
                            const photoEl = document.getElementById('studentPhoto');
                            if (photoEl) {
                                if (studentData.photo_url) {
                                    photoEl.style.backgroundImage = `url("${studentData.photo_url}")`;
                                } else {
                                    const photoUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(studentData.nama)}&background=13ec6d&color=fff&size=256`;
                                    photoEl.style.backgroundImage = `url("${photoUrl}")`;
                                }
                            }

                            // --- MAPPING KOORDINATOR & FASILITATOR ---
                            // ... (Mapping data remains same) ...
                            const trialMap = {
                                'X.TRIAL-1': { koord: 'Koordinator Trial A', fasil: 'Fasilitator Trial 1' },
                                'X.TRIAL-2': { koord: 'Koordinator Trial A', fasil: 'Fasilitator Trial 2' },
                                'X.TRIAL-3': { koord: 'Koordinator Trial B', fasil: 'Fasilitator Trial 3' }
                            };

                            const realClassMap = {
                                'X.1': { koord: 'Lucia Erviana, S.Pd., M.Pd.', fasil: 'Sukirno, S.Pd. & Ari Muchtrinai N. N, S.Pd.I.' },
                                'X.2': { koord: 'Lucia Erviana, S.Pd., M.Pd.', fasil: 'Handaroh, S.Pd. & Fantas Jaya A, S.Pd.' },
                                'X.3': { koord: 'Lucia Erviana, S.Pd., M.Pd.', fasil: 'Nelly Kurniasih, S.Pd. & Fika Mega Elita, S.Pd.' },
                                'X.4': { koord: 'Ninda Ningtyas, S.Pd., M.Si.', fasil: 'Siti Anita, S.Pd. & Latifatu Anisa, S. Pd.' },
                                'X.5': { koord: 'Vivi Amelia, S.Pd.', fasil: 'Atik Setianingsih, S.Pd. & Lovelya Valentina, S.Pd.' },
                                'X.6': { koord: 'Vivi Amelia, S.Pd.', fasil: 'Wiwik Eko Prihatin, S.Pd., M.M. & Andi Cahya Sanjaya, S.Pd.' },
                                'X.7': { koord: 'Kustiani, S.Pd.', fasil: 'Azuari Dian Prasasti, S.Pd. & Deni Yunarti, S.Pd.' },
                                'X.8': { koord: 'Aprilyan Dona, S.Pd.', fasil: 'Fajar Abdul Majid, S.Pd & Nora Nurhalita, S.Pd.' },
                                'X.9': { koord: 'Aprilyan Dona, S.Pd.', fasil: 'Andree Prasetyo, S.Pd. & Sindy Dwi Pertiwi, M.Pd.' },
                                'X.10': { koord: 'Ika Setiawati, S.Pd', fasil: 'Indah Sulmayanti, M.Pd. & M. Hafiz Sytar, S.Kom.' },
                                'X.11': { koord: 'Anastasiya Candra M, S.Pd.', fasil: 'Pandu Aditya, M.Pd. & Tiar Hajunilato, M.Pd.' },
                                'XI.1': { koord: 'Dr. Didi Franzhardi, M.Pd.', fasil: 'Try Puri anggraini, S.Pd., M.Pd. & Lia Ningrum, S.Pd.' },
                                'XI.2': { koord: 'Dr. Didi Franzhardi, M.Pd.', fasil: 'Hermanto, S.Pd., M.Pd. & Santi Aryanti, S.Pd.' },
                                'XI.3': { koord: 'Ika Setiawati, S.Pd', fasil: 'Nengsi Juita, M.Pd.Si. & Hedi Prawito, S.Pd.' },
                                'XI.4': { koord: 'Kartika Sari, S.Pd.', fasil: 'Anggun Saymona, S.Pd., M.Pd. & Lia Kurniasari, S.Pd.' },
                                'XI.5': { koord: 'Kartika Sari, S.Pd.', fasil: 'Nyoman Kopariyanto, S.Pd. & Etik Prasetyaningsih, S.Pd.' },
                                'XI.6': { koord: 'Kartika Sari, S.Pd.', fasil: 'Abdul Hafiz, S.Pd. & Suhaib Jawahir, S.Pd.' },
                                'XI.7': { koord: 'Neti Diana, M.Pd.', fasil: 'Singgih Sudarmawan, S.Ag. & Suparmono, S.Ag.' },
                                'XI.8': { koord: 'Neti Diana, M.Pd.', fasil: 'Wely Marisa, S.Pd. & Arif Alimudin Rasyid, S.Pd.' },
                                'XI.9': { koord: 'Neti Diana, M.Pd.', fasil: 'A.Thoriq Ganda, S.Pd. & Rizki Rahmadika, S.Pd.' },
                                'XI.10': { koord: 'Maulidiawati, M.Pd.', fasil: 'Ari Yani A M, S.T. & Adventus, S.Pd.' },
                                'XI.11': { koord: 'Agung Saputra, S.Pd.', fasil: 'Bagus Panca Wiratama, S.Pd., M.Pd. & Samijo, S.Pd.' },
                                'XII.1': { koord: 'Chodman Ariyanto, S.Pd.', fasil: 'Tri Tamti Nugraheni, S.Pd. & Yuni Asrina, S.Pd.' },
                                'XII.2': { koord: 'Chodman Ariyanto, S.Pd.', fasil: 'Titin Sumarni, S.Pd. & Sukirok, S.Pd.' },
                                'XII.3': { koord: 'Chodman Ariyanto, S.Pd.', fasil: 'Nur Azizah, S.Pd.I. & Febrianita Prasasti, S.Pd.' },
                                'XII.4': { koord: 'Taufik Hidayat, S.Pd.', fasil: 'Atik Apriliawati, S.Pd. & Ferdinasari, S.pd.' },
                                'XII.5': { koord: 'Taufik Hidayat, S.Pd.', fasil: 'Nur Rohmad Safarudin, M.Pd. & Fery Ardianto, M.Pd.' },
                                'XII.6': { koord: 'Taufik Hidayat, S.Pd.', fasil: 'Ade Ervani M, S.Sn. & Dra. Hj. Endang Suwartijah' },
                                'XII.7': { koord: 'Mas’ud abid, S.Pd., M.Pd.', fasil: 'Ribuwati, M.Pd. & Nasution, S.Pd.' },
                                'XII.8': { koord: 'Mas’ud abid, S.Pd., M.Pd.', fasil: 'Apriana, S.Pd. & Agung Subaryanto, S.Pd.' },
                                'XII.9': { koord: 'Ade Rohmah Apriani, S.Pd.', fasil: 'Ari Astuti, S.Pd. & Erfizah, S.Pd' },
                                'XII.10': { koord: 'Ade Rohmah Apriani, S.Pd.', fasil: 'Muh. Zuhdi, S.Pd. & Ellys Trisnowati, M.Pd.I.' }
                            };

                            const userClass = studentData.kelas;

                            if (trialMap[userClass]) {
                                if (document.getElementById('headerCoord')) document.getElementById('headerCoord').textContent = trialMap[userClass].koord;
                                if (document.getElementById('headerFasil')) document.getElementById('headerFasil').innerHTML = trialMap[userClass].fasil;
                            } else if (realClassMap[userClass]) {
                                const data = realClassMap[userClass];
                                if (document.getElementById('headerCoord')) document.getElementById('headerCoord').textContent = data.koord;
                                const fasils = data.fasil.split('&').map(s => s.trim());
                                if (fasils.length > 1) {
                                    const html = fasils.map((f, i) => `${i + 1}. ${f}`).join('<br>');
                                    if (document.getElementById('headerFasil')) document.getElementById('headerFasil').innerHTML = html;
                                } else {
                                    if (document.getElementById('headerFasil')) document.getElementById('headerFasil').textContent = fasils[0];
                                }
                            }
                        }
                    }

                    loadProgress();
                    updateDashboardUI();
                    checkAllModulesStatus();

                    // SMART POLLING: Check for updates every 60 seconds (but only if tab is visible)
                    // Optimizes server load by replacing Realtime subscriptions
                    setInterval(() => {
                        if (document.visibilityState === 'visible') {
                            checkAllModulesStatus();
                        }
                    }, 60000);
                } catch (internalError) {
                    console.error('Non-auth error in loadStudentData:', internalError);
                }

            } catch (error) {
                console.error('Critical auth error:', error);
                window.location.href = 'login-siswa.html';
            }
        }

        function loadProgress() {
            const STORAGE_VERSION = '2.4'; // Increment to 2.4 to force refresh for Day 3 Fix (Cerita Kecil & Refleksi Akhir)
            const currentVersion = localStorage.getItem('progress_version');

            // Force reset if version mismatch or corrupted data detected
            if (currentVersion !== STORAGE_VERSION) {
                console.log('Storage version mismatch or first load. Resetting progress...');
                localStorage.removeItem('student_progress');
                localStorage.setItem('progress_version', STORAGE_VERSION);
                studentProgress = JSON.parse(JSON.stringify(defaultProgress));
                calculateGlobalProgress();
                return;
            }

            const savedProgress = localStorage.getItem('student_progress');
            if (savedProgress) {
                try {
                    studentProgress = JSON.parse(savedProgress);

                    // Validate structure - ensure all days exist
                    const requiredDays = ['day1', 'day2', 'day3'];

                    let isCorrupted = false;
                    requiredDays.forEach(day => {
                        if (!studentProgress[day]) {
                            isCorrupted = true;
                        }
                    });

                    // Deep check for missing new keys or extra old keys
                    if (!isCorrupted) {
                        // Check Day 1 (8 modules)
                        if (Object.keys(studentProgress.day1).length !== 8) isCorrupted = true;
                        // Check Day 2 (4 modules)
                        if (Object.keys(studentProgress.day2).length !== 4) isCorrupted = true;
                        // Check Day 3 (5 modules) - updated from 4 to 5
                        if (Object.keys(studentProgress.day3).length !== 5) isCorrupted = true;
                    }

                    if (isCorrupted) {
                        console.warn('Corrupted or outdated progress data detected. Resetting...');
                        studentProgress = JSON.parse(JSON.stringify(defaultProgress));
                        saveProgress();
                        return;
                    }

                    // Sanitize: Migrasi dari 'rangkuman' ke 'dokumentasi' jika ada data lama
                    ['day1', 'day2', 'day3'].forEach(d => {
                        if (studentProgress[d] && studentProgress[d].rangkuman !== undefined) {
                            if (studentProgress[d].dokumentasi === undefined) {
                                studentProgress[d].dokumentasi = studentProgress[d].rangkuman;
                            }
                            delete studentProgress[d].rangkuman;
                        }
                        // Pastikan field dokumentasi ada
                        if (studentProgress[d] && studentProgress[d].dokumentasi === undefined) {
                            studentProgress[d].dokumentasi = false;
                        }
                    });
                } catch (e) {
                    console.error('Error parsing progress:', e);
                    studentProgress = JSON.parse(JSON.stringify(defaultProgress));
                }
            } else {
                studentProgress = JSON.parse(JSON.stringify(defaultProgress));
            }
            calculateGlobalProgress();
        }

        function saveProgress() {
            localStorage.setItem('student_progress', JSON.stringify(studentProgress));
            calculateGlobalProgress();
        }

        // Toggle module completion
        function handleModuleClick(moduleId) {
            // Global Override for Modal-based modules (Active on all days)
            if (moduleId === 'glosarium') {
                openGlosariumModal();
                return;
            }

            // Override untuk Semua Hari (Dinamis dari workshopContent)
            if (moduleId === 'mantik' || moduleId === 'pemantik') {
                openPemantikModal();
                return;
            }
            if (moduleId === 'materi') {
                openMateriModal();
                return;
            }
            if (moduleId === 'dokumentasi') {
                if (currentDay === 2) {
                    openDokumentasiDay2Modal();
                } else if (currentDay === 3) {
                    openDokumentasiDay3Modal();
                } else {
                    openDokumentasiModal();
                }
                return;
            }
            if (moduleId === 'video') {
                openVideoModal();
                return;
            }
            if (moduleId === 'asesmen' || moduleId === 'assessment') {
                openAssessmentModal();
                return;
            }
            if (moduleId === 'lkpd') {
                openLKPDModal();
                return;
            }
            if (moduleId === 'refleksi') {
                openRefleksiModal();
                return;
            }
            if (moduleId === 'bep') {
                openBEPModal();
                return;
            }
            if (moduleId === 'laporan-akhir') {
                if (typeof openLaporanAkhirModal === 'function') {
                    openLaporanAkhirModal();
                } else {
                    console.error('openLaporanAkhirModal not defined');
                }
                return;
            }
            if (moduleId === 'refleksi-akhir') {
                openRefleksiAkhirModal();
                return;
            }
            if (moduleId === 'cerita-kecil' || moduleId === 'cerita') {
                openCeritaKecilModal();
                return;
            }


            const dayKey = `day${currentDay}`;
            // Toggle status
            studentProgress[dayKey][moduleId] = !studentProgress[dayKey][moduleId];
            saveProgress();
            updateModuleUI(moduleId, studentProgress[dayKey][moduleId]);
        }

        // Helper untuk memanggil toggle original dari dalam modal
        function forceCompleteModule(moduleId, score = 0) {
            const dayKey = `day${currentDay}`;
            studentProgress[dayKey][moduleId] = true;
            saveProgress();
            updateModuleUI(moduleId, true, score);
        }

        // Update UI for a single module
        function updateModuleUI(moduleId, status, score = 0) {
            const statusIcon = document.getElementById(`status-${moduleId}`);
            const statusLabel = document.getElementById(`label-${moduleId}`);

            if (!statusIcon || !statusLabel) return;

            if (status === 'submitted') {
                statusIcon.textContent = 'hourglass_top';
                statusIcon.className = 'material-symbols-outlined !text-[14px] text-yellow-500 animate-pulse';
                statusLabel.textContent = 'Menunggu Feedback';
                statusLabel.className = 'text-[11px] font-semibold text-yellow-500';
            } else if (status === true) {
                statusIcon.textContent = 'check_circle';
                statusIcon.className = 'material-symbols-outlined !text-[14px] text-emerald-custom';

                if (score > 0) {
                    const starCount = Math.round(score / 20);
                    const stars = '⭐'.repeat(starCount) || '⭐';
                    statusLabel.textContent = `Selesai ${stars}`;
                } else {
                    statusLabel.textContent = 'Selesai';
                }
                statusLabel.className = 'text-[11px] font-semibold text-emerald-custom';
            } else {
                statusIcon.textContent = 'radio_button_unchecked';
                statusIcon.className = 'material-symbols-outlined !text-[14px] text-slate-400';
                statusLabel.textContent = 'Belum Selesai';
                statusLabel.className = 'text-[11px] font-semibold text-slate-400';
            }
        }

        // Update all modules UI based on current day
        function updateDashboardUI() {
            const dayKey = `day${currentDay}`;
            const currentDayProgress = studentProgress[dayKey];

            Object.keys(currentDayProgress).forEach(moduleId => {
                updateModuleUI(moduleId, currentDayProgress[moduleId]);
            });

            // HIDE modules for Day 2 and Day 3: Video, LKPD, Assessment, Glosarium, Refleksi, Refleksi Akhir
            const modulesToHide = ['module-video', 'module-lkpd', 'module-asesmen', 'module-glosarium', 'module-refleksi', 'module-refleksi-akhir'];

            // Special: Hide Materi for Day 3
            if (currentDay === 3) {
                modulesToHide.push('module-materi');
            }

            modulesToHide.forEach(moduleId => {
                const moduleElement = document.getElementById(moduleId);
                if (moduleElement) {
                    if (currentDay === 2 || currentDay === 3) {
                        moduleElement.style.display = 'none';
                    } else {
                        moduleElement.style.display = '';
                    }
                }
            });

            // BEP Module Visibility (Only Day 2)
            const bepModule = document.getElementById('module-bep');
            if (bepModule) {
                if (currentDay === 2) {
                    bepModule.style.display = '';
                } else {
                    bepModule.style.display = 'none';
                }
            }

            // Laporan Akhir Module Visibility (Only Day 3)
            const lpModule = document.getElementById('module-laporan-akhir');
            if (lpModule) {
                if (currentDay === 3) {
                    lpModule.style.display = '';
                } else {
                    lpModule.style.display = 'none';
                }
            }

            // Refleksi Akhir Module Visibility (Only Day 3)
            const rfModule = document.getElementById('module-refleksi-akhir');
            if (rfModule) {
                if (currentDay === 3) {
                    rfModule.style.display = '';
                } else {
                    rfModule.style.display = 'none';
                }
            }

            // Cerita Kecil Module Visibility (Only Day 3)
            const ckModule = document.getElementById('module-cerita-kecil');
            if (ckModule) {
                if (currentDay === 3) {
                    ckModule.style.display = '';
                } else {
                    ckModule.style.display = 'none';
                }
            }


        }

        // Calculate and update global progress circle
        function calculateGlobalProgress() {
            let totalItems = 0;
            let completedItems = 0;

            // Hitung semua item dari 3 hari
            Object.values(studentProgress).forEach(day => {
                Object.values(day).forEach(status => {
                    totalItems++;
                    if (status) completedItems++;
                });
            });

            const percent = Math.round((completedItems / totalItems) * 100);

            // Update Text
            document.getElementById('progressPercent').textContent = `${percent}%`;

            // Update Circle Gradient
            const degree = Math.round((percent / 100) * 360);
            document.getElementById('progressCircle').style.background = `conic-gradient(#10B981 ${degree}deg, #E2E8F0 0deg)`;

            // Show checkmark if 100%
            const checkmark = document.getElementById('progressCheck');
            if (percent === 100) {
                checkmark.classList.remove('hidden');
            } else {
                checkmark.classList.add('hidden');
            }
        }

        // Switch day tabs
        function switchDay(day) {
            currentDay = day;

            // Handle 'Nilai' Tab
            if (day === 'nilai') {
                document.getElementById('module-grid-container').classList.add('hidden');
                document.getElementById('nilai-report-container').classList.remove('hidden');

                // Update Header Text
                document.getElementById('dashboardTitle').textContent = 'Nilai Kokurikuler';
                document.getElementById('dashboardSubtitle').textContent = 'Pantau hasil penilaian projekmu';

                // Update Tab Styles
                for (let i = 1; i <= 3; i++) {
                    const tab = document.getElementById(`tab-day${i}`);
                    tab.className = 'flex-1 py-3 rounded-xl text-base font-semibold text-slate-500 hover:text-slate-700 transition-all';
                }
                const btnNilai = document.getElementById('tab-nilai');
                btnNilai.className = 'flex-1 py-3 rounded-xl text-base font-semibold bg-white text-emerald-custom shadow-sm transition-all';

                loadFinalGrade();
                return;
            }

            // Handle Regular Days
            document.getElementById('module-grid-container').classList.remove('hidden');
            document.getElementById('nilai-report-container').classList.add('hidden');
            document.getElementById('tab-nilai').className = 'flex-1 py-3 rounded-xl text-base font-semibold text-slate-500 hover:text-slate-700 transition-all';

            // Revert Header Text
            document.getElementById('dashboardTitle').textContent = 'Dasbor Kegiatan';
            document.getElementById('dashboardSubtitle').textContent = 'Selesaikan modul hari ini';

            // Update tab styles
            for (let i = 1; i <= 3; i++) {
                const tab = document.getElementById(`tab-day${i}`);
                if (i === day) {
                    tab.className = 'flex-1 py-3 rounded-xl text-base font-semibold bg-white text-emerald-custom shadow-sm transition-all';
                } else {
                    tab.className = 'flex-1 py-3 rounded-xl text-base font-semibold text-slate-500 hover:text-slate-700 transition-all';
                }
            }

            // CRITICAL FIX: Reset ALL module UI to default state first
            const allModules = ['pemantik', 'materi', 'video', 'lkpd', 'asesmen', 'dokumentasi', 'glosarium', 'refleksi', 'refleksi-akhir', 'cerita-kecil', 'laporan-akhir'];
            allModules.forEach(moduleId => {
                const statusIcon = document.getElementById(`status-${moduleId}`);
                const statusLabel = document.getElementById(`label-${moduleId}`);
                if (statusIcon && statusLabel) {
                    statusIcon.textContent = 'radio_button_unchecked';
                    statusIcon.className = 'material-symbols-outlined !text-[14px] text-slate-400';
                    statusLabel.textContent = 'Belum Selesai';
                    statusLabel.className = 'text-[11px] font-semibold text-slate-400';
                }
            });

            // Update modules display based on new day
            updateDashboardUI();

            // Re-fetch database statuses to ensure sync
            checkAllModulesStatus();
        }

        async function loadFinalGrade() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data, error } = await supabaseClient
                    .from('final_project_grades')
                    .select('*')
                    .eq('student_id', user.id)
                    .single();

                if (error && error.code !== 'PGRST116') throw error; // PGRST116 is no rows found

                const badgeContainer = document.getElementById('final-badge-container');
                const descEl = document.getElementById('final-description');
                const scoreEl = document.getElementById('final-total-score');
                const starContainer = document.getElementById('final-star-display').querySelector('div');

                if (!data || data.status !== 'published') {
                    // Default State: Belum Dinilai (Tampilan Khusus)
                    badgeContainer.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-10 opacity-75">
                            <div class="h-24 w-24 bg-slate-50 rounded-full flex items-center justify-center mb-4 animate-pulse">
                                <span class="material-symbols-outlined text-5xl text-slate-300">hourglass_top</span>
                            </div>
                            <span class="text-sm font-black text-slate-400 uppercase tracking-widest mb-2">MENUNGGU PENILAIAN</span>
                            <span class="text-xs font-medium text-slate-400 max-w-[200px] leading-relaxed">Fasilitator sedang meninjau seluruh aktivitasmu. Harap periksa kembali secara berkala.</span>
                        </div>`;

                    // Sembunyikan elemen nilai yang belum ada
                    if (descEl.parentElement) descEl.parentElement.classList.add('hidden');
                    if (scoreEl.parentElement && scoreEl.parentElement.parentElement) scoreEl.parentElement.parentElement.classList.add('hidden');

                    document.getElementById('final-feedback-section').classList.add('hidden');
                    return;
                }

                // Published State (Tampilkan Kembali elemen yang mungkin disembunyikan)
                // Published State (Tampilkan Kembali elemen yang mungkin disembunyikan)
                if (descEl.parentElement) descEl.parentElement.classList.remove('hidden');
                if (scoreEl.parentElement && scoreEl.parentElement.parentElement) scoreEl.parentElement.parentElement.classList.remove('hidden');

                // Ubah Text Tombol Kembali
                const btnBack = document.getElementById('btn-back-to-task');
                if (btnBack) btnBack.textContent = "Selesai & Kembali ke Materi";

                // Published State
                const category = data.category || 'Belum Valid';
                const totalStars = data.total_stars || 0;

                // Set Badge Style
                let badgeClass = 'bg-slate-100 text-slate-600 border-slate-200';
                if (category === 'Mahir') badgeClass = 'bg-emerald-100 text-emerald-600 border-emerald-200 shadow-emerald-200/50';
                else if (category === 'Berkembang') badgeClass = 'bg-blue-100 text-blue-600 border-blue-200 shadow-blue-200/50';
                else if (category === 'Cakap') badgeClass = 'bg-amber-100 text-amber-600 border-amber-200 shadow-amber-200/50';

                badgeContainer.innerHTML = `
                    <div class="inline-block px-8 py-3 rounded-full border shadow-lg ${badgeClass} animate-bounce">
                        <span class="text-lg font-black uppercase tracking-widest">${category}</span>
                    </div>`;

                // Set Description
                const descriptions = {
                    'Mahir': "Peserta didik sangat kreatif dalam menghasilkan gagasan orisinal dan inovatif pada pengembangan produk jajanan Nusantara yang sehat, bergizi dan kekinian. Mampu merumuskan solusi usaha secara matang serta melakukan perhitungan BEP dengan tepat. Memanfaatkan teknologi digital secara optimal dan komunikatif.",
                    'Berkembang': "Peserta didik menunjukkan kreativitas yang baik dalam mengembangkan produk jajanan Nusantara. Mampu merumuskan solusi usaha sederhana dan perhitungan BEP dengan pendampingan. Komunikasi cukup jelas dan mulai memanfaatkan teknologi digital.",
                    'Cakap': "Peserta didik mulai mampu menunjukkan kreativitas dalam mengolah jajanan Nusantara. Perhitungan BEP dan solusi usaha masih memerlukan bimbingan. Penyampaian informasi sederhana dan memerlukan pendampingan teknologi digital."
                };
                descEl.textContent = descriptions[category] || "Selamat! Anda telah menyelesaikan projek ini.";

                // Set Stars Display
                // Assume totalStars is roughly 0-50 range? Or whatever the total sum is.
                // Wait, I need to know the MAX stars to show relative stars?
                // Visual stars here purely decorative or scaled?
                // Let's just show 5 big stars filled if Mahir, 4 if Berkembang, 3 if Cakap
                let visualStars = 0;
                if (category === 'Mahir') visualStars = 5;
                else if (category === 'Berkembang') visualStars = 4;
                else if (category === 'Cakap') visualStars = 3;

                let starsHtml = '';
                for (let i = 1; i <= 5; i++) {
                    const color = i <= visualStars ? 'text-amber-400 drop-shadow-sm' : 'text-slate-200';
                    starsHtml += `<span class="material-symbols-outlined ${color}" style="font-variation-settings: 'FILL' 1">star</span>`;
                }
                starContainer.innerHTML = starsHtml;
                scoreEl.innerHTML = `<span class="text-slate-800">${totalStars}</span> <span class="text-slate-400 font-medium">Total Bintang</span>`;

                // Feedback
                if (data.facilitator_feedback) {
                    document.getElementById('final-feedback-section').classList.remove('hidden');
                    document.getElementById('final-feedback-text').textContent = data.facilitator_feedback;
                }

            } catch (err) {
                console.error('Final Grade error:', err);
            }
        }

        // SINKRONISASI GLOBAL SEMUA MODUL
        async function checkAllModulesStatus() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                // Ambil semua respon (SEMUA HARI) dalam satu query
                const { data: responses, error } = await supabaseClient
                    .from('module_responses')
                    .select('module_type, day_id, status, score')
                    .eq('student_id', user.id);

                if (error) throw error;

                // Reset UI dulu ke progress local (hanya untuk hari ini)
                updateDashboardUI();

                const dbModulesMap = {
                    day1: new Set(),
                    day2: new Set(),
                    day3: new Set()
                };

                if (responses && responses.length > 0) {
                    responses.forEach(r => {
                        const rDay = r.day_id;
                        const dayKey = `day${rDay}`;

                        // Skip invalid days
                        if (!studentProgress[dayKey]) return;

                        // Mapping Database Type to UI ID
                        let moduleId = r.module_type;
                        if (moduleId === 'kategori') moduleId = 'dokumentasi';
                        if (moduleId === 'laporan_akhir') moduleId = 'laporan-akhir';
                        if (moduleId === 'refleksi_akhir') moduleId = 'refleksi-akhir';
                        if (moduleId === 'cerita_kecil') moduleId = 'cerita-kecil';
                        if (moduleId === 'summary') moduleId = 'materi';
                        if (moduleId === 'bep_analisis') moduleId = 'bep';
                        if (moduleId === 'kuis') moduleId = 'asesmen';

                        // Track what exists in DB
                        if (dbModulesMap[dayKey]) {
                            dbModulesMap[dayKey].add(moduleId);
                        }

                        // 1. Handle Submitted (Menunggu Feedback) - Hanya update UI jika di hari yg sama
                        if (r.status === 'submitted') {
                            if (rDay == currentDay) {
                                const icon = document.getElementById(`status-${moduleId}`);
                                const label = document.getElementById(`label-${moduleId}`);
                                if (icon && label) {
                                    icon.textContent = 'hourglass_top';
                                    icon.className = 'material-symbols-outlined !text-[14px] text-yellow-500 animate-pulse';
                                    label.textContent = 'Menunggu Feedback';
                                    label.className = 'text-[11px] font-semibold text-yellow-500';
                                }
                            }
                        }
                        // 2. Handle Reviewed (Selesai & Dinilai)
                        else if (r.status === 'reviewed') {
                            // Update progress data untuk hari tersebut
                            studentProgress[dayKey][moduleId] = true;

                            // Jika ini hari yang sedang aktif, update UI secara visual
                            if (rDay == currentDay) {
                                forceCompleteModule(moduleId, r.score);
                            }
                        }
                    });
                }

                // Check for deleted modules (Sync Delete)
                // Iterate over ALL days and ALL modules
                const allModules = ['pemantik', 'materi', 'video', 'lkpd', 'asesmen', 'bep', 'dokumentasi', 'glosarium', 'refleksi', 'laporan-akhir', 'refleksi-akhir', 'cerita-kecil'];

                ['day1', 'day2', 'day3'].forEach(dKey => {
                    if (!studentProgress[dKey]) return;

                    allModules.forEach(moduleId => {
                        // Skip modules that don't belong to this day (optional optimization, but safe to check)
                        if (studentProgress[dKey][moduleId] === undefined) return;

                        // FALLBACK FOR ASSESSMENT: If missing from DB but has local score, keep it (only for current day check usually, but keeping safe)
                        if (moduleId === 'asesmen' && !dbModulesMap[dKey].has(moduleId)) {
                            const savedScore = localStorage.getItem(`asesmen_${dKey}_score`);
                            if (savedScore) {
                                // If we have a local score, assume it's valid for now to prevent data loss on erratic connections
                                studentProgress[dKey][moduleId] = true;
                                return;
                            }
                        }

                        // If localStorage has this as completed but database doesn't have it, reset to false
                        // Exception: 'asesmen' is handled above
                        if (studentProgress[dKey][moduleId] === true && !dbModulesMap[dKey].has(moduleId)) {
                            // console.log(`🔄 Syncing: ${moduleId} in ${dKey} was deleted/missing in DB, resetting.`);
                            studentProgress[dKey][moduleId] = false;

                            // Only update UI if it's the current day
                            if (dKey == `day${currentDay}`) {
                                updateModuleUI(moduleId, false);
                            }
                        }
                    });
                });

                // Save synced progress & Recalculate
                saveProgress();
                calculateGlobalProgress();

            } catch (err) {
                console.error("Error checkAllModulesStatus:", err);
            }
        }

        // Logout function
        async function logout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                // Redirect to index.html (Beranda)
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error logging out:', error.message);
                alert('Gagal keluar. Silakan coba lagi.');
            }
        }

        // Load data on page load
        window.addEventListener('load', loadStudentData);

        // ==========================================
        // FITUR PERTANYAAN PEMANTIK
        // ==========================================

        // Buka Modal Pemantik
        function openPemantikModal() {
            const modal = document.getElementById('modalPemantik');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Render Questions based on workshopContent
            const dayKey = `day${currentDay}`;
            const questions = workshopContent[dayKey]?.pemantik || [];
            const container = document.getElementById('pemantikQuestionsContainer');

            if (container) {
                container.innerHTML = questions.map((q, idx) => `
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-700 block leading-relaxed">
                            ${q}
                        </label>
                        <textarea id="tanya${idx + 1}" rows="3"
                            class="w-full text-xs p-3 rounded-xl border border-slate-200 focus:border-emerald-500 focus:ring-emerald-500 bg-slate-50 focus:bg-white transition-all placeholder:text-slate-300"
                            placeholder="Tulis jawabanmu disini..."></textarea>
                    </div>
                `).join('');
            }

            // Update Header Subtitle
            const titles = {
                1: 'Hari 1 • Cita Rasa Jajanan Nusantara',
                2: 'Hari 2 • Rencana Usaha & Inovasi',
                3: 'Hari 3 • Evaluasi & Refleksi'
            };
            const subtitleEl = modal.querySelector('p.text-xs.text-slate-500');
            if (subtitleEl) subtitleEl.textContent = titles[currentDay] || `Hari ${currentDay}`;

            // Cek apakah sudah ada jawaban
            checkExistingPemantik();
        }

        // Tutup Modal
        function closePemantikModal() {
            const modal = document.getElementById('modalPemantik');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function checkExistingPemantik() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return; // Silent return

                const { data, error } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'pemantik')
                    .maybeSingle();

                if (data && data.answers) {
                    const answers = data.answers;
                    answers.forEach((ans, idx) => {
                        const el = document.getElementById(`tanya${idx + 1}`);
                        if (el) {
                            el.value = ans;
                            el.disabled = true;
                            el.classList.add('bg-slate-100', 'text-slate-500');
                        }
                    });

                    const btn = document.getElementById('btnSubmitPemantik');
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = `<span class="material-symbols-outlined text-sm">check_circle</span> Terkirim`;
                        btn.classList.add('bg-slate-200', 'text-slate-500', 'shadow-none');
                        btn.classList.remove('bg-sky-500', 'text-white', 'shadow-lg', 'shadow-sky-200');
                    }
                    updateModuleUI('pemantik', true);
                }
            } catch (err) {
                console.error("Error checkExistingPemantik:", err);
            }
        }

        async function submitPemantik() {
            const btn = document.getElementById('btnSubmitPemantik');
            const dayKey = `day${currentDay}`;
            const questions = workshopContent[dayKey]?.pemantik || [];
            const answers = [];
            let allFilled = true;

            questions.forEach((_, idx) => {
                const el = document.getElementById(`tanya${idx + 1}`);
                if (!el || !el.value.trim()) {
                    allFilled = false;
                } else {
                    answers.push(el.value.trim());
                }
            });

            if (!allFilled) {
                alert('Mohon jawab semua pertanyaan pemantik sebelum mengirim.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'Mengirim...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error("Sesi habis, silakan login ulang.");

                const { error } = await supabaseClient
                    .from('module_responses')
                    .insert({
                        student_id: user.id,
                        day_id: currentDay,
                        module_type: 'pemantik',
                        answers: answers,
                        status: 'submitted'
                    });

                if (error) throw error;

                alert('Jawaban berhasil dikirim!');
                studentProgress[`day${currentDay}`]['pemantik'] = true;
                saveProgress();
                updateModuleUI('pemantik', true);
                closePemantikModal();
                checkExistingPemantik(); // Refresh UI state

            } catch (err) {
                console.error(err);
                alert('Gagal mengirim: ' + err.message);
                btn.disabled = false;
                btn.innerHTML = 'Kirim Jawaban';
            }
        }


        // ==========================================
        // FITUR MATERI BELAJAR (SLIDE)
        // ==========================================

        let currentMateriSlide = 0;
        let totalMateriSlides = 0; // Will be set dynamically

        function openMateriModal() {
            currentMateriSlide = 0;
            const dayKey = `day${currentDay}`;
            const materiItems = workshopContent[dayKey]?.materi || [];
            totalMateriSlides = materiItems.length;

            // Render Slides
            const container = document.getElementById('materiDynamicSlides');
            if (container) {
                container.innerHTML = materiItems.map((html, idx) => `
                    <div id="slide-materi-${idx}" class="${idx === 0 ? '' : 'hidden'} animate-slide-up">
                        ${html}
                    </div>
                `).join('');
            }

            // Render Navigation Pills
            const pillContainer = document.getElementById('materiDynamicPills');
            if (pillContainer) {
                pillContainer.innerHTML = materiItems.map((_, idx) => `
                    <button id="nav-pill-${idx}" onclick="goToSlide(${idx})"
                        class="size-7 rounded-lg ${idx === 0 ? 'bg-emerald-500 text-white shadow-md shadow-emerald-200' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'} text-[9px] font-bold flex items-center justify-center transition-all shrink-0">
                        ${idx + 1}
                    </button>
                `).join('');
            }


            // Cek status materi/summary
            checkExistingMateri();

            document.getElementById('modalMateri').classList.remove('hidden');
            document.getElementById('modalMateri').classList.add('flex');

            // Update Title
            const titleEl = document.querySelector('#modalMateri h3');
            if (titleEl) titleEl.textContent = `Materi Hari ${currentDay}`;

            updateMateriSlideUI();
            checkExistingMateri();
        }

        function closeMateriModal() {
            document.getElementById('modalMateri').classList.add('hidden');
            document.getElementById('modalMateri').classList.remove('flex');
        }

        function nextMateriSlide() {
            if (currentMateriSlide < totalMateriSlides - 1) {
                currentMateriSlide++;
                updateMateriSlideUI();
                // Scroll content ke atas setiap ganti slide
                document.getElementById('materiContentArea').scrollTop = 0;
            }
        }

        function prevMateriSlide() {
            if (currentMateriSlide > 0) {
                currentMateriSlide--;
                updateMateriSlideUI();
                document.getElementById('materiContentArea').scrollTop = 0;
            }
        }

        function goToSlide(n) {
            if (n >= 0 && n < totalMateriSlides) {
                currentMateriSlide = n;
                updateMateriSlideUI();
                document.getElementById('materiContentArea').scrollTop = 0;
            }
        }

        function updateMateriSlideUI() {
            // Hide semua slide
            for (let i = 0; i < totalMateriSlides; i++) {
                const s = document.getElementById(`slide-materi-${i}`);
                if (s) s.classList.add('hidden');
            }
            // Tampilkan slide aktif
            document.getElementById(`slide-materi-${currentMateriSlide}`).classList.remove('hidden');

            // Update Navigation Pills
            for (let i = 0; i < totalMateriSlides; i++) {
                const pill = document.getElementById(`nav-pill-${i}`);
                if (pill) {
                    if (i === currentMateriSlide) {
                        pill.className = "size-7 rounded-lg bg-emerald-500 text-white text-[9px] font-bold flex items-center justify-center shadow-md shadow-emerald-200 transition-all";
                    } else {
                        pill.className = "size-7 rounded-lg bg-slate-50 text-slate-400 text-[9px] font-bold flex items-center justify-center hover:bg-slate-100 transition-all";
                    }
                }
            }

            // Update Progress Bar
            const progress = ((currentMateriSlide + 1) / totalMateriSlides) * 100;
            document.getElementById('materiProgressBar').style.width = `${progress}%`;
            document.getElementById('materiStepText').textContent = `Halaman ${currentMateriSlide + 1} dari ${totalMateriSlides}`;

            // Update Tombol
            const btnPrev = document.getElementById('btnPrevMateri');
            const btnNext = document.getElementById('btnNextMateri');
            const btnFinish = document.getElementById('btnFinishMateri');

            // Tombol Kembali
            if (currentMateriSlide === 0) {
                btnPrev.classList.add('invisible');
            } else {
                btnPrev.classList.remove('invisible');
            }

            // Tombol Lanjut vs Selesai
            if (currentMateriSlide === totalMateriSlides - 1) {
                btnNext.classList.add('hidden');
                btnFinish.classList.remove('hidden');
                updateWordCount(); // Sync button state on show
            } else {
                btnNext.classList.remove('hidden');
                btnFinish.classList.add('hidden');
            }
        }

        function settleMateri() {
            // Check word count first if it's the last slide
            if (currentMateriSlide === totalMateriSlides - 1) {
                submitMateriSummary();
                return;
            }
            // Fallback for older logic if needed
            forceCompleteModule('materi');
            alert('Selamat! Kamu telah menyelesaikan materi hari ini.');
            closeMateriModal();
        }

        function updateWordCount() {
            const textarea = document.getElementById('summaryArea');
            const counter = document.getElementById('wordCounter');
            const text = textarea.value.trim();
            const words = text ? text.split(/\s+/).length : 0;
            const minWords = parseInt(textarea.getAttribute('data-min-words')) || 200;

            counter.textContent = `${words} / ${minWords} kata`;

            const btn = document.getElementById('btnFinishMateri');
            if (textarea.disabled) {
                // Jangan utak-atik tombol jika sudah dikunci (submitted/reviewed)
                btn.classList.add('hidden');
                return;
            }

            if (words >= minWords) {
                counter.className = "text-[10px] font-bold text-emerald-500";
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                counter.className = "text-[10px] font-bold text-slate-400";
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        async function submitMateriSummary() {
            const btn = document.getElementById('btnFinishMateri');
            const summaryArea = document.getElementById('summaryArea');
            const summary = summaryArea.value.trim();
            const minWords = parseInt(summaryArea.getAttribute('data-min-words')) || 200;

            if (summary.split(/\s+/).length < minWords) {
                alert(`Pesan: Ringkasan minimal harus ${minWords} kata.`);
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'Mengirim...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error('Silakan login ulang.');

                // Gunakan user.id (Auth UID) secara konsisten
                const { error } = await supabaseClient
                    .from('module_responses')
                    .insert({
                        student_id: user.id,
                        day_id: currentDay,
                        module_type: 'materi',
                        answers: [summary],
                        status: 'submitted'
                    });

                if (error) throw error;

                alert('Pesan: Ringkasan berhasil dikirim! Silakan tunggu review dari Fasilitator.');
                // SINKRONKAN status lokal (tetap false agar show hourglass)
                studentProgress[`day${currentDay}`]['materi'] = false;
                saveProgress();
                closeMateriModal();
                checkAllModulesStatus();
                checkExistingMateri();

            } catch (e) {
                console.error(e);
                alert('Gagal mengirim: ' + e.message);
                btn.disabled = false;
                btn.innerHTML = 'Selesaikan Materi';
            }
        }

        async function checkExistingMateri() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data: responses } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id) // Konsisten pakai user.id
                    .eq('day_id', currentDay) // Dinamis sesuai hari aktif
                    .eq('module_type', 'materi')
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (responses && responses.length > 0) {
                    const r = responses[0];
                    // SINKRONKAN ke local progress bar
                    if (r.status === 'reviewed') {
                        forceCompleteModule('materi', r.score);
                    }

                    const area = document.getElementById('summaryArea');
                    const msg = document.getElementById('materiStatusMsg');
                    if (area) {
                        area.value = r.answers[0] || '';
                        if (r.status === 'submitted' || r.status === 'reviewed') {
                            area.disabled = true;
                            area.classList.add('bg-slate-100', 'text-slate-500');
                        }
                        updateWordCount(); // Sync tombol & counter berdasarkan isi
                    }

                    if (msg) {
                        msg.classList.remove('hidden');
                        const btn = document.getElementById('btnFinishMateri');
                        if (r.status === 'submitted') {
                            msg.className = "mb-4 p-4 rounded-3xl text-[11px] font-bold border border-amber-100 bg-amber-50 text-amber-700 animate-pulse";
                            msg.innerHTML = `⏳ Ringkasanmu sedang menunggu review Fasilitator.`;
                            if (btn) btn.classList.add('hidden');
                            updateModuleUI('materi', 'submitted');
                        } else if (r.status === 'reviewed') {
                            msg.className = "mb-4 p-4 rounded-3xl text-[11px] font-bold border border-emerald-100 bg-emerald-50 text-emerald-700";
                            msg.innerHTML = `✅ Dinilai: ${r.score}/100<br><span class="font-normal text-[10px] mt-1 block">"${r.feedback || 'Bagus sekali!'}"</span>`;
                            if (btn) btn.classList.add('hidden');
                            updateModuleUI('materi', true, r.score || 0);
                        }
                    }
                } else {
                    // Jika tidak ada data, pastikan textarea aktif
                    // const btn = document.getElementById('btnFinishMateri'); // Let updateMateriSlideUI handle visibility
                    const area = document.getElementById('summaryArea');
                    // if (btn) btn.classList.remove('hidden'); // REMOVED: Causing button to show on slide 1
                    if (area) {
                        area.disabled = false;
                        area.classList.remove('bg-slate-100', 'text-slate-500');
                    }
                }
            } catch (e) { console.error('Error checkExistingMateri:', e); }
        }


        // ==========================================
        // FITUR VIDEO PEMBELAJARAN
        // ==========================================

        // Video data per day
        const videoContentByDay = {
            1: [
                {
                    title: "Video 1: Pengenalan Jajanan Nusantara",
                    url: "https://www.youtube.com/embed/dQw4w9WgXcQ", // Placeholder - ganti dengan video asli
                    duration: "10 menit"
                },
                {
                    title: "Video 2: Nilai Gizi dalam Jajanan",
                    url: "https://www.youtube.com/embed/dQw4w9WgXcQ", // Placeholder - ganti dengan video asli
                    duration: "12 menit"
                },
                {
                    title: "Video 3: Kreativitas dalam Bisnis Jajanan",
                    url: "https://www.youtube.com/embed/dQw4w9WgXcQ", // Placeholder - ganti dengan video asli
                    duration: "15 menit"
                }
            ],
            2: [
                {
                    title: "Video Pembelajaran Hari 2",
                    url: "https://www.youtube.com/embed/T2q2ZOsjkIs",
                    duration: "Durasi video"
                }
            ],
            3: [
                // Placeholder untuk Hari 3
            ]
        };

        // ==========================================
        // ==========================================

        function switchAnalisisTab(tab) {
            const btnLaporan = document.getElementById('tab-analisis-laporan');
            const btnSimulasi = document.getElementById('tab-analisis-simulasi');
            const contentLaporan = document.getElementById('content-analisis-laporan');
            const contentSimulasi = document.getElementById('content-analisis-simulasi');

            if (tab === 'laporan') {
                btnLaporan.className = "flex-1 py-3 rounded-xl text-xs font-bold bg-white text-pink-600 shadow-sm border border-slate-100 transition-all";
                btnSimulasi.className = "flex-1 py-3 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-100 transition-all";
                contentLaporan.classList.remove('hidden');
                contentSimulasi.classList.add('hidden');
            } else {
                btnLaporan.className = "flex-1 py-3 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-100 transition-all";
                btnSimulasi.className = "flex-1 py-3 rounded-xl text-xs font-bold bg-white text-pink-600 shadow-sm border border-slate-100 transition-all";
                contentLaporan.classList.add('hidden');
                contentSimulasi.classList.remove('hidden');
            }
        }

        function addIngredientRow(name = '', cost = '') {
            const table = document.getElementById('ingredients-table-body');
            const row = document.createElement('tr');
            row.className = "border-b border-slate-50";
            const formattedCost = cost ? parseInt(cost).toLocaleString('id-ID') : '';
            row.innerHTML = `<td class="py-2 pl-1"><input type="text" placeholder="Item..." value="${name}" class="w-full text-[10px] font-medium text-slate-700 outline-none bg-transparent"></td><td class="py-2"><input type="text" placeholder="0" value="${formattedCost}" oninput="formatInputWithDots(this); calculateAnalisisTotal()" class="ingredient-cost w-full text-[10px] font-bold text-right outline-none bg-transparent" style="direction: ltr;"></td><td class="py-2 text-right"><button onclick="this.closest('tr').remove(); calculateAnalisisTotal();" class="text-slate-300 hover:text-red-500"><span class="material-symbols-outlined !text-sm">close</span></button></td>`;
            if (table) table.appendChild(row);
        }

        function addStandRow(name = '', cost = '') {
            const table = document.getElementById('stand-table-body');
            const row = document.createElement('tr');
            row.className = "border-b border-slate-50";
            const formattedCost = cost ? parseInt(cost).toLocaleString('id-ID') : '';
            row.innerHTML = `<td class="py-2 pl-1"><input type="text" placeholder="Item..." value="${name}" class="w-full text-[10px] font-medium text-slate-700 outline-none bg-transparent"></td><td class="py-2"><input type="text" placeholder="0" value="${formattedCost}" oninput="formatInputWithDots(this); calculateAnalisisTotal()" class="stand-cost w-full text-[10px] font-bold text-right outline-none bg-transparent" style="direction: ltr;"></td><td class="py-2 text-right"><button onclick="this.closest('tr').remove(); calculateAnalisisTotal();" class="text-slate-300 hover:text-red-500"><span class="material-symbols-outlined !text-sm">close</span></button></td>`;
            if (table) table.appendChild(row);
        }

        function addDrinkRow(name = '', cost = '') {
            const table = document.getElementById('drinks-table-body');
            const row = document.createElement('tr');
            row.className = "border-b border-slate-50";
            const formattedCost = cost ? parseInt(cost).toLocaleString('id-ID') : '';
            row.innerHTML = `<td class="py-2 pl-1"><input type="text" placeholder="Item..." value="${name}" class="w-full text-[10px] font-medium text-slate-700 outline-none bg-transparent"></td><td class="py-2"><input type="text" placeholder="0" value="${formattedCost}" oninput="formatInputWithDots(this); calculateAnalisisTotal()" class="drink-cost w-full text-[10px] font-bold text-right outline-none bg-transparent" style="direction: ltr;"></td><td class="py-2 text-right"><button onclick="this.closest('tr').remove(); calculateAnalisisTotal();" class="text-slate-300 hover:text-red-500"><span class="material-symbols-outlined !text-sm">close</span></button></td>`;
            if (table) table.appendChild(row);
        }

        function calculatePO() {
            const qtyMakan = parseFormattedNumber(document.getElementById('input-po-makanan-qty').value);
            const hrgMakan = parseFormattedNumber(document.getElementById('input-po-makanan-harga').value);
            const qtyMinum = parseFormattedNumber(document.getElementById('input-po-minuman-qty').value);
            const hrgMinum = parseFormattedNumber(document.getElementById('input-po-minuman-harga').value);

            const totalQty = qtyMakan + qtyMinum;
            const totalRp = (qtyMakan * hrgMakan) + (qtyMinum * hrgMinum);

            const dispQty = document.getElementById('display-total-po-qty');
            const dispRp = document.getElementById('display-total-po-rp');

            if (dispQty) dispQty.textContent = `${totalQty.toLocaleString('id-ID')} Item`;
            if (dispRp) dispRp.textContent = `Rp ${totalRp.toLocaleString('id-ID')}`;
        }

        function calculateAnalisisTotal() {
            let totalHpp = 0, totalDrinks = 0, totalStand = 0;
            document.querySelectorAll('.ingredient-cost').forEach(i => totalHpp += parseFormattedNumber(i.value));
            document.querySelectorAll('.drink-cost').forEach(i => totalDrinks += parseFormattedNumber(i.value));
            document.querySelectorAll('.stand-cost').forEach(i => totalStand += parseFormattedNumber(i.value));

            const hppDisp = document.getElementById('total-hpp-display');
            const drkDisp = document.getElementById('total-drinks-display');
            const stDisp = document.getElementById('total-stand-display');

            if (hppDisp) hppDisp.textContent = 'Rp ' + totalHpp.toLocaleString('id-ID');
            if (drkDisp) drkDisp.textContent = 'Rp ' + totalDrinks.toLocaleString('id-ID');
            if (stDisp) stDisp.textContent = 'Rp ' + totalStand.toLocaleString('id-ID');

            const targetMakanan = parseFormattedNumber(document.getElementById('input-target-makanan').value);
            const targetMinuman = parseFormattedNumber(document.getElementById('input-target-minuman').value);
            const hargaMakanan = parseFormattedNumber(document.getElementById('input-harga-makanan').value);
            const hargaMinuman = parseFormattedNumber(document.getElementById('input-harga-minuman').value);

            const standShare = totalStand / 2;
            const margin = 0.4;

            const hppMakPerUnit = targetMakanan > 0 ? ((totalHpp + standShare) / targetMakanan) : 0;
            const rekMak = hppMakPerUnit > 0 ? (Math.ceil((hppMakPerUnit * (1 + margin)) / 100) * 100) : 0;
            const rekMakEl = document.getElementById('rek-harga-makanan');
            if (rekMakEl) rekMakEl.textContent = rekMak > 0 ? 'Rp ' + rekMak.toLocaleString('id-ID') : '-';

            const totalModal = totalHpp + totalDrinks + totalStand;
            const avgPrice = (targetMakanan > 0 || targetMinuman > 0) ? (((targetMakanan * hargaMakanan) + (targetMinuman * hargaMinuman)) / ((targetMakanan + targetMinuman) || 1)) : 0;

            const bepRupiah = totalModal;
            const bepUnit = avgPrice > 0 ? Math.ceil(totalModal / avgPrice) : 0;

            const bepMakEl = document.getElementById('bep-makanan'); // Reuse as total units
            if (bepMakEl) bepMakEl.textContent = bepUnit + ' Unit';

            const bepMinEl = document.getElementById('bep-minuman'); // Reuse as total rupiah
            if (bepMinEl) bepMinEl.textContent = 'Rp ' + bepRupiah.toLocaleString('id-ID');

            const infoBox = document.getElementById('bep-info-box');
            if (infoBox) {
                if (targetMakanan > 0 || targetMinuman > 0) infoBox.classList.remove('hidden');
                else infoBox.classList.add('hidden');
            }
        }

        async function submitAnalisisProduk() {
            const btn = document.getElementById('btnSubmitAnalisis');
            const namaProduk = document.getElementById('input-nama-produk').value;
            if (!namaProduk.trim()) { alert('Mohon isi Nama Produk.'); return; }

            const ingredients = [], drinks = [], standItems = [];
            document.querySelectorAll('#ingredients-table-body tr').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value.trim()) ingredients.push({ item: inputs[0].value, cost: parseFormattedNumber(inputs[1].value) });
            });
            document.querySelectorAll('#drinks-table-body tr').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value.trim()) drinks.push({ item: inputs[0].value, cost: parseFormattedNumber(inputs[1].value) });
            });
            document.querySelectorAll('#stand-table-body tr').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value.trim()) standItems.push({ item: inputs[0].value, cost: parseFormattedNumber(inputs[1].value) });
            });

            const submissionData = {
                nama_produk: namaProduk,
                nama_minuman: document.getElementById('input-nama-minuman').value,
                ingredients, drinks, stand_items: standItems,
                target_makanan: parseFormattedNumber(document.getElementById('input-target-makanan').value),
                target_minuman: parseFormattedNumber(document.getElementById('input-target-minuman').value),
                harga_makanan: parseFormattedNumber(document.getElementById('input-harga-makanan').value),
                harga_minuman: parseFormattedNumber(document.getElementById('input-harga-minuman').value),
                total_hpp_makanan: ingredients.reduce((sum, item) => sum + item.cost, 0),
                total_hpp_minuman: drinks.reduce((sum, item) => sum + item.cost, 0),
                total_hpp_stand: standItems.reduce((sum, item) => sum + item.cost, 0),
                total_modal: (ingredients.reduce((sum, item) => sum + item.cost, 0) + drinks.reduce((sum, item) => sum + item.cost, 0) + standItems.reduce((sum, item) => sum + item.cost, 0)),
                // PO Data
                po_makanan_qty: parseFormattedNumber(document.getElementById('input-po-makanan-qty').value),
                po_makanan_harga: parseFormattedNumber(document.getElementById('input-po-makanan-harga').value),
                po_minuman_qty: parseFormattedNumber(document.getElementById('input-po-minuman-qty').value),
                po_minuman_harga: parseFormattedNumber(document.getElementById('input-po-minuman-harga').value),
                po_total_qty: parseFormattedNumber(document.getElementById('input-po-makanan-qty').value) + parseFormattedNumber(document.getElementById('input-po-minuman-qty').value),
                po_total_rp: (parseFormattedNumber(document.getElementById('input-po-makanan-qty').value) * parseFormattedNumber(document.getElementById('input-po-makanan-harga').value)) + (parseFormattedNumber(document.getElementById('input-po-minuman-qty').value) * parseFormattedNumber(document.getElementById('input-po-minuman-harga').value))
            };

            btn.disabled = true; btn.innerHTML = 'Mengirim...';
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error("Sesi habis");
                const { error } = await supabaseClient
                    .from('module_responses')
                    .upsert({
                        student_id: user.id,
                        day_id: currentDay,
                        module_type: 'bep_analisis',
                        answers: [JSON.stringify(submissionData)],
                        status: 'submitted'
                    }, {
                        onConflict: 'student_id,day_id,module_type'
                    });
                if (error) throw error;
                alert('Laporan Analisis Produk berhasil dikirim!');
                closeBEPModal();
                studentProgress[`day${currentDay}`]['bep'] = false;
                saveProgress();
                checkExistingAnalisis();
            } catch (err) { alert('Gagal mengirim laporan: ' + err.message); } finally { btn.disabled = false; btn.innerHTML = 'Kirim Laporan'; }
        }


        function openBEPModal() {
            const modal = document.getElementById('modalBEP');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                checkExistingAnalisis();
            }
        }

        function closeBEPModal() {
            const modal = document.getElementById('modalBEP');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        // --- LAPORAN AKHIR LOGIC ---
        function openLaporanAkhirModal() {
            console.log("Opening Laporan Akhir Modal... (Nuclear Fix)");
            const modal = document.getElementById('modalLaporanAkhir');
            if (modal) {
                // 1. Move to body to avoid hidden parents
                if (modal.parentNode !== document.body) {
                    console.log("Moving modal to body...");
                    document.body.appendChild(modal);
                }

                // 2. Strip conflicting classes
                modal.classList.remove('hidden', 'animate-fade-in');
                modal.classList.add('flex');

                // 3. Force Styles (Nuclear Option)
                modal.style.display = 'flex';
                modal.style.position = 'fixed';
                modal.style.zIndex = '99999';
                modal.style.inset = '0';
                modal.style.opacity = '1';
                modal.style.visibility = 'visible';
                modal.style.backgroundColor = 'rgba(15, 23, 42, 0.6)'; // Restore backdrop manually

                checkExistingLaporanAkhir();
            } else {
                console.error("modalLaporanAkhir not found!");
                alert("CRITICAL ERROR: Modal Laporan Akhir hilang dari DOM.");
            }
        }

        function closeLaporanAkhirModal() {
            const modal = document.getElementById('modalLaporanAkhir');
            if (modal) {
                // Reset Forced Styles
                modal.style.display = 'none';
                modal.style.zIndex = '';
                modal.style.inset = '';
                modal.style.opacity = '';
                modal.style.visibility = '';
                modal.style.backgroundColor = '';

                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        async function checkExistingLaporanAkhir() {
            console.log("Checking existing Laporan Akhir...");
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data, error } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', 3)
                    .eq('module_type', 'laporan_akhir')
                    .maybeSingle();

                if (data) {
                    const a = JSON.parse(data.answers[0]);
                    const container = document.getElementById('laporanAkhirFormContainer');
                    if (container) {
                        container.classList.add('opacity-70', 'pointer-events-none');
                        if (document.getElementById('btnSubmitLaporanAkhir')) document.getElementById('btnSubmitLaporanAkhir').classList.add('hidden');
                    }

                    // Pre-fill fields
                    if (document.getElementById('input-akhir-jual-makanan-rp')) {
                        document.getElementById('input-akhir-jual-makanan-rp').value = (a.penjualan_makanan_rp || 0).toLocaleString('id-ID');
                    }
                    if (document.getElementById('input-akhir-jual-minuman-rp')) {
                        document.getElementById('input-akhir-jual-minuman-rp').value = (a.penjualan_minuman_rp || 0).toLocaleString('id-ID');
                    }
                    if (document.getElementById('input-akhir-harga-makanan')) {
                        document.getElementById('input-akhir-harga-makanan').value = (a.harga_makanan || 0).toLocaleString('id-ID');
                    }
                    if (document.getElementById('input-akhir-harga-minuman')) {
                        document.getElementById('input-akhir-harga-minuman').value = (a.harga_minuman || 0).toLocaleString('id-ID');
                    }
                    if (document.getElementById('input-akhir-biaya-prod-makan')) {
                        document.getElementById('input-akhir-biaya-prod-makan').value = (a.biaya_prod_makan || 0).toLocaleString('id-ID');
                    }
                    if (document.getElementById('input-akhir-qty-makan')) {
                        document.getElementById('input-akhir-qty-makan').value = (a.qty_makan || 0).toLocaleString('id-ID');
                    }
                    if (document.getElementById('input-akhir-biaya-prod-minum')) {
                        document.getElementById('input-akhir-biaya-prod-minum').value = (a.biaya_prod_minum || 0).toLocaleString('id-ID');
                    }
                    if (document.getElementById('input-akhir-qty-minum')) {
                        document.getElementById('input-akhir-qty-minum').value = (a.qty_minum || 0).toLocaleString('id-ID');
                    }
                    if (document.getElementById('input-akhir-biaya-tetap')) {
                        document.getElementById('input-akhir-biaya-tetap').value = (a.biaya_tetap || 0).toLocaleString('id-ID');
                    }

                    calculateFinancials(true); // Memunculkan ringkasan hasil

                    const statusSection = document.getElementById('laporanAkhirStatusSection');
                    if (statusSection) {
                        statusSection.classList.remove('hidden');
                        if (data.status === 'submitted') {
                            statusSection.innerHTML = `
                                <div class="bg-yellow-50 p-4 rounded-2xl border border-yellow-100 flex items-center gap-3">
                                    <div class="size-8 rounded-full bg-yellow-400 flex items-center justify-center text-white shrink-0 animate-pulse">
                                        <span class="material-symbols-outlined text-sm">hourglass_top</span>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-[10px] font-black text-yellow-700 uppercase tracking-widest">Menunggu Review</p>
                                        <p class="text-[10px] text-yellow-600 mt-0.5 font-medium">Fasilitator sedang memeriksa laporan keuanganmu.</p>
                                    </div>
                                </div>
                            `;
                            updateModuleUI('laporan-akhir', 'submitted');
                        } else if (data.status === 'reviewed') {
                            const score = data.score || 0;
                            const starCount = Math.round(score / 20);
                            let starsHtml = '';
                            for (let i = 1; i <= 5; i++) {
                                starsHtml += `<span class="material-symbols-outlined text-2xl ${i <= starCount ? 'text-amber-400 fill-current' : 'text-slate-200'}">star</span>`;
                            }

                            statusSection.innerHTML = `
                                <div class="bg-emerald-50 p-5 rounded-2xl border border-emerald-100 space-y-3">
                                    <div class="flex items-center justify-between">
                                        <p class="text-[10px] font-black text-emerald-700 uppercase tracking-widest">Dinilai Fasilitator</p>
                                        <div class="flex">${starsHtml}</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-xl border border-emerald-100">
                                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Feedback:</p>
                                        <p class="text-xs text-slate-700 font-medium italic">"${data.feedback || 'Bagus sekali!'}"</p>
                                    </div>
                                </div>
                            `;
                            updateModuleUI('laporan-akhir', true, score);
                        }
                    }
                }
            } catch (err) {
                console.error('Error checkExistingLaporanAkhir:', err);
            }
        }

        // Helper utilities for number formatting
        function formatInputWithDots(input) {
            let value = input.value.replace(/\D/g, '');
            if (value === "") {
                input.value = "";
                return;
            }
            input.value = parseInt(value).toLocaleString('id-ID');
        }

        function parseFormattedNumber(val) {
            if (!val) return 0;
            if (typeof val !== 'string') return parseFloat(val) || 0;
            // Remove everything except digits
            let clean = val.replace(/\D/g, '');
            return parseFloat(clean) || 0;
        }

        function calculateFinancials(showCard = false) {
            // Get values using the parser
            const jualMakanRp = parseFormattedNumber(document.getElementById('input-akhir-jual-makanan-rp')?.value);
            const jualMinumRp = parseFormattedNumber(document.getElementById('input-akhir-jual-minuman-rp')?.value);
            const hargaMakan = parseFormattedNumber(document.getElementById('input-akhir-harga-makanan')?.value);
            const hargaMinum = parseFormattedNumber(document.getElementById('input-akhir-harga-minuman')?.value);

            // New automation fields
            const biayaProdMakan = parseFormattedNumber(document.getElementById('input-akhir-biaya-prod-makan')?.value);
            const qtyMakan = parseFormattedNumber(document.getElementById('input-akhir-qty-makan')?.value);
            const biayaProdMinum = parseFormattedNumber(document.getElementById('input-akhir-biaya-prod-minum')?.value);
            const qtyMinum = parseFormattedNumber(document.getElementById('input-akhir-qty-minum')?.value);

            const biayaTetap = parseFormattedNumber(document.getElementById('input-akhir-biaya-tetap')?.value);

            // Automated Variable Cost / Unit
            const varMakan = qtyMakan > 0 ? (biayaProdMakan / qtyMakan) : 0;
            const varMinum = qtyMinum > 0 ? (biayaProdMinum / qtyMinum) : 0;

            // Show automated results to user
            const displayVarMakan = document.getElementById('display-var-makanan');
            const displayVarMinum = document.getElementById('display-var-minuman');
            if (displayVarMakan) displayVarMakan.textContent = `Rp ${Math.round(varMakan).toLocaleString('id-ID')}`;
            if (displayVarMinum) displayVarMinum.textContent = `Rp ${Math.round(varMinum).toLocaleString('id-ID')}`;

            const totalPenjualan = jualMakanRp + jualMinumRp;
            const totalBiaya = biayaProdMakan + biayaProdMinum + biayaTetap;
            const labaRugi = totalPenjualan - totalBiaya;

            // BEP Calculation (Balik Modal / Cash Flow BEP)
            const bepRupiah = totalBiaya;
            const totalUnits = qtyMakan + qtyMinum;
            const avgPrice = totalUnits > 0 ? (totalPenjualan / totalUnits) : ((hargaMakan + hargaMinum) / ((hargaMakan > 0 ? 1 : 0) + (hargaMinum > 0 ? 1 : 0) || 1));
            const bepUnit = avgPrice > 0 ? Math.ceil(totalBiaya / avgPrice) : 0;

            // Update UI
            if (showCard) document.getElementById('laporanAkhirResultCard')?.classList.remove('hidden');

            const resTotalPenjualan = document.getElementById('res-total-penjualan');
            const resTotalBiaya = document.getElementById('res-total-biaya');
            const resLabaRugiValue = document.getElementById('res-laba-rugi-value');
            const resLabaRugiStatus = document.getElementById('res-laba-rugi-status');
            const resBepUnit = document.getElementById('res-bep-unit');
            const resBepRp = document.getElementById('res-bep-rp');
            const resBepKet = document.getElementById('res-bep-keterangan');
            const lrCard = document.getElementById('laba-rugi-card');

            if (resTotalPenjualan) resTotalPenjualan.textContent = `Rp ${totalPenjualan.toLocaleString('id-ID')}`;
            if (resTotalBiaya) resTotalBiaya.textContent = `Rp ${totalBiaya.toLocaleString('id-ID')}`;
            if (resLabaRugiValue) resLabaRugiValue.textContent = `Rp ${labaRugi.toLocaleString('id-ID')}`;

            if (resLabaRugiStatus && lrCard) {
                if (labaRugi > 0) {
                    resLabaRugiStatus.textContent = 'LABA (UNTUNG)';
                    resLabaRugiStatus.className = 'px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest mb-2 bg-emerald-100 text-emerald-600';
                    lrCard.className = 'p-5 rounded-[2rem] border border-emerald-100 bg-emerald-50/30 shadow-sm flex flex-col items-center justify-center text-center';
                    resLabaRugiValue.className = 'text-2xl font-black text-emerald-600';
                } else if (labaRugi < 0) {
                    resLabaRugiStatus.textContent = 'RUGI';
                    resLabaRugiStatus.className = 'px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest mb-2 bg-red-100 text-red-600';
                    lrCard.className = 'p-5 rounded-[2rem] border border-red-100 bg-red-50/30 shadow-sm flex flex-col items-center justify-center text-center';
                    resLabaRugiValue.className = 'text-2xl font-black text-red-600';
                } else {
                    resLabaRugiStatus.textContent = 'IMPAS';
                    resLabaRugiStatus.className = 'px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest mb-2 bg-slate-100 text-slate-500';
                    lrCard.className = 'p-5 rounded-[2rem] border border-slate-100 bg-white shadow-sm flex flex-col items-center justify-center text-center';
                    resLabaRugiValue.className = 'text-2xl font-black text-slate-600';
                }
            }

            if (resBepUnit) resBepUnit.textContent = `${bepUnit.toLocaleString('id-ID')} Unit`;
            if (resBepRp) resBepRp.textContent = `Rp ${bepRupiah.toLocaleString('id-ID')}`;

            if (resBepKet) {
                if (totalPenjualan > 0 && totalUnits === 0) {
                    resBepKet.textContent = 'ISI HARGA MAKANAN/MINUMAN';
                    resBepKet.className = 'text-[10px] font-black uppercase tracking-tight text-red-500 animate-pulse';
                } else if (totalPenjualan >= bepRupiah && bepRupiah > 0) {
                    resBepKet.textContent = 'TARGET TERCAPAI! (MELEBIHI BEP)';
                    resBepKet.className = 'text-[10px] font-black uppercase tracking-tight text-emerald-600';
                } else if (bepRupiah > 0) {
                    resBepKet.textContent = 'BELUM MENCAPAI BEP';
                    resBepKet.className = 'text-[10px] font-black uppercase tracking-tight text-orange-600';
                } else {
                    resBepKet.textContent = 'MASUKKAN DATA HARGA & BIAYA';
                    resBepKet.className = 'text-[10px] font-black uppercase tracking-tight text-slate-400';
                }
            }

            return { totalPenjualan, totalBiaya, labaRugi, bepUnit, bepRupiah, totalUnits };
        }

        async function submitLaporanAkhir() {
            const btn = document.getElementById('btnSubmitLaporanAkhir');
            const fields = {
                jualMakanRp: parseFormattedNumber(document.getElementById('input-akhir-jual-makanan-rp')?.value),
                jualMinumRp: parseFormattedNumber(document.getElementById('input-akhir-jual-minuman-rp')?.value),
                hargaMakan: parseFormattedNumber(document.getElementById('input-akhir-harga-makanan')?.value),
                hargaMinum: parseFormattedNumber(document.getElementById('input-akhir-harga-minuman')?.value),
                biayaProdMakan: parseFormattedNumber(document.getElementById('input-akhir-biaya-prod-makan')?.value),
                qtyMakan: parseFormattedNumber(document.getElementById('input-akhir-qty-makan')?.value),
                biayaProdMinum: parseFormattedNumber(document.getElementById('input-akhir-biaya-prod-minum')?.value),
                qtyMinum: parseFormattedNumber(document.getElementById('input-akhir-qty-minum')?.value),
                biayaTetap: parseFormattedNumber(document.getElementById('input-akhir-biaya-tetap')?.value)
            };

            // Basic Validation
            if (fields.jualMakanRp === 0 && fields.jualMinumRp === 0) {
                alert('Mohon isi minimal satu data Penjualan.');
                return;
            }
            if (fields.jualMakanRp > 0 && fields.hargaMakan === 0) {
                alert('Mohon isi Harga Jual Makanan.');
                return;
            }
            if (fields.jualMinumRp > 0 && fields.hargaMinum === 0) {
                alert('Mohon isi Harga Jual Minuman.');
                return;
            }

            const results = calculateFinancials(true);

            const confirmed = confirm('Apakah Anda yakin data sudah benar? Laporan yang dikirim tidak dapat diubah.');
            if (!confirmed) return;

            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined text-lg animate-spin">progress_activity</span> Mengirim...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error('Silakan login ulang.');

                const payload = {
                    penjualan_makanan_rp: fields.jualMakanRp,
                    penjualan_minuman_rp: fields.jualMinumRp,
                    harga_makanan: fields.hargaMakan,
                    harga_minuman: fields.hargaMinum,
                    biaya_prod_makan: fields.biayaProdMakan,
                    qty_makan: fields.qtyMakan,
                    biaya_prod_minum: fields.biayaProdMinum,
                    qty_minum: fields.qtyMinum,
                    biaya_tetap: fields.biayaTetap,
                    var_makanan: results.totalUnits > 0 || fields.qtyMakan > 0 ? (fields.biayaProdMakan / (fields.qtyMakan || 1)) : 0,
                    var_minuman: results.totalUnits > 0 || fields.qtyMinum > 0 ? (fields.biayaProdMinum / (fields.qtyMinum || 1)) : 0,
                    total_penjualan: results.totalPenjualan,
                    total_biaya: results.totalBiaya,
                    laba_rugi: results.labaRugi,
                    bep_unit: results.bepUnit,
                    bep_rupiah: results.bepRupiah
                };

                const { error } = await supabaseClient
                    .from('module_responses')
                    .upsert({
                        student_id: user.id,
                        day_id: 3,
                        module_type: 'laporan_akhir',
                        answers: [JSON.stringify(payload)],
                        status: 'submitted',
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'student_id,day_id,module_type'
                    });

                if (error) throw error;

                alert('✅ Laporan Akhir berhasil dikirim!');
                closeLaporanAkhirModal();
                updateModuleUI('laporan-akhir', 'submitted');
                checkAllModulesStatus();

            } catch (err) {
                console.error('Error submit:', err);
                alert('Gagal: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Kirim Laporan Akhir';
            }
        }

        async function checkExistingAnalisis() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;
                const { data, error } = await supabaseClient.from('module_responses').select('*').eq('student_id', user.id).eq('day_id', currentDay).eq('module_type', 'bep_analisis').maybeSingle();
                if (data) {
                    const statusSection = document.getElementById('analisisStatusSection');
                    const formContainer = document.getElementById('analisisFormContainer');
                    const statusIcon = document.getElementById('status-bep');
                    const statusLabel = document.getElementById('label-bep');
                    let ans; try { ans = JSON.parse(data.answers[0]); } catch (e) { ans = {}; }
                    if (statusSection) statusSection.classList.remove('hidden');
                    if (formContainer) { formContainer.classList.remove('hidden'); formContainer.classList.add('opacity-70', 'pointer-events-none'); document.getElementById('btnSubmitAnalisis').classList.add('hidden'); }
                    if (document.getElementById('input-nama-produk')) document.getElementById('input-nama-produk').value = ans.nama_produk || '';
                    if (document.getElementById('input-nama-minuman')) document.getElementById('input-nama-minuman').value = ans.nama_minuman || '';
                    if (document.getElementById('input-target-makanan')) document.getElementById('input-target-makanan').value = (ans.target_makanan || 0).toLocaleString('id-ID');
                    if (document.getElementById('input-target-minuman')) document.getElementById('input-target-minuman').value = (ans.target_minuman || 0).toLocaleString('id-ID');
                    if (document.getElementById('input-harga-makanan')) document.getElementById('input-harga-makanan').value = (ans.harga_makanan || 0).toLocaleString('id-ID');
                    if (document.getElementById('input-harga-minuman')) document.getElementById('input-harga-minuman').value = (ans.harga_minuman || 0).toLocaleString('id-ID');
                    const ingTable = document.getElementById('ingredients-table-body');
                    const drkTable = document.getElementById('drinks-table-body');
                    const stnTable = document.getElementById('stand-table-body');
                    if (ingTable) ingTable.innerHTML = '';
                    if (drkTable) drkTable.innerHTML = '';
                    if (stnTable) stnTable.innerHTML = '';
                    if (ans.ingredients) ans.ingredients.forEach(ing => addIngredientRow(ing.item, ing.cost));
                    if (ans.drinks) ans.drinks.forEach(drk => addDrinkRow(drk.item, drk.cost));
                    if (ans.stand_items) ans.stand_items.forEach(st => addStandRow(st.item, st.cost));

                    // Load PO Data
                    if (document.getElementById('input-po-makanan-qty')) document.getElementById('input-po-makanan-qty').value = (ans.po_makanan_qty || 0).toLocaleString('id-ID');
                    if (document.getElementById('input-po-makanan-harga')) document.getElementById('input-po-makanan-harga').value = (ans.po_makanan_harga || 0).toLocaleString('id-ID');
                    if (document.getElementById('input-po-minuman-qty')) document.getElementById('input-po-minuman-qty').value = (ans.po_minuman_qty || 0).toLocaleString('id-ID');
                    if (document.getElementById('input-po-minuman-harga')) document.getElementById('input-po-minuman-harga').value = (ans.po_minuman_harga || 0).toLocaleString('id-ID');

                    calculatePO(); // Recalculate PO totals
                    calculateAnalisisTotal();
                    if (data.status === 'submitted') {
                        if (statusIcon) { statusIcon.textContent = 'hourglass_top'; statusIcon.className = 'material-symbols-outlined !text-[14px] text-yellow-500 animate-pulse'; }
                        if (statusLabel) { statusLabel.textContent = 'Menunggu Feedback'; statusLabel.className = 'text-[11px] font-semibold text-yellow-500'; }
                        updateModuleUI('bep', 'submitted');
                    } else if (data.status === 'reviewed') {
                        updateModuleUI('bep', true, data.score || 0);
                        studentProgress[`day${currentDay}`]['bep'] = true; saveProgress(); calculateGlobalProgress();
                    }
                }
            } catch (err) { console.error('Check BEP error:', err); }
        }

        function openVideoModal() {
            const modal = document.getElementById('modalVideo');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            loadVideoContent();
            checkExistingVideoResponse();
        }

        function closeVideoModal() {
            const modal = document.getElementById('modalVideo');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function loadVideoContent() {
            const container = document.getElementById('videoDynamicItems');
            const videos = videoContentByDay[currentDay] || [];

            if (videos.length === 0) {
                container.innerHTML = `
                    <div class="bg-amber-50 p-6 rounded-2xl border border-amber-100 text-center">
                        <span class="material-symbols-outlined text-amber-500 text-4xl mb-2">info</span>
                        <p class="text-sm font-bold text-amber-700">Video untuk hari ini belum tersedia</p>
                    </div>
                `;
                return;
            }

            // Generate video items
            let html = '';
            videos.forEach((video, index) => {
                html += `
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="aspect-video bg-slate-900">
                            <iframe 
                                class="w-full h-full" 
                                src="${video.url}" 
                                title="${video.title}"
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen>
                            </iframe>
                        </div>
                        <div class="p-4">
                            <h4 class="text-sm font-bold text-slate-800">${video.title}</h4>
                            <p class="text-xs text-slate-400 mt-1">${video.duration}</p>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // NOTE: checkExistingVideoResponse() is defined later at line ~3915
        // with the correct implementation using data.answers[0]

        function updateVideoWordCount() {
            const input = document.getElementById('videoSummaryInput');
            const display = document.getElementById('videoWordCountDisplay');
            const submitBtn = document.getElementById('btnSubmitVideo');

            const text = input.value.trim();
            const wordCount = text ? text.split(/\s+/).length : 0;

            display.textContent = `${wordCount} / 50 kata`;

            if (wordCount >= 50) {
                display.className = 'text-[10px] font-bold text-emerald-500 bg-white/50 px-2 py-1 rounded-lg border border-emerald-100';
                submitBtn.disabled = false;
                submitBtn.className = 'w-full py-4 bg-red-500 text-white rounded-2xl font-black shadow-lg shadow-red-200 active:scale-95 transition-all';
            } else {
                display.className = 'text-[10px] font-bold text-red-500 bg-white/50 px-2 py-1 rounded-lg border border-red-100';
                submitBtn.disabled = true;
                submitBtn.className = 'w-full py-4 bg-slate-300 text-white rounded-2xl font-black shadow-none transition-all cursor-not-allowed';
            }
        }

        async function submitVideoLog() {
            const summaryInput = document.getElementById('videoSummaryInput');
            const summary = summaryInput.value.trim();

            if (!summary || summary.split(/\s+/).length < 50) {
                alert('Ringkasan minimal 50 kata!');
                return;
            }

            const submitBtn = document.getElementById('btnSubmitVideo');
            submitBtn.disabled = true;
            submitBtn.textContent = '⏳ Mengirim...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error('User not authenticated');

                const { error } = await supabaseClient
                    .from('module_responses')
                    .insert({
                        student_id: user.id,
                        day_id: currentDay,
                        module_type: 'video',
                        response_text: summary,
                        status: 'submitted',
                        submitted_at: new Date().toISOString()
                    });

                if (error) throw error;

                alert('✅ Ringkasan berhasil dikirim!');
                forceCompleteModule('video');
                closeVideoModal();

            } catch (err) {
                console.error('Submit Error:', err);
                alert('❌ Gagal mengirim ringkasan: ' + err.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Simpan Ringkasan & Selesai';
            }
        }

        // ==========================================
        // FITUR DOKUMENTASI FOTO (REPLACEMENT RANGKUMAN)
        // ==========================================

        function openDokumentasiModal() {
            const modal = document.getElementById('modalDokumentasi');
            const uploadArea = document.getElementById('docUploadArea');
            const previewArea = document.getElementById('docPreviewArea');

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Reset UI to upload state
            uploadArea.classList.remove('hidden');
            previewArea.classList.add('hidden');

            checkExistingDokumentasi();
        }

        function closeDokumentasiModal() {
            document.getElementById('modalDokumentasi').classList.add('hidden');
            document.getElementById('modalDokumentasi').classList.remove('flex');
        }

        function changeDocPhoto() {
            const uploadArea = document.getElementById('docUploadArea');
            const previewArea = document.getElementById('docPreviewArea');
            const docInput = document.getElementById('docInput');
            const statusText = document.getElementById('docStatusMsg');

            // Reset to upload state
            uploadArea.classList.remove('hidden');
            previewArea.classList.add('hidden');
            statusText.classList.add('hidden');

            // Reset file input
            docInput.value = '';
            window.selectedDocFile = null;

            // Disable submit button until new photo selected
            document.getElementById('btnUploadDokumentasi').disabled = true;
        }

        // Compress image function (Optimized for Documentation)
        async function compressImage(file, maxWidth = 800, quality = 0.5) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function handleDocPhotoSelection(e) {
            const file = e.target.files[0];
            if (!file) return;

            // VALIDASI: Batasan 10MB sebelum kompresi
            const MAX_SIZE = 10 * 1024 * 1024;
            if (file.size > MAX_SIZE) {
                alert(`Pesan: Ukuran file terlalu besar (${Math.round(file.size / 1024 / 1024)}MB). Maksimal 10MB agar tidak memberatkan sistem.`);
                e.target.value = '';
                return;
            }

            const btn = document.getElementById('btnUploadDokumentasi');
            const statusText = document.getElementById('docStatusMsg');
            const preview = document.getElementById('docPreview');
            const uploadArea = document.getElementById('docUploadArea');
            const previewArea = document.getElementById('docPreviewArea');

            statusText.classList.remove('hidden');
            statusText.className = "mb-4 p-4 rounded-2xl text-[11px] font-bold border border-blue-100 bg-blue-50 text-blue-700 animate-pulse";
            statusText.innerHTML = "⏳ Sedang mengoptimalkan foto...";
            btn.disabled = true;

            try {
                const compressedBlob = await compressImage(file, 600, 0.6);
                const compressedFile = new File([compressedBlob], `doc_${Date.now()}.jpg`, { type: 'image/jpeg' });

                // Preview
                const reader = new FileReader();
                reader.onload = (re) => {
                    console.log('📸 Setting preview image...');
                    preview.src = re.target.result;
                    console.log('✅ Preview src set:', preview.src.substring(0, 50) + '...');

                    // Show preview area, hide upload area
                    uploadArea.classList.add('hidden');
                    previewArea.classList.remove('hidden');
                    console.log('✅ Preview area shown, upload area hidden');
                };
                reader.readAsDataURL(compressedFile);

                statusText.className = "mb-4 p-4 rounded-2xl text-[11px] font-bold border border-emerald-100 bg-emerald-50 text-emerald-700";
                statusText.innerHTML = "✅ Foto siap dikirim (~" + Math.round(compressedBlob.size / 1024) + " KB)";
                btn.disabled = false;

                // Simpan file sementara di window agar bisa diakses submit
                window.selectedDocFile = compressedFile;

            } catch (err) {
                console.error(err);
                statusText.className = "mb-4 p-4 rounded-2xl text-[11px] font-bold border border-red-100 bg-red-50 text-red-700";
                statusText.innerHTML = "❌ Gagal memproses foto.";
            }
        }


        async function checkExistingDokumentasi() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data: responses } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'dokumentasi')
                    .order('created_at', { ascending: false })
                    .limit(1);

                const container = document.getElementById('docUploadArea');
                const btn = document.getElementById('btnUploadDokumentasi');
                const statusMsg = document.getElementById('docStatusMsg');
                const preview = document.getElementById('docPreview');

                if (responses && responses.length > 0) {
                    const r = responses[0];

                    if (r.status === 'submitted' || r.status === 'reviewed') {
                        if (r.status === 'reviewed') {
                            forceCompleteModule('dokumentasi', r.score);
                        }
                        if (container) container.classList.add('hidden');
                        if (btn) btn.classList.add('hidden');
                        if (statusMsg) {
                            statusMsg.classList.remove('hidden');
                            statusMsg.className = "mb-4 p-4 rounded-2xl text-[11px] font-bold border border-emerald-100 bg-emerald-50 text-emerald-700";
                            statusMsg.innerHTML = "✅ Dokumentasi hari ini sudah terkirim.";
                        }
                        if (preview && r.answers[0]) {
                            preview.src = r.answers[0];
                            preview.classList.remove('hidden');
                        }
                        updateModuleUI('dokumentasi', r.status === 'reviewed' ? true : 'submitted', r.score || 0);
                    }
                } else {
                    if (container) container.classList.remove('hidden');
                    if (btn) {
                        btn.classList.remove('hidden');
                        btn.disabled = true;
                        btn.innerHTML = 'Kirim Dokumentasi';
                    }
                    if (statusMsg) statusMsg.classList.add('hidden');
                    if (preview) {
                        preview.src = '';
                        preview.classList.add('hidden');
                    }
                }
            } catch (e) { console.error('Error checkExistingDokumentasi:', e); }
        }


        // ===== DAY 2: 5-CATEGORY DOCUMENTATION FUNCTIONS =====

        // Global storage for selected photos
        window.day2Photos = {
            makanan: null,
            minuman: null,
            stand: null,
            iklan: null,
            presentasi: null
        };

        // Open Day 2 documentation modal
        function openDokumentasiDay2Modal() {
            const modal = document.getElementById('modal-dokumentasi-day2');
            if (modal) {
                modal.classList.remove('hidden');
                loadExistingDay2Documentation();
            }
        }

        // Close Day 2 documentation modal
        function closeDokumentasiDay2Modal() {
            const modal = document.getElementById('modal-dokumentasi-day2');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Handle photo selection for specific category
        async function handleCategoryPhoto(category, fileInput) {
            const file = fileInput.files[0];
            if (!file) return;

            // Validation: Max 10MB
            const MAX_SIZE = 10 * 1024 * 1024;
            if (file.size > MAX_SIZE) {
                alert(`Ukuran file terlalu besar (${Math.round(file.size / 1024 / 1024)}MB). Maksimal 10MB.`);
                fileInput.value = '';
                return;
            }

            const uploadArea = document.getElementById(`upload-area-${category}`);
            const previewArea = document.getElementById(`preview-area-${category}`);
            const preview = document.getElementById(`preview-${category}`);
            const status = document.getElementById(`status-${category}`);

            // Show loading
            status.className = "text-xs font-bold text-blue-600 animate-pulse";
            status.textContent = "⏳ Mengoptimalkan foto...";

            try {
                // Compress image (reuse existing function)
                const compressedBlob = await compressImage(file, 600, 0.6);
                const compressedFile = new File([compressedBlob], `${category}_${Date.now()}.jpg`, { type: 'image/jpeg' });

                // Preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    uploadArea.classList.add('hidden');
                    previewArea.classList.remove('hidden');
                    // Pastikan tombol hapus muncul (jika sebelumnya disembunyikan)
                    const deleteBtn = previewArea.querySelector('button');
                    if (deleteBtn) deleteBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(compressedFile);

                // Store in global
                window.day2Photos[category] = compressedFile;

                // Update status
                status.className = "text-xs font-bold text-emerald-600";
                status.textContent = `✅ Siap dikirim (~${Math.round(compressedBlob.size / 1024)} KB)`;

                // Check if all 5 photos selected
                checkAllPhotosSelected();

            } catch (err) {
                console.error(err);
                status.className = "text-xs font-bold text-red-600";
                status.textContent = "❌ Gagal memproses foto.";
            }
        }

        // Check if all 5 photos are selected
        function checkAllPhotosSelected() {
            const photos = Object.values(window.day2Photos);
            const allSelected = photos.every(photo => photo !== null);
            const allExisting = photos.every(photo => photo === 'existing');

            const submitBtn = document.getElementById('btnSubmitAllDocs');
            if (submitBtn) {
                if (allExisting) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = 'Semua Dokumentasi Terkirim';
                    submitBtn.classList.remove('bg-indigo-600', 'shadow-indigo-200', 'text-white', 'active:scale-95');
                    submitBtn.classList.add('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                    return;
                }

                submitBtn.disabled = !allSelected;
                if (allSelected) {
                    submitBtn.classList.add('bg-indigo-600', 'shadow-indigo-200', 'text-white', 'active:scale-95');
                    submitBtn.classList.remove('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                    submitBtn.innerHTML = `
                        <span>Kirim 5 Dokumentasi</span>
                        <span class="material-symbols-outlined text-sm">send</span>
                    `;
                } else {
                    submitBtn.classList.add('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                    submitBtn.classList.remove('bg-indigo-600', 'shadow-indigo-200', 'text-white', 'active:scale-95');
                    submitBtn.innerHTML = `
                        <span>Kirim Semua Dokumentasi</span>
                        <span class="material-symbols-outlined text-sm">send</span>
                    `;
                }
            }
        }

        // Hapus Foto Kategori
        function removeCategoryPhoto(category) {
            // 1. Clear global state
            window.day2Photos[category] = null;

            // 2. Clear input
            const input = document.getElementById(`doc-${category}`);
            if (input) input.value = '';

            // 3. Update UI
            document.getElementById(`upload-area-${category}`).classList.remove('hidden');
            document.getElementById(`preview-area-${category}`).classList.add('hidden');
            document.getElementById(`preview-${category}`).src = '';

            // 4. Update Submit Button
            checkAllPhotosSelected();
        }

        // --- HARI 2 DOCUMENTATION LOGIC (5 CATEGORIES) ---
        async function submitAllDocumentation() {
            const btn = document.getElementById('btnSubmitAllDocs');
            if (!btn) return;

            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined text-sm animate-spin">sync</span> Mengirim...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error('Silakan login ulang.');

                const categories = ['makanan', 'minuman', 'stand', 'iklan', 'presentasi'];
                const photoUrls = {};

                // 1. Upload new photos sequentially
                for (const category of categories) {
                    const file = window.day2Photos[category];
                    if (file === 'existing') {
                        photoUrls[category] = document.getElementById(`preview-${category}`).src;
                        continue;
                    }
                    if (!file) continue;

                    const fileName = `${user.id}/day2_${category}_${Date.now()}.jpg`;
                    const { data: uploadData, error: uploadErr } = await supabaseClient.storage
                        .from('documentation')
                        .upload(fileName, file);

                    if (uploadErr) throw uploadErr;

                    const { data: urlData } = supabaseClient.storage
                        .from('documentation')
                        .getPublicUrl(fileName);

                    photoUrls[category] = urlData.publicUrl;
                }

                // 2. Upsert as single row (JSON)
                const { error: dbError } = await supabaseClient
                    .from('module_responses')
                    .upsert({
                        student_id: user.id,
                        day_id: 2,
                        module_type: 'dokumentasi',
                        answers: [JSON.stringify(photoUrls)],
                        status: 'submitted',
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'student_id,day_id,module_type'
                    });

                if (dbError) throw dbError;

                alert('✅ Semua dokumentasi Hari 2 berhasil dikirim!');
                window.day2Photos = { makanan: null, minuman: null, stand: null, iklan: null, presentasi: null };
                closeDokumentasiDay2Modal();
                checkAllModulesStatus();
            } catch (e) {
                console.error(e);
                alert('Gagal mengirim: ' + e.message);
                btn.disabled = false;
                btn.innerHTML = 'Kirim Semua Dokumentasi Hari 2';
            }
        }

        async function loadExistingDay2Documentation() {
            try {
                const { data: { user } = {} } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data: responses } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', 2)
                    .eq('module_type', 'dokumentasi')
                    .maybeSingle();

                if (responses && responses.answers && responses.answers[0]) {
                    const photoUrls = JSON.parse(responses.answers[0]);
                    const categories = ['makanan', 'minuman', 'stand', 'iklan', 'presentasi'];

                    categories.forEach(cat => {
                        if (photoUrls[cat]) {
                            const uploadArea = document.getElementById(`upload-area-${cat}`);
                            const previewArea = document.getElementById(`preview-area-${cat}`);
                            const preview = document.getElementById(`preview-${cat}`);
                            const status = document.getElementById(`status-${cat}`);

                            if (uploadArea) uploadArea.classList.add('hidden');
                            if (previewArea) {
                                previewArea.classList.remove('hidden');
                                const deleteBtn = previewArea.querySelector('button');
                                if (deleteBtn) deleteBtn.classList.add('hidden');
                            }
                            if (preview) preview.src = photoUrls[cat];
                            if (status) {
                                status.className = "text-[10px] font-bold text-emerald-600 bg-emerald-50 px-3 py-2 rounded-xl border border-emerald-100 flex items-center gap-2 w-fit mt-3";
                                status.innerHTML = `<span class="material-symbols-outlined text-sm">verified</span> Sudah Terkirim`;
                            }
                            window.day2Photos[cat] = 'existing';
                        }
                    });
                    checkAllPhotosSelected();
                }
            } catch (e) {
                console.error('Error loading Day 2 documentation:', e);
            }
        }

        // --- HARI 3 DOCUMENTATION LOGIC (5 CATEGORIES) ---
        function openDokumentasiDay3Modal() {
            console.log("Opening Dokumentasi Day 3...");
            const modal = document.getElementById('modal-dokumentasi-day3');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                if (typeof checkExistingDocumentationDay3 === 'function') {
                    checkExistingDocumentationDay3();
                } else if (typeof loadExistingDay3Documentation === 'function') {
                    loadExistingDay3Documentation();
                }
            } else {
                console.error("modal-dokumentasi-day3 not found");
            }
        }

        function closeDokumentasiDay3Modal() {
            const modal = document.getElementById('modal-dokumentasi-day3');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        async function handleCategoryPhotoDay3(category, fileInput) {
            const file = fileInput.files[0];
            if (!file) return;

            const MAX_SIZE = 5 * 1024 * 1024; // 5MB Limit
            if (file.size > MAX_SIZE) {
                alert(`File terlalu besar (${Math.round(file.size / 1024 / 1024)}MB). Maksimal 5MB.`);
                fileInput.value = '';
                return;
            }

            const uploadArea = document.getElementById(`upload-area-day3-${category}`);
            const previewArea = document.getElementById(`preview-area-day3-${category}`);
            const preview = document.getElementById(`preview-day3-${category}`);
            const status = document.getElementById(`status-day3-${category}`);
            const deleteBtn = previewArea ? previewArea.querySelector('button') : null;

            // Update loading state
            if (status) {
                status.className = "text-xs font-bold text-indigo-600 animate-pulse";
                status.textContent = "⏳ Memproses...";
            }
            if (deleteBtn) deleteBtn.classList.add('hidden'); // Hide delete button while processing

            try {
                const compressedBlob = await compressImage(file, 800, 0.7);
                const compressedFile = new File([compressedBlob], `day3_${category}_${Date.now()}.jpg`, { type: 'image/jpeg' });

                const reader = new FileReader();
                reader.onload = (e) => {
                    if (preview) preview.src = e.target.result;
                    if (uploadArea) uploadArea.classList.add('hidden');
                    if (previewArea) previewArea.classList.remove('hidden');

                    // Show Delete Photo button
                    if (deleteBtn) deleteBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(compressedFile);

                window.day3Photos[category] = compressedFile;

                if (status) {
                    status.className = "text-xs font-bold text-emerald-600";
                    status.textContent = `✅ Siap (~${Math.round(compressedBlob.size / 1024)} KB)`;
                }

                checkAllPhotosSelectedDay3();
            } catch (err) {
                console.error(err);
                if (status) {
                    status.className = "text-xs font-bold text-red-600";
                    status.textContent = "❌ Gagal.";
                }
                // Revert
                if (uploadArea) uploadArea.classList.remove('hidden');
                if (previewArea) previewArea.classList.add('hidden');
            }
        }

        function removeCategoryPhotoDay3(category) {
            const input = document.getElementById(`doc-day3-${category}`);
            const uploadArea = document.getElementById(`upload-area-day3-${category}`);
            const previewArea = document.getElementById(`preview-area-day3-${category}`);
            const status = document.getElementById(`status-day3-${category}`);
            const preview = document.getElementById(`preview-day3-${category}`);

            if (input) input.value = '';
            if (uploadArea) uploadArea.classList.remove('hidden');
            if (previewArea) previewArea.classList.add('hidden');
            if (preview) preview.src = '';

            if (status) {
                status.textContent = '';
                status.className = "text-xs mt-2";
            }

            window.day3Photos[category] = null;
            checkAllPhotosSelectedDay3();
        }

        function checkAllPhotosSelectedDay3() {
            const allSelected = Object.values(window.day3Photos).every(photo => photo !== null);
            const submitBtn = document.getElementById('btnSubmitAllDocsDay3');
            if (submitBtn) submitBtn.disabled = !allSelected;
        }


        async function loadExistingDay3Documentation() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data: responses } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', 3)
                    .eq('module_type', 'dokumentasi');

                if (responses && responses.length > 0) {
                    responses.forEach(r => {
                        const uploadArea = document.getElementById(`upload-area-day3-${r.category}`);
                        const previewArea = document.getElementById(`preview-area-day3-${r.category}`);
                        const preview = document.getElementById(`preview-day3-${r.category}`);
                        const status = document.getElementById(`status-day3-${r.category}`);

                        if (uploadArea) uploadArea.classList.add('hidden');
                        if (previewArea) {
                            previewArea.classList.remove('hidden');
                            // Hide Change Photo button if already submitted (server data)
                            const changeBtn = previewArea.querySelector('button');
                            if (changeBtn) changeBtn.classList.add('hidden');
                        }
                        if (preview && r.answers[0]) preview.src = r.answers[0];
                        if (status) {
                            status.className = "text-xs font-bold text-emerald-600";
                            status.textContent = "✅ Terkirim";
                        }
                    });

                    const btn = document.getElementById('btnSubmitAllDocsDay3');
                    if (btn && responses.length >= 5) {
                        btn.disabled = true;
                        btn.innerHTML = 'Semua Dokumentasi Hari 3 Terkirim';
                    }
                }
            } catch (e) { console.error('Error loadExistingDay3Documentation:', e); }
        }








    </script>

    <!-- MODAL PERTANYAAN PEMANTIK -->
    <div id="modalPemantik"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2rem] shadow-2xl max-h-[90vh] flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div>
                    <h3 class="text-lg font-black text-slate-800">Pertanyaan Pemantik</h3>
                    <p class="text-xs text-slate-500 font-medium">Hari 1 • Cita Rasa Jajanan Nusantara</p>
                </div>
                <button onclick="closePemantikModal()"
                    class="size-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200 transition-colors">
                    <span class="material-symbols-outlined text-xl">close</span>
                </button>
            </div>

            <!-- Scrollable Content -->
            <div class="p-6 overflow-y-auto no-scrollbar space-y-6">

                <!-- Status Message Area -->
                <div id="statusMessage" class="hidden"></div>

                <!-- Dynamic Questions Container -->
                <div id="pemantikQuestionsContainer" class="space-y-6">
                    <!-- Questions will be injected here -->
                </div>

            </div>

            <!-- Footer -->
            <div class="p-5 border-t border-slate-100 bg-slate-50/50">
                <button id="btnSubmitPemantik" onclick="submitPemantik()"
                    class="w-full py-3.5 rounded-xl bg-emerald-custom text-white font-bold text-sm shadow-lg shadow-emerald-500/20 active:scale-[0.98] transition-all hover:bg-emerald-600">
                    Kirim Jawaban
                </button>
            </div>
        </div>
    </div>
    <!-- MODAL MATERI BELAJAR (SLIDE) -->
    <div id="modalMateri"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/60 backdrop-blur-md p-0 md:p-4 animate-fade-in">
        <div
            class="bg-white w-full max-w-lg h-full md:h-auto md:max-h-[85vh] md:rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden relative">

            <!-- Progress Top -->
            <div class="absolute top-0 left-0 w-full h-1.5 bg-slate-100">
                <div id="materiProgressBar" class="h-full bg-emerald-500 transition-all duration-500"
                    style="width: 12.5%"></div>
            </div>

            <!-- Header -->
            <div class="px-6 pt-8 pb-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="size-10 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center">
                        <span class="material-symbols-outlined font-icon">menu_book</span>
                    </div>
                    <div>
                        <h3 class="text-sm font-black text-slate-800 leading-tight">Materi Hari 1</h3>
                        <p id="materiStepText" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">
                            Halaman 1 dari 8</p>
                    </div>
                </div>
                <button onclick="closeMateriModal()"
                    class="size-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-slate-100 transition-all">
                    <span class="material-symbols-outlined text-xl">close</span>
                </button>
            </div>

            <!-- Content Area -->
            <div id="materiContentArea" class="flex-1 overflow-y-auto px-6 py-4 no-scrollbar">
                <div id="materiDynamicSlides">
                    <!-- Slides will be injected here -->
                </div>

                <!-- SLIDE 9: RINGKASAN (NEW) -->
                <div id="slide-materi-8" class="hidden animate-slide-up h-full flex flex-col">
                    <div class="flex flex-col items-center text-center mb-4">
                        <span class="material-symbols-outlined text-4xl text-emerald-500 mb-1">edit_document</span>
                        <h4 class="text-lg font-black text-slate-800">Bagian IX: Ringkasan Materi</h4>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Tuliskan apa yang
                            kamu
                            pelajari hari ini</p>
                    </div>

                    <div id="materiStatusMsg" class="hidden mb-4 p-3 rounded-2xl text-[11px] font-medium border">
                    </div>

                    <div class="flex-1 flex flex-col gap-3">
                        <div class="relative flex-1">
                            <textarea id="summaryArea" oninput="updateWordCount()"
                                class="w-full h-full min-h-[200px] bg-slate-50 border border-slate-200 rounded-2xl p-4 text-xs text-slate-700 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all resize-none font-medium leading-relaxed"
                                placeholder="Tuliskan ringkasan materi minimal 200 kata..."></textarea>
                            <div class="absolute bottom-3 right-4">
                                <span id="wordCounter"
                                    class="text-[10px] font-bold text-slate-400 bg-white/80 backdrop-blur px-2 py-1 rounded-lg border border-slate-100">0
                                    / 200 kata</span>
                            </div>
                        </div>

                        <div class="bg-amber-50 p-3 rounded-2xl border border-amber-100/50 flex gap-3">
                            <span class="material-symbols-outlined text-amber-500 text-lg">info</span>
                            <p class="text-[10px] text-amber-700 font-medium leading-relaxed">
                                <b>Penting:</b> Ringkasan ini akan diperiksa oleh Fasilitator. Kamu baru dianggap
                                menyelesaikan materi setelah mendapat review.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slide Navigation Bar -->
            <div class="px-6 pb-2">
                <div id="materiDynamicPills"
                    class="flex items-center justify-between bg-slate-50/50 p-1.5 rounded-2xl border border-slate-100 overflow-x-auto no-scrollbar gap-1.5">
                    <!-- Pills will be injected here -->
                </div>
            </div>

            <!-- Footer Controls -->
            <div class="p-6 border-t border-slate-50 bg-white flex gap-3">
                <button id="btnPrevMateri" onclick="prevMateriSlide()"
                    class="flex-1 py-3.5 rounded-2xl bg-slate-50 text-slate-400 font-bold text-xs transition-all invisible">Kembali</button>
                <button id="btnNextMateri" onclick="nextMateriSlide()"
                    class="flex-[3] py-3.5 rounded-2xl bg-emerald-500 text-white font-bold text-xs shadow-lg shadow-emerald-500/20 active:scale-95">Selanjutnya</button>
                <button id="btnFinishMateri" onclick="settleMateri()"
                    class="flex-[3] py-3.5 rounded-2xl bg-emerald-600 text-white font-bold text-xs shadow-lg shadow-emerald-500/30 transition-all active:scale-95 hidden">Selesaikan
                    Materi</button>
            </div>
        </div>
    </div>

    <!-- MODAL VIDEO PEMBELAJARAN -->
    <div id="modalVideo"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="p-8 border-b flex justify-between items-center bg-red-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-red-500 text-white flex items-center justify-center shadow-lg shadow-red-200">
                        <span class="material-symbols-outlined !text-2xl">play_circle</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">Video Pembelajaran</h3>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Tonton semua &
                            ringkas</p>
                    </div>
                </div>
                <button onclick="closeVideoModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Content -->
            <div id="videoItemsContainer" class="p-6 overflow-y-auto no-scrollbar flex-1 space-y-6">
                <!-- Video items will be injected here -->
                <div id="videoDynamicItems" class="space-y-6"></div>

                <!-- Ringkasan Form -->
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 space-y-3 relative">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-indigo-500 text-lg">edit_note</span>
                            <h4 class="text-sm font-black text-slate-800">Ringkasan Materi</h4>
                        </div>
                        <span id="videoWordCountDisplay"
                            class="text-[10px] font-bold text-red-500 bg-white/50 px-2 py-1 rounded-lg border border-red-100">0
                            / 50 kata</span>
                    </div>
                    <textarea id="videoSummaryInput" rows="4" oninput="updateVideoWordCount()"
                        class="w-full rounded-xl border-slate-200 text-sm focus:border-red-500 focus:ring-red-500 p-3"
                        placeholder="Tuliskan poin-poin penting dari video di atas (minimal 50 kata)..."></textarea>
                </div>

                <!-- Penilaian Fasil (Dynamic) -->
                <div id="videoStatusSection" class="hidden"></div>

                <!-- Placeholder Penilaian (Hidden if logic above works) -->
                <div id="videoFeedbackPlaceholder"
                    class="bg-amber-50 p-4 rounded-2xl border border-amber-100 flex flex-col items-center gap-2">
                    <p class="text-[10px] font-bold text-amber-700 uppercase tracking-widest">Penilaian Fasilitator
                    </p>
                    <div class="flex gap-1">
                        <span class="material-symbols-outlined text-slate-300 text-2xl">star</span>
                        <span class="material-symbols-outlined text-slate-300 text-2xl">star</span>
                        <span class="material-symbols-outlined text-slate-300 text-2xl">star</span>
                        <span class="material-symbols-outlined text-slate-300 text-2xl">star</span>
                        <span class="material-symbols-outlined text-slate-300 text-2xl">star</span>
                    </div>
                    <p class="text-[10px] text-slate-400">Akan dinilai setelah ringkasan dikirim</p>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-8 bg-white border-t">
                <button id="btnSubmitVideo" onclick="submitVideoLog()" disabled
                    class="w-full py-4 bg-slate-300 text-white rounded-2xl font-black shadow-none transition-all cursor-not-allowed">
                    Simpan Ringkasan & Selesai
                </button>
            </div>
        </div>
    </div>

    </div>

    <!-- MODAL ANALISIS PRODUK (REPLACING BEP) -->
    <div id="modalBEP"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
            <!-- Header -->
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-pink-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-amber-500 text-white flex items-center justify-center shadow-lg shadow-amber-200">
                        <span class="material-symbols-outlined !text-2xl">calculate</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">Analisis BEP</h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Kalkulasi & Simulasi
                        </p>
                    </div>
                </div>
                <button onclick="closeBEPModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>



            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto no-scrollbar bg-slate-50/30 relative">

                <!-- TAB 1: LAPORAN (GRADED) -->
                <div id="content-analisis-laporan" class="p-6 space-y-6">
                    <!-- Status Section (If Submitted) -->
                    <div id="analisisStatusSection" class="hidden"></div>

                    <!-- Form Container -->
                    <div id="analisisFormContainer">
                        <!-- 1. Identitas Produk -->
                        <div class="space-y-3">
                            <h4 class="text-xs font-black text-slate-700 uppercase flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm text-pink-500">inventory_2</span> 1.
                                Identitas Produk
                            </h4>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 mb-1">Nama Menu / Produk
                                    Utama</label>
                                <input type="text" id="input-nama-produk"
                                    class="w-full p-3 rounded-xl border border-slate-200 text-xs font-bold focus:border-pink-500 focus:ring-pink-500 outline-none"
                                    placeholder="Contoh: Es Kuwut Bali">
                            </div>
                        </div>

                        <!-- 2. Rincian Bahan (HPP) -->
                        <div class="space-y-3 pt-2">
                            <div class="flex justify-between items-center">
                                <h4 class="text-xs font-black text-slate-700 uppercase flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm text-pink-500">shopping_basket</span>
                                    2. HPP Makanan
                                </h4>
                                <button onclick="addIngredientRow()"
                                    class="text-[10px] font-bold text-pink-500 bg-pink-50 px-2 py-1 rounded-lg border border-pink-100 hover:bg-pink-100">+
                                    Tambah</button>
                            </div>
                            <div class="bg-white p-3 rounded-2xl border border-slate-200 shadow-sm">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr class="text-[9px] text-slate-400 uppercase border-b border-slate-100">
                                            <th class="pb-2 pl-1 font-bold">Nama Bahan</th>
                                            <th class="pb-2 font-bold w-24">Harga (Rp)</th>
                                            <th class="pb-2 w-6"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="ingredients-table-body">
                                        <!-- Dynamic Rows -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="border-t border-slate-100">
                                            <td class="pt-2 pl-1 text-[10px] font-bold text-slate-600">Total HPP Makanan
                                            </td>
                                            <td class="pt-2 text-[10px] font-black text-pink-600"
                                                id="total-hpp-display">Rp 0</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>




                        <!-- 3. Bahan Baku Minuman (HPP) -->
                        <div class="space-y-3 pt-2">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 mb-1">Nama Minuman
                                    Utama</label>
                                <input type="text" id="input-nama-minuman"
                                    class="w-full p-3 rounded-xl border border-slate-200 text-xs font-bold focus:border-pink-500 focus:ring-pink-500 outline-none"
                                    placeholder="Contoh: Es Teh Manis / Thai Tea">
                            </div>
                            <div class="flex justify-between items-center pt-2">
                                <h4 class="text-xs font-black text-slate-700 uppercase flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm text-pink-500">local_bar</span>
                                    3. HPP Minuman
                                </h4>
                                <button onclick="addDrinkRow()"
                                    class="text-[10px] font-bold text-pink-500 bg-pink-50 px-2 py-1 rounded-lg border border-pink-100 hover:bg-pink-100">+
                                    Tambah</button>
                            </div>
                            <div class="bg-white p-3 rounded-2xl border border-slate-200 shadow-sm">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr class="text-[9px] text-slate-400 uppercase border-b border-slate-100">
                                            <th class="pb-2 pl-1 font-bold">Nama Bahan</th>
                                            <th class="pb-2 font-bold w-24">Harga (Rp)</th>
                                            <th class="pb-2 w-6"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="drinks-table-body">
                                        <!-- Dynamic Rows -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="border-t border-slate-100">
                                            <td class="pt-2 pl-1 text-[10px] font-bold text-slate-600">Total Minuman
                                            </td>
                                            <td class="pt-2 text-[10px] font-black text-pink-600"
                                                id="total-drinks-display">Rp 0</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- 4. Biaya Stand -->
                        <div class="space-y-3 pt-2">
                            <div class="flex justify-between items-center">
                                <h4 class="text-xs font-black text-slate-700 uppercase flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm text-pink-500">storefront</span> 4.
                                    HPP Biaya Stand Bazar
                                </h4>
                                <button onclick="addStandRow()"
                                    class="text-[10px] font-bold text-pink-500 bg-pink-50 px-2 py-1 rounded-lg border border-pink-100 hover:bg-pink-100">+
                                    Tambah</button>
                            </div>
                            <div class="bg-white p-3 rounded-2xl border border-slate-200 shadow-sm">
                                <table class="w-full text-left border-collapse">
                                    <tbody id="stand-table-body">
                                        <!-- Dynamic Rows -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="border-t border-slate-100">
                                            <td class="pt-2 pl-1 text-[10px] font-bold text-slate-600">Total Harga Stand
                                            </td>
                                            <td class="pt-2 text-[10px] font-black text-pink-600"
                                                id="total-stand-display">Rp 0</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- 5. LAPORAN PRE-ORDER (PO) [NEW] -->
                        <div class="space-y-4 pt-4 border-t border-slate-100">
                            <h4 class="text-xs font-black text-slate-700 uppercase flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm text-purple-500">shopping_cart</span> 5.
                                Laporan Pre-Order (PO)
                            </h4>

                            <div class="bg-purple-50 p-4 rounded-2xl border border-purple-100 space-y-4">
                                <p class="text-[10px] text-purple-700 font-medium">
                                    Masukkan jumlah pesanan (PO) yang sudah diterima dari konsumen.
                                </p>

                                <!-- PO Makanan -->
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Jml PO
                                            Makanan (Porsi)</label>
                                        <input type="text" id="input-po-makanan-qty"
                                            oninput="formatInputWithDots(this); calculatePO()"
                                            class="w-full p-2.5 rounded-xl border border-purple-200 text-sm font-black text-slate-700 focus:border-purple-500 outline-none bg-white"
                                            placeholder="0">
                                    </div>
                                    <div>
                                        <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Harga
                                            Jual / Porsi</label>
                                        <input type="text" id="input-po-makanan-harga"
                                            oninput="formatInputWithDots(this); calculatePO()"
                                            class="w-full p-2.5 rounded-xl border border-purple-200 text-sm font-black text-slate-700 focus:border-purple-500 outline-none bg-white"
                                            placeholder="Rp">
                                    </div>
                                </div>

                                <!-- PO Minuman -->
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Jml PO
                                            Minuman (Cup)</label>
                                        <input type="text" id="input-po-minuman-qty"
                                            oninput="formatInputWithDots(this); calculatePO()"
                                            class="w-full p-2.5 rounded-xl border border-purple-200 text-sm font-black text-slate-700 focus:border-purple-500 outline-none bg-white"
                                            placeholder="0">
                                    </div>
                                    <div>
                                        <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Harga
                                            Jual / Cup</label>
                                        <input type="text" id="input-po-minuman-harga"
                                            oninput="formatInputWithDots(this); calculatePO()"
                                            class="w-full p-2.5 rounded-xl border border-purple-200 text-sm font-black text-slate-700 focus:border-purple-500 outline-none bg-white"
                                            placeholder="Rp">
                                    </div>
                                </div>

                                <!-- Ringkasan PO -->
                                <div class="bg-white p-3 rounded-xl border border-purple-100 grid grid-cols-2 gap-3">
                                    <div>
                                        <p class="text-[9px] font-bold text-slate-400 uppercase mb-0.5">Total Item PO
                                        </p>
                                        <p class="text-sm font-black text-purple-700" id="display-total-po-qty">0 Item
                                        </p>
                                    </div>
                                    <div>
                                        <p class="text-[9px] font-bold text-slate-400 uppercase mb-0.5">Total Pemasukan
                                            PO</p>
                                        <p class="text-sm font-black text-purple-700" id="display-total-po-rp">Rp 0</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 6. RINGKASAN MODAL & BEP (EXISTING) -->
                        <div class="space-y-4 pt-4 border-t border-slate-100">
                            <h4 class="text-xs font-black text-slate-700 uppercase flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm text-pink-500">calculate</span> 6.
                                Ringkasan & BEP
                            </h4>

                            <div class="grid grid-cols-1 gap-3">
                                <!-- Simulasi Jual -->
                                <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                                    <!-- Makanan -->
                                    <div class="space-y-3 pb-3 border-b border-slate-100">
                                        <h5
                                            class="text-[10px] font-black text-pink-600 uppercase flex items-center gap-2">
                                            <span class="material-symbols-outlined text-sm">restaurant</span> Simulasi
                                            Makanan
                                        </h5>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label
                                                    class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Target
                                                    Produksi</label>
                                                <input type="text" id="input-target-makanan"
                                                    oninput="formatInputWithDots(this); calculateAnalisisTotal()"
                                                    class="w-full p-2.5 rounded-xl border border-slate-200 text-sm font-black text-slate-700 focus:border-pink-500 outline-none"
                                                    placeholder="Unit">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Harga
                                                    Jual</label>
                                                <input type="text" id="input-harga-makanan"
                                                    oninput="formatInputWithDots(this); calculateAnalisisTotal()"
                                                    class="w-full p-2.5 rounded-xl border border-slate-200 text-sm font-black text-slate-700 focus:border-pink-500 outline-none"
                                                    placeholder="Rp">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div class="p-2.5 bg-emerald-50 rounded-xl border border-emerald-100">
                                                <p class="text-[8px] font-bold text-emerald-600 uppercase mb-0.5">
                                                    Rekomendasi</p>
                                                <p class="text-xs font-black text-emerald-700" id="rek-harga-makanan">Rp
                                                    0</p>
                                            </div>
                                            <div class="p-2.5 bg-pink-50 rounded-xl border border-pink-100">
                                                <p class="text-[8px] font-bold text-pink-600 uppercase mb-0.5">BEP
                                                    (Unit)</p>
                                                <p class="text-xs font-black text-pink-700" id="bep-makanan">0 Unit</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Minuman -->
                                    <div class="space-y-3">
                                        <h5
                                            class="text-[10px] font-black text-blue-600 uppercase flex items-center gap-2">
                                            <span class="material-symbols-outlined text-sm">local_bar</span> Simulasi
                                            Minuman
                                        </h5>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label
                                                    class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Target
                                                    Produksi</label>
                                                <input type="text" id="input-target-minuman"
                                                    oninput="formatInputWithDots(this); calculateAnalisisTotal()"
                                                    class="w-full p-2.5 rounded-xl border border-slate-200 text-sm font-black text-slate-700 focus:border-blue-500 outline-none"
                                                    placeholder="Unit">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Harga
                                                    Jual</label>
                                                <input type="text" id="input-harga-minuman"
                                                    oninput="formatInputWithDots(this); calculateAnalisisTotal()"
                                                    class="w-full p-2.5 rounded-xl border border-slate-200 text-sm font-black text-slate-700 focus:border-blue-500 outline-none"
                                                    placeholder="Rp">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div class="p-2.5 bg-emerald-50 rounded-xl border border-emerald-100">
                                                <p class="text-[8px] font-bold text-emerald-600 uppercase mb-0.5">
                                                    Rekomendasi</p>
                                                <p class="text-xs font-black text-emerald-700" id="rek-harga-minuman">Rp
                                                    0</p>
                                            </div>
                                            <div class="p-2.5 bg-blue-50 rounded-xl border border-blue-100">
                                                <p class="text-[8px] font-bold text-blue-600 uppercase mb-0.5">BEP
                                                    (Unit)</p>
                                                <p class="text-xs font-black text-blue-700" id="bep-minuman">0 Unit</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="bep-info-box"
                                        class="p-3 bg-slate-50 rounded-xl border border-slate-200 hidden">
                                        <p class="text-[10px] text-slate-600 font-medium leading-relaxed"
                                            id="bep-description">
                                            *Biaya stand dibagi 2 untuk kalkulasi simulasi ini.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="pt-6 pb-2">
                            <button onclick="submitAnalisisProduk()" id="btnSubmitAnalisis"
                                class="w-full py-4 bg-pink-500 text-white rounded-2xl font-black shadow-lg shadow-pink-200 active:scale-95 transition-all">
                                Kirim Laporan
                            </button>
                            <p class="text-[10px] text-center text-slate-400 mt-3">Pastikan data sudah benar sebelum
                                dikirim.</p>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: SIMULASI (EXISTING CALCULATOR) -->
                <div id="content-analisis-simulasi" class="hidden p-6 bg-slate-50/30">
                    <!-- Calculator Inner Tabs -->
                    <div class="flex p-1 bg-slate-200 rounded-xl mb-4 gap-1">
                        <button onclick="switchBEPTab('makanan')" id="tab-bep-makanan"
                            class="flex-1 py-2 rounded-lg text-[10px] font-bold bg-white text-pink-600 shadow-sm transition-all">Makanan</button>
                        <button onclick="switchBEPTab('minuman')" id="tab-bep-minuman"
                            class="flex-1 py-2 rounded-lg text-[10px] font-bold text-slate-500 hover:text-slate-700 transition-all">Minuman</button>
                    </div>


                </div>

            </div>
        </div>

        <!-- MODAL LAPORAN AKHIR (DAY 3 NEW) -->
        <div id="modalLaporanAkhir"
            class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
            <div
                class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
                <!-- Header -->
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-emerald-50/50">
                    <div class="flex items-center gap-4">
                        <div
                            class="size-12 rounded-2xl bg-emerald-500 text-white flex items-center justify-center shadow-lg shadow-emerald-200">
                            <span class="material-symbols-outlined !text-2xl">receipt_long</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-black text-slate-800">Laporan Akhir</h3>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Evaluasi & Hasil
                                Bazaar</p>
                        </div>
                    </div>
                    <button onclick="closeLaporanAkhirModal()"
                        class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <!-- Content Area -->
                <div class="flex-1 overflow-y-auto no-scrollbar bg-slate-50/30 p-6 space-y-6">
                    <!-- Status Section (If Submitted) -->
                    <div id="laporanAkhirStatusSection" class="hidden"></div>

                    <!-- Form Container -->
                    <div id="laporanAkhirFormContainer" class="space-y-6">
                        <!-- 1. Data Penjualan -->
                        <div class="space-y-4">
                            <h4 class="text-xs font-black text-slate-700 uppercase flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm text-emerald-500">point_of_sale</span> 1.
                                Data Penjualan
                            </h4>
                            <div class="space-y-3 p-4 bg-white rounded-3xl border border-slate-100 shadow-sm">
                                <div>
                                    <label
                                        class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wider">Penjualan
                                        Makanan (Rp)</label>
                                    <input type="text" id="input-akhir-jual-makanan-rp"
                                        oninput="formatInputWithDots(this); calculateFinancials()"
                                        class="w-full p-3 rounded-xl border border-slate-100 text-sm font-black text-slate-700 focus:border-emerald-500 outline-none"
                                        placeholder="0">
                                </div>
                                <div>
                                    <label
                                        class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wider">Penjualan
                                        Minuman (Rp)</label>
                                    <input type="text" id="input-akhir-jual-minuman-rp"
                                        oninput="formatInputWithDots(this); calculateFinancials()"
                                        class="w-full p-3 rounded-xl border border-slate-100 text-sm font-black text-slate-700 focus:border-emerald-500 outline-none"
                                        placeholder="0">
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label
                                            class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wider">Harga
                                            Makanan (Rp)</label>
                                        <input type="text" id="input-akhir-harga-makanan"
                                            oninput="formatInputWithDots(this); calculateFinancials()"
                                            class="w-full p-3 rounded-xl border border-slate-100 text-sm font-black text-slate-700 focus:border-emerald-500 outline-none"
                                            placeholder="Ex: 10.000">
                                    </div>
                                    <div>
                                        <label
                                            class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wider">Harga
                                            Minuman (Rp)</label>
                                        <input type="text" id="input-akhir-harga-minuman"
                                            oninput="formatInputWithDots(this); calculateFinancials()"
                                            class="w-full p-3 rounded-xl border border-slate-100 text-sm font-black text-slate-700 focus:border-emerald-500 outline-none"
                                            placeholder="Ex: 5.000">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Data Biaya -->
                        <div class="space-y-4 pt-2">
                            <h4 class="text-xs font-black text-slate-700 uppercase flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm text-emerald-500">payments</span> 2.
                                Data Biaya
                            </h4>
                            <div class="space-y-4 p-4 bg-white rounded-3xl border border-slate-100 shadow-sm">
                                <!-- Makanan Cost -->
                                <div class="space-y-2">
                                    <p class="text-[9px] font-black text-emerald-500 uppercase tracking-widest">Produksi
                                        Makanan</p>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label
                                                class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Total
                                                Biaya (Bahan+Kemas)</label>
                                            <input type="text" id="input-akhir-biaya-prod-makan"
                                                oninput="formatInputWithDots(this); calculateFinancials()"
                                                class="w-full p-3 rounded-xl border border-slate-100 text-sm font-black text-slate-700 focus:border-emerald-500 outline-none"
                                                placeholder="0">
                                        </div>
                                        <div>
                                            <label
                                                class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Jumlah
                                                Porsi Dibuat</label>
                                            <input type="text" id="input-akhir-qty-makan"
                                                oninput="formatInputWithDots(this); calculateFinancials()"
                                                class="w-full p-3 rounded-xl border border-slate-100 text-sm font-black text-slate-700 focus:border-emerald-500 outline-none"
                                                placeholder="Qty">
                                        </div>
                                    </div>
                                    <p class="text-[9px] text-slate-400 italic">Otomatis biaya per porsi: <span
                                            id="display-var-makanan" class="font-bold text-slate-600">Rp 0</span></p>
                                </div>

                                <div class="h-px bg-slate-50"></div>

                                <!-- Minuman Cost -->
                                <div class="space-y-2">
                                    <p class="text-[9px] font-black text-blue-500 uppercase tracking-widest">Produksi
                                        Minuman</p>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label
                                                class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Total
                                                Biaya (Bahan+Kemas)</label>
                                            <input type="text" id="input-akhir-biaya-prod-minum"
                                                oninput="formatInputWithDots(this); calculateFinancials()"
                                                class="w-full p-3 rounded-xl border border-slate-100 text-sm font-black text-slate-700 focus:border-emerald-500 outline-none"
                                                placeholder="0">
                                        </div>
                                        <div>
                                            <label
                                                class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Jumlah
                                                Cup Dibuat</label>
                                            <input type="text" id="input-akhir-qty-minum"
                                                oninput="formatInputWithDots(this); calculateFinancials()"
                                                class="w-full p-3 rounded-xl border border-slate-100 text-sm font-black text-slate-700 focus:border-emerald-500 outline-none"
                                                placeholder="Qty">
                                        </div>
                                    </div>
                                    <p class="text-[9px] text-slate-400 italic">Otomatis biaya per cup: <span
                                            id="display-var-minuman" class="font-bold text-slate-600">Rp 0</span></p>
                                </div>

                                <div class="h-px bg-slate-50"></div>

                                <!-- Fixed Cost -->
                                <div>
                                    <label
                                        class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wider">Biaya
                                        Tetap / Sewa Stand Booth (Rp)</label>
                                    <input type="text" id="input-akhir-biaya-tetap"
                                        oninput="formatInputWithDots(this); calculateFinancials()"
                                        class="w-full p-3 rounded-xl border border-slate-100 text-sm font-black text-slate-700 focus:border-emerald-500 outline-none"
                                        placeholder="0">
                                </div>
                            </div>
                        </div>

                        <!-- 3. Hasil Analisis Finansial -->
                        <div id="laporanAkhirResultCard" class="space-y-4 pt-2 hidden">
                            <h4 class="text-xs font-black text-slate-700 uppercase flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm text-emerald-500">analytics</span> 3.
                                Ringkasan Hasil
                            </h4>

                            <!-- Sales & Cost Summary -->
                            <div class="grid grid-cols-2 gap-3">
                                <div class="p-4 bg-blue-50 rounded-3xl border border-blue-100">
                                    <p class="text-[9px] font-black text-blue-400 uppercase tracking-widest mb-1">
                                        Total
                                        Penjualan</p>
                                    <p class="text-sm font-black text-blue-700" id="res-total-penjualan">Rp 0</p>
                                </div>
                                <div class="p-4 bg-orange-50 rounded-3xl border border-orange-100">
                                    <p class="text-[9px] font-black text-orange-400 uppercase tracking-widest mb-1">
                                        Total Biaya</p>
                                    <p class="text-sm font-black text-orange-700" id="res-total-biaya">Rp 0</p>
                                </div>
                            </div>

                            <!-- Laba Rugi Card -->
                            <div id="laba-rugi-card"
                                class="p-5 rounded-[2rem] border bg-white shadow-sm flex flex-col items-center justify-center text-center">
                                <span id="res-laba-rugi-status"
                                    class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest mb-2 bg-slate-100 text-slate-400">STATUS</span>
                                <h2 class="text-2xl font-black" id="res-laba-rugi-value">Rp 0</h2>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">
                                    Estimasi
                                    Laba / Rugi</p>
                            </div>

                            <!-- BEP Analysis -->
                            <div class="space-y-3 p-4 bg-emerald-50 rounded-3xl border border-emerald-100">
                                <p
                                    class="text-[10px] font-black text-emerald-600 uppercase tracking-widest text-center mb-2">
                                    Break Even Point (BEP)</p>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="text-center">
                                        <p class="text-[9px] font-bold text-emerald-500 uppercase">BEP Unit</p>
                                        <p class="text-sm font-black text-emerald-700" id="res-bep-unit">0 Unit</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-[9px] font-bold text-emerald-500 uppercase">BEP Rupiah</p>
                                        <p class="text-sm font-black text-emerald-700" id="res-bep-rp">Rp 0</p>
                                    </div>
                                </div>
                                <div id="res-bep-status-box" class="mt-2 p-2 bg-white/50 rounded-xl text-center">
                                    <p class="text-[10px] font-black uppercase tracking-tight" id="res-bep-keterangan">-
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="pt-4 pb-2 space-y-3">
                            <button onclick="calculateFinancials(true)"
                                class="w-full py-3 bg-white text-emerald-600 border-2 border-emerald-500 rounded-2xl font-black active:scale-95 transition-all text-xs">
                                <span
                                    class="material-symbols-outlined text-sm inline-block translate-y-0.5">calculate</span>
                                Hitung Hasil
                            </button>

                            <button onclick="submitLaporanAkhir()" id="btnSubmitLaporanAkhir"
                                class="w-full py-4 bg-emerald-500 text-white rounded-2xl font-black shadow-lg shadow-emerald-200 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                Kirim Laporan Akhir
                            </button>
                            <p class="text-[10px] text-center text-slate-400 mt-3 font-medium">Laporan ini akan
                                dievaluasi oleh Fasilitator.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL LKPD DIGITAL (NEW) -->
    <div id="modalLKPD"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="p-6 border-b flex justify-between items-center bg-orange-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-terracotta text-white flex items-center justify-center shadow-lg shadow-terracotta/30">
                        <span class="material-symbols-outlined !text-2xl">edit_note</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">LKPD Digital</h3>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Lembar Kerja
                            Peserta
                            Didik</p>
                    </div>
                </div>
                <button onclick="closeLKPDModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto no-scrollbar bg-slate-50/50 p-6">

                <!-- Stepper -->
                <div class="flex items-center justify-between mb-8 px-4 relative">
                    <div class="absolute top-1/2 left-0 w-full h-0.5 bg-slate-200 -translate-y-1/2 z-0"></div>
                    <div id="lkpd-stepper-progress"
                        class="absolute top-1/2 left-0 h-0.5 bg-terracotta -translate-y-1/2 z-0 transition-all duration-300"
                        style="width: 0%"></div>

                    <button onclick="switchLKPD(1)" id="step-1"
                        class="size-8 rounded-full bg-terracotta text-white text-xs font-bold z-10 transition-all shadow-lg shadow-terracotta/20 relative">1</button>
                    <button onclick="switchLKPD(2)" id="step-2"
                        class="size-8 rounded-full bg-white border-2 border-slate-200 text-slate-400 text-xs font-bold z-10 transition-all relative">2</button>
                    <button onclick="switchLKPD(3)" id="step-3"
                        class="size-8 rounded-full bg-white border-2 border-slate-200 text-slate-400 text-xs font-bold z-10 transition-all relative">3</button>
                    <button onclick="switchLKPD(4)" id="step-4"
                        class="size-8 rounded-full bg-white border-2 border-slate-200 text-slate-400 text-xs font-bold z-10 transition-all relative">4</button>
                    <button onclick="switchLKPD(5)" id="step-5"
                        class="size-8 rounded-full bg-white border-2 border-slate-200 text-slate-400 text-xs font-bold z-10 transition-all relative">5</button>
                </div>

                <!-- Instruction Toggle -->
                <div class="mb-6">
                    <button onclick="document.getElementById('lkpdInstructions').classList.toggle('hidden')"
                        class="flex items-center gap-2 text-[11px] font-bold text-slate-500 hover:text-terracotta transition-colors">
                        <span class="material-symbols-outlined !text-base">info</span>
                        LIHAT PETUNJUK PENGERJAAN
                    </button>
                    <div id="lkpdInstructions"
                        class="hidden mt-3 p-4 bg-white rounded-2xl border border-slate-100 shadow-sm space-y-2">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Petunjuk:
                        </p>
                        <ul class="text-[11px] text-slate-600 space-y-1 ml-4 list-decimal font-medium">
                            <li>Kerjakan LKPD ini secara berkelompok</li>
                            <li>Bacalah materi tentang Jajanan Nusantara Sehat dengan cermat.</li>
                            <li>Amati video pembelajaran yang ditayangkan guru.</li>
                            <li>Diskusikan setiap pertanyaan bersama kelompok.</li>
                            <li>Tuliskan jawaban dengan jelas dan sistematis.</li>
                        </ul>
                    </div>
                </div>

                <!-- LKPD Section 1: Definisi & Budaya -->
                <div id="lkpd-section-1" class="lkpd-section space-y-6">
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm-soft">
                        <label class="block text-[11px] font-black text-slate-800 uppercase tracking-widest mb-3">1.
                            Pengertian Jajanan Nusantara</label>
                        <textarea id="lkpd1_q1" oninput="saveLKPDDraft()"
                            class="w-full min-h-[100px] p-4 bg-slate-50 border border-slate-100 rounded-2xl text-xs text-slate-700 focus:ring-2 focus:ring-terracotta/20 focus:border-terracotta outline-none transition-all placeholder:text-slate-300 font-medium"
                            placeholder="Tuliskan jawabanmu di sini..."></textarea>
                    </div>

                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm-soft">
                        <label class="block text-[11px] font-black text-slate-800 uppercase tracking-widest mb-4">2.
                            Sejarah dan Pengaruh Budaya</label>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Tiongkok -->
                            <div class="p-4 rounded-2xl bg-orange-50/30 border border-orange-100/50 space-y-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span
                                        class="size-6 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center text-[10px] font-bold">A</span>
                                    <span class="text-[11px] font-bold text-slate-700 uppercase">Tiongkok</span>
                                </div>
                                <div>
                                    <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Bentuk
                                        Pengaruh:</label>
                                    <input type="text" id="lkpd1_q2a_bentuk" oninput="saveLKPDDraft()"
                                        class="w-full p-2.5 bg-white border border-slate-100 rounded-xl text-[11px] focus:border-terracotta outline-none transition-all">
                                </div>
                                <div>
                                    <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Contoh
                                        Jajanan:</label>
                                    <input type="text" id="lkpd1_q2a_contoh" oninput="saveLKPDDraft()"
                                        class="w-full p-2.5 bg-white border border-slate-100 rounded-xl text-[11px] focus:border-terracotta outline-none transition-all">
                                </div>
                                <div>
                                    <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Bahan
                                        Utama:</label>
                                    <input type="text" id="lkpd1_q2a_bahan" oninput="saveLKPDDraft()"
                                        class="w-full p-2.5 bg-white border border-slate-100 rounded-xl text-[11px] focus:border-terracotta outline-none transition-all">
                                </div>
                            </div>

                            <!-- Eropa -->
                            <div class="p-4 rounded-2xl bg-indigo-50/30 border border-indigo-100/50 space-y-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span
                                        class="size-6 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center text-[10px] font-bold">B</span>
                                    <span class="text-[11px] font-bold text-slate-700 uppercase">Eropa /
                                        Kolonial</span>
                                </div>
                                <div>
                                    <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Bentuk
                                        Pengaruh:</label>
                                    <input type="text" id="lkpd1_q2b_bentuk" oninput="saveLKPDDraft()"
                                        class="w-full p-2.5 bg-white border border-slate-100 rounded-xl text-[11px] focus:border-terracotta outline-none transition-all">
                                </div>
                                <div>
                                    <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Contoh
                                        Jajanan:</label>
                                    <input type="text" id="lkpd1_q2b_contoh" oninput="saveLKPDDraft()"
                                        class="w-full p-2.5 bg-white border border-slate-100 rounded-xl text-[11px] focus:border-terracotta outline-none transition-all">
                                </div>
                                <div>
                                    <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Bahan
                                        Utama:</label>
                                    <input type="text" id="lkpd1_q2b_bahan" oninput="saveLKPDDraft()"
                                        class="w-full p-2.5 bg-white border border-slate-100 rounded-xl text-[11px] focus:border-terracotta outline-none transition-all">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sections for LKPD 2, 3, 4, 5 (Placeholders) -->
                <!-- LKPD 2: Analisis Atlas Kuliner -->
                <div id="lkpd-section-2" class="lkpd-section hidden animate-slide-up pb-8">
                    <div class="mb-6">
                        <h4 class="text-sm font-black text-slate-800 uppercase tracking-wider mb-2">LKPD 2: Analisis
                            Atlas Kuliner</h4>
                        <p class="text-[10px] text-slate-500 font-medium leading-relaxed">Perhatikan materi Atlas
                            Kuliner, kemudian lengkapi data berikut sesuai pemahaman kelompokmu!</p>
                    </div>

                    <div class="space-y-4">
                        <!-- Card Region Helper Function Context -->
                        <script>
                            function generateRegionCard(id, name, icon, colorClass, iconColor) {
                                return `
                                <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden group">
                                    <div class="px-5 py-3 ${colorClass} flex items-center gap-3 border-b border-white/50">
                                        <div class="size-8 rounded-full bg-white flex items-center justify-center ${iconColor} shadow-sm">
                                            <span class="material-symbols-outlined text-[18px]">${icon}</span>
                                        </div>
                                        <span class="text-xs font-black uppercase tracking-widest text-slate-700">${name}</span>
                                    </div>
                                    <div class="p-5 space-y-4 bg-slate-50/30">
                                        <div>
                                            <label class="block text-[9px] font-bold text-slate-400 mb-1.5 uppercase tracking-tighter">Contoh Jajanan:</label>
                                            <input type="text" id="lkpd2_${id}_contoh" oninput="saveLKPDDraft()" placeholder="Jawab..."
                                                class="w-full p-3 bg-white border border-slate-100 rounded-2xl text-[11px] font-medium focus:border-terracotta outline-none transition-all placeholder:text-slate-300">
                                        </div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-[9px] font-bold text-slate-400 mb-1.5 uppercase tracking-tighter">Bahan Utama:</label>
                                                <input type="text" id="lkpd2_${id}_bahan" oninput="saveLKPDDraft()" placeholder="Jawab..."
                                                    class="w-full p-3 bg-white border border-slate-100 rounded-2xl text-[11px] font-medium focus:border-terracotta outline-none transition-all placeholder:text-slate-300">
                                            </div>
                                            <div>
                                                <label class="block text-[9px] font-bold text-slate-400 mb-1.5 uppercase tracking-tighter">Cita Rasa:</label>
                                                <input type="text" id="lkpd2_${id}_rasa" oninput="saveLKPDDraft()" placeholder="Jawab..."
                                                    class="w-full p-3 bg-white border border-slate-100 rounded-2xl text-[11px] font-medium focus:border-terracotta outline-none transition-all placeholder:text-slate-300">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                `;
                            }
                        </script>

                        <!-- Region Sumatra -->
                        <div id="card-sumatra"></div>
                        <script>document.getElementById('card-sumatra').outerHTML = generateRegionCard('sumatra', 'Sumatra', 'landscape', 'bg-emerald-50', 'text-emerald-500');</script>

                        <!-- Region Jawa -->
                        <div id="card-jawa"></div>
                        <script>document.getElementById('card-jawa').outerHTML = generateRegionCard('jawa', 'Jawa', 'temple_hindu', 'bg-blue-50', 'text-blue-500');</script>

                        <!-- Region Sulawesi -->
                        <div id="card-sulawesi"></div>
                        <script>document.getElementById('card-sulawesi').outerHTML = generateRegionCard('sulawesi', 'Sulawesi', 'waves', 'bg-red-50', 'text-red-500');</script>

                        <!-- Region Bali -->
                        <div id="card-bali"></div>
                        <script>document.getElementById('card-bali').outerHTML = generateRegionCard('bali', 'Bali', 'surfing', 'bg-indigo-50', 'text-indigo-500');</script>

                        <!-- Region Papua -->
                        <div id="card-papua"></div>
                        <script>document.getElementById('card-papua').outerHTML = generateRegionCard('papua', 'Papua', 'forest', 'bg-orange-50', 'text-orange-500');</script>
                    </div>
                </div>
                <!-- ... repeat for 3, 4, 5 ... -->
                <!-- LKPD 3: Analisis Gizi & Bahan Utama -->
                <div id="lkpd-section-3" class="lkpd-section hidden animate-slide-up pb-8">
                    <div class="mb-6">
                        <h4 class="text-sm font-black text-slate-800 uppercase tracking-wider mb-2">LKPD 3: Analisis
                            Gizi & Bahan Utama</h4>
                        <p class="text-[10px] text-slate-500 font-medium leading-relaxed">Analisis kandungan gizi
                            dan
                            manfaat bahan tradisional berikut berdasarkan materi yang telah dipelajari.</p>
                    </div>

                    <div class="space-y-5">
                        <script>
                            function generateNutrientCard(num, question, id) {
                                return `
                                <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden group">
                                    <div class="px-5 py-3 bg-emerald-50/50 flex items-center gap-3 border-b border-white/50">
                                        <div class="size-8 rounded-full bg-white flex items-center justify-center text-emerald-500 shadow-sm">
                                            <span class="text-[10px] font-black">${num}</span>
                                        </div>
                                        <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">Pertanyaan ${num}</span>
                                    </div>
                                    <div class="p-5 bg-slate-50/30">
                                        <label class="block text-[10px] font-bold text-slate-500 mb-2 leading-relaxed">${question}</label>
                                        <textarea id="lkpd3_q${num}" oninput="saveLKPDDraft()" placeholder="Jawab..."
                                            class="w-full min-h-[80px] p-4 bg-white border border-slate-100 rounded-2xl text-xs text-slate-700 focus:border-terracotta outline-none transition-all placeholder:text-slate-300 font-medium"></textarea>
                                    </div>
                                </div>`;
                            }
                        </script>

                        <div id="lkpd3-questions-container"></div>
                        <script>
                            const lkpd3Questions = [
                                "Sebutkan 3 jenis bahan lokal yang menjadi sumber karbohidrat utama dalam jajanan Nusantara!",
                                "Mengapa bahan umbi-umbian (singkong/sagu) lebih unggul seratnya dibanding tepung terigu?",
                                "Identifikasi zat gizi utama pada Bika Ambon berdasarkan bahan penyusunnya!",
                                "Apa peran kelapa parut dalam memberikan serat pada jajanan Jawa Barat?",
                                "Jelaskan manfaat gizi utama dari penggunaan kacang hijau pada jajanan Yogyakarta!",
                                "Sebutkan mineral penting dalam pisang (Sulawesi Selatan) yang bermanfaat bagi tubuh!",
                                "Apa keunggulan pati sagu alami (Papua) bagi kesehatan, khususnya terkait gluten?",
                                "Jelaskan perbedaan manfaat gula aren dibanding gula pasir!",
                                "Bagaimana cara meningkatkan nilai gizi panada menggunakan sayuran?",
                                "Apa kontribusi gizi dari penggunaan santan/kelapa selain sebagai pemberi rasa gurih?"
                            ];
                            let lkpd3Html = '';
                            lkpd3Questions.forEach((q, i) => {
                                lkpd3Html += generateNutrientCard(i + 1, q, `lkpd3_q${i + 1}`);
                            });
                            document.getElementById('lkpd3-questions-container').outerHTML = lkpd3Html;
                        </script>
                    </div>
                </div>
                <!-- LKPD 4: Inovasi Jajanan Nusantara -->
                <div id="lkpd-section-4" class="lkpd-section hidden animate-slide-up pb-8">
                    <div class="mb-6">
                        <h4 class="text-sm font-black text-slate-800 uppercase tracking-wider mb-2">LKPD 4: Inovasi
                            Jajanan Nusantara</h4>
                        <p class="text-[10px] text-slate-500 font-medium leading-relaxed">Rancanglah inovasi jajanan
                            (makanan & minuman) Nusantara untuk kegiatan bazar sekolah!</p>
                    </div>

                    <div class="space-y-8">
                        <!-- BAGIAN MAKANAN -->
                        <div class="space-y-5">
                            <div class="flex items-center gap-3 border-b border-orange-100 pb-2">
                                <span class="material-symbols-outlined text-orange-500">restaurant</span>
                                <h5 class="text-xs font-black text-slate-700 uppercase tracking-widest">A. Inovasi
                                    Makanan</h5>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Nama Makanan -->
                                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                    <label
                                        class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                        <span class="material-symbols-outlined !text-sm">label</span> Nama Makanan
                                    </label>
                                    <input type="text" id="lkpd4_m_nama" oninput="saveLKPDDraft()"
                                        placeholder="Nama inovasi makanan..."
                                        class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-orange-400 outline-none transition-all">
                                </div>
                                <!-- Asal Daerah -->
                                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                    <label
                                        class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                        <span class="material-symbols-outlined !text-sm">location_on</span> Asal
                                        Daerah
                                    </label>
                                    <input type="text" id="lkpd4_m_asal" oninput="saveLKPDDraft()"
                                        placeholder="Asal daerah makanan..."
                                        class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-orange-400 outline-none transition-all">
                                </div>
                            </div>

                            <div class="space-y-4">
                                <!-- Grid Kolom 3 & 4: Bahan & Gizi -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">shopping_basket</span>
                                            Bahan Utama
                                        </label>
                                        <textarea id="lkpd4_m_bahan" oninput="saveLKPDDraft()"
                                            placeholder="Daftar bahan utama..."
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-orange-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">nutrition</span>
                                            Informasi
                                            Gizi
                                        </label>
                                        <textarea id="lkpd4_m_gizi" oninput="saveLKPDDraft()"
                                            placeholder="Kandungan gizi..."
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-orange-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                </div>

                                <!-- Grid Kolom 5 & 6: Metode & Keunggulan -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">cooking</span> Metode
                                            Pengolahan
                                        </label>
                                        <textarea id="lkpd4_m_metode" oninput="saveLKPDDraft()"
                                            placeholder="Cara mengolah..."
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-orange-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">workspace_premium</span>
                                            Keunggulan Produk
                                        </label>
                                        <textarea id="lkpd4_m_keunggulan" oninput="saveLKPDDraft()"
                                            placeholder="Apa keunggulan makanan ini?"
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-orange-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                </div>

                                <!-- Grid Kolom 7 & 8: Teknologi Pemasaran & Inovasi -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">ads_click</span>
                                            Teknologi
                                            Pemasaran
                                        </label>
                                        <textarea id="lkpd4_m_pemasaran" oninput="saveLKPDDraft()"
                                            placeholder="Strategi pemasaran digital/modern..."
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-orange-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">lightbulb</span>
                                            Inovasi
                                            Makanan
                                        </label>
                                        <textarea id="lkpd4_m_inovasi" oninput="saveLKPDDraft()"
                                            placeholder="Apa sentuhan inovasi barunya?"
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-orange-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN MINUMAN -->
                        <div class="space-y-5 pt-4">
                            <div class="flex items-center gap-3 border-b border-blue-100 pb-2">
                                <span class="material-symbols-outlined text-blue-500">local_drink</span>
                                <h5 class="text-xs font-black text-slate-700 uppercase tracking-widest">B. Inovasi
                                    Minuman</h5>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Nama Minuman -->
                                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                    <label
                                        class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                        <span class="material-symbols-outlined !text-sm">label</span> Nama Minuman
                                    </label>
                                    <input type="text" id="lkpd4_d_nama" oninput="saveLKPDDraft()"
                                        placeholder="Nama inovasi minuman..."
                                        class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-blue-400 outline-none transition-all">
                                </div>
                                <!-- Asal Daerah -->
                                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                    <label
                                        class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                        <span class="material-symbols-outlined !text-sm">location_on</span> Asal
                                        Daerah
                                    </label>
                                    <input type="text" id="lkpd4_d_asal" oninput="saveLKPDDraft()"
                                        placeholder="Asal daerah minuman..."
                                        class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-blue-400 outline-none transition-all">
                                </div>
                            </div>

                            <div class="space-y-4">
                                <!-- Grid Kolom 3 & 4: Bahan & Gizi -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">shopping_basket</span>
                                            Bahan Utama
                                        </label>
                                        <textarea id="lkpd4_d_bahan" oninput="saveLKPDDraft()"
                                            placeholder="Daftar bahan utama..."
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-blue-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">nutrition</span>
                                            Informasi
                                            Gizi
                                        </label>
                                        <textarea id="lkpd4_d_gizi" oninput="saveLKPDDraft()"
                                            placeholder="Kandungan gizi..."
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-blue-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                </div>

                                <!-- Grid Kolom 5 & 6: Metode & Keunggulan -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">cooking</span> Metode
                                            Pengolahan
                                        </label>
                                        <textarea id="lkpd4_d_metode" oninput="saveLKPDDraft()"
                                            placeholder="Cara mengolah..."
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-blue-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">workspace_premium</span>
                                            Keunggulan Produk
                                        </label>
                                        <textarea id="lkpd4_d_keunggulan" oninput="saveLKPDDraft()"
                                            placeholder="Apa keunggulan minuman ini?"
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-blue-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                </div>

                                <!-- Kolom 7: Teknologi Pemasaran -->
                                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                    <label
                                        class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                        <span class="material-symbols-outlined !text-sm">ads_click</span> Teknologi
                                        Pemasaran
                                    </label>
                                    <textarea id="lkpd4_d_pemasaran" oninput="saveLKPDDraft()"
                                        placeholder="Strategi pemasaran digital/modern..."
                                        class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-blue-400 outline-none transition-all resize-none"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN C. INOVASI BAZAR -->
                        <div class="space-y-5 pt-4">
                            <div class="flex items-center gap-3 border-b border-purple-100 pb-2">
                                <span class="material-symbols-outlined text-purple-500">storefront</span>
                                <h5 class="text-xs font-black text-slate-700 uppercase tracking-widest">C. Inovasi
                                    Bazar
                                </h5>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Alat -->
                                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                    <label
                                        class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                        <span class="material-symbols-outlined !text-sm">construction</span> Alat
                                    </label>
                                    <textarea id="lkpd4_b_alat" oninput="saveLKPDDraft()"
                                        placeholder="Daftar alat untuk booth..."
                                        class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-purple-400 outline-none transition-all resize-none"></textarea>
                                </div>
                                <!-- Bahan -->
                                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                    <label
                                        class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                        <span class="material-symbols-outlined !text-sm">inventory_2</span> Bahan
                                    </label>
                                    <textarea id="lkpd4_b_bahan" oninput="saveLKPDDraft()"
                                        placeholder="Daftar bahan dekorasi/booth..."
                                        class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-purple-400 outline-none transition-all resize-none"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="lkpd-section-5" class="lkpd-section hidden animate-slide-up pb-8">
                    <div class="mb-6">
                        <h4 class="text-sm font-black text-slate-800 uppercase tracking-wider mb-2">LKPD 5: Desain &
                            Sketsa</h4>
                        <p class="text-[10px] text-slate-500 font-medium leading-relaxed">
                            Silakan unggah visualisasi ide rancangan produk Makanan, Minuman, dan Booth Bazar yang
                            telah
                            kalian rancang sebelumnya di LKPD 4.
                            Hasil karya dapat berupa foto, ilustrasi digital, atau sketsa tangan.
                        </p>
                    </div>

                    <div class="space-y-6">
                        <!-- 1. Desain Makanan -->
                        <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden group">
                            <div
                                class="px-5 py-3 bg-orange-50/50 flex items-center gap-3 border-b border-orange-100/50">
                                <div
                                    class="size-8 rounded-full bg-white flex items-center justify-center text-orange-500 shadow-sm">
                                    <span class="material-symbols-outlined text-[18px]">restaurant_menu</span>
                                </div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">1.
                                    Desain
                                    Inovasi Makanan</span>
                            </div>
                            <div class="p-5 bg-slate-50/30 text-center">
                                <div id="lkpd5-preview-container-food"
                                    class="hidden mb-4 relative w-full h-48 bg-slate-100 rounded-2xl overflow-hidden border border-slate-200">
                                    <img id="lkpd5-preview-img-food" src="" class="w-full h-full object-cover">
                                    <div
                                        class="absolute bottom-2 right-2 bg-emerald-500 text-white text-[9px] font-bold px-2 py-1 rounded-lg shadow-sm">
                                        Terupload
                                    </div>
                                    <button onclick="removeLKPD5Image('food')"
                                        class="absolute top-2 right-2 size-8 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-red-600 transition-all z-10">
                                        <span class="material-symbols-outlined text-sm">delete</span>
                                    </button>
                                </div>

                                <div id="lkpd5-upload-ui-food">
                                    <input type="file" id="lkpd5-file-food" accept="image/*" class="hidden"
                                        onchange="handleLKPDUpload('food', event)">
                                    <label for="lkpd5-file-food"
                                        class="w-full py-4 bg-white border-2 border-dashed border-orange-200 text-orange-500 rounded-2xl font-bold text-xs flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-orange-50 transition-all active:scale-95">
                                        <span class="material-symbols-outlined text-3xl">add_photo_alternate</span>
                                        <span>Pilih Foto Sketsa Makanan</span>
                                    </label>
                                    <p class="text-[9px] text-slate-400 mt-2">Format: JPG/PNG. Maks 5MB.</p>
                                </div>
                                <div id="lkpd5-status-food"
                                    class="hidden mt-3 text-[10px] font-bold text-slate-500 animate-pulse">
                                    Menyiapkan...
                                </div>
                            </div>
                        </div>

                        <!-- 2. Desain Minuman -->
                        <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden group">
                            <div class="px-5 py-3 bg-blue-50/50 flex items-center gap-3 border-b border-blue-100/50">
                                <div
                                    class="size-8 rounded-full bg-white flex items-center justify-center text-blue-500 shadow-sm">
                                    <span class="material-symbols-outlined text-[18px]">local_bar</span>
                                </div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">2.
                                    Desain
                                    Inovasi Minuman</span>
                            </div>
                            <div class="p-5 bg-slate-50/30 text-center">
                                <div id="lkpd5-preview-container-drink"
                                    class="hidden mb-4 relative w-full h-48 bg-slate-100 rounded-2xl overflow-hidden border border-slate-200">
                                    <img id="lkpd5-preview-img-drink" src="" class="w-full h-full object-cover">
                                    <div
                                        class="absolute bottom-2 right-2 bg-emerald-500 text-white text-[9px] font-bold px-2 py-1 rounded-lg shadow-sm">
                                        Terupload
                                    </div>
                                    <button onclick="removeLKPD5Image('drink')"
                                        class="absolute top-2 right-2 size-8 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-red-600 transition-all z-10">
                                        <span class="material-symbols-outlined text-sm">delete</span>
                                    </button>
                                </div>

                                <div id="lkpd5-upload-ui-drink">
                                    <input type="file" id="lkpd5-file-drink" accept="image/*" class="hidden"
                                        onchange="handleLKPDUpload('drink', event)">
                                    <label for="lkpd5-file-drink"
                                        class="w-full py-4 bg-white border-2 border-dashed border-blue-200 text-blue-500 rounded-2xl font-bold text-xs flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-blue-50 transition-all active:scale-95">
                                        <span class="material-symbols-outlined text-3xl">add_photo_alternate</span>
                                        <span>Pilih Foto Sketsa Minuman</span>
                                    </label>
                                    <p class="text-[9px] text-slate-400 mt-2">Format: JPG/PNG. Maks 5MB.</p>
                                </div>
                                <div id="lkpd5-status-drink"
                                    class="hidden mt-3 text-[10px] font-bold text-slate-500 animate-pulse">
                                    Menyiapkan...
                                </div>
                            </div>
                        </div>

                        <!-- 3. Desain Booth -->
                        <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden group">
                            <div
                                class="px-5 py-3 bg-purple-50/50 flex items-center gap-3 border-b border-purple-100/50">
                                <div
                                    class="size-8 rounded-full bg-white flex items-center justify-center text-purple-500 shadow-sm">
                                    <span class="material-symbols-outlined text-[18px]">storefront</span>
                                </div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">3.
                                    Desain
                                    Booth Bazar</span>
                            </div>
                            <div class="p-5 bg-slate-50/30 text-center">
                                <div id="lkpd5-preview-container-booth"
                                    class="hidden mb-4 relative w-full h-48 bg-slate-100 rounded-2xl overflow-hidden border border-slate-200">
                                    <img id="lkpd5-preview-img-booth" src="" class="w-full h-full object-cover">
                                    <div
                                        class="absolute bottom-2 right-2 bg-emerald-500 text-white text-[9px] font-bold px-2 py-1 rounded-lg shadow-sm">
                                        Terupload
                                    </div>
                                    <button onclick="removeLKPD5Image('booth')"
                                        class="absolute top-2 right-2 size-8 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-red-600 transition-all z-10">
                                        <span class="material-symbols-outlined text-sm">delete</span>
                                    </button>
                                </div>

                                <div id="lkpd5-upload-ui-booth">
                                    <input type="file" id="lkpd5-file-booth" accept="image/*" class="hidden"
                                        onchange="handleLKPDUpload('booth', event)">
                                    <label for="lkpd5-file-booth"
                                        class="w-full py-4 bg-white border-2 border-dashed border-purple-200 text-purple-500 rounded-2xl font-bold text-xs flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-purple-50 transition-all active:scale-95">
                                        <span class="material-symbols-outlined text-3xl">add_photo_alternate</span>
                                        <span>Pilih Foto Sketsa Booth</span>
                                    </label>
                                    <p class="text-[9px] text-slate-400 mt-2">Format: JPG/PNG. Maks 5MB.</p>
                                </div>
                                <div id="lkpd5-status-booth"
                                    class="hidden mt-3 text-[10px] font-bold text-slate-500 animate-pulse">
                                    Menyiapkan...
                                </div>
                            </div>
                        </div>

                        <!-- 4. Desain Pemasaran -->
                        <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden group">
                            <div class="px-5 py-3 bg-rose-50/50 flex items-center gap-3 border-b border-rose-100/50">
                                <div
                                    class="size-8 rounded-full bg-white flex items-center justify-center text-rose-500 shadow-sm">
                                    <span class="material-symbols-outlined text-[18px]">campaign</span>
                                </div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">4.
                                    Desain
                                    Teknologi Pemasaran</span>
                            </div>
                            <div class="p-5 bg-slate-50/30 text-center">
                                <div id="lkpd5-preview-container-marketing"
                                    class="hidden mb-4 relative w-full h-48 bg-slate-100 rounded-2xl overflow-hidden border border-slate-200">
                                    <img id="lkpd5-preview-img-marketing" src="" class="w-full h-full object-cover">
                                    <div
                                        class="absolute bottom-2 right-2 bg-emerald-500 text-white text-[9px] font-bold px-2 py-1 rounded-lg shadow-sm">
                                        Terupload
                                    </div>
                                    <button onclick="removeLKPD5Image('marketing')"
                                        class="absolute top-2 right-2 size-8 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-red-600 transition-all z-10">
                                        <span class="material-symbols-outlined text-sm">delete</span>
                                    </button>
                                </div>

                                <div id="lkpd5-upload-ui-marketing">
                                    <input type="file" id="lkpd5-file-marketing" accept="image/*" class="hidden"
                                        onchange="handleLKPDUpload('marketing', event)">
                                    <label for="lkpd5-file-marketing"
                                        class="w-full py-4 bg-white border-2 border-dashed border-rose-200 text-rose-500 rounded-2xl font-bold text-xs flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-rose-50 transition-all active:scale-95">
                                        <span class="material-symbols-outlined text-3xl">add_photo_alternate</span>
                                        <span>Pilih Flyer/Poster/Brosur</span>
                                    </label>
                                    <p class="text-[9px] text-slate-400 mt-2">Format: JPG/PNG. Maks 5MB.</p>
                                </div>
                                <div id="lkpd5-status-marketing"
                                    class="hidden mt-3 text-[10px] font-bold text-slate-500 animate-pulse">
                                    Menyiapkan...
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Feedback Section after submission -->
                <div id="lkpdStatusSection" class="hidden mt-6"></div>

            </div>

            <!-- Footer -->
            <div class="p-6 border-t bg-white flex items-center justify-between gap-4">
                <button id="btnPrevLKPD" onclick="prevLKPD()"
                    class="px-6 py-3 rounded-2xl border border-slate-200 text-slate-400 text-xs font-bold hover:bg-slate-50 transition-all opacity-0 pointer-events-none">
                    Sebelumnya
                </button>
                <div class="flex-1"></div>
                <button id="btnNextLKPD" onclick="nextLKPD()"
                    class="px-8 py-3 bg-terracotta text-white rounded-2xl text-xs font-bold shadow-lg shadow-terracotta/20 hover:scale-[1.02] transition-all">
                    Lanjut ke LKPD 2
                </button>
                <button id="btnSubmitLKPDAll" onclick="submitLKPDTotal()"
                    class="hidden px-8 py-3 bg-emerald-500 text-white rounded-2xl text-xs font-bold shadow-lg shadow-emerald-200 hover:scale-[1.02] transition-all">
                    Kirim Semua LKPD
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL ASSESSMENT (REPLACEMENT) -->
    <div id="modalAssessment"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="p-6 border-b flex justify-between items-center bg-indigo-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-indigo-500 text-white flex items-center justify-center shadow-lg shadow-indigo-200">
                        <span class="material-symbols-outlined !text-2xl">quiz</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">Assessment</h3>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Uji Pemahamanmu
                        </p>
                    </div>
                </div>
                <button onclick="closeAssessmentModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Content -->
            <div class="p-6 flex-1 overflow-y-auto no-scrollbar relative">
                <!-- Progress -->
                <div class="w-full bg-slate-100 h-2 rounded-full mb-2 overflow-hidden">
                    <div id="assessmentProgressBar" class="h-full bg-indigo-500 w-0 transition-all duration-300">
                    </div>
                </div>
                <p id="assessmentProgressText" class="text-[10px] text-slate-400 font-bold mb-6 text-right">Soal 1
                    dari
                    50</p>

                <!-- Question Container -->
                <div id="assessmentQuestionContainer" class="animate-slide-up">
                    <!-- Dynamic Question Content Here -->
                </div>

                <!-- Result Container (Hidden initially) -->
                <div id="assessmentResultContainer"
                    class="hidden flex-col items-center justify-center text-center space-y-6 py-10 animate-scale-up">
                    <div class="size-24 bg-amber-100 rounded-full flex items-center justify-center mb-2 mx-auto">
                        <span class="text-6xl">🏆</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-slate-800 mb-2">Luar Biasa!</h2>
                        <p class="text-xs text-slate-500">Kamu telah menyelesaikan assessment.</p>
                    </div>

                    <div id="resultStars" class="flex gap-2 justify-center">
                        <!-- Stars injected here -->
                    </div>

                    <p id="resultScoreText"
                        class="text-lg font-bold text-indigo-600 bg-indigo-50 px-6 py-2 rounded-2xl"></p>

                    <button onclick="closeAssessmentModal()"
                        class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition-all">
                        Tutup & Simpan
                    </button>
                </div>

                <!-- Navigation Button (Outside result) -->
                <button id="btnNextAssessment"
                    class="px-6 py-3 bg-indigo-500 text-white rounded-xl font-bold text-xs shadow-lg shadow-indigo-200 active:scale-95 transition-all w-full mt-6">
                    Selanjutnya
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DOKUMENTASI FOTO (REPLACEMENT RANGKUMAN) -->
    <div id="modalDokumentasi"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-8 border-b flex justify-between items-center bg-slate-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-indigo-500 text-white flex items-center justify-center shadow-lg shadow-indigo-200">
                        <span class="material-symbols-outlined !text-2xl">photo_camera</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">Dokumentasi Foto</h3>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Hanya 1
                            foto terbaik
                            setiap hari</p>
                    </div>
                </div>
                <button onclick="closeDokumentasiModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="p-8 overflow-y-auto no-scrollbar flex-1">
                <div id="docStatusMsg" class="hidden"></div>

                <!-- Upload Area -->
                <div id="docUploadArea" class="space-y-6">
                    <div
                        class="p-8 border-2 border-dashed border-slate-200 rounded-[2rem] bg-slate-50 flex flex-col items-center justify-center text-center group hover:border-indigo-400 transition-all cursor-pointer relative">
                        <input type="file" accept="image/*" onchange="handleDocPhotoSelection(event)"
                            class="absolute inset-0 opacity-0 cursor-pointer" id="docInput">
                        <div
                            class="size-16 rounded-full bg-white shadow-sm flex items-center justify-center text-indigo-500 mb-4 group-hover:scale-110 transition-transform">
                            <span class="material-symbols-outlined !text-3xl">add_photo_alternate</span>
                        </div>
                        <p class="text-sm font-bold text-slate-700">Upload Foto Kegiatan</p>
                        <p class="text-[11px] text-slate-400 mt-1">Pilih foto dari galeri atau kamera</p>
                    </div>

                    <div class="bg-amber-50 p-4 rounded-2xl border border-amber-100 flex gap-3">
                        <span class="material-symbols-outlined text-amber-500 text-lg">info</span>
                        <p class="text-[11px] text-amber-700 font-medium leading-relaxed">
                            Foto akan dikompresi otomatis untuk menghemat kuota. Pastikan objek foto
                            terlihat jelas.
                        </p>
                    </div>
                </div>

                <!-- Preview Area (shown after photo selected) -->
                <div id="docPreviewArea" class="hidden space-y-4">
                    <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100 flex gap-3">
                        <span class="material-symbols-outlined text-emerald-500 text-lg">check_circle</span>
                        <p class="text-[11px] text-emerald-700 font-bold">
                            Foto berhasil dipilih! Pastikan foto sudah benar sebelum mengirim.
                        </p>
                    </div>

                    <!-- Preview Image Container -->
                    <div class="bg-slate-100 rounded-2xl overflow-hidden border-4 border-white shadow-xl p-2">
                        <img id="docPreview" class="w-full rounded-xl"
                            style="display: block; min-height: 200px; max-height: 400px; object-fit: contain;" src=""
                            alt="Preview Foto">
                    </div>

                    <button onclick="changeDocPhoto()"
                        class="w-full py-4 bg-slate-100 text-slate-700 rounded-2xl font-bold hover:bg-slate-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-lg">sync</span>
                        Ganti Foto
                    </button>
                </div>
            </div>

            <div class="p-8 bg-slate-50 border-t">
                <button id="btnUploadDokumentasi" onclick="submitDokumentasi()"
                    class="w-full py-5 bg-indigo-500 text-white rounded-2xl font-black shadow-lg shadow-indigo-200 active:scale-95 transition-all disabled:opacity-50 disabled:active:scale-100">
                    Kirim Dokumentasi
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL PEMANTIK -->
    <div id="modalPemantik"
        class="fixed inset-0 z-[9999] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="p-8 border-b flex justify-between items-center bg-sky-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-sky-500 text-white flex items-center justify-center shadow-lg shadow-sky-200">
                        <span class="material-symbols-outlined !text-2xl">psychology_alt</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">Pertanyaan Pemantik</h3>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Pemanasan Sebelum
                            Mulai</p>
                    </div>
                </div>
                <button onclick="closePemantikModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Content -->
            <div class="p-8 overflow-y-auto no-scrollbar flex-1 space-y-6">
                <div class="p-4 rounded-2xl bg-sky-50 border border-sky-100">
                    <p class="text-xs text-slate-500" id="pemantikSubtitle">Jawab pertanyaan berikut untuk memulai
                        hari
                        ini.</p>
                </div>
                <div id="pemantikQuestionsContainer" class="space-y-4">
                    <!-- Dynamic Questions -->
                </div>
            </div>

            <!-- Footer -->
            <div class="p-8 bg-white border-t">
                <button id="btnSubmitPemantik" onclick="submitPemantik()"
                    class="w-full py-4 bg-sky-500 text-white rounded-2xl font-black shadow-lg shadow-sky-200 active:scale-95 transition-all">
                    Kirim Jawaban
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL GLOSARIUM (MOVED OUTSIDE) -->
    <div id="modalGlosarium"
        class="fixed inset-0 z-[9999] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="p-8 border-b flex justify-between items-center bg-emerald-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-emerald-500 text-white flex items-center justify-center shadow-lg shadow-emerald-200">
                        <span class="material-symbols-outlined !text-2xl">menu_book</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">Glosarium</h3>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Kamus Istilah
                            Penting</p>
                    </div>
                </div>
                <button onclick="closeGlosariumModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Content -->
            <div class="p-8 overflow-y-auto no-scrollbar flex-1 space-y-6">
                <!-- Glosarium Content from Draft -->
                <div class="space-y-6 text-sm text-slate-600 leading-relaxed font-medium">
                    <!-- A - E -->
                    <div class="space-y-4">
                        <h4
                            class="font-black text-emerald-800 uppercase tracking-widest text-xs border-b border-emerald-100 pb-2">
                            A - E</h4>
                        <div class="space-y-3">
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Air Fryer</p>
                                <p class="text-xs mt-1">Teknologi memasak modern menggunakan sirkulasi udara panas
                                    berkecepatan tinggi. Teknik ini memungkinkan pembuatan jajanan yang renyah
                                    (seperti tekstur gorengan) dengan penggunaan minyak yang sangat sedikit,
                                    sehingga lebih sehat dan rendah lemak.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Bahan Baku Lokal</p>
                                <p class="text-xs mt-1">Bahan pangan yang asli berasal dan tumbuh di lingkungan
                                    sekitar tempat produksi, seperti singkong, ubi, kelapa, dan gula aren.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Bandrek</p>
                                <p class="text-xs mt-1">Minuman tradisional khas Jawa Barat / Sunda yang terbuat
                                    dari campuran jahe, gula merah, dan rempah-rempah. Sering ditambahkan kerokan
                                    kelapa muda. Berfungsi menghangatkan tubuh.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Bika Ambon</p>
                                <p class="text-xs mt-1">Kue pipih berwarna kuning dengan tekstur berlubang-lubang
                                    (bersarang) khas Medan, Sumatera Utara. Terbuat dari tapioka, telur, gula, dan
                                    santan yang difermentasi.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Blending / Puree</p>
                                <p class="text-xs mt-1">Teknik menghaluskan bahan makanan (biasanya buah atau
                                    sayuran) menjadi bubur lembut. Digunakan untuk menyisipkan nutrisi sayuran/buah
                                    ke dalam adonan.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Eco-friendly Packaging</p>
                                <p class="text-xs mt-1">Kemasan ramah lingkungan yang materialnya mudah terurai di
                                    alam (biodegradable) atau dapat didaur ulang. Contoh: daun pisang, besek bambu.
                                </p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Elektrolit</p>
                                <p class="text-xs mt-1">Mineral bermuatan listrik (seperti natrium, kalium, kalsium)
                                    yang penting untuk fungsi tubuh. Air kelapa dan gula aren adalah sumber
                                    elektrolit alami.</p>
                            </div>
                        </div>
                    </div>

                    <!-- F - J -->
                    <div class="space-y-4">
                        <h4
                            class="font-black text-emerald-800 uppercase tracking-widest text-xs border-b border-emerald-100 pb-2">
                            F - J</h4>
                        <div class="space-y-3">
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Food-grade</p>
                                <p class="text-xs mt-1">Standar keamanan bahan (biasanya plastik atau kertas) yang
                                    menyatakan bahwa bahan tersebut aman untuk kontak langsung dengan makanan.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Fortifikasi Nutrisi</p>
                                <p class="text-xs mt-1">Upaya sengaja menambahkan mikronutrien (vitamin/mineral)
                                    atau bahan bergizi lain ke dalam makanan untuk meningkatkan kualitas gizinya.
                                </p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Gluten</p>
                                <p class="text-xs mt-1">Jenis protein yang ditemukan dalam gandum (terigu). Jajanan
                                    berbahan tepung beras/ketan/sagu biasanya bebas gluten.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Indeks Glikemik</p>
                                <p class="text-xs mt-1">Skala yang mengukur seberapa cepat makanan meningkatkan
                                    kadar gula darah. Gula aren memiliki indeks glikemik lebih rendah dari gula
                                    pasir.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Jajanan Nusantara</p>
                                <p class="text-xs mt-1">Kudapan atau makanan ringan tradisional yang berasal dari
                                    berbagai daerah di Indonesia, mencerminkan kearifan lokal.</p>
                            </div>
                        </div>
                    </div>

                    <!-- K - O -->
                    <div class="space-y-4">
                        <h4
                            class="font-black text-emerald-800 uppercase tracking-widest text-xs border-b border-emerald-100 pb-2">
                            K - O</h4>
                        <div class="space-y-3">
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Karbohidrat Kompleks</p>
                                <p class="text-xs mt-1">Jenis karbohidrat dengan rangkaian molekul panjang yang
                                    dicerna lebih lama, memberikan energi stabil dan rasa kenyang lebih lama
                                    (contoh: singkong, ubi).</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Klappertaart</p>
                                <p class="text-xs mt-1">Kue khas Manado yang dipengaruhi kuliner Belanda. Berbahan
                                    dasar kelapa muda, susu, telur, dan mentega.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Klepon</p>
                                <p class="text-xs mt-1">Jajanan pasar berbentuk bola-bola dari tepung beras ketan,
                                    diisi gula merah cair, dan digulingkan di atas kelapa parut.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Membakar / Memanggang (Tradisional)</p>
                                <p class="text-xs mt-1">Teknik mematangkan makanan di atas bara api, seringkali
                                    dengan perantara daun pisang untuk aroma *smoky*.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Mengukus (Steaming)</p>
                                <p class="text-xs mt-1">Teknik memasak menggunakan uap air mendidih. Metode sehat
                                    yang menjaga kelembapan dan nutrisi makanan.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Menyangrai (Roasting)</p>
                                <p class="text-xs mt-1">Teknik memasak kering di atas wajan tanpa minyak (misal:
                                    untuk kelapa parut atau kacang).</p>
                            </div>
                        </div>
                    </div>

                    <!-- P - T -->
                    <div class="space-y-4">
                        <h4
                            class="font-black text-emerald-800 uppercase tracking-widest text-xs border-b border-emerald-100 pb-2">
                            P - T</h4>
                        <div class="space-y-3">
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Protein Nabati</p>
                                <p class="text-xs mt-1">Protein dari tumbuhan (kacang-kacangan, kelapa) yang penting
                                    untuk tubuh.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Sagu Lempeng</p>
                                <p class="text-xs mt-1">Roti tawar tradisional khas Papua/Maluku dari tepung sagu
                                    basah yang dibakar dalam cetakan tanah liat.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Serat Pangan</p>
                                <p class="text-xs mt-1">Bagian tumbuhan yang tidak dicerna tubuh, penting untuk
                                    pencernaan. Banyak pada ubi dan singkong.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Substitusi Bahan</p>
                                <p class="text-xs mt-1">Strategi mengganti bahan resep dengan yang lebih sehat
                                    (misal: santan diganti susu rendah lemak).</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Timphan</p>
                                <p class="text-xs mt-1">Kue tradisional Aceh berbahan tepung ketan dan pisang raja,
                                    diisi srikaya, dibungkus daun pisang.</p>
                            </div>
                        </div>
                    </div>

                    <!-- U - Z -->
                    <div class="space-y-4">
                        <h4
                            class="font-black text-emerald-800 uppercase tracking-widest text-xs border-b border-emerald-100 pb-2">
                            U - Z</h4>
                        <div class="space-y-3">
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Unique Selling Point (USP)</p>
                                <p class="text-xs mt-1">Keunikan atau nilai tambah utama yang membedakan produk dari
                                    pesaing (misal: "Tanpa Pengawet", "Resep Kuno").</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Visual Display</p>
                                <p class="text-xs mt-1">Tata letak dan presentasi produk di bazar untuk menarik
                                    perhatian pembeli.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Wedang Uwuh</p>
                                <p class="text-xs mt-1">Minuman rempah khas Yogyakarta ("sampah") berisi dedaunan
                                    dan rempah berkhasiat.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Feedback Section -->
                <div class="mt-8 border-t border-slate-100 pt-6">
                    <div class="bg-amber-50 p-4 rounded-2xl border border-amber-100 mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-amber-600">rate_review</span>
                            <p class="text-xs font-black text-amber-800 uppercase tracking-widest">Tugas Mandiri</p>
                        </div>
                        <p class="text-[11px] text-amber-700 leading-relaxed font-medium">Sebutkan 5 istilah dalam
                            Glosarium di atas yang baru kamu ketahui, beserta definisi aslinya menurut pemahamanmu!
                        </p>
                    </div>

                    <div id="glosariumStatusSection" class="hidden mb-4 rounded-2xl border p-4"></div>

                    <div id="glosariumInputArea">
                        <textarea id="glosariumInput" rows="5"
                            class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-800 focus:ring-2 focus:ring-emerald-500 outline-none transition-all placeholder:text-slate-400 font-medium"
                            placeholder="1. Istilah A: Definisi...&#10;2. Istilah B: Definisi..."></textarea>
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <div class="p-8 bg-white border-t">
                <button id="btnSubmitGlosarium" onclick="submitGlosarium()"
                    class="w-full py-4 bg-emerald-500 text-white rounded-2xl font-black shadow-lg shadow-emerald-200 active:scale-95 transition-all">
                    Kirim Jawaban
                </button>
            </div>
        </div>
    </div>
    </div>
    <!-- MODAL REFLEKSI (CHECK) -->
    <div id="modalRefleksi"
        class="fixed inset-0 z-[9999] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="p-8 border-b flex justify-between items-center bg-rose-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-rose-500 text-white flex items-center justify-center shadow-lg shadow-rose-200">
                        <span class="material-symbols-outlined !text-2xl">self_improvement</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">Refleksi Harian</h3>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Evaluasi Diri &
                            Saran</p>
                    </div>
                </div>
                <button onclick="closeRefleksiModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Content -->
            <div class="p-8 overflow-y-auto no-scrollbar flex-1 space-y-8">
                <form id="refleksiForm" class="space-y-8">
                    <!-- BAGIAN 1: PERASAAN & MOOD -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-rose-500 text-lg">sentiment_satisfied</span>
                            <h4 class="font-black text-slate-700 uppercase tracking-widest text-xs">Bagian 1: Perasaan &
                                Mood</h4>
                        </div>

                        <!-- Q1 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">1. Bagaimana perasaanmu setelah
                                mengikuti kegiatan hari ini? <span class="text-rose-500">*</span></label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="cursor-pointer">
                                    <input type="radio" name="refleksi_q1" value="Sangat Senang" class="peer hidden"
                                        required>
                                    <div
                                        class="p-3 rounded-xl border border-slate-200 bg-white hover:bg-rose-50 peer-checked:bg-rose-500 peer-checked:text-white peer-checked:border-rose-500 transition-all text-center text-xs font-bold">
                                        😄 Sangat Senang
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="refleksi_q1" value="Biasa Saja" class="peer hidden">
                                    <div
                                        class="p-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 peer-checked:bg-slate-700 peer-checked:text-white peer-checked:border-slate-700 transition-all text-center text-xs font-bold">
                                        😐 Biasa Saja
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="refleksi_q1" value="Bingung" class="peer hidden">
                                    <div
                                        class="p-3 rounded-xl border border-slate-200 bg-white hover:bg-amber-50 peer-checked:bg-amber-400 peer-checked:text-white peer-checked:border-amber-400 transition-all text-center text-xs font-bold">
                                        🤔 Bingung
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="refleksi_q1" value="Lelah/Bosan" class="peer hidden">
                                    <div
                                        class="p-3 rounded-xl border border-slate-200 bg-white hover:bg-red-50 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 transition-all text-center text-xs font-bold">
                                        😴 Lelah/Bosan
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- BAGIAN 2: EVALUASI BELAJAR -->
                    <div class="space-y-4 pt-4 border-t border-slate-100">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-indigo-500 text-lg">school</span>
                            <h4 class="font-black text-slate-700 uppercase tracking-widest text-xs">Bagian 2: Evaluasi
                                Belajar</h4>
                        </div>

                        <!-- Q2 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">2. Apa satu hal baru yang paling
                                menarik kamu pelajari hari ini?</label>
                            <textarea name="refleksi_q2" rows="3"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Ceritakan singkat..."></textarea>
                        </div>
                        <!-- Q3 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">3. Apa bagian yang paling sulit atau
                                menantang?</label>
                            <textarea name="refleksi_q3" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Tuliskan kesulitanmu..."></textarea>
                        </div>
                        <!-- Q4 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">4. Bagaimana caramu mengatasi
                                kesulitan tersebut?</label>
                            <textarea name="refleksi_q4" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Strategi belajarmu..."></textarea>
                        </div>
                        <!-- Q5 Range -->
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <label class="text-xs font-bold text-slate-600 block">5. Seberapa fokus kamu hari ini?
                                    (1-10)</label>
                                <span id="focusVal" class="text-xs font-black text-indigo-500">5</span>
                            </div>
                            <input type="range" name="refleksi_q5" min="1" max="10" value="5"
                                class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                                oninput="document.getElementById('focusVal').innerText = this.value">
                            <div class="flex justify-between text-[9px] text-slate-400 font-bold uppercase">
                                <span>Tidak Fokus</span>
                                <span>Sangat Fokus</span>
                            </div>
                        </div>

                        <!-- Q6 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">6. Apa kontrisibusimu dalam
                                diskusi/kelompok hari ini?</label>
                            <textarea name="refleksi_q6" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Kontribusimu..."></textarea>
                        </div>
                        <!-- Q7 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">7. Skill/sikap apa yang kamu rasa
                                berkembang hari ini?</label>
                            <textarea name="refleksi_q7" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Contoh: Kerjasama, komunikasi..."></textarea>
                        </div>
                        <!-- Q8 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">8. Apakah ada hambatan non-teknis
                                (misal: mood, ngantuk, gangguan lain)?</label>
                            <textarea name="refleksi_q8" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Ceritakan jika ada..."></textarea>
                        </div>
                        <!-- Q9 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">9. Apa targetmu untuk pembelajaran
                                besok?</label>
                            <textarea name="refleksi_q9" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Target besok..."></textarea>
                        </div>
                    </div>

                    <!-- BAGIAN 3: FEEDBACK & LAINNYA -->
                    <div class="space-y-4 pt-4 border-t border-slate-100">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-emerald-500 text-lg">thumbs_up_down</span>
                            <h4 class="font-black text-slate-700 uppercase tracking-widest text-xs">Bagian 3: Feedback &
                                Saran</h4>
                        </div>

                        <!-- Q10 Star Rating -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">10. Beri rating untuk keseruan
                                aktivitas hari ini!</label>
                            <div class="flex gap-2 rating justify-center py-2">
                                <input type="radio" name="refleksi_q10" value="1" id="star1" class="hidden peer"><label
                                    for="star1"
                                    class="material-symbols-outlined text-3xl text-slate-300 cursor-pointer peer-check:text-amber-400 hover:text-amber-300 transition-colors"
                                    onclick="setStars(1)">star</label>
                                <input type="radio" name="refleksi_q10" value="2" id="star2" class="hidden peer"><label
                                    for="star2"
                                    class="material-symbols-outlined text-3xl text-slate-300 cursor-pointer peer-check:text-amber-400 hover:text-amber-300 transition-colors"
                                    onclick="setStars(2)">star</label>
                                <input type="radio" name="refleksi_q10" value="3" id="star3" class="hidden peer"><label
                                    for="star3"
                                    class="material-symbols-outlined text-3xl text-slate-300 cursor-pointer peer-check:text-amber-400 hover:text-amber-300 transition-colors"
                                    onclick="setStars(3)">star</label>
                                <input type="radio" name="refleksi_q10" value="4" id="star4" class="hidden peer"><label
                                    for="star4"
                                    class="material-symbols-outlined text-3xl text-slate-300 cursor-pointer peer-check:text-amber-400 hover:text-amber-300 transition-colors"
                                    onclick="setStars(4)">star</label>
                                <input type="radio" name="refleksi_q10" value="5" id="star5" class="hidden peer"><label
                                    for="star5"
                                    class="material-symbols-outlined text-3xl text-slate-300 cursor-pointer peer-check:text-amber-400 hover:text-amber-300 transition-colors"
                                    onclick="setStars(5)">star</label>
                            </div>
                            <script>
                                function setStars(n) {
                                    for (let i = 1; i <= 5; i++) {
                                        const lbl = document.querySelector(`label[for="star${i}"]`);
                                        if (i <= n) lbl.classList.add('text-amber-400', 'fill-current');
                                        else lbl.classList.remove('text-amber-400', 'fill-current');
                                    }
                                    const radio = document.getElementById(`star${n}`);
                                    if (radio) radio.checked = true;
                                }
                            </script>
                        </div>

                        <!-- Q11 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">11. Siapa nama Fasilitator &
                                Koordinator di kelasmu hari ini?</label>
                            <input type="text" name="refleksi_q11"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Tulis nama mereka...">
                        </div>
                        <!-- Q12 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">12. Bagaimana gaya
                                mengajar/pendampingan mereka? (Jujur saja)</label>
                            <textarea name="refleksi_q12" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Sabar, seru, atau...?"></textarea>
                        </div>
                        <!-- Q13 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">13. Apa pendapatmu tentang aplikasi
                                web ini?</label>
                            <textarea name="refleksi_q13" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Keren, lemot, membantu...?"></textarea>
                        </div>
                        <!-- Q14 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">14. Apa saran untuk perbaikan kegiatan
                                besok?</label>
                            <textarea name="refleksi_q14" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Sarannya..."></textarea>
                        </div>
                        <!-- Q15 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">15. (Bonus) Tebak siapa yang membuat
                                aplikasi ini?</label>
                            <input type="text" name="refleksi_q15"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Tebakanmu...">
                        </div>
                    </div>
                </form>
            </div>

            <!-- Footer -->
            <div class="p-8 bg-white border-t">
                <button onclick="submitRefleksi()"
                    class="w-full py-4 bg-rose-500 text-white rounded-2xl font-black shadow-lg shadow-rose-200 active:scale-95 transition-all">
                    Kirim Refleksi
                </button>
            </div>
        </div>
    </div>
    <script>
        // VIDEO MODAL LOGIC
        function openVideoModal() {
            const modal = document.getElementById('modalVideo');
            const dayKey = `day${currentDay}`;
            const videos = workshopContent[dayKey]?.video || [];
            const container = document.getElementById('videoDynamicItems');

            if (container) {
                container.innerHTML = videos.map((v, idx) => `
                    <div class="space-y-2">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">${v.title}</p>
                        <div class="aspect-video w-full rounded-2xl overflow-hidden shadow-sm bg-slate-100">
                            <iframe class="w-full h-full" src="${v.url}" title="${v.title}"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen></iframe>
                        </div>
                    </div>
                `).join('');
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Re-check existing summary
            checkExistingVideo();
        }

        function updateVideoWordCount() {
            const input = document.getElementById('videoSummaryInput');
            const counter = document.getElementById('videoWordCountDisplay');
            const btn = document.getElementById('btnSubmitVideo');

            if (!input || !counter || !btn) return;

            const text = input.value.trim();
            const wordCount = text ? text.split(/\s+/).length : 0;
            const limit = 100;

            counter.textContent = `${wordCount} / ${limit} kata`;

            if (wordCount >= limit) {
                // VALID STATE
                counter.className = "text-[10px] font-bold text-emerald-600 bg-white/50 px-2 py-1 rounded-lg border border-emerald-200 transition-all";
                // Enable Button
                btn.disabled = false;
                btn.className = "w-full py-4 bg-red-500 text-white rounded-2xl font-black shadow-lg shadow-red-200 active:scale-95 transition-all cursor-pointer";
            } else {
                // INVALID STATE
                counter.className = "text-[10px] font-bold text-red-500 bg-white/50 px-2 py-1 rounded-lg border border-red-100 transition-all";
                // Disable Button
                btn.disabled = true;
                btn.className = "w-full py-4 bg-slate-200 text-slate-400 rounded-2xl font-black shadow-none transition-all cursor-not-allowed";
            }
        }

        function closeVideoModal() {
            const modal = document.getElementById('modalVideo');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');

                // Stop videos by resetting src
                const iframes = modal.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    const src = iframe.src;
                    iframe.src = src;
                });
            }
        }

        // LKPD DIGITAL LOGIC
        let currentLKPDStep = 1;

        function openLKPDModal() {
            document.getElementById('modalLKPD').classList.remove('hidden');
            document.getElementById('modalLKPD').classList.add('flex');
            loadLKPDDraft();
            checkExistingLKPD();

            // Fokus otomatis ke step yang relevan sesuai hari
            let targetStep = 1;
            if (currentDay === 2) targetStep = 3;
            else if (currentDay === 3) targetStep = 5;

            switchLKPD(targetStep);
        }

        function closeLKPDModal() {
            document.getElementById('modalLKPD').classList.add('hidden');
            document.getElementById('modalLKPD').classList.remove('flex');
        }

        function switchLKPD(step) {
            currentLKPDStep = step;

            // Update UI Sections
            const sections = document.querySelectorAll('.lkpd-section');
            sections.forEach(s => s.classList.add('hidden'));
            document.getElementById(`lkpd-section-${step}`).classList.remove('hidden');

            // Update Stepper
            const buttons = document.querySelectorAll('[id^="step-"]');
            buttons.forEach((btn, idx) => {
                const sNum = idx + 1;
                if (sNum < step) {
                    btn.className = "size-8 rounded-full bg-emerald-500 text-white text-xs font-bold z-10 transition-all shadow-lg shadow-emerald-200 relative";
                    btn.innerHTML = '<span class="material-symbols-outlined !text-sm">check</span>';
                } else if (sNum === step) {
                    btn.className = "size-8 rounded-full bg-terracotta text-white text-xs font-bold z-10 transition-all shadow-lg shadow-terracotta/20 relative";
                    btn.innerHTML = sNum;
                } else {
                    btn.className = "size-8 rounded-full bg-white border-2 border-slate-200 text-slate-400 text-xs font-bold z-10 transition-all relative";
                    btn.innerHTML = sNum;
                }
            });

            // Progress Bar
            const progress = ((step - 1) / 4) * 100;
            document.getElementById('lkpd-stepper-progress').style.width = `${progress}%`;

            // Footer Buttons
            const btnPrev = document.getElementById('btnPrevLKPD');
            const btnNext = document.getElementById('btnNextLKPD');
            const btnSubmit = document.getElementById('btnSubmitLKPDAll');

            if (step === 1) {
                btnPrev.classList.add('opacity-0', 'pointer-events-none');
            } else {
                btnPrev.classList.remove('opacity-0', 'pointer-events-none');
            }

            if (step === 5) {
                btnNext.classList.add('hidden');
                btnSubmit.classList.remove('hidden');
            } else {
                btnNext.classList.remove('hidden');
                btnSubmit.classList.add('hidden');
                btnNext.innerText = `Lanjut ke LKPD ${step + 1}`;
            }
        }

        function nextLKPD() {
            if (currentLKPDStep < 5) switchLKPD(currentLKPDStep + 1);
        }

        function prevLKPD() {
            if (currentLKPDStep > 1) switchLKPD(currentLKPDStep - 1);
        }

        function saveLKPDDraft() {
            const lkpdData = {
                lkpd1: {
                    q1: document.getElementById('lkpd1_q1').value,
                    q2a: {
                        bentuk: document.getElementById('lkpd1_q2a_bentuk').value,
                        contoh: document.getElementById('lkpd1_q2a_contoh').value,
                        bahan: document.getElementById('lkpd1_q2a_bahan').value
                    },
                    q2b: {
                        bentuk: document.getElementById('lkpd1_q2b_bentuk').value,
                        contoh: document.getElementById('lkpd1_q2b_contoh').value,
                        bahan: document.getElementById('lkpd1_q2b_bahan').value
                    }
                },
                lkpd2: {
                    sumatra: {
                        contoh: document.getElementById('lkpd2_sumatra_contoh').value,
                        bahan: document.getElementById('lkpd2_sumatra_bahan').value,
                        rasa: document.getElementById('lkpd2_sumatra_rasa').value
                    },
                    jawa: {
                        contoh: document.getElementById('lkpd2_jawa_contoh').value,
                        bahan: document.getElementById('lkpd2_jawa_bahan').value,
                        rasa: document.getElementById('lkpd2_jawa_rasa').value
                    },
                    sulawesi: {
                        contoh: document.getElementById('lkpd2_sulawesi_contoh').value,
                        bahan: document.getElementById('lkpd2_sulawesi_bahan').value,
                        rasa: document.getElementById('lkpd2_sulawesi_rasa').value
                    },
                    bali: {
                        contoh: document.getElementById('lkpd2_bali_contoh').value,
                        bahan: document.getElementById('lkpd2_bali_bahan').value,
                        rasa: document.getElementById('lkpd2_bali_rasa').value
                    },
                    papua: {
                        contoh: document.getElementById('lkpd2_papua_contoh').value,
                        bahan: document.getElementById('lkpd2_papua_bahan').value,
                        rasa: document.getElementById('lkpd2_papua_rasa').value
                    }
                },
                lkpd3: {
                    q1: document.getElementById('lkpd3_q1')?.value || '',
                    q2: document.getElementById('lkpd3_q2')?.value || '',
                    q3: document.getElementById('lkpd3_q3')?.value || '',
                    q4: document.getElementById('lkpd3_q4')?.value || '',
                    q5: document.getElementById('lkpd3_q5')?.value || '',
                    q6: document.getElementById('lkpd3_q6')?.value || '',
                    q7: document.getElementById('lkpd3_q7')?.value || '',
                    q8: document.getElementById('lkpd3_q8')?.value || '',
                    q9: document.getElementById('lkpd3_q9')?.value || '',
                    q10: document.getElementById('lkpd3_q10')?.value || ''
                },
                lkpd4: {
                    makan: {
                        nama: document.getElementById('lkpd4_m_nama').value,
                        asal: document.getElementById('lkpd4_m_asal').value,
                        bahan: document.getElementById('lkpd4_m_bahan').value,
                        gizi: document.getElementById('lkpd4_m_gizi').value,
                        metode: document.getElementById('lkpd4_m_metode').value,
                        keunggulan: document.getElementById('lkpd4_m_keunggulan').value,
                        pemasaran: document.getElementById('lkpd4_m_pemasaran').value,
                        inovasi: document.getElementById('lkpd4_m_inovasi').value
                    },
                    minum: {
                        nama: document.getElementById('lkpd4_d_nama').value,
                        asal: document.getElementById('lkpd4_d_asal').value,
                        bahan: document.getElementById('lkpd4_d_bahan').value,
                        gizi: document.getElementById('lkpd4_d_gizi').value,
                        metode: document.getElementById('lkpd4_d_metode').value,
                        keunggulan: document.getElementById('lkpd4_d_keunggulan').value,
                        pemasaran: document.getElementById('lkpd4_d_pemasaran').value
                    },
                    bazar: {
                        alat: document.getElementById('lkpd4_b_alat').value,
                        bahan: document.getElementById('lkpd4_b_bahan').value
                    }
                },
                lkpd5: {
                    food: document.getElementById('lkpd5-preview-img-food')?.src || '',
                    drink: document.getElementById('lkpd5-preview-img-drink')?.src || '',
                    booth: document.getElementById('lkpd5-preview-img-booth')?.src || '',
                    marketing: document.getElementById('lkpd5-preview-img-marketing')?.src || ''
                }
            };
            localStorage.setItem(`lkpd_draft_day${currentDay}`, JSON.stringify(lkpdData));
        }

        function fillLKPDFields(data) {
            if (!data) return;

            // LKPD 1
            if (data.lkpd1) {
                if (document.getElementById('lkpd1_q1')) document.getElementById('lkpd1_q1').value = data.lkpd1.q1 || '';
                if (document.getElementById('lkpd1_q2a_bentuk')) document.getElementById('lkpd1_q2a_bentuk').value = data.lkpd1.q2a?.bentuk || '';
                if (document.getElementById('lkpd1_q2a_contoh')) document.getElementById('lkpd1_q2a_contoh').value = data.lkpd1.q2a?.contoh || '';
                if (document.getElementById('lkpd1_q2a_bahan')) document.getElementById('lkpd1_q2a_bahan').value = data.lkpd1.q2a?.bahan || '';

                if (document.getElementById('lkpd1_q2b_bentuk')) document.getElementById('lkpd1_q2b_bentuk').value = data.lkpd1.q2b?.bentuk || '';
                if (document.getElementById('lkpd1_q2b_contoh')) document.getElementById('lkpd1_q2b_contoh').value = data.lkpd1.q2b?.contoh || '';
                if (document.getElementById('lkpd1_q2b_bahan')) document.getElementById('lkpd1_q2b_bahan').value = data.lkpd1.q2b?.bahan || '';
            }

            // LKPD 2
            if (data.lkpd2) {
                const regions = ['sumatra', 'jawa', 'sulawesi', 'bali', 'papua'];
                regions.forEach(reg => {
                    const r = data.lkpd2[reg];
                    if (!r) return;
                    if (document.getElementById(`lkpd2_${reg}_contoh`)) document.getElementById(`lkpd2_${reg}_contoh`).value = r.contoh || '';
                    if (document.getElementById(`lkpd2_${reg}_bahan`)) document.getElementById(`lkpd2_${reg}_bahan`).value = r.bahan || '';
                    if (document.getElementById(`lkpd2_${reg}_rasa`)) document.getElementById(`lkpd2_${reg}_rasa`).value = r.rasa || '';
                });
            }

            // LKPD 3
            if (data.lkpd3) {
                for (let i = 1; i <= 10; i++) {
                    const el = document.getElementById(`lkpd3_q${i}`);
                    if (el) el.value = data.lkpd3[`q${i}`] || '';
                }
            }

            // LKPD 4
            if (data.lkpd4) {
                // Makanan
                const m = data.lkpd4.makan || {};
                if (document.getElementById('lkpd4_m_nama')) document.getElementById('lkpd4_m_nama').value = m.nama || '';
                if (document.getElementById('lkpd4_m_asal')) document.getElementById('lkpd4_m_asal').value = m.asal || '';
                if (document.getElementById('lkpd4_m_bahan')) document.getElementById('lkpd4_m_bahan').value = m.bahan || '';
                if (document.getElementById('lkpd4_m_gizi')) document.getElementById('lkpd4_m_gizi').value = m.gizi || '';
                if (document.getElementById('lkpd4_m_metode')) document.getElementById('lkpd4_m_metode').value = m.metode || '';
                if (document.getElementById('lkpd4_m_keunggulan')) document.getElementById('lkpd4_m_keunggulan').value = m.keunggulan || '';
                if (document.getElementById('lkpd4_m_pemasaran')) document.getElementById('lkpd4_m_pemasaran').value = m.pemasaran || '';
                if (document.getElementById('lkpd4_m_inovasi')) document.getElementById('lkpd4_m_inovasi').value = m.inovasi || '';

                // Minuman
                const d = data.lkpd4.minum || {};
                if (document.getElementById('lkpd4_d_nama')) document.getElementById('lkpd4_d_nama').value = d.nama || '';
                if (document.getElementById('lkpd4_d_asal')) document.getElementById('lkpd4_d_asal').value = d.asal || '';
                if (document.getElementById('lkpd4_d_bahan')) document.getElementById('lkpd4_d_bahan').value = d.bahan || '';
                if (document.getElementById('lkpd4_d_gizi')) document.getElementById('lkpd4_d_gizi').value = d.gizi || '';
                if (document.getElementById('lkpd4_d_metode')) document.getElementById('lkpd4_d_metode').value = d.metode || '';
                if (document.getElementById('lkpd4_d_keunggulan')) document.getElementById('lkpd4_d_keunggulan').value = d.keunggulan || '';
                if (document.getElementById('lkpd4_d_pemasaran')) document.getElementById('lkpd4_d_pemasaran').value = d.pemasaran || '';

                // Bazar
                const b = data.lkpd4.bazar || {};
                if (document.getElementById('lkpd4_b_alat')) document.getElementById('lkpd4_b_alat').value = b.alat || '';
                if (document.getElementById('lkpd4_b_bahan')) document.getElementById('lkpd4_b_bahan').value = b.bahan || '';
            }

            // LKPD 5
            if (data.lkpd5) {
                // Helper to set preview
                const setPreview = (type, url) => {
                    const img = document.getElementById(`lkpd5-preview-img-${type}`);
                    const container = document.getElementById(`lkpd5-preview-container-${type}`);
                    const ui = document.getElementById(`lkpd5-upload-ui-${type}`);
                    const statusEl = document.getElementById(`lkpd5-status-${type}`);

                    // Reset state first
                    if (container) container.classList.add('hidden');
                    if (ui) ui.classList.remove('hidden');
                    if (statusEl) statusEl.classList.add('hidden');

                    // Strict Validation
                    if (url && typeof url === 'string' && url.length > 10 && (url.startsWith('http') || url.startsWith('blob:') || url.startsWith('data:'))) {
                        if (img && container && ui) {
                            // Handler jika gambar error/broken
                            img.onerror = function () {
                                console.warn(`[LKPD5] Gagal memuat gambar ${type}: ${url}`);
                                container.classList.add('hidden');
                                ui.classList.remove('hidden');
                                img.src = ''; // Clear source
                            };

                            // Handler jika gambar sukses dimuat
                            img.onload = function () {
                                container.classList.remove('hidden');
                                ui.classList.add('hidden');
                            };

                            img.src = url;
                        }
                    }
                };
                setPreview('food', data.lkpd5.food);
                setPreview('drink', data.lkpd5.drink);
                setPreview('booth', data.lkpd5.booth);
                setPreview('marketing', data.lkpd5.marketing);
            }
        }

        function loadLKPDDraft() {
            const dataStr = localStorage.getItem(`lkpd_draft_day${currentDay}`);
            if (!dataStr) return;
            fillLKPDFields(JSON.parse(dataStr));
        }

        async function submitLKPDTotal() {
            const btn = document.getElementById('btnSubmitLKPDAll');
            btn.disabled = true;
            btn.innerHTML = 'Mengirim Semua...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error("Silakan login ulang.");

                const lkpdData = JSON.parse(localStorage.getItem(`lkpd_draft_day${currentDay}`));

                // VALIDASI: Minimal LKPD 1 terisi (karena baru LKPD 1 yang diimplementasikan detailnya)
                if (!lkpdData || !lkpdData.lkpd1 || !lkpdData.lkpd1.q1) {
                    alert('Mohon lengkapi jawaban LKPD minimal pada bagian pertama.');
                    btn.disabled = false;
                    btn.innerHTML = 'Kirim Semua LKPD';
                    return;
                }

                const { error } = await supabaseClient
                    .from('module_responses')
                    .upsert({
                        student_id: user.id,
                        day_id: currentDay,
                        module_type: 'lkpd',
                        answers: [JSON.stringify(lkpdData)],
                        status: 'submitted',
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'student_id,day_id,module_type'
                    });

                if (error) throw error;

                alert('Hebat! Seluruh LKPD berhasil dikirim. Menunggu feedback dari fasilitator.');

                // Sync progress lokal
                studentProgress[`day${currentDay}`]['lkpd'] = false; // Tetap false agar muncul jam pasir
                saveProgress();

                checkAllModulesStatus();
                closeLKPDModal();
                checkExistingLKPD();

            } catch (err) {
                console.error('Gagal kirim LKPD:', err);
                alert('Terjadi kesalahan saat mengirim LKPD.');
                btn.disabled = false;
                btn.innerHTML = 'Kirim Semua LKPD';
            }
        }

        // FUNGSI UPLOAD LKPD 5
        async function compressImageLKPD(file, maxWidth = 800, quality = 0.5) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function handleLKPDUpload(type, event) {
            const file = event.target.files[0];
            if (!file) return;

            // UI Elements
            const statusEl = document.getElementById(`lkpd5-status-${type}`);
            const inputLabel = document.querySelector(`label[for="lkpd5-file-${type}"]`);

            // Validasi Size
            if (file.size > 5 * 1024 * 1024) {
                alert('Ukuran file terlalu besar. Maksimal 5MB.');
                return;
            }

            try {
                // Update UI: Loading
                if (statusEl) {
                    statusEl.textContent = 'Mengompresi & Mengunggah...';
                    statusEl.classList.remove('hidden');
                }
                if (inputLabel) inputLabel.classList.add('opacity-50', 'pointer-events-none');

                // 1. Kompresi
                const compressedBlob = await compressImageLKPD(file, 1000, 0.6);
                const compressedFile = new File([compressedBlob], `lkpd5_${type}_${Date.now()}.jpg`, { type: 'image/jpeg' });

                // 2. Auth Check
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error('Sesi habis, silakan login ulang.');

                // 3. Upload ke Storage
                const fileName = `${user.id}/lkpd5_${type}_${Date.now()}.jpg`;
                const { error: uploadError } = await supabaseClient.storage
                    .from('documentation')
                    .upload(fileName, compressedFile);

                if (uploadError) throw uploadError;

                // 4. Get Public URL
                const { data: { publicUrl } } = supabaseClient.storage
                    .from('documentation')
                    .getPublicUrl(fileName);

                // 5. Update Preview UI
                const img = document.getElementById(`lkpd5-preview-img-${type}`);
                const container = document.getElementById(`lkpd5-preview-container-${type}`);
                const ui = document.getElementById(`lkpd5-upload-ui-${type}`);

                if (img) img.src = publicUrl;
                if (container) container.classList.remove('hidden');
                if (ui) ui.classList.add('hidden');
                if (statusEl) statusEl.classList.add('hidden');

                // 6. trigger Auto Save Draft
                saveLKPDDraft();

            } catch (error) {
                console.error('Upload failed:', error);
                alert('Gagal mengunggah gambar: ' + error.message);
                if (statusEl) statusEl.classList.add('hidden');
                if (inputLabel) inputLabel.classList.remove('opacity-50', 'pointer-events-none');
            }
        }

        async function checkExistingLKPD() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data, error } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'lkpd')
                    .maybeSingle();

                if (data) {
                    const statusSection = document.getElementById('lkpdStatusSection');
                    const btnSubmit = document.getElementById('btnSubmitLKPDAll');

                    // Populate fields from server data
                    try {
                        const lkpdData = JSON.parse(data.answers[0]);
                        fillLKPDFields(lkpdData);
                    } catch (e) {
                        console.error('Error parsing server LKPD data', e);
                    }

                    // Lock all inputs
                    const inputs = document.querySelectorAll('#modalLKPD input, #modalLKPD textarea');
                    inputs.forEach(i => i.disabled = true);
                    if (btnSubmit) btnSubmit.classList.add('hidden');

                    if (statusSection) {
                        statusSection.classList.remove('hidden');
                        if (data.status === 'submitted') {
                            statusSection.innerHTML = `
                                <div class="bg-yellow-50 p-4 rounded-2xl border border-yellow-100 flex items-center gap-3">
                                    <div class="size-8 rounded-full bg-yellow-400 flex items-center justify-center text-white shrink-0 animate-pulse">
                                        <span class="material-symbols-outlined text-sm">hourglass_top</span>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-[10px] font-black text-yellow-700 uppercase tracking-widest">Menunggu Feedback</p>
                                        <p class="text-[10px] text-yellow-600 mt-0.5 font-medium">Fasilitator sedang membaca jawaban LKPD kelompokmu.</p>
                                    </div>
                                </div>
                            `;
                            updateModuleUI('lkpd', 'submitted');
                        } else if (data.status === 'reviewed') {
                            let starsHtml = '';
                            const score = data.score || 0;
                            const starCount = Math.round(score / 20);
                            for (let i = 1; i <= 5; i++) {
                                starsHtml += `<span class="material-symbols-outlined text-2xl ${i <= starCount ? 'text-amber-400 fill-current' : 'text-slate-200'}">star</span>`;
                            }

                            statusSection.innerHTML = `
                                <div class="bg-emerald-50 p-5 rounded-2xl border border-emerald-100 space-y-3">
                                    <div class="flex items-center justify-between">
                                        <p class="text-[10px] font-black text-emerald-700 uppercase tracking-widest">Dinilai Fasilitator</p>
                                        <div class="flex">${starsHtml}</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-xl border border-emerald-100">
                                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Feedback:</p>
                                        <p class="text-xs text-slate-700 font-medium italic">"${data.feedback || 'Bagus sekali!'}"</p>
                                    </div>
                                </div>
                            `;
                            updateModuleUI('lkpd', true, data.score || 0);
                        }
                    }
                } else {
                    // NEW: Unlock inputs if data is gone (deleted by facilitator)
                    console.log('⚠️ Data tidak ditemukan di server (mungkin dihapus). Resetting UI...');

                    const inputs = document.querySelectorAll('#modalLKPD input, #modalLKPD textarea');
                    inputs.forEach(i => i.disabled = false); // Unlock

                    const btnSubmit = document.getElementById('btnSubmitLKPDAll');
                    if (btnSubmit) btnSubmit.classList.remove('hidden'); // Show submit

                    const statusSection = document.getElementById('lkpdStatusSection');
                    if (statusSection) statusSection.classList.add('hidden'); // Hide status
                }
            } catch (err) { console.error('Error checkExistingLKPD:', err); }
        }

        function removeLKPD5Image(type) {
            if (!confirm('Hapus foto ini?')) return;

            // 1. Clear UI
            const img = document.getElementById(`lkpd5-preview-img-${type}`);
            const container = document.getElementById(`lkpd5-preview-container-${type}`);
            const ui = document.getElementById(`lkpd5-upload-ui-${type}`);
            const input = document.getElementById(`lkpd5-file-${type}`);

            if (img) img.src = '';
            if (container) container.classList.add('hidden');
            if (ui) ui.classList.remove('hidden');
            if (input) input.value = ''; // Reset file input

            // 2. Remove from LocalStorage Draft
            try {
                const dataStr = localStorage.getItem(`lkpd_draft_day${currentDay}`);
                if (dataStr) {
                    const data = JSON.parse(dataStr);
                    if (data.lkpd5) {
                        data.lkpd5[type] = ''; // Clear URL
                        localStorage.setItem(`lkpd_draft_day${currentDay}`, JSON.stringify(data));
                    }
                }
            } catch (e) {
                console.error('Error removing Draft image', e);
            }
        }

        async function submitVideoLog() {
            const btn = document.getElementById('btnSubmitVideo');
            const summary = document.getElementById('videoSummaryInput').value;
            const wordCount = summary.trim().split(/\s+/).length;

            if (wordCount < 50) {
                alert('Ringkasan belum mencapai 50 kata. Silakan lengkapi lagi.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'Mengirim...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error("User tidak ditemukan");

                // Save to local storage (backup)
                localStorage.setItem(`video_summary_day${currentDay}`, summary);

                // 1. Simpan ke Supabase
                const { error } = await supabaseClient
                    .from('module_responses')
                    .insert({
                        student_id: user.id,
                        day_id: currentDay,
                        module_type: 'video',
                        answers: [summary],
                        status: 'submitted'
                    });

                if (error) throw error;

                alert('Hebat! Ringkasan berhasil dikirim. Menunggu feedback dari fasilitator.');

                // Update progress lokal agar sinkron
                const dayKey = `day${currentDay}`;
                studentProgress[dayKey]['video'] = false; // Tetap false agar show "Menunggu Feedback"
                saveProgress();

                checkAllModulesStatus(); // Refresh dashboard UI
                closeVideoModal();
                checkExistingVideo(); // Refresh modal content

            } catch (err) {
                console.error('Gagal kirim video summary:', err);
                alert('Terjadi kesalahan saat mengirim ringkasan.');
                btn.disabled = false;
                btn.innerHTML = 'Simpan Ringkasan & Selesai';
            }
        }

        async function checkExistingVideo() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data, error } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'video')
                    .maybeSingle();

                if (data) {
                    const input = document.getElementById('videoSummaryInput');
                    const btn = document.getElementById('btnSubmitVideo');
                    const statusSection = document.getElementById('videoStatusSection');
                    const placeholder = document.getElementById('videoFeedbackPlaceholder');

                    if (input) {
                        input.value = data.answers[0] || '';
                        input.disabled = true;
                    }
                    if (btn) btn.classList.add('hidden');
                    if (placeholder) placeholder.classList.add('hidden');

                    if (statusSection) {
                        statusSection.classList.remove('hidden');
                        if (data.status === 'submitted') {
                            statusSection.innerHTML = `
                                <div class="bg-yellow-50 p-4 rounded-2xl border border-yellow-100 flex items-center gap-3">
                                    <div class="size-8 rounded-full bg-yellow-400 flex items-center justify-center text-white shrink-0 animate-pulse">
                                        <span class="material-symbols-outlined text-sm">hourglass_top</span>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-[10px] font-black text-yellow-700 uppercase tracking-widest">Menunggu Feedback</p>
                                        <p class="text-[10px] text-yellow-600 mt-0.5 font-medium">Fasilitator sedang membaca ringkasanmu.</p>
                                    </div>
                                </div>
                            `;
                            updateModuleUI('video', 'submitted');
                        } else if (data.status === 'reviewed') {
                            // Render Stars
                            let starsHtml = '';
                            const score = data.score || 0;
                            const starCount = Math.round(score / 20);
                            for (let i = 1; i <= 5; i++) {
                                starsHtml += `<span class="material-symbols-outlined text-2xl ${i <= starCount ? 'text-amber-400 fill-current' : 'text-slate-200'}">star</span>`;
                            }

                            statusSection.innerHTML = `
                                <div class="bg-emerald-50 p-5 rounded-2xl border border-emerald-100 space-y-3">
                                    <div class="flex items-center justify-between">
                                        <p class="text-[10px] font-black text-emerald-700 uppercase tracking-widest">Dinilai Fasilitator</p>
                                        <div class="flex">${starsHtml}</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-xl border border-emerald-100">
                                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Feedback:</p>
                                        <p class="text-xs text-slate-700 font-medium italic">"${data.feedback || 'Bagus sekali!'}"</p>
                                    </div>
                                </div>
                            `;
                            updateModuleUI('video', true, data.score || 0);
                        }
                    }
                }
            } catch (e) {
                console.error('Error checkExistingVideo:', e);
            }
        }

        // ASSESSMENT LOGIC
        let currentQuestionIndex = 0;
        let userAnswers = {}; // { quesID: correctIndex }
        let assessmentScore = 0;
        let shuffledIndices = []; // Stores the randomized order of indices

        async function openAssessmentModal() {
            const modal = document.getElementById('modalAssessment');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            // Check status first - Wait for result
            // If completed (returns true), do NOT setup quiz again
            const isCompleted = await checkExistingAssessment();
            if (isCompleted) return;

            // Load script dynamically if not present
            if (typeof assessmentQuestions === 'undefined') {
                const script = document.createElement('script');
                script.src = 'data/assessment_data.js';
                script.onload = () => {
                    if (!document.getElementById('assessmentResultContainer').classList.contains('flex')) {
                        setupAssessment();
                    }
                };
                document.body.appendChild(script);
            } else {
                if (!document.getElementById('assessmentResultContainer').classList.contains('flex')) {
                    setupAssessment();
                }
            }
        }

        function setupAssessment() {
            currentQuestionIndex = 0;
            userAnswers = {};

            // Reset containers
            document.getElementById('assessmentQuestionContainer').classList.remove('hidden');
            document.getElementById('assessmentResultContainer').classList.add('hidden');
            document.getElementById('assessmentResultContainer').classList.remove('flex');
            document.getElementById('btnNextAssessment').classList.remove('hidden');

            // Initialize Shuffle
            initShuffle();

            renderQuestion(0);
        }

        async function checkExistingAssessment() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return false;

                // 1. Cek database dulu (Sumber Kebenaran)
                const { data: cloudData, error: cloudError } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'kuis')
                    .maybeSingle();

                const savedScore = localStorage.getItem(`asesmen_day${currentDay}_score`);

                // 2. Jika di cloud tidak ada tapi di lokal ada -> SINKRONISASI OTOMATIS
                if (!cloudData && savedScore) {
                    console.log("☁️ Data cloud hilang, melakukan sinkronisasi dari lokal...");
                    const score = parseInt(savedScore);
                    const stars = Math.ceil(score / 20);

                    // Simpan ke cloud (Gunakan variabel default jika answers tidak ada di lokal)
                    await supabaseClient.from('module_responses').upsert({
                        student_id: user.id,
                        day_id: currentDay,
                        module_type: 'kuis',
                        status: 'reviewed',
                        score: score,
                        answers: [] // Data jawaban detail mungkin tidak ada di localStorage, tapi skor cukup untuk status
                    }, { onConflict: 'student_id,day_id,module_type' });

                    showAssessmentResultUI(score, stars);
                    return true;
                }

                // 3. Jika di cloud ada (paling akurat)
                if (cloudData) {
                    const score = cloudData.score;
                    const stars = Math.ceil(score / 20);
                    showAssessmentResultUI(score, stars);

                    // Update local storage jika berbeda (opsional tapi bagus untuk sinkronisasi antar perangkat)
                    localStorage.setItem(`asesmen_day${currentDay}_score`, score);
                    return true;
                }

                // 4. Jika di cloud tidak ada dan di lokal pun tidak ada
                return false;

            } catch (err) {
                console.error("Error in checkExistingAssessment:", err);
            }
            return false;
        }

        // Helper function to update UI from result
        function showAssessmentResultUI(score, stars) {
            document.getElementById('assessmentQuestionContainer').classList.add('hidden');
            document.getElementById('assessmentResultContainer').classList.remove('hidden');
            document.getElementById('assessmentResultContainer').classList.add('flex');
            document.getElementById('btnNextAssessment').classList.add('hidden');

            let starsHtml = '';
            for (let i = 0; i < 5; i++) {
                starsHtml += `<span class="material-symbols-outlined text-4xl ${i < stars ? 'text-amber-400 fill-current' : 'text-slate-200'}">star</span>`;
            }
            document.getElementById('resultStars').innerHTML = starsHtml;
            document.getElementById('resultScoreText').innerText = `Skor Kamu: ${score} / 100`;

            updateModuleUI('asesmen', true, score);
        }
        }

        // Initialize or Load Shuffled Order
        function initShuffle() {
            const savedOrder = localStorage.getItem(`assessment_shuffle_order_day${currentDay}`);
            if (savedOrder) {
                shuffledIndices = JSON.parse(savedOrder);
                // Validation: ensure length matches current questions (in case questions updated)
                if (shuffledIndices.length !== assessmentQuestions.length) {
                    generateNewShuffle();
                }
            } else {
                generateNewShuffle();
            }
        }

        function generateNewShuffle() {
            // Create array of indices [0, 1, ... N]
            shuffledIndices = Array.from({ length: assessmentQuestions.length }, (_, i) => i);

            // Fisher-Yates Shuffle
            for (let i = shuffledIndices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledIndices[i], shuffledIndices[j]] = [shuffledIndices[j], shuffledIndices[i]];
            }

            // Save to preserve order for this user/device
            localStorage.setItem(`assessment_shuffle_order_day${currentDay}`, JSON.stringify(shuffledIndices));
        }

        function closeAssessmentModal() {
            const modal = document.getElementById('modalAssessment');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        function renderQuestion(index) {
            if (!assessmentQuestions || !assessmentQuestions[index]) return;

            // Get the Question Object based on SHUFFLED index
            // If shuffledIndices is empty (fail-safe), use index directly
            const realIndex = (shuffledIndices.length > 0) ? shuffledIndices[index] : index;
            const q = assessmentQuestions[realIndex];

            const container = document.getElementById('assessmentQuestionContainer');

            // Progress Bar
            const progressPercent = ((index + 1) / assessmentQuestions.length) * 100;
            document.getElementById('assessmentProgressBar').style.width = `${progressPercent}%`;
            document.getElementById('assessmentProgressText').innerText = `Soal ${index + 1} dari ${assessmentQuestions.length}`;

            // Render
            // Display numbering as 1, 2, 3... even though content is random
            let html = `
                <h4 class="text-sm font-bold text-slate-800 mb-4">${index + 1}. ${q.question}</h4>
                <div class="space-y-3">
            `;

            q.options.forEach((opt, idx) => {
                const isSelected = userAnswers[q.id] === idx;
                const activeClass = isSelected ? 'border-emerald-500 bg-emerald-50 ring-2 ring-emerald-200' : 'border-slate-200 hover:border-indigo-300 hover:bg-slate-50';

                html += `
                    <div onclick="selectOption(${q.id}, ${idx})" 
                        class="p-4 rounded-xl border-2 ${activeClass} cursor-pointer transition-all flex items-center gap-3 group">
                        <div class="size-6 rounded-full border-2 ${isSelected ? 'border-emerald-500 bg-emerald-500' : 'border-slate-300 group-hover:border-indigo-400'} flex items-center justify-center shrink-0">
                            ${isSelected ? '<span class="material-symbols-outlined text-white text-xs">check</span>' : ''}
                        </div>
                        <p class="text-xs font-medium text-slate-700">${opt}</p>
                    </div>
                `;
            });

            html += `</div>`;
            container.innerHTML = html;

            // Button Control
            const btnNext = document.getElementById('btnNextAssessment');
            if (index === assessmentQuestions.length - 1) {
                btnNext.innerText = 'Kumpulkan Jawaban';
                btnNext.onclick = finishAssessment;
                btnNext.className = "px-6 py-3 bg-emerald-500 text-white rounded-xl font-bold text-xs shadow-lg shadow-emerald-200 active:scale-95 transition-all w-full mt-6";
            } else {
                btnNext.innerText = 'Selanjutnya';
                btnNext.className = "px-6 py-3 bg-indigo-500 text-white rounded-xl font-bold text-xs shadow-lg shadow-indigo-200 active:scale-95 transition-all w-full mt-6";
                btnNext.onclick = () => {
                    if (userAnswers[q.id] === undefined) {
                        alert('Pilih jawaban dulu ya!');
                        return;
                    }
                    currentQuestionIndex++;
                    renderQuestion(currentQuestionIndex);
                };
            }
        }

        function selectOption(qId, optIdx) {
            userAnswers[qId] = optIdx;
            // Rerender current to show selection
            renderQuestion(currentQuestionIndex);
        }

        async function finishAssessment() {
            // Get current question using shuffled index mapping to validate answer
            const realIndex = (shuffledIndices.length > 0) ? shuffledIndices[currentQuestionIndex] : currentQuestionIndex;
            const q = assessmentQuestions[realIndex];

            if (userAnswers[q.id] === undefined) {
                alert('Pilih jawaban dulu ya!');
                return;
            }

            // Calculate Score
            let correctCount = 0;
            assessmentQuestions.forEach(ques => {
                if (userAnswers[ques.id] === ques.correctIndex) {
                    correctCount++;
                }
            });

            const score = correctCount * 2; // 50 soal x 2 = 100
            const stars = Math.ceil(score / 20); // 0-100 -> 0-5 stars

            // Show Result
            document.getElementById('assessmentQuestionContainer').classList.add('hidden');
            document.getElementById('assessmentResultContainer').classList.remove('hidden');
            document.getElementById('assessmentResultContainer').classList.add('flex');
            document.getElementById('btnNextAssessment').classList.add('hidden');

            // Render Stars
            let starsHtml = '';
            for (let i = 0; i < 5; i++) {
                if (i < stars) {
                    starsHtml += '<span class="material-symbols-outlined text-4xl text-amber-400 fill-current animate-bounce" style="animation-delay: ' + (i * 100) + 'ms">star</span>';
                } else {
                    starsHtml += '<span class="material-symbols-outlined text-4xl text-slate-200">star</span>';
                }
            }
            document.getElementById('resultStars').innerHTML = starsHtml;
            document.getElementById('resultScoreText').innerText = `Skor Kamu: ${score} / 100`;

            // Save Status Local
            localStorage.setItem(`asesmen_day${currentDay}_stars`, stars);
            localStorage.setItem(`asesmen_day${currentDay}_score`, score);
            forceCompleteModule('asesmen', score);

            // SAVE TO SUPABASE
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    // Storing plain JSON of user answers
                    const answerData = JSON.stringify(userAnswers);

                    await supabaseClient
                        .from('module_responses')
                        .upsert({
                            student_id: user.id,
                            day_id: currentDay,
                            module_type: 'kuis',
                            answers: [answerData],
                            status: 'reviewed',
                            score: score
                        }, { onConflict: 'student_id,day_id,module_type' });
                }
            } catch (err) {
                console.error('Failed to save assessment to cloud:', err);
                alert('Peringatan: Jawaban tersimpan secara lokal namun gagal mengirim ke cloud. Mohon cek koneksi internet Anda.');
            }

        }

        async function checkExistingRefleksi() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data: responses } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'refleksi')
                    .order('created_at', { ascending: false })
                    .limit(1);

                const form = document.getElementById('refleksiForm');
                const btn = document.querySelector('#modalRefleksi button[onclick="submitRefleksi()"]');

                // Remove existing status message if any
                const existingMsg = document.getElementById('refleksiStatusMessage');
                if (existingMsg) existingMsg.remove();

                const statusMsgContainer = document.createElement('div');
                statusMsgContainer.id = 'refleksiStatusMessage';
                statusMsgContainer.className = 'mb-4 p-4 rounded-xl text-xs font-medium';
                statusMsgContainer.style.display = 'none';
                form.prepend(statusMsgContainer);

                if (responses && responses.length > 0) {
                    const r = responses[0];
                    // Handle array format properly
                    let answers = r.answers;
                    // If stored as JSON string inside array [ "JSON" ]
                    if (answers.length === 1 && typeof answers[0] === 'string' && answers[0].startsWith('{')) {
                        // But wait, submitRefleksi below sends an ARRAY of strings.
                        // Let's assume the new format is ARRAY of values.
                        // If it's the OLD format (JSON string in array), handle it.
                        try {
                            answers = JSON.parse(answers[0]);
                        } catch (e) {
                            // It's likely the new array format, so use r.answers directly
                            answers = r.answers;
                        }
                    }

                    // If answers is Array (New Format)
                    if (Array.isArray(answers) && answers.length > 1) {
                        // Map Array Index to Form Fields
                        // Q1: answers[0], Q2: answers[1], ...
                        const fieldNames = [
                            'refleksi_q1', 'refleksi_q2', 'refleksi_q3', 'refleksi_q4', 'refleksi_q5',
                            'refleksi_q6', 'refleksi_q7', 'refleksi_q8', 'refleksi_q9', 'refleksi_q10',
                            'refleksi_q11', 'refleksi_q12', 'refleksi_q13', 'refleksi_q14', 'refleksi_q15'
                        ];

                        fieldNames.forEach((name, idx) => {
                            const val = answers[idx];
                            const input = form.querySelector(`[name="${name}"]`);
                            if (input) {
                                if (input.type === 'radio') {
                                    const radio = form.querySelector(`input[name="${name}"][value="${val}"]`);
                                    if (radio) radio.checked = true;
                                } else if (input.type === 'range') {
                                    input.value = val;
                                    const fv = document.getElementById('focusVal');
                                    if (fv) fv.innerText = val;
                                } else {
                                    input.value = val;
                                }
                            }
                        });

                        // Special handling for Star Rating (Q10) which is Radio but custom UI
                        if (answers[9]) {
                            const starVal = answers[9];
                            // Update UI
                            for (let i = 1; i <= 5; i++) {
                                const lbl = document.querySelector(`label[for="star${i}"]`);
                                if (lbl) {
                                    if (i <= starVal) lbl.classList.add('text-amber-400', 'fill-current');
                                    else lbl.classList.remove('text-amber-400', 'fill-current');
                                }
                            }
                        }

                    } else if (!Array.isArray(answers) && typeof answers === 'object') {
                        // OLD object format
                        for (let i = 1; i <= 15; i++) {
                            const name = `refleksi_q${i}`;
                            const value = answers[name];
                            const input = form.querySelector(`[name="${name}"]`);
                            if (input) {
                                if (input.type === 'radio') {
                                    const radio = form.querySelector(`input[name="${name}"][value="${value}"]`);
                                    if (radio) radio.checked = true;
                                } else if (input.type === 'range') {
                                    input.value = value;
                                } else {
                                    input.value = value;
                                }
                            }
                        }
                    }

                    // Disable inputs
                    form.querySelectorAll('input, textarea').forEach(el => {
                        el.disabled = true;
                        el.classList.add('bg-slate-100', 'text-slate-500');
                    });

                    // Hide submit button
                    if (btn) btn.classList.add('hidden');

                    // Update Status UI
                    statusMsgContainer.style.display = 'block';
                    if (r.status === 'submitted') {
                        statusMsgContainer.className = "mb-4 p-4 rounded-xl text-xs font-medium bg-yellow-50 text-yellow-700 border border-yellow-200";
                        statusMsgContainer.innerHTML = "⏳ <b>Refleksi Terkirim</b><br>Menunggu feedback dari fasilitator.";
                        updateModuleUI('refleksi', 'submitted');
                    } else if (r.status === 'reviewed') {
                        statusMsgContainer.className = "mb-4 p-4 rounded-xl text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200";
                        statusMsgContainer.innerHTML = `✅ <b>Sudah Direview (Skor: ${r.score || 0})</b><br>Feedback: "${r.feedback || '-'}"`;
                        updateModuleUI('refleksi', true, r.score || 0);
                    }

                    // Update Dashboard Button
                    const dashBtn = document.querySelector('div[onclick="handleModuleClick(\'refleksi\')"]');
                    if (dashBtn) {
                        const icon = dashBtn.querySelector('.material-symbols-outlined');
                        if (icon) icon.innerText = 'check_circle';
                    }


                } else {
                    // No data - Reset form
                    form.querySelectorAll('input, textarea').forEach(el => {
                        el.disabled = false;
                        el.classList.remove('bg-slate-100', 'text-slate-500');
                        if (el.type === 'radio') el.checked = false;
                        if (el.type === 'text' || el.tagName === 'TEXTAREA') el.value = '';
                        if (el.type === 'range') { el.value = 5; document.getElementById('focusVal').innerText = '5'; }
                    });
                    // Reset stars
                    for (let i = 1; i <= 5; i++) {
                        const lbl = document.querySelector(`label[for="star${i}"]`);
                        if (lbl) lbl.classList.remove('text-amber-400', 'fill-current');
                    }

                    if (btn) {
                        btn.classList.remove('hidden');
                        btn.disabled = false;
                        btn.innerHTML = 'Kirim Refleksi';
                    }
                    statusMsgContainer.style.display = 'none';
                }
            } catch (e) {
                console.error('Error checking refleksi:', e);
            }
        }

        function openRefleksiModal() {
            document.getElementById('modalRefleksi').classList.remove('hidden');
            document.getElementById('modalRefleksi').classList.add('flex');
            checkExistingRefleksi();
            if (currentDay === 2) checkExistingAnalisis();
        }

        function closeRefleksiModal() {
            document.getElementById('modalRefleksi').classList.add('hidden');
            document.getElementById('modalRefleksi').classList.remove('flex');
        }

        async function submitRefleksi() {
            const form = document.getElementById('refleksiForm');
            const data = new FormData(form);
            const answers = [];

            // Helper to get value
            const getV = (name, def = "-") => data.get(name) || def;

            // Map Q1-Q15 to Array
            answers.push(getV('refleksi_q1'));
            answers.push(getV('refleksi_q2'));
            answers.push(getV('refleksi_q3'));
            answers.push(getV('refleksi_q4'));
            answers.push(getV('refleksi_q5', "0"));
            answers.push(getV('refleksi_q6'));
            answers.push(getV('refleksi_q7'));
            answers.push(getV('refleksi_q8'));
            answers.push(getV('refleksi_q9'));
            answers.push(getV('refleksi_q10', "0"));
            answers.push(getV('refleksi_q11'));
            answers.push(getV('refleksi_q12'));
            answers.push(getV('refleksi_q13'));
            answers.push(getV('refleksi_q14'));
            answers.push(getV('refleksi_q15'));

            // Validation: Ensure at least Q1 and Q2 are filled
            if (!answers[0] || answers[0] === "-" || !answers[1] || answers[1] === "-") {
                alert('Mohon isi minimal bagian Perasaan (No.1) dan Evaluasi (No.2) sebelum mengirim.');
                return;
            }

            const btn = document.querySelector('#modalRefleksi button[onclick="submitRefleksi()"]');
            const originalText = btn.innerText;
            btn.innerText = 'Mengirim...';
            btn.disabled = true;

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error('Silakan login ulang.');

                // Check existing
                const { data: existing } = await supabaseClient
                    .from('module_responses')
                    .select('id')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'refleksi')
                    .maybeSingle();

                let error;
                // Store answers as actual Array (JSONB in Supabase handles array automatically if column is jsonb)
                // If column is text array, this works too. 
                // Previously used [JSON.stringify(obj)], typically Supabase returns array.
                // We will send the array directly. 
                // IMPORTANT: Facilitator dashboard expects ONE item in array? 
                // Facilitator code: refData = JSON.parse(answers[0]);
                // This implies facilitator expects a JSON STRING as the first element of the array.
                // So I MUST Wrap it in [JSON.stringify(answersObject)] OR [JSON.stringify(answersArray)].
                // My facilitator update handled KEY-BASED access (getVal('refleksi_q1')).
                // So I should stick to OBJECT format wrapped in JSON String for compatibility with Facilitator code I just wrote.

                // REVERTING TO OBJECT FORMAT FOR COMPATIBILITY
                const answerObj = {};
                answerObj['refleksi_q1'] = answers[0];
                answerObj['refleksi_q2'] = answers[1];
                answerObj['refleksi_q3'] = answers[2];
                answerObj['refleksi_q4'] = answers[3];
                answerObj['refleksi_q5'] = answers[4];
                answerObj['refleksi_q6'] = answers[5];
                answerObj['refleksi_q7'] = answers[6];
                answerObj['refleksi_q8'] = answers[7];
                answerObj['refleksi_q9'] = answers[8];
                answerObj['refleksi_q10'] = answers[9];
                answerObj['refleksi_q11'] = answers[10];
                answerObj['refleksi_q12'] = answers[11];
                answerObj['refleksi_q13'] = answers[12];
                answerObj['refleksi_q14'] = answers[13];
                answerObj['refleksi_q15'] = answers[14];

                const payloadAnswers = [JSON.stringify(answerObj)];

                if (existing) {
                    const { error: updErr } = await supabaseClient
                        .from('module_responses')
                        .update({
                            answers: payloadAnswers,
                            status: 'submitted',
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existing.id);
                    error = updErr;
                } else {
                    const { error: insErr } = await supabaseClient
                        .from('module_responses')
                        .upsert({
                            student_id: user.id,
                            day_id: currentDay,
                            module_type: 'refleksi',
                            answers: payloadAnswers,
                            status: 'submitted'
                        }, {
                            onConflict: 'student_id,day_id,module_type'
                        });
                    error = insErr;
                }

                if (error) throw error;

                alert('Refleksi berhasil dikirim! Terima kasih atas masukanmu.');
                closeRefleksiModal();
                checkExistingRefleksi();
                checkAllModulesStatus(); // Sync Dashboard Badge

            } catch (e) {
                console.error('Submit Refleksi Error:', e);
                alert('Gagal mengirim refleksi: ' + e.message);
            } finally {
                if (btn) {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }
        }




        // --- GLOSARIUM LOGIC ---
        function openGlosariumModal() {
            const modal = document.getElementById('modalGlosarium');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                checkExistingGlosarium();
            }
        }

        function closeGlosariumModal() {
            const modal = document.getElementById('modalGlosarium');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        async function checkExistingGlosarium() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'glosarium')
                    .maybeSingle();

                if (data) {
                    const ans = data.answers[0];
                    const area = document.getElementById('glosariumInput');
                    if (area) {
                        area.value = ans || '';
                        area.disabled = true;
                        area.classList.add('bg-slate-100', 'text-slate-500');
                    }

                    const btn = document.getElementById('btnSubmitGlosarium');
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = `<span class="material-symbols-outlined text-sm">check_circle</span> Terkirim`;
                        btn.classList.add('bg-slate-200', 'text-slate-500', 'shadow-none');
                        btn.classList.remove('bg-emerald-500', 'text-white', 'shadow-lg');
                    }

                    const statusSection = document.getElementById('glosariumStatusSection');
                    if (statusSection) {
                        statusSection.classList.remove('hidden');
                        if (data.status === 'submitted') {
                            statusSection.innerHTML = `
                                <div class="bg-yellow-50 p-4 rounded-xl flex items-center gap-3">
                                    <span class="material-symbols-outlined text-yellow-500 animate-pulse">hourglass_top</span>
                                    <p class="text-xs text-yellow-700 font-bold">Menunggu Review Fasilitator</p>
                                </div>
                             `;
                            updateModuleUI('glosarium', 'submitted');
                        } else if (data.status === 'reviewed') {
                            statusSection.innerHTML = `
                                <div class="bg-emerald-50 p-4 rounded-xl space-y-2">
                                    <div class="flex items-center gap-2">
                                        <span class="material-symbols-outlined text-emerald-500">check_circle</span>
                                        <p class="text-xs text-emerald-700 font-bold">Dinilai: ${data.score}/100</p>
                                    </div>
                                    <p class="text-xs text-slate-600 italic">"${data.feedback || 'Bagus!'}"</p>
                                </div>
                             `;
                            updateModuleUI('glosarium', true, data.score);
                        }
                    }
                }
            } catch (e) {
                console.error('Error checkExistingGlosarium:', e);
            }
        }

        async function submitGlosarium() {
            const area = document.getElementById('glosariumInput');
            const summary = area.value.trim();

            if (!summary) {
                alert('Mohon isi jawaban tugas mandiri Glosarium.');
                return;
            }

            const btn = document.getElementById('btnSubmitGlosarium');
            btn.disabled = true;
            btn.innerHTML = 'Mengirim...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error("Sesi habis.");

                const { error } = await supabaseClient
                    .from('module_responses')
                    .upsert({
                        student_id: user.id,
                        day_id: currentDay, // Glosarium di Hari 1
                        module_type: 'glosarium',
                        answers: [summary],
                        status: 'submitted'
                    }, {
                        onConflict: 'student_id,day_id,module_type'
                    });

                if (error) throw error;

                alert('Jawaban Glosarium berhasil dikirim!');
                studentProgress[`day${currentDay}`]['glosarium'] = false;
                saveProgress();
                checkAllModulesStatus();
                checkExistingGlosarium();
                closeGlosariumModal();

            } catch (err) {
                console.error(err);
                alert('Gagal mengirim: ' + err.message);
                btn.disabled = false;
                btn.innerHTML = 'Kirim Jawaban';
            }
        }

        // --- REFLEKSI AKHIR LOGIC (DAY 3) ---
        function openRefleksiAkhirModal() {
            const modal = document.getElementById('modal-refleksi-akhir');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                checkExistingRefleksiAkhir();
            }
        }

        function closeRefleksiAkhirModal() {
            const modal = document.getElementById('modal-refleksi-akhir');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        async function checkExistingRefleksiAkhir() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', 3)
                    .eq('module_type', 'refleksi_akhir')
                    .maybeSingle();

                if (data) {
                    const btn = document.getElementById('btnSubmitRefleksiAkhir');
                    const form = document.getElementById('refleksiAkhirForm');

                    // NEW: Populate form with existing answers
                    try {
                        const answers = JSON.parse(data.answers[0]);
                        for (let i = 1; i <= 10; i++) {
                            const input = form.querySelector(`[name="ra_q${i}"]`);
                            if (input) input.value = answers[`q${i}`] || '';
                        }
                        const scoreInput = form.querySelector('[name="ra_q9_score"]');
                        if (scoreInput) scoreInput.value = answers['q9_score'] || 10;
                    } catch (e) {
                        console.error('Error parsing existing Refleksi Akhir answers:', e);
                    }

                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = `<span class="material-symbols-outlined text-sm">check_circle</span> Terkirim & Terkunci`;
                        btn.classList.add('bg-slate-200', 'text-slate-400', 'shadow-none');
                        btn.classList.remove('bg-rose-500', 'text-white', 'shadow-lg');
                    }

                    // Lock all textareas and inputs
                    if (form) {
                        const inputs = form.querySelectorAll('textarea, input');
                        inputs.forEach(i => {
                            i.disabled = true;
                            i.classList.add('bg-slate-100', 'text-slate-400');
                        });
                    }

                    if (data.status === 'submitted') {
                        updateModuleUI('refleksi-akhir', 'submitted');
                    } else if (data.status === 'reviewed') {
                        updateModuleUI('refleksi-akhir', true, data.score);
                    }
                }
            } catch (e) {
                console.error('Error checkExistingRefleksiAkhir:', e);
            }
        }

        async function submitRefleksiAkhir() {
            const form = document.getElementById('refleksiAkhirForm');
            const formData = new FormData(form);
            const btn = document.getElementById('btnSubmitRefleksiAkhir');

            // Validation
            let isValid = true;
            for (let i = 1; i <= 10; i++) {
                if (!formData.get(`ra_q${i}`)) isValid = false;
            }
            if (!formData.get('ra_q9_score')) isValid = false;

            if (!isValid) {
                alert('Mohon lengkapi semua 10 pertanyaan refleksi sebelum mengirim.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined text-sm animate-spin">sync</span> Mengirim...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error("Sesi login berakhir.");

                const answers = {};
                for (let i = 1; i <= 10; i++) {
                    answers[`q${i}`] = formData.get(`ra_q${i}`);
                }
                answers['q9_score'] = formData.get('ra_q9_score');

                const { error } = await supabaseClient
                    .from('module_responses')
                    .upsert({
                        student_id: user.id,
                        day_id: 3,
                        module_type: 'refleksi_akhir',
                        answers: [JSON.stringify(answers)],
                        status: 'submitted',
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'student_id,day_id,module_type'
                    });

                if (error) throw error;

                alert('Refleksi akhir berhasil disimpan! Terima kasih atas partisipasimu dalam projek ini. ❤️');
                closeRefleksiAkhirModal();
                checkExistingRefleksiAkhir();
                checkAllModulesStatus();

            } catch (err) {
                console.error(err);
                alert('Gagal mengirim: ' + err.message);
                btn.disabled = false;
                btn.innerHTML = 'Simpan & Kirim Refleksi';
            }
        }

        // --- UTILITY: REUSABLE IMAGE COMPRESSION ---
        async function compressImage(file, maxWidth = 800, quality = 0.6) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            if (blob) resolve(blob);
                            else reject(new Error("Gagal mengompresi gambar."));
                        }, 'image/jpeg', quality);
                    };
                };
                reader.onerror = (err) => reject(err);
            });
        }

        // --- CERITA KECILKU HARI INI LOGIC (DAY 3) ---
        let currentCeritaPhoto = null;

        function openCeritaKecilModal() {
            const modal = document.getElementById('modalCeritaKecil');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                checkExistingCeritaKecil();
            }
        }

        function closeCeritaKecilModal() {
            const modal = document.getElementById('modalCeritaKecil');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        function resetCeritaPhoto() {
            currentCeritaPhoto = null;
            document.getElementById('inputCeritaPhoto').value = "";
            document.getElementById('previewCeritaImage').src = "";
            document.getElementById('areaUploadCerita').classList.remove('hidden');
            document.getElementById('areaPreviewCerita').classList.add('hidden');
        }

        function updateCeritaCounter() {
            const text = document.getElementById('textCerita').value;
            const charCount = text.length;
            const wordCount = text.trim() === "" ? 0 : text.trim().split(/\s+/).length;

            document.getElementById('charCount').textContent = charCount;
            document.getElementById('wordCount').textContent = wordCount;

            const status = document.getElementById('charStatus');
            if (charCount >= 50) {
                status.textContent = 'Syarat Terpenuhi ✔';
                status.classList.remove('text-red-400');
                status.classList.add('text-emerald-500');
            } else {
                status.textContent = '*Minimal 50 karakter';
                status.classList.remove('text-emerald-500');
                status.classList.add('text-red-400');
            }
        }

        async function handleCeritaPhoto(input) {
            const file = input.files[0];
            if (!file) return;

            const areaUpload = document.getElementById('areaUploadCerita');
            const areaPreview = document.getElementById('areaPreviewCerita');
            const previewImg = document.getElementById('previewCeritaImage');

            // Optimistic loading state
            areaUpload.innerHTML = '<div class="animate-spin size-8 border-4 border-indigo-500 border-t-transparent rounded-full mb-3"></div><p class="text-xs font-bold text-indigo-400">Memproses Foto...</p>';

            try {
                const compressed = await compressImage(file, 800, 0.7);
                currentCeritaPhoto = compressed;

                previewImg.src = URL.createObjectURL(compressed);
                areaUpload.classList.add('hidden');
                areaPreview.classList.remove('hidden');
                // Restore upload area text in case of next use
                areaUpload.innerHTML = '<div class="size-16 rounded-full bg-white text-indigo-500 flex items-center justify-center mb-3 shadow-md group-hover:scale-110 transition-transform"><span class="material-symbols-outlined text-4xl">add_a_photo</span></div><p class="text-xs font-black text-indigo-400 uppercase tracking-widest">Ambil/Pilih Foto Kenangan</p>';
            } catch (e) {
                console.error(e);
                alert('Gagal memproses foto.');
                resetCeritaPhoto();
            }
        }

        async function submitCeritaKecil() {
            const storyText = document.getElementById('textCerita').value.trim();
            const btn = document.getElementById('btnSaveCerita');

            if (!currentCeritaPhoto && !document.getElementById('previewCeritaImage').src.startsWith('http')) {
                alert('Silakan ambil atau pilih satu foto kenangan hari ini.');
                return;
            }

            if (storyText.length < 50) {
                alert('Ceritakan lebih banyak pengalamanmu hari ini (minimal 50 karakter).');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined text-sm animate-spin">sync</span> Menyimpan...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error("Sesi habis.");

                let photoUrl = document.getElementById('previewCeritaImage').src;

                // 1. Upload Photo to Storage if new
                if (currentCeritaPhoto) {
                    const fileName = `${user.id}_cerita_${Date.now()}.jpg`;
                    const { data: uploadData, error: uploadErr } = await supabaseClient.storage
                        .from('documentation')
                        .upload(`cerita/${fileName}`, currentCeritaPhoto);

                    if (uploadErr) throw uploadErr;

                    const { data: urlData } = supabaseClient.storage
                        .from('documentation')
                        .getPublicUrl(`cerita/${fileName}`);

                    photoUrl = urlData.publicUrl;
                }

                // 2. Save to DB
                const answers = JSON.stringify({
                    story: storyText,
                    photo_url: photoUrl
                });

                const { error: dbErr } = await supabaseClient
                    .from('module_responses')
                    .upsert({
                        student_id: user.id,
                        day_id: 3,
                        module_type: 'cerita_kecil',
                        answers: [answers],
                        status: 'submitted',
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'student_id,day_id,module_type'
                    });

                if (dbErr) throw dbErr;

                alert('Cerita kenanganmu berhasil disimpan! ✨');
                closeCeritaKecilModal();
                checkAllModulesStatus();

            } catch (err) {
                console.error(err);
                alert('Gagal menyimpan cerita: ' + err.message);
                btn.disabled = false;
                btn.innerHTML = 'Simpan Kenangan <span class="material-symbols-outlined text-sm">auto_stories</span>';
            }
        }

        async function checkExistingCeritaKecil() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', 3)
                    .eq('module_type', 'cerita_kecil')
                    .maybeSingle();

                if (data) {
                    const payload = JSON.parse(data.answers[0]);
                    document.getElementById('textCerita').value = payload.story;
                    updateCeritaCounter();
                    document.getElementById('previewCeritaImage').src = payload.photo_url;

                    document.getElementById('areaUploadCerita').classList.add('hidden');
                    document.getElementById('areaPreviewCerita').classList.remove('hidden');
                    document.getElementById('btnResetCeritaPhoto').classList.add('hidden'); // Cannot delete if submitted

                    const btn = document.getElementById('btnSaveCerita');
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = '<span class="material-symbols-outlined text-sm">check_circle</span> Kenangan Tersimpan & Terkunci';
                        btn.classList.add('bg-slate-200', 'text-slate-400', 'shadow-none');
                        btn.classList.remove('bg-indigo-500', 'text-white', 'shadow-lg');
                    }

                    document.getElementById('textCerita').disabled = true;
                    document.getElementById('textCerita').classList.add('bg-slate-50', 'text-slate-500');
                    document.getElementById('inputCeritaPhoto').disabled = true;

                    if (data.status === 'submitted') {
                        updateModuleUI('cerita-kecil', 'submitted');
                    } else if (data.status === 'reviewed') {
                        updateModuleUI('cerita-kecil', true, data.score);
                    }
                }
            } catch (e) {
                console.error('Error checkExistingCeritaKecil:', e);
            }
        }

        // --- RECOVERY: DOCUMENTATION HANDLERS (DAY 2 & 3) ---
        async function handleCategoryPhoto(category, input) {
            const file = input.files[0];
            if (!file) return;

            const areaUpload = document.getElementById(`upload-area-${category}`);
            const areaPreview = document.getElementById(`preview-area-${category}`);
            const previewImg = document.getElementById(`preview-${category}`);

            // Store original innerHTML for recovery
            const originalHTML = areaUpload.innerHTML;

            try {
                areaUpload.innerHTML = '<p class="text-xs font-bold text-slate-400 animate-pulse">Memproses...</p>';
                const compressed = await compressImage(file, 800, 0.6);
                window.day2Photos[category] = compressed;

                previewImg.src = URL.createObjectURL(compressed);
                areaUpload.classList.add('hidden');
                areaPreview.classList.remove('hidden');
                checkDocumentationReady();

                // Restore original HTML for next time (in case image is removed)
                areaUpload.innerHTML = originalHTML;
            } catch (e) {
                console.error(e);
                alert("Gagal memproses foto: " + e.message);
                areaUpload.innerHTML = originalHTML;
            }
        }

        function removeCategoryPhoto(category) {
            window.day2Photos[category] = null;
            document.getElementById(`upload-area-${category}`).classList.remove('hidden');
            document.getElementById(`preview-area-${category}`).classList.add('hidden');
            document.getElementById(`doc-${category}`).value = "";
            checkDocumentationReady();
        }

        async function handleCategoryPhotoDay3(category, input) {
            const file = input.files[0];
            if (!file) return;

            const areaUpload = document.getElementById(`upload-area-day3-${category}`);
            const areaPreview = document.getElementById(`preview-area-day3-${category}`);
            const previewImg = document.getElementById(`preview-day3-${category}`);

            // Store original innerHTML for recovery
            const originalHTML = areaUpload.innerHTML;

            try {
                areaUpload.innerHTML = '<p class="text-xs font-bold text-slate-400 animate-pulse">Memproses...</p>';
                // Lowered from 1000 to 800 for better memory management on mobile
                const compressed = await compressImage(file, 800, 0.6);
                window.day3Photos[category] = compressed;

                previewImg.src = URL.createObjectURL(compressed);
                areaUpload.classList.add('hidden');
                areaPreview.classList.remove('hidden');
                checkDocumentationReadyDay3();

                // Restore original HTML for next time (in case image is removed)
                areaUpload.innerHTML = originalHTML;
            } catch (e) {
                console.error(e);
                alert("Gagal memproses foto: " + e.message);
                areaUpload.innerHTML = originalHTML;
            }
        }

        function removeCategoryPhotoDay3(category) {
            window.day3Photos[category] = null;
            document.getElementById(`upload-area-day3-${category}`).classList.remove('hidden');
            document.getElementById(`preview-area-day3-${category}`).classList.add('hidden');
            document.getElementById(`doc-day3-${category}`).value = "";
            checkDocumentationReadyDay3();
        }

        function checkDocumentationReady() {
            const categories = ['makanan', 'minuman', 'stand', 'iklan', 'presentasi'];
            const allFilled = categories.every(cat => window.day2Photos[cat] || (document.getElementById(`preview-${cat}`).src.startsWith('http')));
            document.getElementById('btnSubmitAllDocs').disabled = !allFilled;
        }

        function checkDocumentationReadyDay3() {
            const categories = ['stand', 'gizi', 'jajan', 'acara', 'bersama'];
            const allFilled = categories.every(cat => window.day3Photos[cat] || (document.getElementById(`preview-day3-${cat}`).src.startsWith('http')));
            document.getElementById('btnSubmitAllDocsDay3').disabled = !allFilled;
        }

        async function submitAllDocumentation() {
            const btn = document.getElementById('btnSubmitAllDocs');
            const categories = ['makanan', 'minuman', 'stand', 'iklan', 'presentasi'];

            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined text-sm animate-spin">sync</span> Mengirim Dokumentasi...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error("Sesi habis.");

                const photoUrls = {};

                // 1. Upload new photos
                for (const cat of categories) {
                    if (window.day2Photos[cat]) {
                        const fileName = `${user.id}_d2_${cat}_${Date.now()}.jpg`;
                        const { data: uploadData, error: uploadErr } = await supabaseClient.storage
                            .from('documentation')
                            .upload(`day2/${fileName}`, window.day2Photos[cat]);

                        if (uploadErr) throw uploadErr;

                        const { data: urlData } = supabaseClient.storage
                            .from('documentation')
                            .getPublicUrl(`day2/${fileName}`);

                        photoUrls[cat] = urlData.publicUrl;
                    } else {
                        // Keep existing if any
                        const preview = document.getElementById(`preview-${cat}`).src;
                        if (preview.startsWith('http')) {
                            photoUrls[cat] = preview;
                        }
                    }
                }

                // 2. Save to DB using upsert for reliability and retries
                const { error: dbErr } = await supabaseClient
                    .from('module_responses')
                    .upsert({
                        student_id: user.id,
                        day_id: 2,
                        module_type: 'dokumentasi',
                        answers: [JSON.stringify(photoUrls)],
                        status: 'submitted',
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'student_id,day_id,module_type'
                    });

                if (dbErr) throw dbErr;

                alert('Seluruh dokumentasi Hari 2 berhasil terkirim! 📸');
                closeDokumentasiDay2Modal();
                checkAllModulesStatus();
            } catch (err) {
                console.error(err);
                alert('Gagal mengirim dokumentasi: ' + err.message);
                btn.disabled = false;
                btn.innerHTML = 'Kirim Semua Dokumentasi <span class="material-symbols-outlined text-sm">send</span>';
            }
        }

        async function checkExistingDocumentation() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', 2)
                    .eq('module_type', 'dokumentasi')
                    .maybeSingle();

                if (data) {
                    const urls = JSON.parse(data.answers[0]);
                    Object.keys(urls).forEach(cat => {
                        const previewImg = document.getElementById(`preview-${cat}`);
                        const uploadArea = document.getElementById(`upload-area-${cat}`);
                        const previewArea = document.getElementById(`preview-area-${cat}`);

                        if (previewImg && urls[cat]) {
                            previewImg.src = urls[cat];
                            uploadArea.classList.add('hidden');
                            previewArea.classList.remove('hidden');
                            // Hide delete button in preview area for locked state
                            const delBtn = previewArea.querySelector('button');
                            if (delBtn) delBtn.classList.add('hidden');
                        }
                    });

                    const submitBtn = document.getElementById('btnSubmitAllDocs');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span class="material-symbols-outlined text-sm">check_circle</span> Dokumentasi Terkirim & Terkunci';
                    }

                    if (data.status === 'submitted') {
                        updateModuleUI('dokumentasi', 'submitted');
                    } else if (data.status === 'reviewed') {
                        updateModuleUI('dokumentasi', true, data.score);
                    }
                }
            } catch (e) {
                console.error('Error checkExistingDocumentation:', e);
            }
        }

        async function submitAllDocumentationDay3() {
            const btn = document.getElementById('btnSubmitAllDocsDay3');
            const categories = ['stand', 'gizi', 'jajan', 'acara', 'bersama'];

            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined text-sm animate-spin">sync</span> Mengirim Dokumentasi...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error("Sesi habis. Silakan login ulang.");

                const photoUrls = {};

                // 1. Upload new photos sequentially to avoid heavy concurrent memory/network usage
                for (const cat of categories) {
                    if (window.day3Photos[cat]) {
                        const fileName = `${user.id}_d3_${cat}_${Date.now()}.jpg`;
                        const { data: uploadData, error: uploadErr } = await supabaseClient.storage
                            .from('documentation')
                            .upload(`day3/${fileName}`, window.day3Photos[cat]);

                        if (uploadErr) throw uploadErr;

                        const { data: urlData } = supabaseClient.storage
                            .from('documentation')
                            .getPublicUrl(`day3/${fileName}`);

                        photoUrls[cat] = urlData.publicUrl;
                    } else {
                        const preview = document.getElementById(`preview-day3-${cat}`).src;
                        if (preview.startsWith('http')) {
                            photoUrls[cat] = preview;
                        }
                    }
                }

                // 2. Save to DB using upsert to prevent duplicate key errors and allow retries
                const { error: dbErr } = await supabaseClient
                    .from('module_responses')
                    .upsert({
                        student_id: user.id,
                        day_id: 3,
                        module_type: 'dokumentasi',
                        answers: [JSON.stringify(photoUrls)],
                        status: 'submitted',
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'student_id,day_id,module_type'
                    });

                if (dbErr) throw dbErr;

                alert('Seluruh dokumentasi Hari 3 berhasil terkirim! 🎪');
                closeDokumentasiDay3Modal();
                checkAllModulesStatus();
            } catch (err) {
                console.error('Final Submit Error:', err);
                alert('Gagal mengirim dokumentasi: ' + (err.message || 'Terjadi kesalahan jaringan.'));
                btn.disabled = false;
                btn.innerHTML = 'Kirim Semua Dokumentasi Hari 3';
            }
        }

        async function checkExistingDocumentationDay3() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', 3)
                    .eq('module_type', 'dokumentasi')
                    .maybeSingle();

                if (data) {
                    const urls = JSON.parse(data.answers[0]);
                    Object.keys(urls).forEach(cat => {
                        const previewImg = document.getElementById(`preview-day3-${cat}`);
                        const uploadArea = document.getElementById(`upload-area-day3-${cat}`);
                        const previewArea = document.getElementById(`preview-area-day3-${cat}`);

                        if (previewImg && urls[cat]) {
                            previewImg.src = urls[cat];
                            uploadArea.classList.add('hidden');
                            previewArea.classList.remove('hidden');
                            const delBtn = previewArea.querySelector('button');
                            if (delBtn) delBtn.classList.add('hidden');
                        }
                    });

                    const submitBtn = document.getElementById('btnSubmitAllDocsDay3');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span class="material-symbols-outlined text-sm">check_circle</span> Dokumentasi Terkirim & Terkunci';
                    }

                    if (data.status === 'submitted') {
                        updateModuleUI('dokumentasi', 'submitted');
                    } else if (data.status === 'reviewed') {
                        updateModuleUI('dokumentasi', true, data.score);
                    }
                }
            } catch (e) {
                console.error('Error checkExistingDocumentationDay3:', e);
            }
        }

        // --- ATTACH TO MODAL OPENERS ---
        function openDokumentasiDay2Modal() {
            const modal = document.getElementById('modal-dokumentasi-day2');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                checkExistingDocumentation();
            }
        }
        function closeDokumentasiDay2Modal() {
            const modal = document.getElementById('modal-dokumentasi-day2');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }


    </script>

    <script>
        // Init logic if needed
    </script>
</body>

</html>