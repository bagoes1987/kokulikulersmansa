<!DOCTYPE html>
<html class="light" lang="id">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Dashboard Kegiatan - SMAN 1 Belitang</title>
    <link rel="icon" href="./logo-sekolah.png" type="image/png">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <!-- Deployment Trigger v1.0.8 -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "emerald-custom": "#10B981",
                        "terracotta": "#E2725B",
                        "bg-main": "#F8FAFB",
                    },
                    fontFamily: {
                        "sans": ["Inter", "sans-serif"]
                    }
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        @layer base {
            body {
                @apply font-sans bg-bg-main text-slate-800;
            }
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 48;
        }

        .ios-shadow {
            box-shadow: 0 4px 20px -1px rgba(0, 0, 0, 0.05);
        }

        .circular-progress {
            background: conic-gradient(#10B981 0deg, #E2E8F0 0deg);
            transition: background 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body class="min-h-screen">
    <div class="relative flex min-h-screen w-full flex-col max-w-md mx-auto bg-bg-main overflow-x-hidden pb-24">
        <!-- Header -->
        <header
            class="sticky top-0 z-50 bg-white/80 backdrop-blur-lg border-b border-slate-100 px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="h-16 w-16 rounded-full bg-cover bg-center border-2 border-slate-100 shadow-sm"
                    id="studentPhoto"
                    style='background-image: url("https://ui-avatars.com/api/?name=Siswa&background=13ec6d&color=fff&size=256");'>
                </div>
                <div>
                    <h1 class="text-lg font-black text-slate-900 leading-tight" id="headerStudentName">Memuat...</h1>
                    <p class="text-[13px] text-slate-500 font-bold mt-0.5">
                        <span id="headerClass">...</span> • SMAN 1 BELITANG
                    </p>
                    <div class="mt-2.5 flex flex-col gap-1.5">
                        <div class="flex items-start gap-1 text-[11px] leading-tight">
                            <span class="text-slate-400 font-medium w-[38px] shrink-0">Koord:</span>
                            <span id="headerCoord" class="text-slate-700 font-bold">-</span>
                        </div>
                        <div class="flex items-start gap-1 text-[11px] leading-tight">
                            <span class="text-slate-400 font-medium w-[38px] shrink-0">Fasil:</span>
                            <span id="headerFasil" class="text-slate-700 font-bold">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="relative flex items-center justify-center">
                <div class="circular-progress h-14 w-14 rounded-full flex items-center justify-center"
                    id="progressCircle">
                    <div class="h-11 w-11 bg-white rounded-full flex items-center justify-center">
                        <span class="text-[12px] font-bold text-emerald-custom" id="progressPercent">0%</span>
                    </div>
                </div>
                <!-- Checkmark muncul jika 100% -->
                <div class="absolute -bottom-2 -right-1 bg-white rounded-full p-0.5 shadow-sm hidden"
                    id="progressCheck">
                    <span class="material-symbols-outlined !text-xs text-emerald-custom">check_circle</span>
                </div>
            </div>
        </header>

        <!-- Day Tabs -->
        <div class="px-6 py-6">
            <div class="bg-slate-200/50 p-1 rounded-2xl flex items-center">
                <button onclick="switchDay(1)"
                    class="flex-1 py-3 rounded-xl text-base font-semibold bg-white text-emerald-custom shadow-sm transition-all"
                    id="tab-day1">Hari 1</button>
                <button onclick="switchDay(2)"
                    class="flex-1 py-3 rounded-xl text-base font-semibold text-slate-500 hover:text-slate-700 transition-all"
                    id="tab-day2">Hari 2</button>
                <button onclick="switchDay(3)"
                    class="flex-1 py-3 rounded-xl text-base font-semibold text-slate-500 hover:text-slate-700 transition-all"
                    id="tab-day3">Hari 3</button>
                <button onclick="switchDay('nilai')"
                    class="flex-1 py-3 rounded-xl text-base font-semibold text-slate-500 hover:text-slate-700 transition-all"
                    id="tab-nilai">Nilai</button>
            </div>
        </div>

        <!-- Title -->
        <div class="px-6 mb-4">
            <h2 class="text-2xl font-bold text-slate-900" id="dashboardTitle">Dasbor Kegiatan</h2>
            <p class="text-base text-slate-500" id="dashboardSubtitle">Selesaikan modul hari ini</p>
        </div>

        <!-- Module Grid -->
        <div id="module-grid-container" class="animate-fade-in block">
            <div class="grid grid-cols-2 gap-4 px-6">
                <!-- Pertanyaan Pemantik -->
                <div onclick="toggleModule('pemantik')"
                    class="bg-amber-50/50 p-4 rounded-[24px] ios-shadow border border-amber-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-amber-400 flex items-center justify-center text-white shadow-lg shadow-amber-200">
                        <span class="material-symbols-outlined !text-2xl">lightbulb</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Pertanyaan Pemantik</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-pemantik">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-pemantik">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>

                <!-- Materi Belajar -->
                <div onclick="toggleModule('materi')"
                    class="bg-blue-50/50 p-4 rounded-[24px] ios-shadow border border-blue-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-blue-500 flex items-center justify-center text-white shadow-lg shadow-blue-200">
                        <span class="material-symbols-outlined !text-2xl">description</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Materi Belajar</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-materi">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-materi">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>

                <!-- Video Belajar -->
                <div id="module-video" onclick="toggleModule('video')"
                    class="bg-red-50/50 p-4 rounded-[24px] ios-shadow border border-red-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-red-500 flex items-center justify-center text-white shadow-lg shadow-red-200">
                        <span class="material-symbols-outlined !text-2xl">play_circle</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Video Belajar</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-video">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-video">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>

                <!-- LKPD Digital -->
                <div id="module-lkpd" onclick="toggleModule('lkpd')"
                    class="bg-orange-50/50 p-4 rounded-[24px] ios-shadow border border-orange-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-terracotta flex items-center justify-center text-white shadow-lg shadow-terracotta/30">
                        <span class="material-symbols-outlined !text-2xl">edit_note</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">LKPD Digital</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-lkpd">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-lkpd">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>

                <!-- Asesmen -->
                <div id="module-asesmen" onclick="toggleModule('asesmen')"
                    class="bg-purple-50/50 p-4 rounded-[24px] ios-shadow border border-purple-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-purple-500 flex items-center justify-center text-white shadow-lg shadow-purple-200">
                        <span class="material-symbols-outlined !text-2xl">task_alt</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Assessment</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-asesmen">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-asesmen">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>

                <!-- Dokumentasi Foto -->
                <div onclick="toggleModule('dokumentasi')"
                    class="bg-indigo-50/50 p-4 rounded-[24px] ios-shadow border border-indigo-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-indigo-500 flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                        <span class="material-symbols-outlined !text-2xl">photo_camera</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Dokumentasi Foto</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-dokumentasi">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-dokumentasi">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>

                <!-- Glosarium -->
                <div id="module-glosarium" onclick="openGlosariumModal()"
                    class="bg-cyan-50/50 p-4 rounded-[24px] ios-shadow border border-cyan-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-cyan-500 flex items-center justify-center text-white shadow-lg shadow-cyan-200">
                        <span class="material-symbols-outlined !text-2xl">dictionary</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Glosarium</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-glosarium">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-glosarium">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>

                <!-- Refleksi -->
                <div id="module-refleksi" onclick="openRefleksiModal()"
                    class="bg-rose-50/50 p-4 rounded-[24px] ios-shadow border border-rose-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                    <div
                        class="h-12 w-12 rounded-2xl bg-rose-500 flex items-center justify-center text-white shadow-lg shadow-rose-200">
                        <span class="material-symbols-outlined !text-2xl">self_improvement</span>
                    </div>
                    <div>
                        <h3 class="text-[15px] font-bold text-slate-800">Refleksi</h3>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined !text-base text-slate-400"
                                id="status-refleksi">radio_button_unchecked</span>
                            <span class="text-[13px] font-semibold text-slate-400" id="label-refleksi">Belum
                                Selesai</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nilai Final / Report Card Section -->
        <div id="nilai-report-container" class="hidden animate-slide-up px-6 pb-24">
            <div
                class="bg-white rounded-[2.5rem] p-8 shadow-xl border border-slate-100 text-center relative overflow-hidden">
                <!-- Decorative BG -->
                <div
                    class="absolute top-0 left-0 w-full h-24 bg-gradient-to-br from-emerald-500/10 to-teal-500/10 rounded-b-[50%] -z-0">
                </div>

                <div class="relative z-10">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Nilai Kokurikuler
                    </p>

                    <div id="final-star-display" class="mb-4">
                        <div class="flex justify-center gap-1 text-4xl mb-2">
                            <span class="material-symbols-outlined text-slate-200"
                                style="font-variation-settings: 'FILL' 1">star</span>
                            <span class="material-symbols-outlined text-slate-200"
                                style="font-variation-settings: 'FILL' 1">star</span>
                            <span class="material-symbols-outlined text-slate-200"
                                style="font-variation-settings: 'FILL' 1">star</span>
                            <span class="material-symbols-outlined text-slate-200"
                                style="font-variation-settings: 'FILL' 1">star</span>
                            <span class="material-symbols-outlined text-slate-200"
                                style="font-variation-settings: 'FILL' 1">star</span>
                        </div>
                        <p class="text-xs text-slate-400 font-bold" id="final-total-score">Belum Dinilai</p>
                    </div>

                    <div id="final-badge-container" class="my-6">
                        <div class="inline-block px-8 py-3 bg-slate-50 rounded-full border border-slate-200">
                            <span class="text-sm font-black text-slate-400">MENUNGGU PENILAIAN</span>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100 text-left">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Deskripsi
                            Capaian</p>
                        <p class="text-xs text-slate-600 font-medium leading-relaxed text-justify"
                            id="final-description">
                            Fasilitator belum mempublikasikan nilai akhir projekmu. Silakan selesaikan semua tugas Hari
                            1-3.
                        </p>
                    </div>

                    <div id="final-feedback-section" class="mt-4 hidden">
                        <div class="bg-amber-50 p-6 rounded-3xl border border-amber-100 text-left">
                            <p class="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-2">Catatan
                                Fasilitator</p>
                            <p class="text-xs text-slate-700 font-medium leading-relaxed italic text-justify"
                                id="final-feedback-text">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="switchDay(3)" id="btn-back-to-task"
                class="w-full mt-6 py-4 rounded-2xl bg-slate-800 text-white font-bold shadow-lg shadow-slate-200 active:scale-95 transition-transform">
                Kembali ke Tugas
            </button>
        </div>

        <!-- Bottom Navigation -->
        <nav
            class="fixed bottom-0 w-full max-w-md bg-white/90 backdrop-blur-xl border-t border-slate-100 px-8 py-3 pb-8 flex justify-between items-center z-[100]">
            <button onclick="window.location.href='index.html'"
                class="flex flex-col items-center gap-1 text-slate-400 transition-transform active:scale-90">
                <span class="material-symbols-outlined !text-2xl">home</span>
                <span class="text-[12px] font-medium">Beranda</span>
            </button>
            <button onclick="window.location.href='dashboard-kegiatan.html'"
                class="flex flex-col items-center gap-1 text-emerald-custom transition-transform active:scale-90">
                <span class="material-symbols-outlined !text-2xl">grid_view</span>
                <span class="text-[12px] font-bold">Dasbor</span>
            </button>
            <button onclick="window.location.href='pengaturan-akun.html'"
                class="flex flex-col items-center gap-1 text-slate-400 transition-transform active:scale-90">
                <span class="material-symbols-outlined !text-2xl">person</span>
                <span class="text-[12px] font-medium">Profil</span>
            </button>
            <button onclick="logout()"
                class="flex flex-col items-center gap-1 text-slate-400 transition-transform active:scale-90 hover:text-red-500">
                <span class="material-symbols-outlined !text-2xl">logout</span>
                <span class="text-[12px] font-medium">Keluar</span>
            </button>
        </nav>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Dynamic Content Data -->
    <script src="data/assessment_data.js"></script>
    <script src="data/workshop_content.js"></script>

    <script>
        // Inisialisasi Supabase
        const supabaseUrl = 'https://jnsqqswpkigyzewnbvaf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impuc3Fxc3dwa2lneXpld25idmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NjA3NDIsImV4cCI6MjA4NTIzNjc0Mn0.RrjPnddC55Xv9CLCtG8-1RyDmEkYg_04tHeKqRE7pok';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let currentDay = 1;

        // Struktur data progress default (3 hari x 8 modul)
        const defaultProgress = {
            day1: { pemantik: false, materi: false, video: false, lkpd: false, asesmen: false, dokumentasi: false, glosarium: false, refleksi: false },
            day2: { pemantik: false, materi: false, video: false, lkpd: false, asesmen: false, dokumentasi: false, glosarium: false, refleksi: false },
            day3: { pemantik: false, materi: false, video: false, lkpd: false, asesmen: false, dokumentasi: false, glosarium: false, refleksi: false }
        };

        let studentProgress = JSON.parse(JSON.stringify(defaultProgress));

        // Load student data
        async function loadStudentData() {
            try {
                // 1. CEK SESSION AUTH (HANYA INI YANG BOLEH REDIRECT KE LOGIN)
                const { data: { session }, error: authError } = await supabaseClient.auth.getSession();

                if (authError || !session) {
                    console.warn('No session found or auth error, redirecting to login.');
                    window.location.href = 'login-siswa.html';
                    return;
                }

                // 2. LOGIKA INTERNAL DASHBOARD (DIBUNGKUS AGAR TIDAK LOOP REDIRECT)
                try {
                    const studentDataStr = localStorage.getItem('student_data');

                    if (studentDataStr && studentDataStr !== "undefined") {
                        const studentData = JSON.parse(studentDataStr);
                        if (studentData) {
                            // Update Header Info (Nama & Kelas)
                            if (document.getElementById('headerStudentName')) document.getElementById('headerStudentName').textContent = studentData.nama || 'Siswa';
                            if (document.getElementById('headerClass')) document.getElementById('headerClass').textContent = studentData.kelas || 'X.1';

                            // Update header photo
                            const photoEl = document.getElementById('studentPhoto');
                            if (photoEl) {
                                if (studentData.photo_url) {
                                    photoEl.style.backgroundImage = `url("${studentData.photo_url}")`;
                                } else {
                                    const photoUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(studentData.nama)}&background=13ec6d&color=fff&size=256`;
                                    photoEl.style.backgroundImage = `url("${photoUrl}")`;
                                }
                            }

                            // --- MAPPING KOORDINATOR & FASILITATOR ---
                            // ... (Mapping data remains same) ...
                            const trialMap = {
                                'X.TRIAL-1': { koord: 'Koordinator Trial A', fasil: 'Fasilitator Trial 1' },
                                'X.TRIAL-2': { koord: 'Koordinator Trial A', fasil: 'Fasilitator Trial 2' },
                                'X.TRIAL-3': { koord: 'Koordinator Trial B', fasil: 'Fasilitator Trial 3' }
                            };

                            const realClassMap = {
                                'X.1': { koord: 'Lucia Erviana, S.Pd., M.Pd.', fasil: 'Sukirno, S.Pd. & Ari Muchtrinai N. N, S.Pd.I.' },
                                'X.2': { koord: 'Lucia Erviana, S.Pd., M.Pd.', fasil: 'Handaroh, S.Pd. & Fantas Jaya A, S.Pd.' },
                                'X.3': { koord: 'Lucia Erviana, S.Pd., M.Pd.', fasil: 'Nelly Kurniasih, S.Pd. & Fika Mega Elita, S.Pd.' },
                                'X.4': { koord: 'Ninda Ningtyas, S.Pd., M.Si.', fasil: 'Siti Anita, S.Pd. & Latifatu Anisa, S. Pd.' },
                                'X.5': { koord: 'Vivi Amelia, S.Pd.', fasil: 'Atik Setianingsih, S.Pd. & Lovelya Valentina, S.Pd.' },
                                'X.6': { koord: 'Vivi Amelia, S.Pd.', fasil: 'Wiwik Eko Prihatin, S.Pd., M.M. & Andi Cahya Sanjaya, S.Pd.' },
                                'X.7': { koord: 'Kustiani, S.Pd.', fasil: 'Azuari Dian Prasasti, S.Pd. & Deni Yunarti, S.Pd.' },
                                'X.8': { koord: 'Aprilyan Dona, S.Pd.', fasil: 'Fajar Abdul Majid, S.Pd & Nora Nurhalita, S.Pd.' },
                                'X.9': { koord: 'Aprilyan Dona, S.Pd.', fasil: 'Andree Prasetyo, S.Pd. & Sindy Dwi Pertiwi, M.Pd.' },
                                'X.10': { koord: 'Ika Setiawati, S.Pd', fasil: 'Indah Sulmayanti, M.Pd. & M. Hafiz Sytar, S.Kom.' },
                                'X.11': { koord: 'Anastasiya Candra M, S.Pd.', fasil: 'Pandu Aditya, M.Pd. & Tiar Hajunilato, M.Pd.' },
                                'XI.1': { koord: 'Dr. Didi Franzhardi, M.Pd.', fasil: 'Try Puri anggraini, S.Pd., M.Pd. & Lia Ningrum, S.Pd.' },
                                'XI.2': { koord: 'Dr. Didi Franzhardi, M.Pd.', fasil: 'Hermanto, S.Pd., M.Pd. & Santi Aryanti, S.Pd.' },
                                'XI.3': { koord: 'Ika Setiawati, S.Pd', fasil: 'Nengsi Juita, M.Pd.Si. & Hedi Prawito, S.Pd.' },
                                'XI.4': { koord: 'Kartika Sari, S.Pd.', fasil: 'Anggun Saymona, S.Pd., M.Pd. & Lia Kurniasari, S.Pd.' },
                                'XI.5': { koord: 'Kartika Sari, S.Pd.', fasil: 'Nyoman Kopariyanto, S.Pd. & Etik Prasetyaningsih, S.Pd.' },
                                'XI.6': { koord: 'Kartika Sari, S.Pd.', fasil: 'Abdul Hafiz, S.Pd. & Suhaib Jawahir, S.Pd.' },
                                'XI.7': { koord: 'Neti Diana, M.Pd.', fasil: 'Singgih Sudarmawan, S.Ag. & Suparmono, S.Ag.' },
                                'XI.8': { koord: 'Neti Diana, M.Pd.', fasil: 'Wely Marisa, S.Pd. & Arif Alimudin Rasyid, S.Pd.' },
                                'XI.9': { koord: 'Neti Diana, M.Pd.', fasil: 'A.Thoriq Ganda, S.Pd. & Rizki Rahmadika, S.Pd.' },
                                'XI.10': { koord: 'Maulidiawati, M.Pd.', fasil: 'Ari Yani A M, S.T. & Adventus, S.Pd.' },
                                'XI.11': { koord: 'Agung Saputra, S.Pd.', fasil: 'Bagus Panca Wiratama, S.Pd., M.Pd. & Samijo, S.Pd.' },
                                'XII.1': { koord: 'Chodman Ariyanto, S.Pd.', fasil: 'Tri Tamti Nugraheni, S.Pd. & Yuni Asrina, S.Pd.' },
                                'XII.2': { koord: 'Chodman Ariyanto, S.Pd.', fasil: 'Titin Sumarni, S.Pd. & Sukirok, S.Pd.' },
                                'XII.3': { koord: 'Chodman Ariyanto, S.Pd.', fasil: 'Nur Azizah, S.Pd.I. & Febrianita Prasasti, S.Pd.' },
                                'XII.4': { koord: 'Taufik Hidayat, S.Pd.', fasil: 'Atik Apriliawati, S.Pd. & Ferdinasari, S.pd.' },
                                'XII.5': { koord: 'Taufik Hidayat, S.Pd.', fasil: 'Nur Rohmad Safarudin, M.Pd. & Fery Ardianto, M.Pd.' },
                                'XII.6': { koord: 'Taufik Hidayat, S.Pd.', fasil: 'Ade Ervani M, S.Sn. & Dra. Hj. Endang Suwartijah' },
                                'XII.7': { koord: 'Mas’ud abid, S.Pd., M.Pd.', fasil: 'Ribuwati, M.Pd. & Nasution, S.Pd.' },
                                'XII.8': { koord: 'Mas’ud abid, S.Pd., M.Pd.', fasil: 'Apriana, S.Pd. & Agung Subaryanto, S.Pd.' },
                                'XII.9': { koord: 'Ade Rohmah Apriani, S.Pd.', fasil: 'Ari Astuti, S.Pd. & Erfizah, S.Pd' },
                                'XII.10': { koord: 'Ade Rohmah Apriani, S.Pd.', fasil: 'Muh. Zuhdi, S.Pd. & Ellys Trisnowati, M.Pd.I.' }
                            };

                            const userClass = studentData.kelas;

                            if (trialMap[userClass]) {
                                if (document.getElementById('headerCoord')) document.getElementById('headerCoord').textContent = trialMap[userClass].koord;
                                if (document.getElementById('headerFasil')) document.getElementById('headerFasil').innerHTML = trialMap[userClass].fasil;
                            } else if (realClassMap[userClass]) {
                                const data = realClassMap[userClass];
                                if (document.getElementById('headerCoord')) document.getElementById('headerCoord').textContent = data.koord;
                                const fasils = data.fasil.split('&').map(s => s.trim());
                                if (fasils.length > 1) {
                                    const html = fasils.map((f, i) => `${i + 1}. ${f}`).join('<br>');
                                    if (document.getElementById('headerFasil')) document.getElementById('headerFasil').innerHTML = html;
                                } else {
                                    if (document.getElementById('headerFasil')) document.getElementById('headerFasil').textContent = fasils[0];
                                }
                            }
                        }
                    }

                    loadProgress();
                    updateDashboardUI();
                    checkAllModulesStatus();
                    // Individual checks for modal pre-population
                    checkExistingPemantik();
                    checkExistingMateri();
                    checkExistingVideo();
                    checkExistingDokumentasi();
                    checkExistingLKPD();
                    checkExistingRefleksi();
                    checkExistingAssessment(); // Add this line
                } catch (internalError) {
                    console.error('Non-auth error in loadStudentData:', internalError);
                }

            } catch (error) {
                console.error('Critical auth error:', error);
                window.location.href = 'login-siswa.html';
            }
        }

        // Load progress logic with version control
        function loadProgress() {
            const STORAGE_VERSION = '2.0'; // Increment this to force localStorage reset
            const currentVersion = localStorage.getItem('progress_version');

            // Force reset if version mismatch or corrupted data detected
            if (currentVersion !== STORAGE_VERSION) {
                console.log('Storage version mismatch or first load. Resetting progress...');
                localStorage.removeItem('student_progress');
                localStorage.setItem('progress_version', STORAGE_VERSION);
                studentProgress = JSON.parse(JSON.stringify(defaultProgress));
                calculateGlobalProgress();
                return;
            }

            const savedProgress = localStorage.getItem('student_progress');
            if (savedProgress) {
                try {
                    studentProgress = JSON.parse(savedProgress);

                    // Validate structure - ensure all days exist
                    const requiredDays = ['day1', 'day2', 'day3'];
                    const requiredModules = ['pemantik', 'materi', 'video', 'lkpd', 'asesmen', 'dokumentasi', 'glosarium', 'refleksi'];

                    let isCorrupted = false;
                    requiredDays.forEach(day => {
                        if (!studentProgress[day]) {
                            isCorrupted = true;
                            return;
                        }
                        requiredModules.forEach(module => {
                            if (studentProgress[day][module] === undefined) {
                                isCorrupted = true;
                            }
                        });
                    });

                    if (isCorrupted) {
                        console.warn('Corrupted progress data detected. Resetting...');
                        studentProgress = JSON.parse(JSON.stringify(defaultProgress));
                        saveProgress();
                        return;
                    }

                    // Sanitize: Migrasi dari 'rangkuman' ke 'dokumentasi' jika ada data lama
                    ['day1', 'day2', 'day3'].forEach(d => {
                        if (studentProgress[d] && studentProgress[d].rangkuman !== undefined) {
                            if (studentProgress[d].dokumentasi === undefined) {
                                studentProgress[d].dokumentasi = studentProgress[d].rangkuman;
                            }
                            delete studentProgress[d].rangkuman;
                        }
                        // Pastikan field dokumentasi ada
                        if (studentProgress[d] && studentProgress[d].dokumentasi === undefined) {
                            studentProgress[d].dokumentasi = false;
                        }
                    });
                } catch (e) {
                    console.error('Error parsing progress:', e);
                    studentProgress = JSON.parse(JSON.stringify(defaultProgress));
                }
            } else {
                studentProgress = JSON.parse(JSON.stringify(defaultProgress));
            }
            calculateGlobalProgress();
        }

        function saveProgress() {
            localStorage.setItem('student_progress', JSON.stringify(studentProgress));
            calculateGlobalProgress();
        }

        // Toggle module completion
        function toggleModule(moduleId) {
            // Global Override for Modal-based modules (Active on all days)
            if (moduleId === 'glosarium') {
                openGlosariumModal();
                return;
            }

            // Override untuk Semua Hari (Dinamis dari workshopContent)
            if (moduleId === 'mantik' || moduleId === 'pemantik') {
                openPemantikModal();
                return;
            }
            if (moduleId === 'materi') {
                openMateriModal();
                return;
            }
            if (moduleId === 'dokumentasi') {
                openDokumentasiModal();
                return;
            }
            if (moduleId === 'video') {
                openVideoModal();
                return;
            }
            if (moduleId === 'asesmen' || moduleId === 'assessment') {
                openAssessmentModal();
                return;
            }
            if (moduleId === 'lkpd') {
                openLKPDModal();
                return;
            }
            if (moduleId === 'refleksi') {
                openRefleksiModal();
                return;
            }

            const dayKey = `day${currentDay}`;
            // Toggle status
            studentProgress[dayKey][moduleId] = !studentProgress[dayKey][moduleId];
            saveProgress();
            updateModuleUI(moduleId, studentProgress[dayKey][moduleId]);
        }

        // Helper untuk memanggil toggle original dari dalam modal
        function forceCompleteModule(moduleId, score = 0) {
            const dayKey = `day${currentDay}`;
            studentProgress[dayKey][moduleId] = true;
            saveProgress();
            updateModuleUI(moduleId, true, score);
        }

        // Update UI for a single module
        function updateModuleUI(moduleId, status, score = 0) {
            const statusIcon = document.getElementById(`status-${moduleId}`);
            const statusLabel = document.getElementById(`label-${moduleId}`);

            if (!statusIcon || !statusLabel) return;

            if (status === 'submitted') {
                statusIcon.textContent = 'hourglass_top';
                statusIcon.className = 'material-symbols-outlined !text-[14px] text-yellow-500 animate-pulse';
                statusLabel.textContent = 'Menunggu Feedback';
                statusLabel.className = 'text-[11px] font-semibold text-yellow-500';
            } else if (status === true) {
                statusIcon.textContent = 'check_circle';
                statusIcon.className = 'material-symbols-outlined !text-[14px] text-emerald-custom';

                if (score > 0) {
                    const starCount = Math.round(score / 20);
                    const stars = '⭐'.repeat(starCount) || '⭐';
                    statusLabel.textContent = `Selesai ${stars}`;
                } else {
                    statusLabel.textContent = 'Selesai';
                }
                statusLabel.className = 'text-[11px] font-semibold text-emerald-custom';
            } else {
                statusIcon.textContent = 'radio_button_unchecked';
                statusIcon.className = 'material-symbols-outlined !text-[14px] text-slate-400';
                statusLabel.textContent = 'Belum Selesai';
                statusLabel.className = 'text-[11px] font-semibold text-slate-400';
            }
        }

        // Update all modules UI based on current day
        function updateDashboardUI() {
            const dayKey = `day${currentDay}`;
            const currentDayProgress = studentProgress[dayKey];

            Object.keys(currentDayProgress).forEach(moduleId => {
                updateModuleUI(moduleId, currentDayProgress[moduleId]);
            });

            // HIDE modules for Day 2: Video, LKPD, Assessment, Glosarium, Refleksi
            const modulesToHide = ['module-video', 'module-lkpd', 'module-asesmen', 'module-glosarium', 'module-refleksi'];
            modulesToHide.forEach(moduleId => {
                const moduleElement = document.getElementById(moduleId);
                if (moduleElement) {
                    if (currentDay === 2) {
                        moduleElement.style.display = 'none';
                    } else {
                        moduleElement.style.display = '';
                    }
                }
            });
        }

        // Calculate and update global progress circle
        function calculateGlobalProgress() {
            let totalItems = 0;
            let completedItems = 0;

            // Hitung semua item dari 3 hari
            Object.values(studentProgress).forEach(day => {
                Object.values(day).forEach(status => {
                    totalItems++;
                    if (status) completedItems++;
                });
            });

            const percent = Math.round((completedItems / totalItems) * 100);

            // Update Text
            document.getElementById('progressPercent').textContent = `${percent}%`;

            // Update Circle Gradient
            const degree = Math.round((percent / 100) * 360);
            document.getElementById('progressCircle').style.background = `conic-gradient(#10B981 ${degree}deg, #E2E8F0 0deg)`;

            // Show checkmark if 100%
            const checkmark = document.getElementById('progressCheck');
            if (percent === 100) {
                checkmark.classList.remove('hidden');
            } else {
                checkmark.classList.add('hidden');
            }
        }

        // Switch day tabs
        function switchDay(day) {
            currentDay = day;

            // Handle 'Nilai' Tab
            if (day === 'nilai') {
                document.getElementById('module-grid-container').classList.add('hidden');
                document.getElementById('nilai-report-container').classList.remove('hidden');

                // Update Header Text
                document.getElementById('dashboardTitle').textContent = 'Nilai Kokurikuler';
                document.getElementById('dashboardSubtitle').textContent = 'Pantau hasil penilaian projekmu';

                // Update Tab Styles
                for (let i = 1; i <= 3; i++) {
                    const tab = document.getElementById(`tab-day${i}`);
                    tab.className = 'flex-1 py-3 rounded-xl text-base font-semibold text-slate-500 hover:text-slate-700 transition-all';
                }
                const btnNilai = document.getElementById('tab-nilai');
                btnNilai.className = 'flex-1 py-3 rounded-xl text-base font-semibold bg-white text-emerald-custom shadow-sm transition-all';

                loadFinalGrade();
                return;
            }

            // Handle Regular Days
            document.getElementById('module-grid-container').classList.remove('hidden');
            document.getElementById('nilai-report-container').classList.add('hidden');
            document.getElementById('tab-nilai').className = 'flex-1 py-3 rounded-xl text-base font-semibold text-slate-500 hover:text-slate-700 transition-all';

            // Revert Header Text
            document.getElementById('dashboardTitle').textContent = 'Dasbor Kegiatan';
            document.getElementById('dashboardSubtitle').textContent = 'Selesaikan modul hari ini';

            // Update tab styles
            for (let i = 1; i <= 3; i++) {
                const tab = document.getElementById(`tab-day${i}`);
                if (i === day) {
                    tab.className = 'flex-1 py-3 rounded-xl text-base font-semibold bg-white text-emerald-custom shadow-sm transition-all';
                } else {
                    tab.className = 'flex-1 py-3 rounded-xl text-base font-semibold text-slate-500 hover:text-slate-700 transition-all';
                }
            }

            // CRITICAL FIX: Reset ALL module UI to default state first
            const allModules = ['pemantik', 'materi', 'video', 'lkpd', 'asesmen', 'dokumentasi', 'glosarium', 'refleksi'];
            allModules.forEach(moduleId => {
                const statusIcon = document.getElementById(`status-${moduleId}`);
                const statusLabel = document.getElementById(`label-${moduleId}`);
                if (statusIcon && statusLabel) {
                    statusIcon.textContent = 'radio_button_unchecked';
                    statusIcon.className = 'material-symbols-outlined !text-[14px] text-slate-400';
                    statusLabel.textContent = 'Belum Selesai';
                    statusLabel.className = 'text-[11px] font-semibold text-slate-400';
                }
            });

            // Update modules display based on new day
            updateDashboardUI();

            // Re-fetch database statuses to ensure sync
            checkAllModulesStatus();
        }

        async function loadFinalGrade() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data, error } = await supabaseClient
                    .from('final_project_grades')
                    .select('*')
                    .eq('student_id', user.id)
                    .single();

                if (error && error.code !== 'PGRST116') throw error; // PGRST116 is no rows found

                const badgeContainer = document.getElementById('final-badge-container');
                const descEl = document.getElementById('final-description');
                const scoreEl = document.getElementById('final-total-score');
                const starContainer = document.getElementById('final-star-display').querySelector('div');

                if (!data || data.status !== 'published') {
                    // Default State: Belum Dinilai (Tampilan Khusus)
                    badgeContainer.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-10 opacity-75">
                            <div class="h-24 w-24 bg-slate-50 rounded-full flex items-center justify-center mb-4 animate-pulse">
                                <span class="material-symbols-outlined text-5xl text-slate-300">hourglass_top</span>
                            </div>
                            <span class="text-sm font-black text-slate-400 uppercase tracking-widest mb-2">MENUNGGU PENILAIAN</span>
                            <span class="text-xs font-medium text-slate-400 max-w-[200px] leading-relaxed">Fasilitator sedang meninjau seluruh aktivitasmu. Harap periksa kembali secara berkala.</span>
                        </div>`;

                    // Sembunyikan elemen nilai yang belum ada
                    if (descEl.parentElement) descEl.parentElement.classList.add('hidden');
                    if (scoreEl.parentElement && scoreEl.parentElement.parentElement) scoreEl.parentElement.parentElement.classList.add('hidden');

                    document.getElementById('final-feedback-section').classList.add('hidden');
                    return;
                }

                // Published State (Tampilkan Kembali elemen yang mungkin disembunyikan)
                // Published State (Tampilkan Kembali elemen yang mungkin disembunyikan)
                if (descEl.parentElement) descEl.parentElement.classList.remove('hidden');
                if (scoreEl.parentElement && scoreEl.parentElement.parentElement) scoreEl.parentElement.parentElement.classList.remove('hidden');

                // Ubah Text Tombol Kembali
                const btnBack = document.getElementById('btn-back-to-task');
                if (btnBack) btnBack.textContent = "Selesai & Kembali ke Materi";

                // Published State
                const category = data.category || 'Belum Valid';
                const totalStars = data.total_stars || 0;

                // Set Badge Style
                let badgeClass = 'bg-slate-100 text-slate-600 border-slate-200';
                if (category === 'Mahir') badgeClass = 'bg-emerald-100 text-emerald-600 border-emerald-200 shadow-emerald-200/50';
                else if (category === 'Berkembang') badgeClass = 'bg-blue-100 text-blue-600 border-blue-200 shadow-blue-200/50';
                else if (category === 'Cakap') badgeClass = 'bg-amber-100 text-amber-600 border-amber-200 shadow-amber-200/50';

                badgeContainer.innerHTML = `
                    <div class="inline-block px-8 py-3 rounded-full border shadow-lg ${badgeClass} animate-bounce">
                        <span class="text-lg font-black uppercase tracking-widest">${category}</span>
                    </div>`;

                // Set Description
                const descriptions = {
                    'Mahir': "Peserta didik sangat kreatif dalam menghasilkan gagasan orisinal dan inovatif pada pengembangan produk jajanan Nusantara yang sehat, bergizi dan kekinian. Mampu merumuskan solusi usaha secara matang serta melakukan perhitungan BEP dengan tepat. Memanfaatkan teknologi digital secara optimal dan komunikatif.",
                    'Berkembang': "Peserta didik menunjukkan kreativitas yang baik dalam mengembangkan produk jajanan Nusantara. Mampu merumuskan solusi usaha sederhana dan perhitungan BEP dengan pendampingan. Komunikasi cukup jelas dan mulai memanfaatkan teknologi digital.",
                    'Cakap': "Peserta didik mulai mampu menunjukkan kreativitas dalam mengolah jajanan Nusantara. Perhitungan BEP dan solusi usaha masih memerlukan bimbingan. Penyampaian informasi sederhana dan memerlukan pendampingan teknologi digital."
                };
                descEl.textContent = descriptions[category] || "Selamat! Anda telah menyelesaikan projek ini.";

                // Set Stars Display
                // Assume totalStars is roughly 0-50 range? Or whatever the total sum is.
                // Wait, I need to know the MAX stars to show relative stars?
                // Visual stars here purely decorative or scaled?
                // Let's just show 5 big stars filled if Mahir, 4 if Berkembang, 3 if Cakap
                let visualStars = 0;
                if (category === 'Mahir') visualStars = 5;
                else if (category === 'Berkembang') visualStars = 4;
                else if (category === 'Cakap') visualStars = 3;

                let starsHtml = '';
                for (let i = 1; i <= 5; i++) {
                    const color = i <= visualStars ? 'text-amber-400 drop-shadow-sm' : 'text-slate-200';
                    starsHtml += `<span class="material-symbols-outlined ${color}" style="font-variation-settings: 'FILL' 1">star</span>`;
                }
                starContainer.innerHTML = starsHtml;
                scoreEl.innerHTML = `<span class="text-slate-800">${totalStars}</span> <span class="text-slate-400 font-medium">Total Bintang</span>`;

                // Feedback
                if (data.facilitator_feedback) {
                    document.getElementById('final-feedback-section').classList.remove('hidden');
                    document.getElementById('final-feedback-text').textContent = data.facilitator_feedback;
                }

            } catch (err) {
                console.error('Final Grade error:', err);
            }
        }

        // SINKRONISASI GLOBAL SEMUA MODUL
        async function checkAllModulesStatus() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                // Ambil semua respon hari ini dalam satu query
                const { data: responses, error } = await supabaseClient
                    .from('module_responses')
                    .select('module_type, status, score')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay);

                if (error) throw error;

                // Reset UI dulu ke progress local
                updateDashboardUI();

                // CRITICAL: Sync localStorage with database
                // If a module exists in localStorage but NOT in database, it was deleted by facilitator
                const dayKey = `day${currentDay}`;
                const dbModules = new Set();

                if (responses && responses.length > 0) {
                    responses.forEach(r => {
                        // Mapping Database Type to UI ID
                        let moduleId = r.module_type;
                        if (moduleId === 'kuis') moduleId = 'asesmen';
                        if (moduleId === 'summary') moduleId = 'materi';

                        dbModules.add(moduleId);

                        if (r.status === 'submitted') {
                            const icon = document.getElementById(`status-${moduleId}`);
                            const label = document.getElementById(`label-${moduleId}`);
                            if (icon && label) {
                                icon.textContent = 'hourglass_top';
                                icon.className = 'material-symbols-outlined !text-[14px] text-yellow-500 animate-pulse';
                                label.textContent = 'Menunggu Feedback';
                                label.className = 'text-[11px] font-semibold text-yellow-500';
                            }
                        } else if (r.status === 'reviewed') {
                            forceCompleteModule(moduleId, r.score);
                        }
                    });
                }

                // Check for deleted modules: if localStorage says true but not in database, reset to false
                const allModules = ['pemantik', 'materi', 'video', 'lkpd', 'asesmen', 'dokumentasi', 'glosarium', 'refleksi'];
                allModules.forEach(moduleId => {
                    // If localStorage has this as completed/submitted but database doesn't have it, reset
                    if (studentProgress[dayKey][moduleId] === true && !dbModules.has(moduleId)) {
                        console.log(`🔄 Syncing: ${moduleId} was deleted by facilitator, resetting to false`);
                        studentProgress[dayKey][moduleId] = false;
                        updateModuleUI(moduleId, false);
                    }
                });

                // Save synced progress
                saveProgress();
            } catch (err) {
                console.error("Error checkAllModulesStatus:", err);
            }
        }

        // Logout function
        async function logout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                // Redirect to index.html (Beranda)
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error logging out:', error.message);
                alert('Gagal keluar. Silakan coba lagi.');
            }
        }

        // Load data on page load
        window.addEventListener('load', loadStudentData);

        // ==========================================
        // FITUR PERTANYAAN PEMANTIK
        // ==========================================

        // Buka Modal Pemantik
        function openPemantikModal() {
            const modal = document.getElementById('modalPemantik');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Render Questions based on workshopContent
            const dayKey = `day${currentDay}`;
            const questions = workshopContent[dayKey]?.pemantik || [];
            const container = document.getElementById('pemantikQuestionsContainer');

            if (container) {
                container.innerHTML = questions.map((q, idx) => `
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-700 block leading-relaxed">
                            ${q}
                        </label>
                        <textarea id="tanya${idx + 1}" rows="3"
                            class="w-full text-xs p-3 rounded-xl border border-slate-200 focus:border-emerald-500 focus:ring-emerald-500 bg-slate-50 focus:bg-white transition-all placeholder:text-slate-300"
                            placeholder="Tulis jawabanmu disini..."></textarea>
                    </div>
                `).join('');
            }

            // Update Header Subtitle
            const titles = {
                1: 'Hari 1 • Cita Rasa Jajanan Nusantara',
                2: 'Hari 2 • Rencana Usaha & Inovasi',
                3: 'Hari 3 • Evaluasi & Refleksi'
            };
            const subtitleEl = modal.querySelector('p.text-xs.text-slate-500');
            if (subtitleEl) subtitleEl.textContent = titles[currentDay] || `Hari ${currentDay}`;

            // Cek apakah sudah ada jawaban
            checkExistingPemantik();
        }

        // Tutup Modal
        function closePemantikModal() {
            const modal = document.getElementById('modalPemantik');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }


        // ==========================================
        // FITUR MATERI BELAJAR (SLIDE)
        // ==========================================

        let currentMateriSlide = 0;
        let totalMateriSlides = 0; // Will be set dynamically

        function openMateriModal() {
            currentMateriSlide = 0;
            const dayKey = `day${currentDay}`;
            const materiItems = workshopContent[dayKey]?.materi || [];
            totalMateriSlides = materiItems.length;

            // Render Slides
            const container = document.getElementById('materiDynamicSlides');
            if (container) {
                container.innerHTML = materiItems.map((html, idx) => `
                    <div id="slide-materi-${idx}" class="${idx === 0 ? '' : 'hidden'} animate-slide-up">
                        ${html}
                    </div>
                `).join('');
            }

            // Render Navigation Pills
            const pillContainer = document.getElementById('materiDynamicPills');
            if (pillContainer) {
                pillContainer.innerHTML = materiItems.map((_, idx) => `
                    <button id="nav-pill-${idx}" onclick="goToSlide(${idx})"
                        class="size-7 rounded-lg ${idx === 0 ? 'bg-emerald-500 text-white shadow-md shadow-emerald-200' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'} text-[9px] font-bold flex items-center justify-center transition-all shrink-0">
                        ${idx + 1}
                    </button>
                `).join('');
            }

            document.getElementById('modalMateri').classList.remove('hidden');
            document.getElementById('modalMateri').classList.add('flex');

            // Update Title
            const titleEl = document.querySelector('#modalMateri h3');
            if (titleEl) titleEl.textContent = `Materi Hari ${currentDay}`;

            updateMateriSlideUI();
            checkExistingMateri();
        }

        function closeMateriModal() {
            document.getElementById('modalMateri').classList.add('hidden');
            document.getElementById('modalMateri').classList.remove('flex');
        }

        function nextMateriSlide() {
            if (currentMateriSlide < totalMateriSlides - 1) {
                currentMateriSlide++;
                updateMateriSlideUI();
                // Scroll content ke atas setiap ganti slide
                document.getElementById('materiContentArea').scrollTop = 0;
            }
        }

        function prevMateriSlide() {
            if (currentMateriSlide > 0) {
                currentMateriSlide--;
                updateMateriSlideUI();
                document.getElementById('materiContentArea').scrollTop = 0;
            }
        }

        function goToSlide(n) {
            if (n >= 0 && n < totalMateriSlides) {
                currentMateriSlide = n;
                updateMateriSlideUI();
                document.getElementById('materiContentArea').scrollTop = 0;
            }
        }

        function updateMateriSlideUI() {
            // Hide semua slide
            for (let i = 0; i < totalMateriSlides; i++) {
                const s = document.getElementById(`slide-materi-${i}`);
                if (s) s.classList.add('hidden');
            }
            // Tampilkan slide aktif
            document.getElementById(`slide-materi-${currentMateriSlide}`).classList.remove('hidden');

            // Update Navigation Pills
            for (let i = 0; i < totalMateriSlides; i++) {
                const pill = document.getElementById(`nav-pill-${i}`);
                if (pill) {
                    if (i === currentMateriSlide) {
                        pill.className = "size-7 rounded-lg bg-emerald-500 text-white text-[9px] font-bold flex items-center justify-center shadow-md shadow-emerald-200 transition-all";
                    } else {
                        pill.className = "size-7 rounded-lg bg-slate-50 text-slate-400 text-[9px] font-bold flex items-center justify-center hover:bg-slate-100 transition-all";
                    }
                }
            }

            // Update Progress Bar
            const progress = ((currentMateriSlide + 1) / totalMateriSlides) * 100;
            document.getElementById('materiProgressBar').style.width = `${progress}%`;
            document.getElementById('materiStepText').textContent = `Halaman ${currentMateriSlide + 1} dari ${totalMateriSlides}`;

            // Update Tombol
            const btnPrev = document.getElementById('btnPrevMateri');
            const btnNext = document.getElementById('btnNextMateri');
            const btnFinish = document.getElementById('btnFinishMateri');

            // Tombol Kembali
            if (currentMateriSlide === 0) {
                btnPrev.classList.add('invisible');
            } else {
                btnPrev.classList.remove('invisible');
            }

            // Tombol Lanjut vs Selesai
            if (currentMateriSlide === totalMateriSlides - 1) {
                btnNext.classList.add('hidden');
                btnFinish.classList.remove('hidden');
                updateWordCount(); // Sync button state on show
            } else {
                btnNext.classList.remove('hidden');
                btnFinish.classList.add('hidden');
            }
        }

        function settleMateri() {
            // Check word count first if it's the last slide
            if (currentMateriSlide === totalMateriSlides - 1) {
                submitMateriSummary();
                return;
            }
            // Fallback for older logic if needed
            forceCompleteModule('materi');
            alert('Selamat! Kamu telah menyelesaikan materi hari ini.');
            closeMateriModal();
        }

        function updateWordCount() {
            const textarea = document.getElementById('summaryArea');
            const counter = document.getElementById('wordCounter');
            const text = textarea.value.trim();
            const words = text ? text.split(/\s+/).length : 0;

            counter.textContent = `${words} / 200 kata`;

            const btn = document.getElementById('btnFinishMateri');
            if (textarea.disabled) {
                // Jangan utak-atik tombol jika sudah dikunci (submitted/reviewed)
                btn.classList.add('hidden');
                return;
            }

            if (words >= 200) {
                counter.className = "text-[10px] font-bold text-emerald-500";
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                counter.className = "text-[10px] font-bold text-slate-400";
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        async function submitMateriSummary() {
            const btn = document.getElementById('btnFinishMateri');
            const summary = document.getElementById('summaryArea').value.trim();

            if (summary.split(/\s+/).length < 200) {
                alert('Pesan: Ringkasan minimal harus 200 kata.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'Mengirim...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error('Silakan login ulang.');

                // Gunakan user.id (Auth UID) secara konsisten
                const { error } = await supabaseClient
                    .from('module_responses')
                    .insert({
                        student_id: user.id,
                        day_id: currentDay,
                        module_type: 'materi',
                        answers: [summary],
                        status: 'submitted'
                    });

                if (error) throw error;

                alert('Pesan: Ringkasan berhasil dikirim! Silakan tunggu review dari Fasilitator.');
                // SINKRONKAN status lokal (tetap false agar show hourglass)
                studentProgress[`day${currentDay}`]['materi'] = false;
                saveProgress();
                closeMateriModal();
                checkAllModulesStatus();
                checkExistingMateri();

            } catch (e) {
                console.error(e);
                alert('Gagal mengirim: ' + e.message);
                btn.disabled = false;
                btn.innerHTML = 'Selesaikan Materi';
            }
        }

        async function checkExistingMateri() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data: responses } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id) // Konsisten pakai user.id
                    .eq('day_id', currentDay) // Dinamis sesuai hari aktif
                    .eq('module_type', 'materi')
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (responses && responses.length > 0) {
                    const r = responses[0];
                    // SINKRONKAN ke local progress bar
                    if (r.status === 'reviewed') {
                        forceCompleteModule('materi', r.score);
                    }

                    const area = document.getElementById('summaryArea');
                    const msg = document.getElementById('materiStatusMsg');
                    if (area) {
                        area.value = r.answers[0] || '';
                        if (r.status === 'submitted' || r.status === 'reviewed') {
                            area.disabled = true;
                            area.classList.add('bg-slate-100', 'text-slate-500');
                        }
                        updateWordCount(); // Sync tombol & counter berdasarkan isi
                    }

                    if (msg) {
                        msg.classList.remove('hidden');
                        const btn = document.getElementById('btnFinishMateri');
                        if (r.status === 'submitted') {
                            msg.className = "mb-4 p-4 rounded-3xl text-[11px] font-bold border border-amber-100 bg-amber-50 text-amber-700 animate-pulse";
                            msg.innerHTML = `⏳ Ringkasanmu sedang menunggu review Fasilitator.`;
                            if (btn) btn.classList.add('hidden');
                            updateModuleUI('materi', 'submitted');
                        } else if (r.status === 'reviewed') {
                            msg.className = "mb-4 p-4 rounded-3xl text-[11px] font-bold border border-emerald-100 bg-emerald-50 text-emerald-700";
                            msg.innerHTML = `✅ Dinilai: ${r.score}/100<br><span class="font-normal text-[10px] mt-1 block">"${r.feedback || 'Bagus sekali!'}"</span>`;
                            if (btn) btn.classList.add('hidden');
                            updateModuleUI('materi', true, r.score || 0);
                        }
                    }
                } else {
                    // Jika tidak ada data, pastikan tombol muncul & textarea aktif
                    const btn = document.getElementById('btnFinishMateri');
                    const area = document.getElementById('summaryArea');
                    if (btn) btn.classList.remove('hidden');
                    if (area) {
                        area.disabled = false;
                        area.classList.remove('bg-slate-100', 'text-slate-500');
                    }
                }
            } catch (e) { console.error('Error checkExistingMateri:', e); }
        }


        // ==========================================
        // FITUR VIDEO PEMBELAJARAN
        // ==========================================

        // Video data per day
        const videoContentByDay = {
            1: [
                {
                    title: "Video 1: Pengenalan Jajanan Nusantara",
                    url: "https://www.youtube.com/embed/dQw4w9WgXcQ", // Placeholder - ganti dengan video asli
                    duration: "10 menit"
                },
                {
                    title: "Video 2: Nilai Gizi dalam Jajanan",
                    url: "https://www.youtube.com/embed/dQw4w9WgXcQ", // Placeholder - ganti dengan video asli
                    duration: "12 menit"
                },
                {
                    title: "Video 3: Kreativitas dalam Bisnis Jajanan",
                    url: "https://www.youtube.com/embed/dQw4w9WgXcQ", // Placeholder - ganti dengan video asli
                    duration: "15 menit"
                }
            ],
            2: [
                {
                    title: "Video Pembelajaran Hari 2",
                    url: "https://www.youtube.com/embed/T2q2ZOsjkIs",
                    duration: "Durasi video"
                }
            ],
            3: [
                // Placeholder untuk Hari 3
            ]
        };

        function openVideoModal() {
            const modal = document.getElementById('modalVideo');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            loadVideoContent();
            checkExistingVideoResponse();
        }

        function closeVideoModal() {
            const modal = document.getElementById('modalVideo');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function loadVideoContent() {
            const container = document.getElementById('videoDynamicItems');
            const videos = videoContentByDay[currentDay] || [];

            if (videos.length === 0) {
                container.innerHTML = `
                    <div class="bg-amber-50 p-6 rounded-2xl border border-amber-100 text-center">
                        <span class="material-symbols-outlined text-amber-500 text-4xl mb-2">info</span>
                        <p class="text-sm font-bold text-amber-700">Video untuk hari ini belum tersedia</p>
                    </div>
                `;
                return;
            }

            // Generate video items
            let html = '';
            videos.forEach((video, index) => {
                html += `
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="aspect-video bg-slate-900">
                            <iframe 
                                class="w-full h-full" 
                                src="${video.url}" 
                                title="${video.title}"
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen>
                            </iframe>
                        </div>
                        <div class="p-4">
                            <h4 class="text-sm font-bold text-slate-800">${video.title}</h4>
                            <p class="text-xs text-slate-400 mt-1">${video.duration}</p>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // NOTE: checkExistingVideoResponse() is defined later at line ~3915
        // with the correct implementation using data.answers[0]

        function updateVideoWordCount() {
            const input = document.getElementById('videoSummaryInput');
            const display = document.getElementById('videoWordCountDisplay');
            const submitBtn = document.getElementById('btnSubmitVideo');

            const text = input.value.trim();
            const wordCount = text ? text.split(/\s+/).length : 0;

            display.textContent = `${wordCount} / 50 kata`;

            if (wordCount >= 50) {
                display.className = 'text-[10px] font-bold text-emerald-500 bg-white/50 px-2 py-1 rounded-lg border border-emerald-100';
                submitBtn.disabled = false;
                submitBtn.className = 'w-full py-4 bg-red-500 text-white rounded-2xl font-black shadow-lg shadow-red-200 active:scale-95 transition-all';
            } else {
                display.className = 'text-[10px] font-bold text-red-500 bg-white/50 px-2 py-1 rounded-lg border border-red-100';
                submitBtn.disabled = true;
                submitBtn.className = 'w-full py-4 bg-slate-300 text-white rounded-2xl font-black shadow-none transition-all cursor-not-allowed';
            }
        }

        async function submitVideoLog() {
            const summaryInput = document.getElementById('videoSummaryInput');
            const summary = summaryInput.value.trim();

            if (!summary || summary.split(/\s+/).length < 50) {
                alert('Ringkasan minimal 50 kata!');
                return;
            }

            const submitBtn = document.getElementById('btnSubmitVideo');
            submitBtn.disabled = true;
            submitBtn.textContent = '⏳ Mengirim...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error('User not authenticated');

                const { error } = await supabaseClient
                    .from('module_responses')
                    .insert({
                        student_id: user.id,
                        day_id: currentDay,
                        module_type: 'video',
                        response_text: summary,
                        status: 'submitted',
                        submitted_at: new Date().toISOString()
                    });

                if (error) throw error;

                alert('✅ Ringkasan berhasil dikirim!');
                forceCompleteModule('video');
                closeVideoModal();

            } catch (err) {
                console.error('Submit Error:', err);
                alert('❌ Gagal mengirim ringkasan: ' + err.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Simpan Ringkasan & Selesai';
            }
        }

        // ==========================================
        // FITUR DOKUMENTASI FOTO (REPLACEMENT RANGKUMAN)
        // ==========================================

        function openDokumentasiModal() {
            const modal = document.getElementById('modalDokumentasi');
            const uploadArea = document.getElementById('docUploadArea');
            const previewArea = document.getElementById('docPreviewArea');

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Reset UI to upload state
            uploadArea.classList.remove('hidden');
            previewArea.classList.add('hidden');

            checkExistingDokumentasi();
        }

        function closeDokumentasiModal() {
            document.getElementById('modalDokumentasi').classList.add('hidden');
            document.getElementById('modalDokumentasi').classList.remove('flex');
        }

        function changeDocPhoto() {
            const uploadArea = document.getElementById('docUploadArea');
            const previewArea = document.getElementById('docPreviewArea');
            const docInput = document.getElementById('docInput');
            const statusText = document.getElementById('docStatusMsg');

            // Reset to upload state
            uploadArea.classList.remove('hidden');
            previewArea.classList.add('hidden');
            statusText.classList.add('hidden');

            // Reset file input
            docInput.value = '';
            window.selectedDocFile = null;

            // Disable submit button until new photo selected
            document.getElementById('btnUploadDokumentasi').disabled = true;
        }

        // Compress image function (Optimized for Documentation)
        async function compressImage(file, maxWidth = 800, quality = 0.5) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function handleDocPhotoSelection(e) {
            const file = e.target.files[0];
            if (!file) return;

            // VALIDASI: Batasan 10MB sebelum kompresi
            const MAX_SIZE = 10 * 1024 * 1024;
            if (file.size > MAX_SIZE) {
                alert(`Pesan: Ukuran file terlalu besar (${Math.round(file.size / 1024 / 1024)}MB). Maksimal 10MB agar tidak memberatkan sistem.`);
                e.target.value = '';
                return;
            }

            const btn = document.getElementById('btnUploadDokumentasi');
            const statusText = document.getElementById('docStatusMsg');
            const preview = document.getElementById('docPreview');
            const uploadArea = document.getElementById('docUploadArea');
            const previewArea = document.getElementById('docPreviewArea');

            statusText.classList.remove('hidden');
            statusText.className = "mb-4 p-4 rounded-2xl text-[11px] font-bold border border-blue-100 bg-blue-50 text-blue-700 animate-pulse";
            statusText.innerHTML = "⏳ Sedang mengoptimalkan foto...";
            btn.disabled = true;

            try {
                const compressedBlob = await compressImage(file, 600, 0.6);
                const compressedFile = new File([compressedBlob], `doc_${Date.now()}.jpg`, { type: 'image/jpeg' });

                // Preview
                const reader = new FileReader();
                reader.onload = (re) => {
                    console.log('📸 Setting preview image...');
                    preview.src = re.target.result;
                    console.log('✅ Preview src set:', preview.src.substring(0, 50) + '...');

                    // Show preview area, hide upload area
                    uploadArea.classList.add('hidden');
                    previewArea.classList.remove('hidden');
                    console.log('✅ Preview area shown, upload area hidden');
                };
                reader.readAsDataURL(compressedFile);

                statusText.className = "mb-4 p-4 rounded-2xl text-[11px] font-bold border border-emerald-100 bg-emerald-50 text-emerald-700";
                statusText.innerHTML = "✅ Foto siap dikirim (~" + Math.round(compressedBlob.size / 1024) + " KB)";
                btn.disabled = false;

                // Simpan file sementara di window agar bisa diakses submit
                window.selectedDocFile = compressedFile;

            } catch (err) {
                console.error(err);
                statusText.className = "mb-4 p-4 rounded-2xl text-[11px] font-bold border border-red-100 bg-red-50 text-red-700";
                statusText.innerHTML = "❌ Gagal memproses foto.";
            }
        }

        async function submitDokumentasi() {
            const btn = document.getElementById('btnUploadDokumentasi');
            const file = window.selectedDocFile;
            if (!file) {
                alert('Silakan pilih foto terlebih dahulu.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'Mengirim...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error('Silakan login ulang.');

                const fileName = `${user.id}/day${currentDay}_${Date.now()}.jpg`;

                // 1. Upload ke Storage Bucket 'documentation'
                // NOTE: Pastikan bucket ini sudah dibuat di dashboard Supabase
                const { error: uploadError } = await supabaseClient.storage
                    .from('documentation')
                    .upload(fileName, file);

                if (uploadError) throw uploadError;

                const { data: { publicUrl } } = supabaseClient.storage
                    .from('documentation')
                    .getPublicUrl(fileName);

                // 2. Simpan ke module_responses
                const { error: dbError } = await supabaseClient
                    .from('module_responses')
                    .insert({
                        student_id: user.id,
                        day_id: currentDay,
                        module_type: 'dokumentasi',
                        answers: [publicUrl],
                        status: 'submitted'
                    });

                if (dbError) throw dbError;

                alert('✅ Foto dokumentasi berhasil dikirim!');
                // Reset local complete status
                studentProgress[`day${currentDay}`]['dokumentasi'] = false;
                saveProgress();
                closeDokumentasiModal();
                checkExistingDokumentasi();
                checkExistingLKPD();
                checkAllModulesStatus();
                checkExistingDokumentasi();

            } catch (e) {
                console.error(e);
                alert('Gagal mengirim: ' + e.message);
                btn.disabled = false;
                btn.innerHTML = 'Kirim Dokumentasi';
            }
        }

        async function checkExistingDokumentasi() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data: responses } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'dokumentasi')
                    .order('created_at', { ascending: false })
                    .limit(1);

                const container = document.getElementById('docUploadArea');
                const btn = document.getElementById('btnUploadDokumentasi');
                const statusMsg = document.getElementById('docStatusMsg');
                const preview = document.getElementById('docPreview');

                if (responses && responses.length > 0) {
                    const r = responses[0];

                    if (r.status === 'submitted' || r.status === 'reviewed') {
                        if (r.status === 'reviewed') {
                            forceCompleteModule('dokumentasi', r.score);
                        }
                        if (container) container.classList.add('hidden');
                        if (btn) btn.classList.add('hidden');
                        if (statusMsg) {
                            statusMsg.classList.remove('hidden');
                            statusMsg.className = "mb-4 p-4 rounded-2xl text-[11px] font-bold border border-emerald-100 bg-emerald-50 text-emerald-700";
                            statusMsg.innerHTML = "✅ Dokumentasi hari ini sudah terkirim.";
                        }
                        if (preview && r.answers[0]) {
                            preview.src = r.answers[0];
                            preview.classList.remove('hidden');
                        }
                        updateModuleUI('dokumentasi', r.status === 'reviewed' ? true : 'submitted', r.score || 0);
                    }
                } else {
                    if (container) container.classList.remove('hidden');
                    if (btn) {
                        btn.classList.remove('hidden');
                        btn.disabled = true;
                        btn.innerHTML = 'Kirim Dokumentasi';
                    }
                    if (statusMsg) statusMsg.classList.add('hidden');
                    if (preview) {
                        preview.src = '';
                        preview.classList.add('hidden');
                    }
                }
            } catch (e) { console.error('Error checkExistingDokumentasi:', e); }
        }



        // Deprecated: Functions below are now handled by updateModuleUI or specific modal logic

        // Kirim Jawaban
        async function submitPemantik() {
            const btn = document.getElementById('btnSubmitPemantik');
            btn.innerHTML = 'Mengirim...';
            btn.disabled = true;

            // Ambil jawaban secara dinamis sesuai jumlah pertanyaan hari ini
            const dayKey = `day${currentDay}`;
            const questions = workshopContent[dayKey]?.pemantik || [];
            const answers = [];

            for (let i = 1; i <= questions.length; i++) {
                const val = document.getElementById(`tanya${i}`).value;
                if (!val) {
                    alert(`Jawaban nomor ${i} belum diisi!`);
                    btn.innerHTML = 'Kirim Jawaban';
                    btn.disabled = false;
                    return;
                }
                answers.push(val);
            }

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error("User tidak ditemukan");

                // Simpan ke Supabase
                const { error } = await supabaseClient
                    .from('module_responses')
                    .insert({
                        student_id: user.id,
                        day_id: currentDay, // Gunakan currentDay yang dinamis
                        module_type: 'pemantik',
                        answers: answers,
                        status: 'submitted' // Status awal
                    });

                if (error) throw error;

                // Berhasil
                alert('Jawaban berhasil dikirim! Menunggu feedback dari fasilitator.');

                // SINKRONKAN status lokal
                studentProgress[`day${currentDay}`]['pemantik'] = false;
                saveProgress();
                checkAllModulesStatus(); // Refresh icon dashboard
                closePemantikModal();
                checkExistingPemantik();

            } catch (err) {
                console.error('Gagal kirim:', err);
                alert('Terjadi kesalahan saat mengirim jawaban.');
            } finally {
                btn.innerHTML = 'Kirim Jawaban';
                btn.disabled = false;
            }
        }

        // Cek Status Jawaban (Saat load / buka modal)
        async function checkExistingPemantik() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data, error } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay) // Dinamis sesuai hari aktif
                    .eq('module_type', 'pemantik')
                    .limit(1)
                    .maybeSingle();

                if (data) {
                    // Isi form dengan jawaban lama
                    data.answers.forEach((ans, idx) => {
                        const el = document.getElementById(`tanya${idx + 1}`);
                        if (el) {
                            el.value = ans;
                            el.disabled = true; // Disable edit jika sudah submit
                        }
                    });

                    // Hide tombol kirim jika sudah submit
                    const btn = document.getElementById('btnSubmitPemantik');
                    if (btn) btn.classList.add('hidden');

                    // Show status message
                    const statusMsg = document.getElementById('statusMessage');
                    if (statusMsg) {
                        statusMsg.classList.remove('hidden');

                        if (data.status === 'submitted') {
                            statusMsg.className = "bg-yellow-50 text-yellow-700 p-4 rounded-xl border border-yellow-200 text-xs font-medium mb-4";
                            statusMsg.innerHTML = "⏳ <b>Jawaban Terkirim</b><br>Menunggu feedback dari fasilitator.";
                            updateModuleUI('pemantik', 'submitted');
                        } else if (data.status === 'reviewed') {
                            statusMsg.className = "bg-emerald-50 text-emerald-700 p-4 rounded-xl border border-emerald-200 text-xs font-medium mb-4";
                            statusMsg.innerHTML = `✅ <b>Sudah Direview (Skor: ${data.score || 0})</b><br>Feedback: "${data.feedback || '-'}"`;
                            updateModuleUI('pemantik', true, data.score || 0);
                        }
                    }
                } else {
                    // Belum ada data
                    const statusMsg = document.getElementById('statusMessage');
                    if (statusMsg) statusMsg.classList.add('hidden');

                    const btn = document.getElementById('btnSubmitPemantik');
                    if (btn) {
                        btn.classList.remove('hidden');
                        btn.innerHTML = 'Kirim Jawaban';
                        btn.disabled = false;
                    }

                    // Enable inputs
                    const dayKey = `day${currentDay}`;
                    const questions = workshopContent[dayKey]?.pemantik || [];
                    for (let i = 1; i <= questions.length; i++) {
                        const el = document.getElementById(`tanya${i}`);
                        if (el) {
                            el.disabled = false;
                            el.value = '';
                        }
                    }
                }
            } catch (err) {
                console.error("Error checkExistingPemantik:", err);
            }
        }

        // Helper: Update Tampilan Icon di Dashboard (Kuning jika pending)
        // Deprecated: Handled by updateModuleUI

    </script>

    <!-- MODAL PERTANYAAN PEMANTIK -->
    <div id="modalPemantik"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2rem] shadow-2xl max-h-[90vh] flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div>
                    <h3 class="text-lg font-black text-slate-800">Pertanyaan Pemantik</h3>
                    <p class="text-xs text-slate-500 font-medium">Hari 1 • Cita Rasa Jajanan Nusantara</p>
                </div>
                <button onclick="closePemantikModal()"
                    class="size-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200 transition-colors">
                    <span class="material-symbols-outlined text-xl">close</span>
                </button>
            </div>

            <!-- Scrollable Content -->
            <div class="p-6 overflow-y-auto no-scrollbar space-y-6">

                <!-- Status Message Area -->
                <div id="statusMessage" class="hidden"></div>

                <!-- Dynamic Questions Container -->
                <div id="pemantikQuestionsContainer" class="space-y-6">
                    <!-- Questions will be injected here -->
                </div>

            </div>

            <!-- Footer -->
            <div class="p-5 border-t border-slate-100 bg-slate-50/50">
                <button id="btnSubmitPemantik" onclick="submitPemantik()"
                    class="w-full py-3.5 rounded-xl bg-emerald-custom text-white font-bold text-sm shadow-lg shadow-emerald-500/20 active:scale-[0.98] transition-all hover:bg-emerald-600">
                    Kirim Jawaban
                </button>
            </div>
        </div>
    </div>
    <!-- MODAL MATERI BELAJAR (SLIDE) -->
    <div id="modalMateri"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/60 backdrop-blur-md p-0 md:p-4 animate-fade-in">
        <div
            class="bg-white w-full max-w-lg h-full md:h-auto md:max-h-[85vh] md:rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden relative">

            <!-- Progress Top -->
            <div class="absolute top-0 left-0 w-full h-1.5 bg-slate-100">
                <div id="materiProgressBar" class="h-full bg-emerald-500 transition-all duration-500"
                    style="width: 12.5%"></div>
            </div>

            <!-- Header -->
            <div class="px-6 pt-8 pb-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="size-10 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center">
                        <span class="material-symbols-outlined font-icon">menu_book</span>
                    </div>
                    <div>
                        <h3 class="text-sm font-black text-slate-800 leading-tight">Materi Hari 1</h3>
                        <p id="materiStepText" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">
                            Halaman 1 dari 8</p>
                    </div>
                </div>
                <button onclick="closeMateriModal()"
                    class="size-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-slate-100 transition-all">
                    <span class="material-symbols-outlined text-xl">close</span>
                </button>
            </div>

            <!-- Content Area -->
            <div id="materiContentArea" class="flex-1 overflow-y-auto px-6 py-4 no-scrollbar">
                <div id="materiDynamicSlides">
                    <!-- Slides will be injected here -->
                </div>

                <!-- SLIDE 9: RINGKASAN (NEW) -->
                <div id="slide-materi-8" class="hidden animate-slide-up h-full flex flex-col">
                    <div class="flex flex-col items-center text-center mb-4">
                        <span class="material-symbols-outlined text-4xl text-emerald-500 mb-1">edit_document</span>
                        <h4 class="text-lg font-black text-slate-800">Bagian IX: Ringkasan Materi</h4>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Tuliskan apa yang kamu
                            pelajari hari ini</p>
                    </div>

                    <div id="materiStatusMsg" class="hidden mb-4 p-3 rounded-2xl text-[11px] font-medium border"></div>

                    <div class="flex-1 flex flex-col gap-3">
                        <div class="relative flex-1">
                            <textarea id="summaryArea" oninput="updateWordCount()"
                                class="w-full h-full min-h-[200px] bg-slate-50 border border-slate-200 rounded-2xl p-4 text-xs text-slate-700 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all resize-none font-medium leading-relaxed"
                                placeholder="Tuliskan ringkasan materi minimal 200 kata..."></textarea>
                            <div class="absolute bottom-3 right-4">
                                <span id="wordCounter"
                                    class="text-[10px] font-bold text-slate-400 bg-white/80 backdrop-blur px-2 py-1 rounded-lg border border-slate-100">0
                                    / 200 kata</span>
                            </div>
                        </div>

                        <div class="bg-amber-50 p-3 rounded-2xl border border-amber-100/50 flex gap-3">
                            <span class="material-symbols-outlined text-amber-500 text-lg">info</span>
                            <p class="text-[10px] text-amber-700 font-medium leading-relaxed">
                                <b>Penting:</b> Ringkasan ini akan diperiksa oleh Fasilitator. Kamu baru dianggap
                                menyelesaikan materi setelah mendapat review.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slide Navigation Bar -->
            <div class="px-6 pb-2">
                <div id="materiDynamicPills"
                    class="flex items-center justify-between bg-slate-50/50 p-1.5 rounded-2xl border border-slate-100 overflow-x-auto no-scrollbar gap-1.5">
                    <!-- Pills will be injected here -->
                </div>
            </div>

            <!-- Footer Controls -->
            <div class="p-6 border-t border-slate-50 bg-white flex gap-3">
                <button id="btnPrevMateri" onclick="prevMateriSlide()"
                    class="flex-1 py-3.5 rounded-2xl bg-slate-50 text-slate-400 font-bold text-xs transition-all invisible">Kembali</button>
                <button id="btnNextMateri" onclick="nextMateriSlide()"
                    class="flex-[3] py-3.5 rounded-2xl bg-emerald-500 text-white font-bold text-xs shadow-lg shadow-emerald-500/20 active:scale-95">Selanjutnya</button>
                <button id="btnFinishMateri" onclick="settleMateri()"
                    class="flex-[3] py-3.5 rounded-2xl bg-emerald-600 text-white font-bold text-xs shadow-lg shadow-emerald-500/30 transition-all active:scale-95 hidden">Selesaikan
                    Materi</button>
            </div>
        </div>
    </div>

    <!-- MODAL VIDEO PEMBELAJARAN -->
    <div id="modalVideo"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="p-8 border-b flex justify-between items-center bg-red-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-red-500 text-white flex items-center justify-center shadow-lg shadow-red-200">
                        <span class="material-symbols-outlined !text-2xl">play_circle</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">Video Pembelajaran</h3>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Tonton semua &
                            ringkas</p>
                    </div>
                </div>
                <button onclick="closeVideoModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Content -->
            <div id="videoItemsContainer" class="p-6 overflow-y-auto no-scrollbar flex-1 space-y-6">
                <!-- Video items will be injected here -->
                <div id="videoDynamicItems" class="space-y-6"></div>

                <!-- Ringkasan Form -->
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 space-y-3 relative">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-indigo-500 text-lg">edit_note</span>
                            <h4 class="text-sm font-black text-slate-800">Ringkasan Materi</h4>
                        </div>
                        <span id="videoWordCountDisplay"
                            class="text-[10px] font-bold text-red-500 bg-white/50 px-2 py-1 rounded-lg border border-red-100">0
                            / 50 kata</span>
                    </div>
                    <textarea id="videoSummaryInput" rows="4" oninput="updateVideoWordCount()"
                        class="w-full rounded-xl border-slate-200 text-sm focus:border-red-500 focus:ring-red-500 p-3"
                        placeholder="Tuliskan poin-poin penting dari video di atas (minimal 50 kata)..."></textarea>
                </div>

                <!-- Penilaian Fasil (Dynamic) -->
                <div id="videoStatusSection" class="hidden"></div>

                <!-- Placeholder Penilaian (Hidden if logic above works) -->
                <div id="videoFeedbackPlaceholder"
                    class="bg-amber-50 p-4 rounded-2xl border border-amber-100 flex flex-col items-center gap-2">
                    <p class="text-[10px] font-bold text-amber-700 uppercase tracking-widest">Penilaian Fasilitator</p>
                    <div class="flex gap-1">
                        <span class="material-symbols-outlined text-slate-300 text-2xl">star</span>
                        <span class="material-symbols-outlined text-slate-300 text-2xl">star</span>
                        <span class="material-symbols-outlined text-slate-300 text-2xl">star</span>
                        <span class="material-symbols-outlined text-slate-300 text-2xl">star</span>
                        <span class="material-symbols-outlined text-slate-300 text-2xl">star</span>
                    </div>
                    <p class="text-[10px] text-slate-400">Akan dinilai setelah ringkasan dikirim</p>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-8 bg-white border-t">
                <button id="btnSubmitVideo" onclick="submitVideoLog()" disabled
                    class="w-full py-4 bg-slate-300 text-white rounded-2xl font-black shadow-none transition-all cursor-not-allowed">
                    Simpan Ringkasan & Selesai
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL LKPD DIGITAL (NEW) -->
    <div id="modalLKPD"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="p-6 border-b flex justify-between items-center bg-orange-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-terracotta text-white flex items-center justify-center shadow-lg shadow-terracotta/30">
                        <span class="material-symbols-outlined !text-2xl">edit_note</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">LKPD Digital</h3>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Lembar Kerja Peserta
                            Didik</p>
                    </div>
                </div>
                <button onclick="closeLKPDModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto no-scrollbar bg-slate-50/50 p-6">

                <!-- Stepper -->
                <div class="flex items-center justify-between mb-8 px-4 relative">
                    <div class="absolute top-1/2 left-0 w-full h-0.5 bg-slate-200 -translate-y-1/2 z-0"></div>
                    <div id="lkpd-stepper-progress"
                        class="absolute top-1/2 left-0 h-0.5 bg-terracotta -translate-y-1/2 z-0 transition-all duration-300"
                        style="width: 0%"></div>

                    <button onclick="switchLKPD(1)" id="step-1"
                        class="size-8 rounded-full bg-terracotta text-white text-xs font-bold z-10 transition-all shadow-lg shadow-terracotta/20 relative">1</button>
                    <button onclick="switchLKPD(2)" id="step-2"
                        class="size-8 rounded-full bg-white border-2 border-slate-200 text-slate-400 text-xs font-bold z-10 transition-all relative">2</button>
                    <button onclick="switchLKPD(3)" id="step-3"
                        class="size-8 rounded-full bg-white border-2 border-slate-200 text-slate-400 text-xs font-bold z-10 transition-all relative">3</button>
                    <button onclick="switchLKPD(4)" id="step-4"
                        class="size-8 rounded-full bg-white border-2 border-slate-200 text-slate-400 text-xs font-bold z-10 transition-all relative">4</button>
                    <button onclick="switchLKPD(5)" id="step-5"
                        class="size-8 rounded-full bg-white border-2 border-slate-200 text-slate-400 text-xs font-bold z-10 transition-all relative">5</button>
                </div>

                <!-- Instruction Toggle -->
                <div class="mb-6">
                    <button onclick="document.getElementById('lkpdInstructions').classList.toggle('hidden')"
                        class="flex items-center gap-2 text-[11px] font-bold text-slate-500 hover:text-terracotta transition-colors">
                        <span class="material-symbols-outlined !text-base">info</span>
                        LIHAT PETUNJUK PENGERJAAN
                    </button>
                    <div id="lkpdInstructions"
                        class="hidden mt-3 p-4 bg-white rounded-2xl border border-slate-100 shadow-sm space-y-2">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Petunjuk:</p>
                        <ul class="text-[11px] text-slate-600 space-y-1 ml-4 list-decimal font-medium">
                            <li>Kerjakan LKPD ini secara berkelompok</li>
                            <li>Bacalah materi tentang Jajanan Nusantara Sehat dengan cermat.</li>
                            <li>Amati video pembelajaran yang ditayangkan guru.</li>
                            <li>Diskusikan setiap pertanyaan bersama kelompok.</li>
                            <li>Tuliskan jawaban dengan jelas dan sistematis.</li>
                        </ul>
                    </div>
                </div>

                <!-- LKPD Section 1: Definisi & Budaya -->
                <div id="lkpd-section-1" class="lkpd-section space-y-6">
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm-soft">
                        <label class="block text-[11px] font-black text-slate-800 uppercase tracking-widest mb-3">1.
                            Pengertian Jajanan Nusantara</label>
                        <textarea id="lkpd1_q1" oninput="saveLKPDDraft()"
                            class="w-full min-h-[100px] p-4 bg-slate-50 border border-slate-100 rounded-2xl text-xs text-slate-700 focus:ring-2 focus:ring-terracotta/20 focus:border-terracotta outline-none transition-all placeholder:text-slate-300 font-medium"
                            placeholder="Tuliskan jawabanmu di sini..."></textarea>
                    </div>

                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm-soft">
                        <label class="block text-[11px] font-black text-slate-800 uppercase tracking-widest mb-4">2.
                            Sejarah dan Pengaruh Budaya</label>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Tiongkok -->
                            <div class="p-4 rounded-2xl bg-orange-50/30 border border-orange-100/50 space-y-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span
                                        class="size-6 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center text-[10px] font-bold">A</span>
                                    <span class="text-[11px] font-bold text-slate-700 uppercase">Tiongkok</span>
                                </div>
                                <div>
                                    <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Bentuk
                                        Pengaruh:</label>
                                    <input type="text" id="lkpd1_q2a_bentuk" oninput="saveLKPDDraft()"
                                        class="w-full p-2.5 bg-white border border-slate-100 rounded-xl text-[11px] focus:border-terracotta outline-none transition-all">
                                </div>
                                <div>
                                    <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Contoh
                                        Jajanan:</label>
                                    <input type="text" id="lkpd1_q2a_contoh" oninput="saveLKPDDraft()"
                                        class="w-full p-2.5 bg-white border border-slate-100 rounded-xl text-[11px] focus:border-terracotta outline-none transition-all">
                                </div>
                                <div>
                                    <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Bahan
                                        Utama:</label>
                                    <input type="text" id="lkpd1_q2a_bahan" oninput="saveLKPDDraft()"
                                        class="w-full p-2.5 bg-white border border-slate-100 rounded-xl text-[11px] focus:border-terracotta outline-none transition-all">
                                </div>
                            </div>

                            <!-- Eropa -->
                            <div class="p-4 rounded-2xl bg-indigo-50/30 border border-indigo-100/50 space-y-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span
                                        class="size-6 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center text-[10px] font-bold">B</span>
                                    <span class="text-[11px] font-bold text-slate-700 uppercase">Eropa / Kolonial</span>
                                </div>
                                <div>
                                    <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Bentuk
                                        Pengaruh:</label>
                                    <input type="text" id="lkpd1_q2b_bentuk" oninput="saveLKPDDraft()"
                                        class="w-full p-2.5 bg-white border border-slate-100 rounded-xl text-[11px] focus:border-terracotta outline-none transition-all">
                                </div>
                                <div>
                                    <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Contoh
                                        Jajanan:</label>
                                    <input type="text" id="lkpd1_q2b_contoh" oninput="saveLKPDDraft()"
                                        class="w-full p-2.5 bg-white border border-slate-100 rounded-xl text-[11px] focus:border-terracotta outline-none transition-all">
                                </div>
                                <div>
                                    <label class="block text-[9px] font-bold text-slate-400 mb-1 uppercase">Bahan
                                        Utama:</label>
                                    <input type="text" id="lkpd1_q2b_bahan" oninput="saveLKPDDraft()"
                                        class="w-full p-2.5 bg-white border border-slate-100 rounded-xl text-[11px] focus:border-terracotta outline-none transition-all">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sections for LKPD 2, 3, 4, 5 (Placeholders) -->
                <!-- LKPD 2: Analisis Atlas Kuliner -->
                <div id="lkpd-section-2" class="lkpd-section hidden animate-slide-up pb-8">
                    <div class="mb-6">
                        <h4 class="text-sm font-black text-slate-800 uppercase tracking-wider mb-2">LKPD 2: Analisis
                            Atlas Kuliner</h4>
                        <p class="text-[10px] text-slate-500 font-medium leading-relaxed">Perhatikan materi Atlas
                            Kuliner, kemudian lengkapi data berikut sesuai pemahaman kelompokmu!</p>
                    </div>

                    <div class="space-y-4">
                        <!-- Card Region Helper Function Context -->
                        <script>
                            function generateRegionCard(id, name, icon, colorClass, iconColor) {
                                return `
                                <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden group">
                                    <div class="px-5 py-3 ${colorClass} flex items-center gap-3 border-b border-white/50">
                                        <div class="size-8 rounded-full bg-white flex items-center justify-center ${iconColor} shadow-sm">
                                            <span class="material-symbols-outlined text-[18px]">${icon}</span>
                                        </div>
                                        <span class="text-xs font-black uppercase tracking-widest text-slate-700">${name}</span>
                                    </div>
                                    <div class="p-5 space-y-4 bg-slate-50/30">
                                        <div>
                                            <label class="block text-[9px] font-bold text-slate-400 mb-1.5 uppercase tracking-tighter">Contoh Jajanan:</label>
                                            <input type="text" id="lkpd2_${id}_contoh" oninput="saveLKPDDraft()" placeholder="Jawab..."
                                                class="w-full p-3 bg-white border border-slate-100 rounded-2xl text-[11px] font-medium focus:border-terracotta outline-none transition-all placeholder:text-slate-300">
                                        </div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-[9px] font-bold text-slate-400 mb-1.5 uppercase tracking-tighter">Bahan Utama:</label>
                                                <input type="text" id="lkpd2_${id}_bahan" oninput="saveLKPDDraft()" placeholder="Jawab..."
                                                    class="w-full p-3 bg-white border border-slate-100 rounded-2xl text-[11px] font-medium focus:border-terracotta outline-none transition-all placeholder:text-slate-300">
                                            </div>
                                            <div>
                                                <label class="block text-[9px] font-bold text-slate-400 mb-1.5 uppercase tracking-tighter">Cita Rasa:</label>
                                                <input type="text" id="lkpd2_${id}_rasa" oninput="saveLKPDDraft()" placeholder="Jawab..."
                                                    class="w-full p-3 bg-white border border-slate-100 rounded-2xl text-[11px] font-medium focus:border-terracotta outline-none transition-all placeholder:text-slate-300">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                `;
                            }
                        </script>

                        <!-- Region Sumatra -->
                        <div id="card-sumatra"></div>
                        <script>document.getElementById('card-sumatra').outerHTML = generateRegionCard('sumatra', 'Sumatra', 'landscape', 'bg-emerald-50', 'text-emerald-500');</script>

                        <!-- Region Jawa -->
                        <div id="card-jawa"></div>
                        <script>document.getElementById('card-jawa').outerHTML = generateRegionCard('jawa', 'Jawa', 'temple_hindu', 'bg-blue-50', 'text-blue-500');</script>

                        <!-- Region Sulawesi -->
                        <div id="card-sulawesi"></div>
                        <script>document.getElementById('card-sulawesi').outerHTML = generateRegionCard('sulawesi', 'Sulawesi', 'waves', 'bg-red-50', 'text-red-500');</script>

                        <!-- Region Bali -->
                        <div id="card-bali"></div>
                        <script>document.getElementById('card-bali').outerHTML = generateRegionCard('bali', 'Bali', 'surfing', 'bg-indigo-50', 'text-indigo-500');</script>

                        <!-- Region Papua -->
                        <div id="card-papua"></div>
                        <script>document.getElementById('card-papua').outerHTML = generateRegionCard('papua', 'Papua', 'forest', 'bg-orange-50', 'text-orange-500');</script>
                    </div>
                </div>
                <!-- ... repeat for 3, 4, 5 ... -->
                <!-- LKPD 3: Analisis Gizi & Bahan Utama -->
                <div id="lkpd-section-3" class="lkpd-section hidden animate-slide-up pb-8">
                    <div class="mb-6">
                        <h4 class="text-sm font-black text-slate-800 uppercase tracking-wider mb-2">LKPD 3: Analisis
                            Gizi & Bahan Utama</h4>
                        <p class="text-[10px] text-slate-500 font-medium leading-relaxed">Analisis kandungan gizi dan
                            manfaat bahan tradisional berikut berdasarkan materi yang telah dipelajari.</p>
                    </div>

                    <div class="space-y-5">
                        <script>
                            function generateNutrientCard(num, question, id) {
                                return `
                                <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden group">
                                    <div class="px-5 py-3 bg-emerald-50/50 flex items-center gap-3 border-b border-white/50">
                                        <div class="size-8 rounded-full bg-white flex items-center justify-center text-emerald-500 shadow-sm">
                                            <span class="text-[10px] font-black">${num}</span>
                                        </div>
                                        <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">Pertanyaan ${num}</span>
                                    </div>
                                    <div class="p-5 bg-slate-50/30">
                                        <label class="block text-[10px] font-bold text-slate-500 mb-2 leading-relaxed">${question}</label>
                                        <textarea id="lkpd3_q${num}" oninput="saveLKPDDraft()" placeholder="Jawab..."
                                            class="w-full min-h-[80px] p-4 bg-white border border-slate-100 rounded-2xl text-xs text-slate-700 focus:border-terracotta outline-none transition-all placeholder:text-slate-300 font-medium"></textarea>
                                    </div>
                                </div>`;
                            }
                        </script>

                        <div id="lkpd3-questions-container"></div>
                        <script>
                            const lkpd3Questions = [
                                "Sebutkan 3 jenis bahan lokal yang menjadi sumber karbohidrat utama dalam jajanan Nusantara!",
                                "Mengapa bahan umbi-umbian (singkong/sagu) lebih unggul seratnya dibanding tepung terigu?",
                                "Identifikasi zat gizi utama pada Bika Ambon berdasarkan bahan penyusunnya!",
                                "Apa peran kelapa parut dalam memberikan serat pada jajanan Jawa Barat?",
                                "Jelaskan manfaat gizi utama dari penggunaan kacang hijau pada jajanan Yogyakarta!",
                                "Sebutkan mineral penting dalam pisang (Sulawesi Selatan) yang bermanfaat bagi tubuh!",
                                "Apa keunggulan pati sagu alami (Papua) bagi kesehatan, khususnya terkait gluten?",
                                "Jelaskan perbedaan manfaat gula aren dibanding gula pasir!",
                                "Bagaimana cara meningkatkan nilai gizi panada menggunakan sayuran?",
                                "Apa kontribusi gizi dari penggunaan santan/kelapa selain sebagai pemberi rasa gurih?"
                            ];
                            let lkpd3Html = '';
                            lkpd3Questions.forEach((q, i) => {
                                lkpd3Html += generateNutrientCard(i + 1, q, `lkpd3_q${i + 1}`);
                            });
                            document.getElementById('lkpd3-questions-container').outerHTML = lkpd3Html;
                        </script>
                    </div>
                </div>
                <!-- LKPD 4: Inovasi Jajanan Nusantara -->
                <div id="lkpd-section-4" class="lkpd-section hidden animate-slide-up pb-8">
                    <div class="mb-6">
                        <h4 class="text-sm font-black text-slate-800 uppercase tracking-wider mb-2">LKPD 4: Inovasi
                            Jajanan Nusantara</h4>
                        <p class="text-[10px] text-slate-500 font-medium leading-relaxed">Rancanglah inovasi jajanan
                            (makanan & minuman) Nusantara untuk kegiatan bazar sekolah!</p>
                    </div>

                    <div class="space-y-8">
                        <!-- BAGIAN MAKANAN -->
                        <div class="space-y-5">
                            <div class="flex items-center gap-3 border-b border-orange-100 pb-2">
                                <span class="material-symbols-outlined text-orange-500">restaurant</span>
                                <h5 class="text-xs font-black text-slate-700 uppercase tracking-widest">A. Inovasi
                                    Makanan</h5>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Nama Makanan -->
                                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                    <label
                                        class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                        <span class="material-symbols-outlined !text-sm">label</span> Nama Makanan
                                    </label>
                                    <input type="text" id="lkpd4_m_nama" oninput="saveLKPDDraft()"
                                        placeholder="Nama inovasi makanan..."
                                        class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-orange-400 outline-none transition-all">
                                </div>
                                <!-- Asal Daerah -->
                                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                    <label
                                        class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                        <span class="material-symbols-outlined !text-sm">location_on</span> Asal Daerah
                                    </label>
                                    <input type="text" id="lkpd4_m_asal" oninput="saveLKPDDraft()"
                                        placeholder="Asal daerah makanan..."
                                        class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-orange-400 outline-none transition-all">
                                </div>
                            </div>

                            <div class="space-y-4">
                                <!-- Grid Kolom 3 & 4: Bahan & Gizi -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">shopping_basket</span>
                                            Bahan Utama
                                        </label>
                                        <textarea id="lkpd4_m_bahan" oninput="saveLKPDDraft()"
                                            placeholder="Daftar bahan utama..."
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-orange-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">nutrition</span> Informasi
                                            Gizi
                                        </label>
                                        <textarea id="lkpd4_m_gizi" oninput="saveLKPDDraft()"
                                            placeholder="Kandungan gizi..."
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-orange-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                </div>

                                <!-- Grid Kolom 5 & 6: Metode & Keunggulan -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">cooking</span> Metode
                                            Pengolahan
                                        </label>
                                        <textarea id="lkpd4_m_metode" oninput="saveLKPDDraft()"
                                            placeholder="Cara mengolah..."
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-orange-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">workspace_premium</span>
                                            Keunggulan Produk
                                        </label>
                                        <textarea id="lkpd4_m_keunggulan" oninput="saveLKPDDraft()"
                                            placeholder="Apa keunggulan makanan ini?"
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-orange-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                </div>

                                <!-- Grid Kolom 7 & 8: Teknologi Pemasaran & Inovasi -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">ads_click</span> Teknologi
                                            Pemasaran
                                        </label>
                                        <textarea id="lkpd4_m_pemasaran" oninput="saveLKPDDraft()"
                                            placeholder="Strategi pemasaran digital/modern..."
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-orange-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">lightbulb</span> Inovasi
                                            Makanan
                                        </label>
                                        <textarea id="lkpd4_m_inovasi" oninput="saveLKPDDraft()"
                                            placeholder="Apa sentuhan inovasi barunya?"
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-orange-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN MINUMAN -->
                        <div class="space-y-5 pt-4">
                            <div class="flex items-center gap-3 border-b border-blue-100 pb-2">
                                <span class="material-symbols-outlined text-blue-500">local_drink</span>
                                <h5 class="text-xs font-black text-slate-700 uppercase tracking-widest">B. Inovasi
                                    Minuman</h5>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Nama Minuman -->
                                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                    <label
                                        class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                        <span class="material-symbols-outlined !text-sm">label</span> Nama Minuman
                                    </label>
                                    <input type="text" id="lkpd4_d_nama" oninput="saveLKPDDraft()"
                                        placeholder="Nama inovasi minuman..."
                                        class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-blue-400 outline-none transition-all">
                                </div>
                                <!-- Asal Daerah -->
                                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                    <label
                                        class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                        <span class="material-symbols-outlined !text-sm">location_on</span> Asal Daerah
                                    </label>
                                    <input type="text" id="lkpd4_d_asal" oninput="saveLKPDDraft()"
                                        placeholder="Asal daerah minuman..."
                                        class="w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-blue-400 outline-none transition-all">
                                </div>
                            </div>

                            <div class="space-y-4">
                                <!-- Grid Kolom 3 & 4: Bahan & Gizi -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">shopping_basket</span>
                                            Bahan Utama
                                        </label>
                                        <textarea id="lkpd4_d_bahan" oninput="saveLKPDDraft()"
                                            placeholder="Daftar bahan utama..."
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-blue-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">nutrition</span> Informasi
                                            Gizi
                                        </label>
                                        <textarea id="lkpd4_d_gizi" oninput="saveLKPDDraft()"
                                            placeholder="Kandungan gizi..."
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-blue-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                </div>

                                <!-- Grid Kolom 5 & 6: Metode & Keunggulan -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">cooking</span> Metode
                                            Pengolahan
                                        </label>
                                        <textarea id="lkpd4_d_metode" oninput="saveLKPDDraft()"
                                            placeholder="Cara mengolah..."
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-blue-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                        <label
                                            class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                            <span class="material-symbols-outlined !text-sm">workspace_premium</span>
                                            Keunggulan Produk
                                        </label>
                                        <textarea id="lkpd4_d_keunggulan" oninput="saveLKPDDraft()"
                                            placeholder="Apa keunggulan minuman ini?"
                                            class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-blue-400 outline-none transition-all resize-none"></textarea>
                                    </div>
                                </div>

                                <!-- Kolom 7: Teknologi Pemasaran -->
                                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                    <label
                                        class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                        <span class="material-symbols-outlined !text-sm">ads_click</span> Teknologi
                                        Pemasaran
                                    </label>
                                    <textarea id="lkpd4_d_pemasaran" oninput="saveLKPDDraft()"
                                        placeholder="Strategi pemasaran digital/modern..."
                                        class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-blue-400 outline-none transition-all resize-none"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN C. INOVASI BAZAR -->
                        <div class="space-y-5 pt-4">
                            <div class="flex items-center gap-3 border-b border-purple-100 pb-2">
                                <span class="material-symbols-outlined text-purple-500">storefront</span>
                                <h5 class="text-xs font-black text-slate-700 uppercase tracking-widest">C. Inovasi Bazar
                                </h5>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Alat -->
                                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                    <label
                                        class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                        <span class="material-symbols-outlined !text-sm">construction</span> Alat
                                    </label>
                                    <textarea id="lkpd4_b_alat" oninput="saveLKPDDraft()"
                                        placeholder="Daftar alat untuk booth..."
                                        class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-purple-400 outline-none transition-all resize-none"></textarea>
                                </div>
                                <!-- Bahan -->
                                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm-soft">
                                    <label
                                        class="flex items-center gap-2 text-[9px] font-black text-slate-400 mb-2 uppercase">
                                        <span class="material-symbols-outlined !text-sm">inventory_2</span> Bahan
                                    </label>
                                    <textarea id="lkpd4_b_bahan" oninput="saveLKPDDraft()"
                                        placeholder="Daftar bahan dekorasi/booth..."
                                        class="w-full min-h-[70px] p-3 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-medium focus:border-purple-400 outline-none transition-all resize-none"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="lkpd-section-5" class="lkpd-section hidden animate-slide-up pb-8">
                    <div class="mb-6">
                        <h4 class="text-sm font-black text-slate-800 uppercase tracking-wider mb-2">LKPD 5: Desain &
                            Sketsa</h4>
                        <p class="text-[10px] text-slate-500 font-medium leading-relaxed">
                            Silakan unggah visualisasi ide rancangan produk Makanan, Minuman, dan Booth Bazar yang telah
                            kalian rancang sebelumnya di LKPD 4.
                            Hasil karya dapat berupa foto, ilustrasi digital, atau sketsa tangan.
                        </p>
                    </div>

                    <div class="space-y-6">
                        <!-- 1. Desain Makanan -->
                        <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden group">
                            <div
                                class="px-5 py-3 bg-orange-50/50 flex items-center gap-3 border-b border-orange-100/50">
                                <div
                                    class="size-8 rounded-full bg-white flex items-center justify-center text-orange-500 shadow-sm">
                                    <span class="material-symbols-outlined text-[18px]">restaurant_menu</span>
                                </div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">1. Desain
                                    Inovasi Makanan</span>
                            </div>
                            <div class="p-5 bg-slate-50/30 text-center">
                                <div id="preview-container-food"
                                    class="hidden mb-4 relative w-full h-48 bg-slate-100 rounded-2xl overflow-hidden border border-slate-200">
                                    <img id="preview-img-food" src="" class="w-full h-full object-cover">
                                    <div
                                        class="absolute bottom-2 right-2 bg-emerald-500 text-white text-[9px] font-bold px-2 py-1 rounded-lg shadow-sm">
                                        Terupload
                                    </div>
                                </div>

                                <div id="upload-ui-food">
                                    <input type="file" id="file-food" accept="image/*" class="hidden"
                                        onchange="handleLKPDUpload('food', event)">
                                    <label for="file-food"
                                        class="w-full py-4 bg-white border-2 border-dashed border-orange-200 text-orange-500 rounded-2xl font-bold text-xs flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-orange-50 transition-all active:scale-95">
                                        <span class="material-symbols-outlined text-3xl">add_photo_alternate</span>
                                        <span>Pilih Foto Sketsa Makanan</span>
                                    </label>
                                    <p class="text-[9px] text-slate-400 mt-2">Format: JPG/PNG. Maks 5MB.</p>
                                </div>
                                <div id="status-food"
                                    class="hidden mt-3 text-[10px] font-bold text-slate-500 animate-pulse">Menyiapkan...
                                </div>
                            </div>
                        </div>

                        <!-- 2. Desain Minuman -->
                        <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden group">
                            <div class="px-5 py-3 bg-blue-50/50 flex items-center gap-3 border-b border-blue-100/50">
                                <div
                                    class="size-8 rounded-full bg-white flex items-center justify-center text-blue-500 shadow-sm">
                                    <span class="material-symbols-outlined text-[18px]">local_bar</span>
                                </div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">2. Desain
                                    Inovasi Minuman</span>
                            </div>
                            <div class="p-5 bg-slate-50/30 text-center">
                                <div id="preview-container-drink"
                                    class="hidden mb-4 relative w-full h-48 bg-slate-100 rounded-2xl overflow-hidden border border-slate-200">
                                    <img id="preview-img-drink" src="" class="w-full h-full object-cover">
                                    <div
                                        class="absolute bottom-2 right-2 bg-emerald-500 text-white text-[9px] font-bold px-2 py-1 rounded-lg shadow-sm">
                                        Terupload
                                    </div>
                                </div>

                                <div id="upload-ui-drink">
                                    <input type="file" id="file-drink" accept="image/*" class="hidden"
                                        onchange="handleLKPDUpload('drink', event)">
                                    <label for="file-drink"
                                        class="w-full py-4 bg-white border-2 border-dashed border-blue-200 text-blue-500 rounded-2xl font-bold text-xs flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-blue-50 transition-all active:scale-95">
                                        <span class="material-symbols-outlined text-3xl">add_photo_alternate</span>
                                        <span>Pilih Foto Sketsa Minuman</span>
                                    </label>
                                    <p class="text-[9px] text-slate-400 mt-2">Format: JPG/PNG. Maks 5MB.</p>
                                </div>
                                <div id="status-drink"
                                    class="hidden mt-3 text-[10px] font-bold text-slate-500 animate-pulse">Menyiapkan...
                                </div>
                            </div>
                        </div>

                        <!-- 3. Desain Booth -->
                        <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden group">
                            <div
                                class="px-5 py-3 bg-purple-50/50 flex items-center gap-3 border-b border-purple-100/50">
                                <div
                                    class="size-8 rounded-full bg-white flex items-center justify-center text-purple-500 shadow-sm">
                                    <span class="material-symbols-outlined text-[18px]">storefront</span>
                                </div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">3. Desain
                                    Booth Bazar</span>
                            </div>
                            <div class="p-5 bg-slate-50/30 text-center">
                                <div id="preview-container-booth"
                                    class="hidden mb-4 relative w-full h-48 bg-slate-100 rounded-2xl overflow-hidden border border-slate-200">
                                    <img id="preview-img-booth" src="" class="w-full h-full object-cover">
                                    <div
                                        class="absolute bottom-2 right-2 bg-emerald-500 text-white text-[9px] font-bold px-2 py-1 rounded-lg shadow-sm">
                                        Terupload
                                    </div>
                                </div>

                                <div id="upload-ui-booth">
                                    <input type="file" id="file-booth" accept="image/*" class="hidden"
                                        onchange="handleLKPDUpload('booth', event)">
                                    <label for="file-booth"
                                        class="w-full py-4 bg-white border-2 border-dashed border-purple-200 text-purple-500 rounded-2xl font-bold text-xs flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-purple-50 transition-all active:scale-95">
                                        <span class="material-symbols-outlined text-3xl">add_photo_alternate</span>
                                        <span>Pilih Foto Sketsa Booth</span>
                                    </label>
                                    <p class="text-[9px] text-slate-400 mt-2">Format: JPG/PNG. Maks 5MB.</p>
                                </div>
                                <div id="status-booth"
                                    class="hidden mt-3 text-[10px] font-bold text-slate-500 animate-pulse">Menyiapkan...
                                </div>
                            </div>
                        </div>

                        <!-- 4. Desain Pemasaran -->
                        <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden group">
                            <div class="px-5 py-3 bg-rose-50/50 flex items-center gap-3 border-b border-rose-100/50">
                                <div
                                    class="size-8 rounded-full bg-white flex items-center justify-center text-rose-500 shadow-sm">
                                    <span class="material-symbols-outlined text-[18px]">campaign</span>
                                </div>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">4. Desain
                                    Teknologi Pemasaran</span>
                            </div>
                            <div class="p-5 bg-slate-50/30 text-center">
                                <div id="preview-container-marketing"
                                    class="hidden mb-4 relative w-full h-48 bg-slate-100 rounded-2xl overflow-hidden border border-slate-200">
                                    <img id="preview-img-marketing" src="" class="w-full h-full object-cover">
                                    <div
                                        class="absolute bottom-2 right-2 bg-emerald-500 text-white text-[9px] font-bold px-2 py-1 rounded-lg shadow-sm">
                                        Terupload
                                    </div>
                                </div>

                                <div id="upload-ui-marketing">
                                    <input type="file" id="file-marketing" accept="image/*" class="hidden"
                                        onchange="handleLKPDUpload('marketing', event)">
                                    <label for="file-marketing"
                                        class="w-full py-4 bg-white border-2 border-dashed border-rose-200 text-rose-500 rounded-2xl font-bold text-xs flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-rose-50 transition-all active:scale-95">
                                        <span class="material-symbols-outlined text-3xl">add_photo_alternate</span>
                                        <span>Pilih Flyer/Poster/Brosur</span>
                                    </label>
                                    <p class="text-[9px] text-slate-400 mt-2">Format: JPG/PNG. Maks 5MB.</p>
                                </div>
                                <div id="status-marketing"
                                    class="hidden mt-3 text-[10px] font-bold text-slate-500 animate-pulse">Menyiapkan...
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Feedback Section after submission -->
                <div id="lkpdStatusSection" class="hidden mt-6"></div>

            </div>

            <!-- Footer -->
            <div class="p-6 border-t bg-white flex items-center justify-between gap-4">
                <button id="btnPrevLKPD" onclick="prevLKPD()"
                    class="px-6 py-3 rounded-2xl border border-slate-200 text-slate-400 text-xs font-bold hover:bg-slate-50 transition-all opacity-0 pointer-events-none">
                    Sebelumnya
                </button>
                <div class="flex-1"></div>
                <button id="btnNextLKPD" onclick="nextLKPD()"
                    class="px-8 py-3 bg-terracotta text-white rounded-2xl text-xs font-bold shadow-lg shadow-terracotta/20 hover:scale-[1.02] transition-all">
                    Lanjut ke LKPD 2
                </button>
                <button id="btnSubmitLKPDAll" onclick="submitLKPDTotal()"
                    class="hidden px-8 py-3 bg-emerald-500 text-white rounded-2xl text-xs font-bold shadow-lg shadow-emerald-200 hover:scale-[1.02] transition-all">
                    Kirim Semua LKPD
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL ASSESSMENT (REPLACEMENT) -->
    <div id="modalAssessment"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="p-6 border-b flex justify-between items-center bg-indigo-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-indigo-500 text-white flex items-center justify-center shadow-lg shadow-indigo-200">
                        <span class="material-symbols-outlined !text-2xl">quiz</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">Assessment</h3>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Uji Pemahamanmu</p>
                    </div>
                </div>
                <button onclick="closeAssessmentModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Content -->
            <div class="p-6 flex-1 overflow-y-auto no-scrollbar relative">
                <!-- Progress -->
                <div class="w-full bg-slate-100 h-2 rounded-full mb-2 overflow-hidden">
                    <div id="assessmentProgressBar" class="h-full bg-indigo-500 w-0 transition-all duration-300"></div>
                </div>
                <p id="assessmentProgressText" class="text-[10px] text-slate-400 font-bold mb-6 text-right">Soal 1 dari
                    50</p>

                <!-- Question Container -->
                <div id="assessmentQuestionContainer" class="animate-slide-up">
                    <!-- Dynamic Question Content Here -->
                </div>

                <!-- Result Container (Hidden initially) -->
                <div id="assessmentResultContainer"
                    class="hidden flex-col items-center justify-center text-center space-y-6 py-10 animate-scale-up">
                    <div class="size-24 bg-amber-100 rounded-full flex items-center justify-center mb-2 mx-auto">
                        <span class="text-6xl">🏆</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-slate-800 mb-2">Luar Biasa!</h2>
                        <p class="text-xs text-slate-500">Kamu telah menyelesaikan assessment.</p>
                    </div>

                    <div id="resultStars" class="flex gap-2 justify-center">
                        <!-- Stars injected here -->
                    </div>

                    <p id="resultScoreText"
                        class="text-lg font-bold text-indigo-600 bg-indigo-50 px-6 py-2 rounded-2xl"></p>

                    <button onclick="closeAssessmentModal()"
                        class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition-all">
                        Tutup & Simpan
                    </button>
                </div>

                <!-- Navigation Button (Outside result) -->
                <button id="btnNextAssessment"
                    class="px-6 py-3 bg-indigo-500 text-white rounded-xl font-bold text-xs shadow-lg shadow-indigo-200 active:scale-95 transition-all w-full mt-6">
                    Selanjutnya
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DOKUMENTASI FOTO (REPLACEMENT RANGKUMAN) -->
    <div id="modalDokumentasi"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-8 border-b flex justify-between items-center bg-slate-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-indigo-500 text-white flex items-center justify-center shadow-lg shadow-indigo-200">
                        <span class="material-symbols-outlined !text-2xl">photo_camera</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">Dokumentasi Foto</h3>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Hanya 1
                            foto terbaik
                            setiap hari</p>
                    </div>
                </div>
                <button onclick="closeDokumentasiModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="p-8 overflow-y-auto no-scrollbar flex-1">
                <div id="docStatusMsg" class="hidden"></div>

                <!-- Upload Area -->
                <div id="docUploadArea" class="space-y-6">
                    <div
                        class="p-8 border-2 border-dashed border-slate-200 rounded-[2rem] bg-slate-50 flex flex-col items-center justify-center text-center group hover:border-indigo-400 transition-all cursor-pointer relative">
                        <input type="file" accept="image/*" capture="environment"
                            onchange="handleDocPhotoSelection(event)" class="absolute inset-0 opacity-0 cursor-pointer"
                            id="docInput">
                        <div
                            class="size-16 rounded-full bg-white shadow-sm flex items-center justify-center text-indigo-500 mb-4 group-hover:scale-110 transition-transform">
                            <span class="material-symbols-outlined !text-3xl">add_a_photo</span>
                        </div>
                        <p class="text-sm font-bold text-slate-700">Ambil Foto Kegiatan</p>
                        <p class="text-[11px] text-slate-400 mt-1">Gunakan kamera HP untuk hasil terbaik</p>
                    </div>

                    <div class="bg-amber-50 p-4 rounded-2xl border border-amber-100 flex gap-3">
                        <span class="material-symbols-outlined text-amber-500 text-lg">info</span>
                        <p class="text-[11px] text-amber-700 font-medium leading-relaxed">
                            Foto akan dikompresi otomatis untuk menghemat kuota. Pastikan objek foto
                            terlihat jelas.
                        </p>
                    </div>
                </div>

                <!-- Preview Area (shown after photo selected) -->
                <div id="docPreviewArea" class="hidden space-y-4">
                    <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100 flex gap-3">
                        <span class="material-symbols-outlined text-emerald-500 text-lg">check_circle</span>
                        <p class="text-[11px] text-emerald-700 font-bold">
                            Foto berhasil dipilih! Pastikan foto sudah benar sebelum mengirim.
                        </p>
                    </div>

                    <!-- Preview Image Container -->
                    <div class="bg-slate-100 rounded-2xl overflow-hidden border-4 border-white shadow-xl p-2">
                        <img id="docPreview" class="w-full rounded-xl"
                            style="display: block; min-height: 200px; max-height: 400px; object-fit: contain;" src=""
                            alt="Preview Foto">
                    </div>

                    <button onclick="changeDocPhoto()"
                        class="w-full py-4 bg-slate-100 text-slate-700 rounded-2xl font-bold hover:bg-slate-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-lg">sync</span>
                        Ganti Foto
                    </button>
                </div>
            </div>

            <div class="p-8 bg-slate-50 border-t">
                <button id="btnUploadDokumentasi" onclick="submitDokumentasi()"
                    class="w-full py-5 bg-indigo-500 text-white rounded-2xl font-black shadow-lg shadow-indigo-200 active:scale-95 transition-all disabled:opacity-50 disabled:active:scale-100">
                    Kirim Dokumentasi
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL GLOSARIUM (MOVED OUTSIDE) -->
    <div id="modalGlosarium"
        class="fixed inset-0 z-[9999] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="p-8 border-b flex justify-between items-center bg-emerald-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-emerald-500 text-white flex items-center justify-center shadow-lg shadow-emerald-200">
                        <span class="material-symbols-outlined !text-2xl">menu_book</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">Glosarium</h3>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Kamus Istilah
                            Penting</p>
                    </div>
                </div>
                <button onclick="closeGlosariumModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Content -->
            <div class="p-8 overflow-y-auto no-scrollbar flex-1 space-y-6">
                <!-- Glosarium Content from Draft -->
                <div class="space-y-6 text-sm text-slate-600 leading-relaxed font-medium">
                    <!-- A - E -->
                    <div class="space-y-4">
                        <h4
                            class="font-black text-emerald-800 uppercase tracking-widest text-xs border-b border-emerald-100 pb-2">
                            A - E</h4>
                        <div class="space-y-3">
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Air Fryer</p>
                                <p class="text-xs mt-1">Teknologi memasak modern menggunakan sirkulasi udara panas
                                    berkecepatan tinggi. Teknik ini memungkinkan pembuatan jajanan yang renyah
                                    (seperti tekstur gorengan) dengan penggunaan minyak yang sangat sedikit,
                                    sehingga lebih sehat dan rendah lemak.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Bahan Baku Lokal</p>
                                <p class="text-xs mt-1">Bahan pangan yang asli berasal dan tumbuh di lingkungan
                                    sekitar tempat produksi, seperti singkong, ubi, kelapa, dan gula aren.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Bandrek</p>
                                <p class="text-xs mt-1">Minuman tradisional khas Jawa Barat / Sunda yang terbuat
                                    dari campuran jahe, gula merah, dan rempah-rempah. Sering ditambahkan kerokan
                                    kelapa muda. Berfungsi menghangatkan tubuh.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Bika Ambon</p>
                                <p class="text-xs mt-1">Kue pipih berwarna kuning dengan tekstur berlubang-lubang
                                    (bersarang) khas Medan, Sumatera Utara. Terbuat dari tapioka, telur, gula, dan
                                    santan yang difermentasi.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Blending / Puree</p>
                                <p class="text-xs mt-1">Teknik menghaluskan bahan makanan (biasanya buah atau
                                    sayuran) menjadi bubur lembut. Digunakan untuk menyisipkan nutrisi sayuran/buah
                                    ke dalam adonan.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Eco-friendly Packaging</p>
                                <p class="text-xs mt-1">Kemasan ramah lingkungan yang materialnya mudah terurai di
                                    alam (biodegradable) atau dapat didaur ulang. Contoh: daun pisang, besek bambu.
                                </p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Elektrolit</p>
                                <p class="text-xs mt-1">Mineral bermuatan listrik (seperti natrium, kalium, kalsium)
                                    yang penting untuk fungsi tubuh. Air kelapa dan gula aren adalah sumber
                                    elektrolit alami.</p>
                            </div>
                        </div>
                    </div>

                    <!-- F - J -->
                    <div class="space-y-4">
                        <h4
                            class="font-black text-emerald-800 uppercase tracking-widest text-xs border-b border-emerald-100 pb-2">
                            F - J</h4>
                        <div class="space-y-3">
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Food-grade</p>
                                <p class="text-xs mt-1">Standar keamanan bahan (biasanya plastik atau kertas) yang
                                    menyatakan bahwa bahan tersebut aman untuk kontak langsung dengan makanan.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Fortifikasi Nutrisi</p>
                                <p class="text-xs mt-1">Upaya sengaja menambahkan mikronutrien (vitamin/mineral)
                                    atau bahan bergizi lain ke dalam makanan untuk meningkatkan kualitas gizinya.
                                </p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Gluten</p>
                                <p class="text-xs mt-1">Jenis protein yang ditemukan dalam gandum (terigu). Jajanan
                                    berbahan tepung beras/ketan/sagu biasanya bebas gluten.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Indeks Glikemik</p>
                                <p class="text-xs mt-1">Skala yang mengukur seberapa cepat makanan meningkatkan
                                    kadar gula darah. Gula aren memiliki indeks glikemik lebih rendah dari gula
                                    pasir.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Jajanan Nusantara</p>
                                <p class="text-xs mt-1">Kudapan atau makanan ringan tradisional yang berasal dari
                                    berbagai daerah di Indonesia, mencerminkan kearifan lokal.</p>
                            </div>
                        </div>
                    </div>

                    <!-- K - O -->
                    <div class="space-y-4">
                        <h4
                            class="font-black text-emerald-800 uppercase tracking-widest text-xs border-b border-emerald-100 pb-2">
                            K - O</h4>
                        <div class="space-y-3">
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Karbohidrat Kompleks</p>
                                <p class="text-xs mt-1">Jenis karbohidrat dengan rangkaian molekul panjang yang
                                    dicerna lebih lama, memberikan energi stabil dan rasa kenyang lebih lama
                                    (contoh: singkong, ubi).</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Klappertaart</p>
                                <p class="text-xs mt-1">Kue khas Manado yang dipengaruhi kuliner Belanda. Berbahan
                                    dasar kelapa muda, susu, telur, dan mentega.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Klepon</p>
                                <p class="text-xs mt-1">Jajanan pasar berbentuk bola-bola dari tepung beras ketan,
                                    diisi gula merah cair, dan digulingkan di atas kelapa parut.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Membakar / Memanggang (Tradisional)</p>
                                <p class="text-xs mt-1">Teknik mematangkan makanan di atas bara api, seringkali
                                    dengan perantara daun pisang untuk aroma *smoky*.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Mengukus (Steaming)</p>
                                <p class="text-xs mt-1">Teknik memasak menggunakan uap air mendidih. Metode sehat
                                    yang menjaga kelembapan dan nutrisi makanan.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Menyangrai (Roasting)</p>
                                <p class="text-xs mt-1">Teknik memasak kering di atas wajan tanpa minyak (misal:
                                    untuk kelapa parut atau kacang).</p>
                            </div>
                        </div>
                    </div>

                    <!-- P - T -->
                    <div class="space-y-4">
                        <h4
                            class="font-black text-emerald-800 uppercase tracking-widest text-xs border-b border-emerald-100 pb-2">
                            P - T</h4>
                        <div class="space-y-3">
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Protein Nabati</p>
                                <p class="text-xs mt-1">Protein dari tumbuhan (kacang-kacangan, kelapa) yang penting
                                    untuk tubuh.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Sagu Lempeng</p>
                                <p class="text-xs mt-1">Roti tawar tradisional khas Papua/Maluku dari tepung sagu
                                    basah yang dibakar dalam cetakan tanah liat.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Serat Pangan</p>
                                <p class="text-xs mt-1">Bagian tumbuhan yang tidak dicerna tubuh, penting untuk
                                    pencernaan. Banyak pada ubi dan singkong.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Substitusi Bahan</p>
                                <p class="text-xs mt-1">Strategi mengganti bahan resep dengan yang lebih sehat
                                    (misal: santan diganti susu rendah lemak).</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Timphan</p>
                                <p class="text-xs mt-1">Kue tradisional Aceh berbahan tepung ketan dan pisang raja,
                                    diisi srikaya, dibungkus daun pisang.</p>
                            </div>
                        </div>
                    </div>

                    <!-- U - Z -->
                    <div class="space-y-4">
                        <h4
                            class="font-black text-emerald-800 uppercase tracking-widest text-xs border-b border-emerald-100 pb-2">
                            U - Z</h4>
                        <div class="space-y-3">
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Unique Selling Point (USP)</p>
                                <p class="text-xs mt-1">Keunikan atau nilai tambah utama yang membedakan produk dari
                                    pesaing (misal: "Tanpa Pengawet", "Resep Kuno").</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Visual Display</p>
                                <p class="text-xs mt-1">Tata letak dan presentasi produk di bazar untuk menarik
                                    perhatian pembeli.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="font-bold text-slate-800">Wedang Uwuh</p>
                                <p class="text-xs mt-1">Minuman rempah khas Yogyakarta ("sampah") berisi dedaunan
                                    dan rempah berkhasiat.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Feedback Section -->
                <div class="mt-8 border-t border-slate-100 pt-6">
                    <div class="bg-amber-50 p-4 rounded-2xl border border-amber-100 mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-amber-600">rate_review</span>
                            <p class="text-xs font-black text-amber-800 uppercase tracking-widest">Tugas Mandiri</p>
                        </div>
                        <p class="text-[11px] text-amber-700 leading-relaxed font-medium">Sebutkan 5 istilah dalam
                            Glosarium di atas yang baru kamu ketahui, beserta definisi aslinya menurut pemahamanmu!
                        </p>
                    </div>

                    <div id="glosariumStatusSection" class="hidden mb-4 rounded-2xl border p-4"></div>

                    <div id="glosariumInputArea">
                        <textarea id="glosariumInput" rows="5"
                            class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-800 focus:ring-2 focus:ring-emerald-500 outline-none transition-all placeholder:text-slate-400 font-medium"
                            placeholder="1. Istilah A: Definisi...&#10;2. Istilah B: Definisi..."></textarea>
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <div class="p-8 bg-white border-t">
                <button id="btnSubmitGlosarium" onclick="submitGlosarium()"
                    class="w-full py-4 bg-emerald-500 text-white rounded-2xl font-black shadow-lg shadow-emerald-200 active:scale-95 transition-all">
                    Kirim Jawaban
                </button>
            </div>
        </div>
    </div>
    </div>
    <!-- MODAL REFLEKSI (CHECK) -->
    <div id="modalRefleksi"
        class="fixed inset-0 z-[9999] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="p-8 border-b flex justify-between items-center bg-rose-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-rose-500 text-white flex items-center justify-center shadow-lg shadow-rose-200">
                        <span class="material-symbols-outlined !text-2xl">self_improvement</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">Refleksi Harian</h3>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Evaluasi Diri &
                            Saran</p>
                    </div>
                </div>
                <button onclick="closeRefleksiModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Content -->
            <div class="p-8 overflow-y-auto no-scrollbar flex-1 space-y-8">
                <form id="refleksiForm" class="space-y-8">
                    <!-- BAGIAN 1: PERASAAN & MOOD -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-rose-500 text-lg">sentiment_satisfied</span>
                            <h4 class="font-black text-slate-700 uppercase tracking-widest text-xs">Bagian 1: Perasaan &
                                Mood</h4>
                        </div>

                        <!-- Q1 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">1. Bagaimana perasaanmu setelah
                                mengikuti kegiatan hari ini? <span class="text-rose-500">*</span></label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="cursor-pointer">
                                    <input type="radio" name="refleksi_q1" value="Sangat Senang" class="peer hidden"
                                        required>
                                    <div
                                        class="p-3 rounded-xl border border-slate-200 bg-white hover:bg-rose-50 peer-checked:bg-rose-500 peer-checked:text-white peer-checked:border-rose-500 transition-all text-center text-xs font-bold">
                                        😄 Sangat Senang
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="refleksi_q1" value="Biasa Saja" class="peer hidden">
                                    <div
                                        class="p-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 peer-checked:bg-slate-700 peer-checked:text-white peer-checked:border-slate-700 transition-all text-center text-xs font-bold">
                                        😐 Biasa Saja
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="refleksi_q1" value="Bingung" class="peer hidden">
                                    <div
                                        class="p-3 rounded-xl border border-slate-200 bg-white hover:bg-amber-50 peer-checked:bg-amber-400 peer-checked:text-white peer-checked:border-amber-400 transition-all text-center text-xs font-bold">
                                        🤔 Bingung
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="refleksi_q1" value="Lelah/Bosan" class="peer hidden">
                                    <div
                                        class="p-3 rounded-xl border border-slate-200 bg-white hover:bg-red-50 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 transition-all text-center text-xs font-bold">
                                        😴 Lelah/Bosan
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- BAGIAN 2: EVALUASI BELAJAR -->
                    <div class="space-y-4 pt-4 border-t border-slate-100">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-indigo-500 text-lg">school</span>
                            <h4 class="font-black text-slate-700 uppercase tracking-widest text-xs">Bagian 2: Evaluasi
                                Belajar</h4>
                        </div>

                        <!-- Q2 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">2. Apa satu hal baru yang paling
                                menarik kamu pelajari hari ini?</label>
                            <textarea name="refleksi_q2" rows="3"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Ceritakan singkat..."></textarea>
                        </div>
                        <!-- Q3 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">3. Apa bagian yang paling sulit atau
                                menantang?</label>
                            <textarea name="refleksi_q3" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Tuliskan kesulitanmu..."></textarea>
                        </div>
                        <!-- Q4 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">4. Bagaimana caramu mengatasi
                                kesulitan tersebut?</label>
                            <textarea name="refleksi_q4" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Strategi belajarmu..."></textarea>
                        </div>
                        <!-- Q5 Range -->
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <label class="text-xs font-bold text-slate-600 block">5. Seberapa fokus kamu hari ini?
                                    (1-10)</label>
                                <span id="focusVal" class="text-xs font-black text-indigo-500">5</span>
                            </div>
                            <input type="range" name="refleksi_q5" min="1" max="10" value="5"
                                class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                                oninput="document.getElementById('focusVal').innerText = this.value">
                            <div class="flex justify-between text-[9px] text-slate-400 font-bold uppercase">
                                <span>Tidak Fokus</span>
                                <span>Sangat Fokus</span>
                            </div>
                        </div>

                        <!-- Q6 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">6. Apa kontrisibusimu dalam
                                diskusi/kelompok hari ini?</label>
                            <textarea name="refleksi_q6" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Kontribusimu..."></textarea>
                        </div>
                        <!-- Q7 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">7. Skill/sikap apa yang kamu rasa
                                berkembang hari ini?</label>
                            <textarea name="refleksi_q7" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Contoh: Kerjasama, komunikasi..."></textarea>
                        </div>
                        <!-- Q8 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">8. Apakah ada hambatan non-teknis
                                (misal: mood, ngantuk, gangguan lain)?</label>
                            <textarea name="refleksi_q8" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Ceritakan jika ada..."></textarea>
                        </div>
                        <!-- Q9 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">9. Apa targetmu untuk pembelajaran
                                besok?</label>
                            <textarea name="refleksi_q9" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Target besok..."></textarea>
                        </div>
                    </div>

                    <!-- BAGIAN 3: FEEDBACK & LAINNYA -->
                    <div class="space-y-4 pt-4 border-t border-slate-100">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-emerald-500 text-lg">thumbs_up_down</span>
                            <h4 class="font-black text-slate-700 uppercase tracking-widest text-xs">Bagian 3: Feedback &
                                Saran</h4>
                        </div>

                        <!-- Q10 Star Rating -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">10. Beri rating untuk keseruan
                                aktivitas hari ini!</label>
                            <div class="flex gap-2 rating justify-center py-2">
                                <input type="radio" name="refleksi_q10" value="1" id="star1" class="hidden peer"><label
                                    for="star1"
                                    class="material-symbols-outlined text-3xl text-slate-300 cursor-pointer peer-check:text-amber-400 hover:text-amber-300 transition-colors"
                                    onclick="setStars(1)">star</label>
                                <input type="radio" name="refleksi_q10" value="2" id="star2" class="hidden peer"><label
                                    for="star2"
                                    class="material-symbols-outlined text-3xl text-slate-300 cursor-pointer peer-check:text-amber-400 hover:text-amber-300 transition-colors"
                                    onclick="setStars(2)">star</label>
                                <input type="radio" name="refleksi_q10" value="3" id="star3" class="hidden peer"><label
                                    for="star3"
                                    class="material-symbols-outlined text-3xl text-slate-300 cursor-pointer peer-check:text-amber-400 hover:text-amber-300 transition-colors"
                                    onclick="setStars(3)">star</label>
                                <input type="radio" name="refleksi_q10" value="4" id="star4" class="hidden peer"><label
                                    for="star4"
                                    class="material-symbols-outlined text-3xl text-slate-300 cursor-pointer peer-check:text-amber-400 hover:text-amber-300 transition-colors"
                                    onclick="setStars(4)">star</label>
                                <input type="radio" name="refleksi_q10" value="5" id="star5" class="hidden peer"><label
                                    for="star5"
                                    class="material-symbols-outlined text-3xl text-slate-300 cursor-pointer peer-check:text-amber-400 hover:text-amber-300 transition-colors"
                                    onclick="setStars(5)">star</label>
                            </div>
                            <script>
                                function setStars(n) {
                                    for (let i = 1; i <= 5; i++) {
                                        const lbl = document.querySelector(`label[for="star${i}"]`);
                                        if (i <= n) lbl.classList.add('text-amber-400', 'fill-current');
                                        else lbl.classList.remove('text-amber-400', 'fill-current');
                                    }
                                    const radio = document.getElementById(`star${n}`);
                                    if (radio) radio.checked = true;
                                }
                            </script>
                        </div>

                        <!-- Q11 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">11. Siapa nama Fasilitator &
                                Koordinator di kelasmu hari ini?</label>
                            <input type="text" name="refleksi_q11"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Tulis nama mereka...">
                        </div>
                        <!-- Q12 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">12. Bagaimana gaya
                                mengajar/pendampingan mereka? (Jujur saja)</label>
                            <textarea name="refleksi_q12" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Sabar, seru, atau...?"></textarea>
                        </div>
                        <!-- Q13 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">13. Apa pendapatmu tentang aplikasi
                                web ini?</label>
                            <textarea name="refleksi_q13" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Keren, lemot, membantu...?"></textarea>
                        </div>
                        <!-- Q14 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">14. Apa saran untuk perbaikan kegiatan
                                besok?</label>
                            <textarea name="refleksi_q14" rows="2"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Sarannya..."></textarea>
                        </div>
                        <!-- Q15 -->
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-600 block">15. (Bonus) Tebak siapa yang membuat
                                aplikasi ini?</label>
                            <input type="text" name="refleksi_q15"
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Tebakanmu...">
                        </div>
                    </div>
                </form>
            </div>

            <!-- Footer -->
            <div class="p-8 bg-white border-t">
                <button onclick="submitRefleksi()"
                    class="w-full py-4 bg-rose-500 text-white rounded-2xl font-black shadow-lg shadow-rose-200 active:scale-95 transition-all">
                    Kirim Refleksi
                </button>
            </div>
        </div>
    </div>
    <script>
        // VIDEO MODAL LOGIC
        function openVideoModal() {
            const modal = document.getElementById('modalVideo');
            const dayKey = `day${currentDay}`;
            const videos = workshopContent[dayKey]?.video || [];
            const container = document.getElementById('videoDynamicItems');

            if (container) {
                container.innerHTML = videos.map((v, idx) => `
                    <div class="space-y-2">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">${v.title}</p>
                        <div class="aspect-video w-full rounded-2xl overflow-hidden shadow-sm bg-slate-100">
                            <iframe class="w-full h-full" src="${v.url}" title="${v.title}"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen></iframe>
                        </div>
                    </div>
                `).join('');
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Re-check existing summary
            checkExistingVideo();
        }

        function updateVideoWordCount() {
            const input = document.getElementById('videoSummaryInput');
            const counter = document.getElementById('videoWordCountDisplay');
            const btn = document.getElementById('btnSubmitVideo');

            if (!input || !counter || !btn) return;

            const text = input.value.trim();
            const wordCount = text ? text.split(/\s+/).length : 0;
            const limit = 100;

            counter.textContent = `${wordCount} / ${limit} kata`;

            if (wordCount >= limit) {
                // VALID STATE
                counter.className = "text-[10px] font-bold text-emerald-600 bg-white/50 px-2 py-1 rounded-lg border border-emerald-200 transition-all";
                // Enable Button
                btn.disabled = false;
                btn.className = "w-full py-4 bg-red-500 text-white rounded-2xl font-black shadow-lg shadow-red-200 active:scale-95 transition-all cursor-pointer";
            } else {
                // INVALID STATE
                counter.className = "text-[10px] font-bold text-red-500 bg-white/50 px-2 py-1 rounded-lg border border-red-100 transition-all";
                // Disable Button
                btn.disabled = true;
                btn.className = "w-full py-4 bg-slate-200 text-slate-400 rounded-2xl font-black shadow-none transition-all cursor-not-allowed";
            }
        }

        function closeVideoModal() {
            const modal = document.getElementById('modalVideo');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');

                // Stop videos by resetting src
                const iframes = modal.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    const src = iframe.src;
                    iframe.src = src;
                });
            }
        }

        // LKPD DIGITAL LOGIC
        let currentLKPDStep = 1;

        function openLKPDModal() {
            document.getElementById('modalLKPD').classList.remove('hidden');
            document.getElementById('modalLKPD').classList.add('flex');
            loadLKPDDraft();
            checkExistingLKPD();

            // Fokus otomatis ke step yang relevan sesuai hari
            let targetStep = 1;
            if (currentDay === 2) targetStep = 3;
            else if (currentDay === 3) targetStep = 5;

            switchLKPD(targetStep);
        }

        function closeLKPDModal() {
            document.getElementById('modalLKPD').classList.add('hidden');
            document.getElementById('modalLKPD').classList.remove('flex');
        }

        function switchLKPD(step) {
            currentLKPDStep = step;

            // Update UI Sections
            const sections = document.querySelectorAll('.lkpd-section');
            sections.forEach(s => s.classList.add('hidden'));
            document.getElementById(`lkpd-section-${step}`).classList.remove('hidden');

            // Update Stepper
            const buttons = document.querySelectorAll('[id^="step-"]');
            buttons.forEach((btn, idx) => {
                const sNum = idx + 1;
                if (sNum < step) {
                    btn.className = "size-8 rounded-full bg-emerald-500 text-white text-xs font-bold z-10 transition-all shadow-lg shadow-emerald-200 relative";
                    btn.innerHTML = '<span class="material-symbols-outlined !text-sm">check</span>';
                } else if (sNum === step) {
                    btn.className = "size-8 rounded-full bg-terracotta text-white text-xs font-bold z-10 transition-all shadow-lg shadow-terracotta/20 relative";
                    btn.innerHTML = sNum;
                } else {
                    btn.className = "size-8 rounded-full bg-white border-2 border-slate-200 text-slate-400 text-xs font-bold z-10 transition-all relative";
                    btn.innerHTML = sNum;
                }
            });

            // Progress Bar
            const progress = ((step - 1) / 4) * 100;
            document.getElementById('lkpd-stepper-progress').style.width = `${progress}%`;

            // Footer Buttons
            const btnPrev = document.getElementById('btnPrevLKPD');
            const btnNext = document.getElementById('btnNextLKPD');
            const btnSubmit = document.getElementById('btnSubmitLKPDAll');

            if (step === 1) {
                btnPrev.classList.add('opacity-0', 'pointer-events-none');
            } else {
                btnPrev.classList.remove('opacity-0', 'pointer-events-none');
            }

            if (step === 5) {
                btnNext.classList.add('hidden');
                btnSubmit.classList.remove('hidden');
            } else {
                btnNext.classList.remove('hidden');
                btnSubmit.classList.add('hidden');
                btnNext.innerText = `Lanjut ke LKPD ${step + 1}`;
            }
        }

        function nextLKPD() {
            if (currentLKPDStep < 5) switchLKPD(currentLKPDStep + 1);
        }

        function prevLKPD() {
            if (currentLKPDStep > 1) switchLKPD(currentLKPDStep - 1);
        }

        function saveLKPDDraft() {
            const lkpdData = {
                lkpd1: {
                    q1: document.getElementById('lkpd1_q1').value,
                    q2a: {
                        bentuk: document.getElementById('lkpd1_q2a_bentuk').value,
                        contoh: document.getElementById('lkpd1_q2a_contoh').value,
                        bahan: document.getElementById('lkpd1_q2a_bahan').value
                    },
                    q2b: {
                        bentuk: document.getElementById('lkpd1_q2b_bentuk').value,
                        contoh: document.getElementById('lkpd1_q2b_contoh').value,
                        bahan: document.getElementById('lkpd1_q2b_bahan').value
                    }
                },
                lkpd2: {
                    sumatra: {
                        contoh: document.getElementById('lkpd2_sumatra_contoh').value,
                        bahan: document.getElementById('lkpd2_sumatra_bahan').value,
                        rasa: document.getElementById('lkpd2_sumatra_rasa').value
                    },
                    jawa: {
                        contoh: document.getElementById('lkpd2_jawa_contoh').value,
                        bahan: document.getElementById('lkpd2_jawa_bahan').value,
                        rasa: document.getElementById('lkpd2_jawa_rasa').value
                    },
                    sulawesi: {
                        contoh: document.getElementById('lkpd2_sulawesi_contoh').value,
                        bahan: document.getElementById('lkpd2_sulawesi_bahan').value,
                        rasa: document.getElementById('lkpd2_sulawesi_rasa').value
                    },
                    bali: {
                        contoh: document.getElementById('lkpd2_bali_contoh').value,
                        bahan: document.getElementById('lkpd2_bali_bahan').value,
                        rasa: document.getElementById('lkpd2_bali_rasa').value
                    },
                    papua: {
                        contoh: document.getElementById('lkpd2_papua_contoh').value,
                        bahan: document.getElementById('lkpd2_papua_bahan').value,
                        rasa: document.getElementById('lkpd2_papua_rasa').value
                    }
                },
                lkpd3: {
                    q1: document.getElementById('lkpd3_q1')?.value || '',
                    q2: document.getElementById('lkpd3_q2')?.value || '',
                    q3: document.getElementById('lkpd3_q3')?.value || '',
                    q4: document.getElementById('lkpd3_q4')?.value || '',
                    q5: document.getElementById('lkpd3_q5')?.value || '',
                    q6: document.getElementById('lkpd3_q6')?.value || '',
                    q7: document.getElementById('lkpd3_q7')?.value || '',
                    q8: document.getElementById('lkpd3_q8')?.value || '',
                    q9: document.getElementById('lkpd3_q9')?.value || '',
                    q10: document.getElementById('lkpd3_q10')?.value || ''
                },
                lkpd4: {
                    makan: {
                        nama: document.getElementById('lkpd4_m_nama').value,
                        asal: document.getElementById('lkpd4_m_asal').value,
                        bahan: document.getElementById('lkpd4_m_bahan').value,
                        gizi: document.getElementById('lkpd4_m_gizi').value,
                        metode: document.getElementById('lkpd4_m_metode').value,
                        keunggulan: document.getElementById('lkpd4_m_keunggulan').value,
                        pemasaran: document.getElementById('lkpd4_m_pemasaran').value,
                        inovasi: document.getElementById('lkpd4_m_inovasi').value
                    },
                    minum: {
                        nama: document.getElementById('lkpd4_d_nama').value,
                        asal: document.getElementById('lkpd4_d_asal').value,
                        bahan: document.getElementById('lkpd4_d_bahan').value,
                        gizi: document.getElementById('lkpd4_d_gizi').value,
                        metode: document.getElementById('lkpd4_d_metode').value,
                        keunggulan: document.getElementById('lkpd4_d_keunggulan').value,
                        pemasaran: document.getElementById('lkpd4_d_pemasaran').value
                    },
                    bazar: {
                        alat: document.getElementById('lkpd4_b_alat').value,
                        bahan: document.getElementById('lkpd4_b_bahan').value
                    }
                },
                lkpd5: {
                    food: document.getElementById('preview-img-food')?.src || '',
                    drink: document.getElementById('preview-img-drink')?.src || '',
                    booth: document.getElementById('preview-img-booth')?.src || '',
                    marketing: document.getElementById('preview-img-marketing')?.src || ''
                }
            };
            localStorage.setItem(`lkpd_draft_day${currentDay}`, JSON.stringify(lkpdData));
        }

        function fillLKPDFields(data) {
            if (!data) return;

            // LKPD 1
            if (data.lkpd1) {
                if (document.getElementById('lkpd1_q1')) document.getElementById('lkpd1_q1').value = data.lkpd1.q1 || '';
                if (document.getElementById('lkpd1_q2a_bentuk')) document.getElementById('lkpd1_q2a_bentuk').value = data.lkpd1.q2a?.bentuk || '';
                if (document.getElementById('lkpd1_q2a_contoh')) document.getElementById('lkpd1_q2a_contoh').value = data.lkpd1.q2a?.contoh || '';
                if (document.getElementById('lkpd1_q2a_bahan')) document.getElementById('lkpd1_q2a_bahan').value = data.lkpd1.q2a?.bahan || '';

                if (document.getElementById('lkpd1_q2b_bentuk')) document.getElementById('lkpd1_q2b_bentuk').value = data.lkpd1.q2b?.bentuk || '';
                if (document.getElementById('lkpd1_q2b_contoh')) document.getElementById('lkpd1_q2b_contoh').value = data.lkpd1.q2b?.contoh || '';
                if (document.getElementById('lkpd1_q2b_bahan')) document.getElementById('lkpd1_q2b_bahan').value = data.lkpd1.q2b?.bahan || '';
            }

            // LKPD 2
            if (data.lkpd2) {
                const regions = ['sumatra', 'jawa', 'sulawesi', 'bali', 'papua'];
                regions.forEach(reg => {
                    const r = data.lkpd2[reg];
                    if (!r) return;
                    if (document.getElementById(`lkpd2_${reg}_contoh`)) document.getElementById(`lkpd2_${reg}_contoh`).value = r.contoh || '';
                    if (document.getElementById(`lkpd2_${reg}_bahan`)) document.getElementById(`lkpd2_${reg}_bahan`).value = r.bahan || '';
                    if (document.getElementById(`lkpd2_${reg}_rasa`)) document.getElementById(`lkpd2_${reg}_rasa`).value = r.rasa || '';
                });
            }

            // LKPD 3
            if (data.lkpd3) {
                for (let i = 1; i <= 10; i++) {
                    const el = document.getElementById(`lkpd3_q${i}`);
                    if (el) el.value = data.lkpd3[`q${i}`] || '';
                }
            }

            // LKPD 4
            if (data.lkpd4) {
                // Makanan
                const m = data.lkpd4.makan || {};
                if (document.getElementById('lkpd4_m_nama')) document.getElementById('lkpd4_m_nama').value = m.nama || '';
                if (document.getElementById('lkpd4_m_asal')) document.getElementById('lkpd4_m_asal').value = m.asal || '';
                if (document.getElementById('lkpd4_m_bahan')) document.getElementById('lkpd4_m_bahan').value = m.bahan || '';
                if (document.getElementById('lkpd4_m_gizi')) document.getElementById('lkpd4_m_gizi').value = m.gizi || '';
                if (document.getElementById('lkpd4_m_metode')) document.getElementById('lkpd4_m_metode').value = m.metode || '';
                if (document.getElementById('lkpd4_m_keunggulan')) document.getElementById('lkpd4_m_keunggulan').value = m.keunggulan || '';
                if (document.getElementById('lkpd4_m_pemasaran')) document.getElementById('lkpd4_m_pemasaran').value = m.pemasaran || '';
                if (document.getElementById('lkpd4_m_inovasi')) document.getElementById('lkpd4_m_inovasi').value = m.inovasi || '';

                // Minuman
                const d = data.lkpd4.minum || {};
                if (document.getElementById('lkpd4_d_nama')) document.getElementById('lkpd4_d_nama').value = d.nama || '';
                if (document.getElementById('lkpd4_d_asal')) document.getElementById('lkpd4_d_asal').value = d.asal || '';
                if (document.getElementById('lkpd4_d_bahan')) document.getElementById('lkpd4_d_bahan').value = d.bahan || '';
                if (document.getElementById('lkpd4_d_gizi')) document.getElementById('lkpd4_d_gizi').value = d.gizi || '';
                if (document.getElementById('lkpd4_d_metode')) document.getElementById('lkpd4_d_metode').value = d.metode || '';
                if (document.getElementById('lkpd4_d_keunggulan')) document.getElementById('lkpd4_d_keunggulan').value = d.keunggulan || '';
                if (document.getElementById('lkpd4_d_pemasaran')) document.getElementById('lkpd4_d_pemasaran').value = d.pemasaran || '';

                // Bazar
                const b = data.lkpd4.bazar || {};
                if (document.getElementById('lkpd4_b_alat')) document.getElementById('lkpd4_b_alat').value = b.alat || '';
                if (document.getElementById('lkpd4_b_bahan')) document.getElementById('lkpd4_b_bahan').value = b.bahan || '';
            }

            // LKPD 5
            if (data.lkpd5) {
                // Helper to set preview
                const setPreview = (type, url) => {
                    if (url && url.startsWith('http')) {
                        const img = document.getElementById(`preview-img-${type}`);
                        const container = document.getElementById(`preview-container-${type}`);
                        const ui = document.getElementById(`upload-ui-${type}`);
                        if (img && container && ui) {
                            img.src = url;
                            container.classList.remove('hidden');
                            ui.classList.add('hidden');
                        }
                    }
                };
                setPreview('food', data.lkpd5.food);
                setPreview('drink', data.lkpd5.drink);
                setPreview('booth', data.lkpd5.booth);
                setPreview('marketing', data.lkpd5.marketing);
            }
        }

        function loadLKPDDraft() {
            const dataStr = localStorage.getItem(`lkpd_draft_day${currentDay}`);
            if (!dataStr) return;
            fillLKPDFields(JSON.parse(dataStr));
        }

        async function submitLKPDTotal() {
            const btn = document.getElementById('btnSubmitLKPDAll');
            btn.disabled = true;
            btn.innerHTML = 'Mengirim Semua...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error("Silakan login ulang.");

                const lkpdData = JSON.parse(localStorage.getItem(`lkpd_draft_day${currentDay}`));

                // VALIDASI: Minimal LKPD 1 terisi (karena baru LKPD 1 yang diimplementasikan detailnya)
                if (!lkpdData || !lkpdData.lkpd1 || !lkpdData.lkpd1.q1) {
                    alert('Mohon lengkapi jawaban LKPD minimal pada bagian pertama.');
                    btn.disabled = false;
                    btn.innerHTML = 'Kirim Semua LKPD';
                    return;
                }

                const { error } = await supabaseClient
                    .from('module_responses')
                    .insert({
                        student_id: user.id,
                        day_id: currentDay,
                        module_type: 'lkpd',
                        answers: [JSON.stringify(lkpdData)],
                        status: 'submitted'
                    });

                if (error) throw error;

                alert('Hebat! Seluruh LKPD berhasil dikirim. Menunggu feedback dari fasilitator.');

                // Sync progress lokal
                studentProgress[`day${currentDay}`]['lkpd'] = false; // Tetap false agar muncul jam pasir
                saveProgress();

                checkAllModulesStatus();
                closeLKPDModal();
                checkExistingLKPD();

            } catch (err) {
                console.error('Gagal kirim LKPD:', err);
                alert('Terjadi kesalahan saat mengirim LKPD.');
                btn.disabled = false;
                btn.innerHTML = 'Kirim Semua LKPD';
            }
        }

        // FUNGSI UPLOAD LKPD 5
        async function handleLKPDUpload(type, event) {
            const file = event.target.files[0];
            if (!file) return;

            // UI Elements
            const statusEl = document.getElementById(`status-${type}`);
            const inputLabel = document.querySelector(`label[for="file-${type}"]`);

            // Validasi Size
            if (file.size > 5 * 1024 * 1024) {
                alert('Ukuran file terlalu besar. Maksimal 5MB.');
                return;
            }

            try {
                // Update UI: Loading
                if (statusEl) {
                    statusEl.textContent = 'Mengompresi & Mengunggah...';
                    statusEl.classList.remove('hidden');
                }
                if (inputLabel) inputLabel.classList.add('opacity-50', 'pointer-events-none');

                // 1. Kompresi
                const compressedBlob = await compressImage(file, 1000, 0.6);
                const compressedFile = new File([compressedBlob], `lkpd5_${type}_${Date.now()}.jpg`, { type: 'image/jpeg' });

                // 2. Auth Check
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error('Sesi habis, silakan login ulang.');

                // 3. Upload ke Storage
                const fileName = `${user.id}/lkpd5_${type}_${Date.now()}.jpg`;
                const { error: uploadError } = await supabaseClient.storage
                    .from('documentation')
                    .upload(fileName, compressedFile);

                if (uploadError) throw uploadError;

                // 4. Get Public URL
                const { data: { publicUrl } } = supabaseClient.storage
                    .from('documentation')
                    .getPublicUrl(fileName);

                // 5. Update Preview UI
                const img = document.getElementById(`preview-img-${type}`);
                const container = document.getElementById(`preview-container-${type}`);
                const ui = document.getElementById(`upload-ui-${type}`);

                if (img) img.src = publicUrl;
                if (container) container.classList.remove('hidden');
                if (ui) ui.classList.add('hidden');
                if (statusEl) statusEl.classList.add('hidden');

                // 6. trigger Auto Save Draft
                saveLKPDDraft();

            } catch (error) {
                console.error('Upload failed:', error);
                alert('Gagal mengunggah gambar: ' + error.message);
                if (statusEl) statusEl.classList.add('hidden');
                if (inputLabel) inputLabel.classList.remove('opacity-50', 'pointer-events-none');
            }
        }

        async function checkExistingLKPD() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data, error } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'lkpd')
                    .maybeSingle();

                if (data) {
                    const statusSection = document.getElementById('lkpdStatusSection');
                    const btnSubmit = document.getElementById('btnSubmitLKPDAll');

                    // Populate fields from server data
                    try {
                        const lkpdData = JSON.parse(data.answers[0]);
                        fillLKPDFields(lkpdData);
                    } catch (e) {
                        console.error('Error parsing server LKPD data', e);
                    }

                    // Lock all inputs
                    const inputs = document.querySelectorAll('#modalLKPD input, #modalLKPD textarea');
                    inputs.forEach(i => i.disabled = true);
                    if (btnSubmit) btnSubmit.classList.add('hidden');

                    if (statusSection) {
                        statusSection.classList.remove('hidden');
                        if (data.status === 'submitted') {
                            statusSection.innerHTML = `
                                <div class="bg-yellow-50 p-4 rounded-2xl border border-yellow-100 flex items-center gap-3">
                                    <div class="size-8 rounded-full bg-yellow-400 flex items-center justify-center text-white shrink-0 animate-pulse">
                                        <span class="material-symbols-outlined text-sm">hourglass_top</span>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-[10px] font-black text-yellow-700 uppercase tracking-widest">Menunggu Feedback</p>
                                        <p class="text-[10px] text-yellow-600 mt-0.5 font-medium">Fasilitator sedang membaca jawaban LKPD kelompokmu.</p>
                                    </div>
                                </div>
                            `;
                            updateModuleUI('lkpd', 'submitted');
                        } else if (data.status === 'reviewed') {
                            let starsHtml = '';
                            const score = data.score || 0;
                            const starCount = Math.round(score / 20);
                            for (let i = 1; i <= 5; i++) {
                                starsHtml += `<span class="material-symbols-outlined text-2xl ${i <= starCount ? 'text-amber-400 fill-current' : 'text-slate-200'}">star</span>`;
                            }

                            statusSection.innerHTML = `
                                <div class="bg-emerald-50 p-5 rounded-2xl border border-emerald-100 space-y-3">
                                    <div class="flex items-center justify-between">
                                        <p class="text-[10px] font-black text-emerald-700 uppercase tracking-widest">Dinilai Fasilitator</p>
                                        <div class="flex">${starsHtml}</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-xl border border-emerald-100">
                                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Feedback:</p>
                                        <p class="text-xs text-slate-700 font-medium italic">"${data.feedback || 'Bagus sekali!'}"</p>
                                    </div>
                                </div>
                            `;
                            updateModuleUI('lkpd', true, data.score || 0);
                        }
                    }
                }
            } catch (err) { console.error('Error checkExistingLKPD:', err); }
        }

        async function submitVideoLog() {
            const btn = document.getElementById('btnSubmitVideo');
            const summary = document.getElementById('videoSummaryInput').value;
            const wordCount = summary.trim().split(/\s+/).length;

            if (wordCount < 50) {
                alert('Ringkasan belum mencapai 50 kata. Silakan lengkapi lagi.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'Mengirim...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error("User tidak ditemukan");

                // Save to local storage (backup)
                localStorage.setItem(`video_summary_day${currentDay}`, summary);

                // 1. Simpan ke Supabase
                const { error } = await supabaseClient
                    .from('module_responses')
                    .insert({
                        student_id: user.id,
                        day_id: currentDay,
                        module_type: 'video',
                        answers: [summary],
                        status: 'submitted'
                    });

                if (error) throw error;

                alert('Hebat! Ringkasan berhasil dikirim. Menunggu feedback dari fasilitator.');

                // Update progress lokal agar sinkron
                const dayKey = `day${currentDay}`;
                studentProgress[dayKey]['video'] = false; // Tetap false agar show "Menunggu Feedback"
                saveProgress();

                checkAllModulesStatus(); // Refresh dashboard UI
                closeVideoModal();
                checkExistingVideo(); // Refresh modal content

            } catch (err) {
                console.error('Gagal kirim video summary:', err);
                alert('Terjadi kesalahan saat mengirim ringkasan.');
                btn.disabled = false;
                btn.innerHTML = 'Simpan Ringkasan & Selesai';
            }
        }

        async function checkExistingVideo() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data, error } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'video')
                    .maybeSingle();

                if (data) {
                    const input = document.getElementById('videoSummaryInput');
                    const btn = document.getElementById('btnSubmitVideo');
                    const statusSection = document.getElementById('videoStatusSection');
                    const placeholder = document.getElementById('videoFeedbackPlaceholder');

                    if (input) {
                        input.value = data.answers[0] || '';
                        input.disabled = true;
                    }
                    if (btn) btn.classList.add('hidden');
                    if (placeholder) placeholder.classList.add('hidden');

                    if (statusSection) {
                        statusSection.classList.remove('hidden');
                        if (data.status === 'submitted') {
                            statusSection.innerHTML = `
                                <div class="bg-yellow-50 p-4 rounded-2xl border border-yellow-100 flex items-center gap-3">
                                    <div class="size-8 rounded-full bg-yellow-400 flex items-center justify-center text-white shrink-0 animate-pulse">
                                        <span class="material-symbols-outlined text-sm">hourglass_top</span>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-[10px] font-black text-yellow-700 uppercase tracking-widest">Menunggu Feedback</p>
                                        <p class="text-[10px] text-yellow-600 mt-0.5 font-medium">Fasilitator sedang membaca ringkasanmu.</p>
                                    </div>
                                </div>
                            `;
                            updateModuleUI('video', 'submitted');
                        } else if (data.status === 'reviewed') {
                            // Render Stars
                            let starsHtml = '';
                            const score = data.score || 0;
                            const starCount = Math.round(score / 20);
                            for (let i = 1; i <= 5; i++) {
                                starsHtml += `<span class="material-symbols-outlined text-2xl ${i <= starCount ? 'text-amber-400 fill-current' : 'text-slate-200'}">star</span>`;
                            }

                            statusSection.innerHTML = `
                                <div class="bg-emerald-50 p-5 rounded-2xl border border-emerald-100 space-y-3">
                                    <div class="flex items-center justify-between">
                                        <p class="text-[10px] font-black text-emerald-700 uppercase tracking-widest">Dinilai Fasilitator</p>
                                        <div class="flex">${starsHtml}</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-xl border border-emerald-100">
                                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Feedback:</p>
                                        <p class="text-xs text-slate-700 font-medium italic">"${data.feedback || 'Bagus sekali!'}"</p>
                                    </div>
                                </div>
                            `;
                            updateModuleUI('video', true, data.score || 0);
                        }
                    }
                }
            } catch (e) {
                console.error('Error checkExistingVideo:', e);
            }
        }

        // ASSESSMENT LOGIC
        let currentQuestionIndex = 0;
        let userAnswers = {}; // { quesID: correctIndex }
        let assessmentScore = 0;
        let shuffledIndices = []; // Stores the randomized order of indices

        function openAssessmentModal() {
            const modal = document.getElementById('modalAssessment');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                checkExistingAssessment(); // Check status on open
            }

            // Load script dynamically if not present
            if (typeof assessmentQuestions === 'undefined') {
                const script = document.createElement('script');
                script.src = 'data/assessment_data.js';
                script.onload = () => {
                    if (!document.getElementById('assessmentResultContainer').classList.contains('flex')) {
                        setupAssessment();
                    }
                };
                document.body.appendChild(script);
            } else {
                if (!document.getElementById('assessmentResultContainer').classList.contains('flex')) {
                    setupAssessment();
                }
            }
        }

        function setupAssessment() {
            currentQuestionIndex = 0;
            userAnswers = {};

            // Reset containers
            document.getElementById('assessmentQuestionContainer').classList.remove('hidden');
            document.getElementById('assessmentResultContainer').classList.add('hidden');
            document.getElementById('assessmentResultContainer').classList.remove('flex');
            document.getElementById('btnNextAssessment').classList.remove('hidden');

            // Initialize Shuffle
            initShuffle();

            renderQuestion(0);
        }

        async function checkExistingAssessment() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data, error } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'kuis')
                    .maybeSingle();

                if (data) {
                    const score = data.score || 0;
                    const stars = Math.ceil(score / 20);

                    document.getElementById('assessmentQuestionContainer').classList.add('hidden');
                    document.getElementById('assessmentResultContainer').classList.remove('hidden');
                    document.getElementById('assessmentResultContainer').classList.add('flex');
                    document.getElementById('btnNextAssessment').classList.add('hidden');

                    let starsHtml = '';
                    for (let i = 0; i < 5; i++) {
                        starsHtml += `<span class="material-symbols-outlined text-4xl ${i < stars ? 'text-amber-400 fill-current' : 'text-slate-200'}">star</span>`;
                    }
                    document.getElementById('resultStars').innerHTML = starsHtml;
                    document.getElementById('resultScoreText').innerText = `Skor Kamu: ${score} / 100`;

                    updateModuleUI('asesmen', true, score);
                } else {
                    // Reset to question view if no data
                    document.getElementById('assessmentQuestionContainer').classList.remove('hidden');
                    document.getElementById('assessmentResultContainer').classList.add('hidden');
                    document.getElementById('assessmentResultContainer').classList.remove('flex');
                    document.getElementById('btnNextAssessment').classList.remove('hidden');
                }
            } catch (err) { console.error('Error checkExistingAssessment:', err); }
        }

        // Initialize or Load Shuffled Order
        function initShuffle() {
            const savedOrder = localStorage.getItem(`assessment_shuffle_order_day${currentDay}`);
            if (savedOrder) {
                shuffledIndices = JSON.parse(savedOrder);
                // Validation: ensure length matches current questions (in case questions updated)
                if (shuffledIndices.length !== assessmentQuestions.length) {
                    generateNewShuffle();
                }
            } else {
                generateNewShuffle();
            }
        }

        function generateNewShuffle() {
            // Create array of indices [0, 1, ... N]
            shuffledIndices = Array.from({ length: assessmentQuestions.length }, (_, i) => i);

            // Fisher-Yates Shuffle
            for (let i = shuffledIndices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledIndices[i], shuffledIndices[j]] = [shuffledIndices[j], shuffledIndices[i]];
            }

            // Save to preserve order for this user/device
            localStorage.setItem(`assessment_shuffle_order_day${currentDay}`, JSON.stringify(shuffledIndices));
        }

        function closeAssessmentModal() {
            const modal = document.getElementById('modalAssessment');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        function renderQuestion(index) {
            if (!assessmentQuestions || !assessmentQuestions[index]) return;

            // Get the Question Object based on SHUFFLED index
            // If shuffledIndices is empty (fail-safe), use index directly
            const realIndex = (shuffledIndices.length > 0) ? shuffledIndices[index] : index;
            const q = assessmentQuestions[realIndex];

            const container = document.getElementById('assessmentQuestionContainer');

            // Progress Bar
            const progressPercent = ((index + 1) / assessmentQuestions.length) * 100;
            document.getElementById('assessmentProgressBar').style.width = `${progressPercent}%`;
            document.getElementById('assessmentProgressText').innerText = `Soal ${index + 1} dari ${assessmentQuestions.length}`;

            // Render
            // Display numbering as 1, 2, 3... even though content is random
            let html = `
                <h4 class="text-sm font-bold text-slate-800 mb-4">${index + 1}. ${q.question}</h4>
                <div class="space-y-3">
            `;

            q.options.forEach((opt, idx) => {
                const isSelected = userAnswers[q.id] === idx;
                const activeClass = isSelected ? 'border-emerald-500 bg-emerald-50 ring-2 ring-emerald-200' : 'border-slate-200 hover:border-indigo-300 hover:bg-slate-50';

                html += `
                    <div onclick="selectOption(${q.id}, ${idx})" 
                        class="p-4 rounded-xl border-2 ${activeClass} cursor-pointer transition-all flex items-center gap-3 group">
                        <div class="size-6 rounded-full border-2 ${isSelected ? 'border-emerald-500 bg-emerald-500' : 'border-slate-300 group-hover:border-indigo-400'} flex items-center justify-center shrink-0">
                            ${isSelected ? '<span class="material-symbols-outlined text-white text-xs">check</span>' : ''}
                        </div>
                        <p class="text-xs font-medium text-slate-700">${opt}</p>
                    </div>
                `;
            });

            html += `</div>`;
            container.innerHTML = html;

            // Button Control
            const btnNext = document.getElementById('btnNextAssessment');
            if (index === assessmentQuestions.length - 1) {
                btnNext.innerText = 'Bintang Saya ?';
                btnNext.onclick = finishAssessment;
                btnNext.className = "px-6 py-3 bg-emerald-500 text-white rounded-xl font-bold text-xs shadow-lg shadow-emerald-200 active:scale-95 transition-all w-full mt-6";
            } else {
                btnNext.innerText = 'Selanjutnya';
                btnNext.className = "px-6 py-3 bg-indigo-500 text-white rounded-xl font-bold text-xs shadow-lg shadow-indigo-200 active:scale-95 transition-all w-full mt-6";
                btnNext.onclick = () => {
                    if (userAnswers[q.id] === undefined) {
                        alert('Pilih jawaban dulu ya!');
                        return;
                    }
                    currentQuestionIndex++;
                    renderQuestion(currentQuestionIndex);
                };
            }
        }

        function selectOption(qId, optIdx) {
            userAnswers[qId] = optIdx;
            // Rerender current to show selection
            renderQuestion(currentQuestionIndex);
        }

        async function finishAssessment() {
            // Get current question using shuffled index mapping to validate answer
            const realIndex = (shuffledIndices.length > 0) ? shuffledIndices[currentQuestionIndex] : currentQuestionIndex;
            const q = assessmentQuestions[realIndex];

            if (userAnswers[q.id] === undefined) {
                alert('Pilih jawaban dulu ya!');
                return;
            }

            // Calculate Score
            let correctCount = 0;
            assessmentQuestions.forEach(ques => {
                if (userAnswers[ques.id] === ques.correctIndex) {
                    correctCount++;
                }
            });

            const score = correctCount * 2; // 50 soal x 2 = 100
            const stars = Math.ceil(score / 20); // 0-100 -> 0-5 stars

            // Show Result
            document.getElementById('assessmentQuestionContainer').classList.add('hidden');
            document.getElementById('assessmentResultContainer').classList.remove('hidden');
            document.getElementById('assessmentResultContainer').classList.add('flex');
            document.getElementById('btnNextAssessment').classList.add('hidden');

            // Render Stars
            let starsHtml = '';
            for (let i = 0; i < 5; i++) {
                if (i < stars) {
                    starsHtml += '<span class="material-symbols-outlined text-4xl text-amber-400 fill-current animate-bounce" style="animation-delay: ' + (i * 100) + 'ms">star</span>';
                } else {
                    starsHtml += '<span class="material-symbols-outlined text-4xl text-slate-200">star</span>';
                }
            }
            document.getElementById('resultStars').innerHTML = starsHtml;
            document.getElementById('resultScoreText').innerText = `Skor Kamu: ${score} / 100`;

            // Save Status Local
            localStorage.setItem(`asesmen_day${currentDay}_stars`, stars);
            localStorage.setItem(`asesmen_day${currentDay}_score`, score);
            forceCompleteModule('asesmen', score);

            // SAVE TO SUPABASE
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    // Storing plain JSON of user answers
                    const answerData = JSON.stringify(userAnswers);

                    await supabaseClient
                        .from('module_responses')
                        .insert({
                            student_id: user.id,
                            day_id: currentDay,
                            module_type: 'kuis', // 'kuis' maps to 'Asesmen' in facilitator view
                            answers: [answerData],
                            status: 'reviewed',
                            score: score
                        });
                }
            } catch (err) {
                console.error('Failed to save assessment to cloud:', err);
            }

        }

        // ==========================================
        // FITUR GLOSARIUM & FEEDBACK
        // ==========================================

        function openGlosariumModal() {
            const modal = document.getElementById('modalGlosarium');
            if (!modal) {
                alert('Error: Modal Glosarium tidak ditemukan. Hubungi pengembang.');
                return;
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // Ensure z-index is top
            modal.style.zIndex = '9999';
            try {
                checkExistingGlosarium();
            } catch (e) {
                console.error('Error fetching glosarium data:', e);
            }
        }

        function closeGlosariumModal() {
            document.getElementById('modalGlosarium').classList.add('hidden');
            document.getElementById('modalGlosarium').classList.remove('flex');
        }

        async function submitGlosarium() {
            const btn = document.getElementById('btnSubmitGlosarium');
            const input = document.getElementById('glosariumInput').value;

            if (input.trim().length < 20) {
                alert('Mohon isi jawaban dengan lengkap minimal 5 poin/istilah.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'Mengirim...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error("User tidak ditemukan");

                const { error } = await supabaseClient
                    .from('module_responses')
                    .insert({
                        student_id: user.id,
                        day_id: currentDay,
                        module_type: 'glosarium',
                        answers: [input],
                        status: 'submitted'
                    });

                if (error) throw error;

                alert('Berhasil dikirim! Menunggu penilaian fasilitator.');

                // Update progress lokal agar sinkron
                const dayKey = `day${currentDay}`;
                studentProgress[dayKey]['glosarium'] = false; // Tetap false agar show "Menunggu Feedback"
                saveProgress();

                checkAllModulesStatus();
                closeGlosariumModal();
                checkExistingGlosarium();

            } catch (e) {
                console.error(e);
                alert('Gagal mengirim: ' + e.message);
                btn.disabled = false;
                btn.innerHTML = 'Kirim Jawaban';
            }
        }

        async function checkExistingGlosarium() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'glosarium')
                    .maybeSingle();

                if (data) {
                    const input = document.getElementById('glosariumInput');
                    const btn = document.getElementById('btnSubmitGlosarium');
                    const statusSection = document.getElementById('glosariumStatusSection');

                    if (input) {
                        input.value = data.answers[0];
                        input.disabled = true;
                        input.classList.add('bg-slate-50', 'text-slate-500');
                    }
                    if (btn) btn.classList.add('hidden');

                    if (statusSection) {
                        statusSection.classList.remove('hidden');
                        if (data.status === 'submitted') {
                            statusSection.className = "mb-4 rounded-2xl border border-yellow-100 bg-yellow-50 p-4";
                            statusSection.innerHTML = `
                                <div class="flex items-center gap-3">
                                    <div class="size-8 rounded-full bg-yellow-400 flex items-center justify-center text-white shrink-0 animate-pulse">
                                        <span class="material-symbols-outlined text-sm">hourglass_top</span>
                                    </div>
                                    <div>
                                        <p class="text-[10px] font-black text-yellow-700 uppercase tracking-widest">Menunggu Penilaian</p>
                                        <p class="text-[10px] text-yellow-600">Fasilitator akan memberikan bintang.</p>
                                    </div>
                                </div>
                            `;
                            updateModuleUI('glosarium', 'submitted');
                        } else if (data.status === 'reviewed') {
                            statusSection.className = "mb-4 rounded-2xl border border-emerald-100 bg-emerald-50 p-4";
                            let starsHtml = '';
                            const score = data.score || 0;
                            const starCount = Math.round(score / 20);
                            for (let i = 1; i <= 5; i++) {
                                starsHtml += `<span class="material-symbols-outlined text-xl ${i <= starCount ? 'text-amber-400 fill-current' : 'text-slate-200'}">star</span>`;
                            }

                            statusSection.innerHTML = `
                                <div class="flex items-center justify-between mb-2">
                                    <p class="text-[10px] font-black text-emerald-700 uppercase tracking-widest">Hasil Penilaian</p>
                                    <div class="flex">${starsHtml}</div>
                                </div>
                                <div class="bg-white p-3 rounded-xl border border-emerald-100">
                                    <p class="text-[10px] text-slate-500 italic">"${data.feedback || 'Terima kasih!'}"</p>
                                </div>
                            `;
                            forceCompleteModule('glosarium', data.score);
                        }
                    }
                }
            } catch (e) { console.error(e); }
        }
        async function checkExistingRefleksi() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data: responses } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'refleksi')
                    .order('created_at', { ascending: false })
                    .limit(1);

                const form = document.getElementById('refleksiForm');
                const btn = document.querySelector('#modalRefleksi button[onclick="submitRefleksi()"]');

                // Remove existing status message if any
                const existingMsg = document.getElementById('refleksiStatusMessage');
                if (existingMsg) existingMsg.remove();

                const statusMsgContainer = document.createElement('div');
                statusMsgContainer.id = 'refleksiStatusMessage';
                statusMsgContainer.className = 'mb-4 p-4 rounded-xl text-xs font-medium';
                statusMsgContainer.style.display = 'none';
                form.prepend(statusMsgContainer);

                if (responses && responses.length > 0) {
                    const r = responses[0];
                    // Handle array format properly
                    let answers = r.answers;
                    // If stored as JSON string inside array [ "JSON" ]
                    if (answers.length === 1 && typeof answers[0] === 'string' && answers[0].startsWith('{')) {
                        // But wait, submitRefleksi below sends an ARRAY of strings.
                        // Let's assume the new format is ARRAY of values.
                        // If it's the OLD format (JSON string in array), handle it.
                        try {
                            answers = JSON.parse(answers[0]);
                        } catch (e) {
                            // It's likely the new array format, so use r.answers directly
                            answers = r.answers;
                        }
                    }

                    // If answers is Array (New Format)
                    if (Array.isArray(answers) && answers.length > 1) {
                        // Map Array Index to Form Fields
                        // Q1: answers[0], Q2: answers[1], ...
                        const fieldNames = [
                            'refleksi_q1', 'refleksi_q2', 'refleksi_q3', 'refleksi_q4', 'refleksi_q5',
                            'refleksi_q6', 'refleksi_q7', 'refleksi_q8', 'refleksi_q9', 'refleksi_q10',
                            'refleksi_q11', 'refleksi_q12', 'refleksi_q13', 'refleksi_q14', 'refleksi_q15'
                        ];

                        fieldNames.forEach((name, idx) => {
                            const val = answers[idx];
                            const input = form.querySelector(`[name="${name}"]`);
                            if (input) {
                                if (input.type === 'radio') {
                                    const radio = form.querySelector(`input[name="${name}"][value="${val}"]`);
                                    if (radio) radio.checked = true;
                                } else if (input.type === 'range') {
                                    input.value = val;
                                    const fv = document.getElementById('focusVal');
                                    if (fv) fv.innerText = val;
                                } else {
                                    input.value = val;
                                }
                            }
                        });

                        // Special handling for Star Rating (Q10) which is Radio but custom UI
                        if (answers[9]) {
                            const starVal = answers[9];
                            // Update UI
                            for (let i = 1; i <= 5; i++) {
                                const lbl = document.querySelector(`label[for="star${i}"]`);
                                if (lbl) {
                                    if (i <= starVal) lbl.classList.add('text-amber-400', 'fill-current');
                                    else lbl.classList.remove('text-amber-400', 'fill-current');
                                }
                            }
                        }

                    } else if (!Array.isArray(answers) && typeof answers === 'object') {
                        // OLD object format
                        for (let i = 1; i <= 15; i++) {
                            const name = `refleksi_q${i}`;
                            const value = answers[name];
                            const input = form.querySelector(`[name="${name}"]`);
                            if (input) {
                                if (input.type === 'radio') {
                                    const radio = form.querySelector(`input[name="${name}"][value="${value}"]`);
                                    if (radio) radio.checked = true;
                                } else if (input.type === 'range') {
                                    input.value = value;
                                } else {
                                    input.value = value;
                                }
                            }
                        }
                    }

                    // Disable inputs
                    form.querySelectorAll('input, textarea').forEach(el => {
                        el.disabled = true;
                        el.classList.add('bg-slate-100', 'text-slate-500');
                    });

                    // Hide submit button
                    if (btn) btn.classList.add('hidden');

                    // Update Status UI
                    statusMsgContainer.style.display = 'block';
                    if (r.status === 'submitted') {
                        statusMsgContainer.className = "mb-4 p-4 rounded-xl text-xs font-medium bg-yellow-50 text-yellow-700 border border-yellow-200";
                        statusMsgContainer.innerHTML = "⏳ <b>Refleksi Terkirim</b><br>Menunggu feedback dari fasilitator.";
                        updateModuleUI('refleksi', 'submitted');
                    } else if (r.status === 'reviewed') {
                        statusMsgContainer.className = "mb-4 p-4 rounded-xl text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200";
                        statusMsgContainer.innerHTML = `✅ <b>Sudah Direview (Skor: ${r.score || 0})</b><br>Feedback: "${r.feedback || '-'}"`;
                        updateModuleUI('refleksi', true, r.score || 0);
                    }

                    // Update Dashboard Button
                    const dashBtn = document.querySelector('div[onclick="toggleModule(\'refleksi\')"]');
                    if (dashBtn) {
                        const icon = dashBtn.querySelector('.material-symbols-outlined');
                        if (icon) icon.innerText = 'check_circle';
                    }


                } else {
                    // No data - Reset form
                    form.querySelectorAll('input, textarea').forEach(el => {
                        el.disabled = false;
                        el.classList.remove('bg-slate-100', 'text-slate-500');
                        if (el.type === 'radio') el.checked = false;
                        if (el.type === 'text' || el.tagName === 'TEXTAREA') el.value = '';
                        if (el.type === 'range') { el.value = 5; document.getElementById('focusVal').innerText = '5'; }
                    });
                    // Reset stars
                    for (let i = 1; i <= 5; i++) {
                        const lbl = document.querySelector(`label[for="star${i}"]`);
                        if (lbl) lbl.classList.remove('text-amber-400', 'fill-current');
                    }

                    if (btn) {
                        btn.classList.remove('hidden');
                        btn.disabled = false;
                        btn.innerHTML = 'Kirim Refleksi';
                    }
                    statusMsgContainer.style.display = 'none';
                }
            } catch (e) {
                console.error('Error checking refleksi:', e);
            }
        }

        function openRefleksiModal() {
            document.getElementById('modalRefleksi').classList.remove('hidden');
            document.getElementById('modalRefleksi').classList.add('flex');
            checkExistingRefleksi();
        }

        function closeRefleksiModal() {
            document.getElementById('modalRefleksi').classList.add('hidden');
            document.getElementById('modalRefleksi').classList.remove('flex');
        }

        async function submitRefleksi() {
            const form = document.getElementById('refleksiForm');
            const data = new FormData(form);
            const answers = [];

            // Helper to get value
            const getV = (name, def = "-") => data.get(name) || def;

            // Map Q1-Q15 to Array
            answers.push(getV('refleksi_q1'));
            answers.push(getV('refleksi_q2'));
            answers.push(getV('refleksi_q3'));
            answers.push(getV('refleksi_q4'));
            answers.push(getV('refleksi_q5', "0"));
            answers.push(getV('refleksi_q6'));
            answers.push(getV('refleksi_q7'));
            answers.push(getV('refleksi_q8'));
            answers.push(getV('refleksi_q9'));
            answers.push(getV('refleksi_q10', "0"));
            answers.push(getV('refleksi_q11'));
            answers.push(getV('refleksi_q12'));
            answers.push(getV('refleksi_q13'));
            answers.push(getV('refleksi_q14'));
            answers.push(getV('refleksi_q15'));

            // Validation: Ensure at least Q1 and Q2 are filled
            if (!answers[0] || answers[0] === "-" || !answers[1] || answers[1] === "-") {
                alert('Mohon isi minimal bagian Perasaan (No.1) dan Evaluasi (No.2) sebelum mengirim.');
                return;
            }

            const btn = document.querySelector('#modalRefleksi button[onclick="submitRefleksi()"]');
            const originalText = btn.innerText;
            btn.innerText = 'Mengirim...';
            btn.disabled = true;

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error('Silakan login ulang.');

                // Check existing
                const { data: existing } = await supabaseClient
                    .from('module_responses')
                    .select('id')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'refleksi')
                    .maybeSingle();

                let error;
                // Store answers as actual Array (JSONB in Supabase handles array automatically if column is jsonb)
                // If column is text array, this works too. 
                // Previously used [JSON.stringify(obj)], typically Supabase returns array.
                // We will send the array directly. 
                // IMPORTANT: Facilitator dashboard expects ONE item in array? 
                // Facilitator code: refData = JSON.parse(answers[0]);
                // This implies facilitator expects a JSON STRING as the first element of the array.
                // So I MUST Wrap it in [JSON.stringify(answersObject)] OR [JSON.stringify(answersArray)].
                // My facilitator update handled KEY-BASED access (getVal('refleksi_q1')).
                // So I should stick to OBJECT format wrapped in JSON String for compatibility with Facilitator code I just wrote.

                // REVERTING TO OBJECT FORMAT FOR COMPATIBILITY
                const answerObj = {};
                answerObj['refleksi_q1'] = answers[0];
                answerObj['refleksi_q2'] = answers[1];
                answerObj['refleksi_q3'] = answers[2];
                answerObj['refleksi_q4'] = answers[3];
                answerObj['refleksi_q5'] = answers[4];
                answerObj['refleksi_q6'] = answers[5];
                answerObj['refleksi_q7'] = answers[6];
                answerObj['refleksi_q8'] = answers[7];
                answerObj['refleksi_q9'] = answers[8];
                answerObj['refleksi_q10'] = answers[9];
                answerObj['refleksi_q11'] = answers[10];
                answerObj['refleksi_q12'] = answers[11];
                answerObj['refleksi_q13'] = answers[12];
                answerObj['refleksi_q14'] = answers[13];
                answerObj['refleksi_q15'] = answers[14];

                const payloadAnswers = [JSON.stringify(answerObj)];

                if (existing) {
                    const { error: updErr } = await supabaseClient
                        .from('module_responses')
                        .update({
                            answers: payloadAnswers,
                            status: 'submitted',
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existing.id);
                    error = updErr;
                } else {
                    const { error: insErr } = await supabaseClient
                        .from('module_responses')
                        .insert({
                            student_id: user.id,
                            day_id: currentDay,
                            module_type: 'refleksi',
                            answers: payloadAnswers,
                            status: 'submitted'
                        });
                    error = insErr;
                }

                if (error) throw error;

                alert('Refleksi berhasil dikirim! Terima kasih atas masukanmu.');
                closeRefleksiModal();
                checkExistingRefleksi();
                checkAllModulesStatus(); // Sync Dashboard Badge

            } catch (e) {
                console.error('Submit Refleksi Error:', e);
                alert('Gagal mengirim refleksi: ' + e.message);
            } finally {
                if (btn) {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }
        }

    </script>
</body>

</html>