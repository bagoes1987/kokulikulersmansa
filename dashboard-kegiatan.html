<!DOCTYPE html>
<html class="light" lang="id">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Dashboard Kegiatan - SMAN 1 Belitang</title>
    <link rel="icon" href="./logo-sekolah.png" type="image/png">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <!-- Deployment Trigger v1.0.8 -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "emerald-custom": "#10B981",
                        "terracotta": "#E2725B",
                        "bg-main": "#F8FAFB",
                    },
                    fontFamily: {
                        "sans": ["Inter", "sans-serif"]
                    }
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        @layer base {
            body {
                @apply font-sans bg-bg-main text-slate-800;
            }
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 48;
        }

        .ios-shadow {
            box-shadow: 0 4px 20px -1px rgba(0, 0, 0, 0.05);
        }

        .circular-progress {
            background: conic-gradient(#10B981 0deg, #E2E8F0 0deg);
            transition: background 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body class="min-h-screen">
    <div class="relative flex min-h-screen w-full flex-col max-w-md mx-auto bg-bg-main overflow-x-hidden pb-24">
        <!-- Header -->
        <header
            class="sticky top-0 z-50 bg-white/80 backdrop-blur-lg border-b border-slate-100 px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="h-16 w-16 rounded-full bg-cover bg-center border-2 border-slate-100 shadow-sm"
                    id="studentPhoto"
                    style='background-image: url("https://ui-avatars.com/api/?name=Siswa&background=13ec6d&color=fff&size=256");'>
                </div>
                <div>
                    <h1 class="text-lg font-black text-slate-900 leading-tight" id="headerStudentName">Memuat...</h1>
                    <p class="text-[13px] text-slate-500 font-bold mt-0.5">
                        <span id="headerClass">...</span> • SMAN 1 BELITANG
                    </p>
                    <div class="mt-2.5 flex flex-col gap-1.5">
                        <div class="flex items-start gap-1 text-[11px] leading-tight">
                            <span class="text-slate-400 font-medium w-[38px] shrink-0">Koord:</span>
                            <span id="headerCoord" class="text-slate-700 font-bold">-</span>
                        </div>
                        <div class="flex items-start gap-1 text-[11px] leading-tight">
                            <span class="text-slate-400 font-medium w-[38px] shrink-0">Fasil:</span>
                            <span id="headerFasil" class="text-slate-700 font-bold">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="relative flex items-center justify-center">
                <div class="circular-progress h-14 w-14 rounded-full flex items-center justify-center"
                    id="progressCircle">
                    <div class="h-11 w-11 bg-white rounded-full flex items-center justify-center">
                        <span class="text-[12px] font-bold text-emerald-custom" id="progressPercent">0%</span>
                    </div>
                </div>
                <!-- Checkmark muncul jika 100% -->
                <div class="absolute -bottom-2 -right-1 bg-white rounded-full p-0.5 shadow-sm hidden"
                    id="progressCheck">
                    <span class="material-symbols-outlined !text-xs text-emerald-custom">check_circle</span>
                </div>
            </div>
        </header>

        <!-- Day Tabs -->
        <div class="px-6 py-6">
            <div class="bg-slate-200/50 p-1 rounded-2xl flex items-center">
                <button onclick="switchDay(1)"
                    class="flex-1 py-3 rounded-xl text-base font-semibold bg-white text-emerald-custom shadow-sm transition-all"
                    id="tab-day1">Hari 1</button>
                <button onclick="switchDay(2)"
                    class="flex-1 py-3 rounded-xl text-base font-semibold text-slate-500 hover:text-slate-700 transition-all"
                    id="tab-day2">Hari 2</button>
                <button onclick="switchDay(3)"
                    class="flex-1 py-3 rounded-xl text-base font-semibold text-slate-500 hover:text-slate-700 transition-all"
                    id="tab-day3">Hari 3</button>
            </div>
        </div>

        <!-- Title -->
        <div class="px-6 mb-4">
            <h2 class="text-2xl font-bold text-slate-900">Dasbor Kegiatan</h2>
            <p class="text-base text-slate-500">Selesaikan modul hari ini</p>
        </div>

        <!-- Module Grid -->
        <div class="grid grid-cols-2 gap-4 px-6">
            <!-- Pertanyaan Pemantik -->
            <div onclick="toggleModule('pemantik')"
                class="bg-amber-50/50 p-4 rounded-[24px] ios-shadow border border-amber-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                <div
                    class="h-12 w-12 rounded-2xl bg-amber-400 flex items-center justify-center text-white shadow-lg shadow-amber-200">
                    <span class="material-symbols-outlined !text-2xl">lightbulb</span>
                </div>
                <div>
                    <h3 class="text-[15px] font-bold text-slate-800">Pertanyaan Pemantik</h3>
                    <div class="flex items-center gap-1 mt-1">
                        <span class="material-symbols-outlined !text-base text-slate-400"
                            id="status-pemantik">radio_button_unchecked</span>
                        <span class="text-[13px] font-semibold text-slate-400" id="label-pemantik">Belum
                            Selesai</span>
                    </div>
                </div>
            </div>

            <!-- Materi Belajar -->
            <div onclick="toggleModule('materi')"
                class="bg-blue-50/50 p-4 rounded-[24px] ios-shadow border border-blue-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                <div
                    class="h-12 w-12 rounded-2xl bg-blue-500 flex items-center justify-center text-white shadow-lg shadow-blue-200">
                    <span class="material-symbols-outlined !text-2xl">description</span>
                </div>
                <div>
                    <h3 class="text-[15px] font-bold text-slate-800">Materi Belajar</h3>
                    <div class="flex items-center gap-1 mt-1">
                        <span class="material-symbols-outlined !text-base text-slate-400"
                            id="status-materi">radio_button_unchecked</span>
                        <span class="text-[13px] font-semibold text-slate-400" id="label-materi">Belum
                            Selesai</span>
                    </div>
                </div>
            </div>

            <!-- Video Belajar -->
            <div onclick="toggleModule('video')"
                class="bg-red-50/50 p-4 rounded-[24px] ios-shadow border border-red-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                <div
                    class="h-12 w-12 rounded-2xl bg-red-500 flex items-center justify-center text-white shadow-lg shadow-red-200">
                    <span class="material-symbols-outlined !text-2xl">play_circle</span>
                </div>
                <div>
                    <h3 class="text-[15px] font-bold text-slate-800">Video Belajar</h3>
                    <div class="flex items-center gap-1 mt-1">
                        <span class="material-symbols-outlined !text-base text-slate-400"
                            id="status-video">radio_button_unchecked</span>
                        <span class="text-[13px] font-semibold text-slate-400" id="label-video">Belum
                            Selesai</span>
                    </div>
                </div>
            </div>

            <!-- LKPD Digital -->
            <div onclick="toggleModule('lkpd')"
                class="bg-orange-50/50 p-4 rounded-[24px] ios-shadow border border-orange-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                <div
                    class="h-12 w-12 rounded-2xl bg-terracotta flex items-center justify-center text-white shadow-lg shadow-terracotta/30">
                    <span class="material-symbols-outlined !text-2xl">edit_note</span>
                </div>
                <div>
                    <h3 class="text-[15px] font-bold text-slate-800">LKPD Digital</h3>
                    <div class="flex items-center gap-1 mt-1">
                        <span class="material-symbols-outlined !text-base text-slate-400"
                            id="status-lkpd">radio_button_unchecked</span>
                        <span class="text-[13px] font-semibold text-slate-400" id="label-lkpd">Belum
                            Selesai</span>
                    </div>
                </div>
            </div>

            <!-- Asesmen -->
            <div onclick="toggleModule('asesmen')"
                class="bg-purple-50/50 p-4 rounded-[24px] ios-shadow border border-purple-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                <div
                    class="h-12 w-12 rounded-2xl bg-purple-500 flex items-center justify-center text-white shadow-lg shadow-purple-200">
                    <span class="material-symbols-outlined !text-2xl">task_alt</span>
                </div>
                <div>
                    <h3 class="text-[15px] font-bold text-slate-800">Assessment</h3>
                    <div class="flex items-center gap-1 mt-1">
                        <span class="material-symbols-outlined !text-base text-slate-400"
                            id="status-asesmen">radio_button_unchecked</span>
                        <span class="text-[13px] font-semibold text-slate-400" id="label-asesmen">Belum
                            Selesai</span>
                    </div>
                </div>
            </div>

            <!-- Dokumentasi Foto -->
            <div onclick="toggleModule('dokumentasi')"
                class="bg-indigo-50/50 p-4 rounded-[24px] ios-shadow border border-indigo-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                <div
                    class="h-12 w-12 rounded-2xl bg-indigo-500 flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                    <span class="material-symbols-outlined !text-2xl">photo_camera</span>
                </div>
                <div>
                    <h3 class="text-[15px] font-bold text-slate-800">Dokumentasi Foto</h3>
                    <div class="flex items-center gap-1 mt-1">
                        <span class="material-symbols-outlined !text-base text-slate-400"
                            id="status-dokumentasi">radio_button_unchecked</span>
                        <span class="text-[13px] font-semibold text-slate-400" id="label-dokumentasi">Belum
                            Selesai</span>
                    </div>
                </div>
            </div>

            <!-- Glosarium -->
            <div onclick="toggleModule('glosarium')"
                class="bg-cyan-50/50 p-4 rounded-[24px] ios-shadow border border-cyan-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                <div
                    class="h-12 w-12 rounded-2xl bg-cyan-500 flex items-center justify-center text-white shadow-lg shadow-cyan-200">
                    <span class="material-symbols-outlined !text-2xl">dictionary</span>
                </div>
                <div>
                    <h3 class="text-[15px] font-bold text-slate-800">Glosarium</h3>
                    <div class="flex items-center gap-1 mt-1">
                        <span class="material-symbols-outlined !text-base text-slate-400"
                            id="status-glosarium">radio_button_unchecked</span>
                        <span class="text-[13px] font-semibold text-slate-400" id="label-glosarium">Belum
                            Selesai</span>
                    </div>
                </div>
            </div>

            <!-- Refleksi -->
            <div onclick="toggleModule('refleksi')"
                class="bg-emerald-50/50 p-4 rounded-[24px] ios-shadow border border-emerald-100/50 flex flex-col gap-4 cursor-pointer hover:scale-105 transition-transform active:scale-95">
                <div
                    class="h-12 w-12 rounded-2xl bg-emerald-custom flex items-center justify-center text-white shadow-lg shadow-emerald-200">
                    <span class="material-symbols-outlined !text-2xl">psychology_alt</span>
                </div>
                <div>
                    <h3 class="text-[15px] font-bold text-slate-800">Refleksi</h3>
                    <div class="flex items-center gap-1 mt-1">
                        <span class="material-symbols-outlined !text-base text-slate-400"
                            id="status-refleksi">radio_button_unchecked</span>
                        <span class="text-[13px] font-semibold text-slate-400" id="label-refleksi">Belum
                            Selesai</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav
            class="fixed bottom-0 w-full max-w-md bg-white/90 backdrop-blur-xl border-t border-slate-100 px-8 py-3 pb-8 flex justify-between items-center z-[100]">
            <button onclick="window.location.href='index.html'"
                class="flex flex-col items-center gap-1 text-slate-400 transition-transform active:scale-90">
                <span class="material-symbols-outlined !text-2xl">home</span>
                <span class="text-[12px] font-medium">Beranda</span>
            </button>
            <button onclick="window.location.href='dashboard-kegiatan.html'"
                class="flex flex-col items-center gap-1 text-emerald-custom transition-transform active:scale-90">
                <span class="material-symbols-outlined !text-2xl">grid_view</span>
                <span class="text-[12px] font-bold">Dasbor</span>
            </button>
            <button onclick="window.location.href='pengaturan-akun.html'"
                class="flex flex-col items-center gap-1 text-slate-400 transition-transform active:scale-90">
                <span class="material-symbols-outlined !text-2xl">person</span>
                <span class="text-[12px] font-medium">Profil</span>
            </button>
            <button onclick="logout()"
                class="flex flex-col items-center gap-1 text-slate-400 transition-transform active:scale-90 hover:text-red-500">
                <span class="material-symbols-outlined !text-2xl">logout</span>
                <span class="text-[12px] font-medium">Keluar</span>
            </button>
        </nav>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Inisialisasi Supabase
        const supabaseUrl = 'https://jnsqqswpkigyzewnbvaf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impuc3Fxc3dwa2lneXpld25idmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NjA3NDIsImV4cCI6MjA4NTIzNjc0Mn0.RrjPnddC55Xv9CLCtG8-1RyDmEkYg_04tHeKqRE7pok';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let currentDay = 1;

        // Struktur data progress default (3 hari x 8 modul)
        const defaultProgress = {
            day1: { pemantik: false, materi: false, video: false, lkpd: false, asesmen: false, dokumentasi: false, glosarium: false, refleksi: false },
            day2: { pemantik: false, materi: false, video: false, lkpd: false, asesmen: false, dokumentasi: false, glosarium: false, refleksi: false },
            day3: { pemantik: false, materi: false, video: false, lkpd: false, asesmen: false, dokumentasi: false, glosarium: false, refleksi: false }
        };

        let studentProgress = JSON.parse(JSON.stringify(defaultProgress));

        // Load student data
        async function loadStudentData() {
            try {
                // 1. CEK SESSION AUTH (HANYA INI YANG BOLEH REDIRECT KE LOGIN)
                const { data: { session }, error: authError } = await supabaseClient.auth.getSession();

                if (authError || !session) {
                    console.warn('No session found or auth error, redirecting to login.');
                    window.location.href = 'login-siswa.html';
                    return;
                }

                // 2. LOGIKA INTERNAL DASHBOARD (DIBUNGKUS AGAR TIDAK LOOP REDIRECT)
                try {
                    const studentDataStr = localStorage.getItem('student_data');

                    if (studentDataStr && studentDataStr !== "undefined") {
                        const studentData = JSON.parse(studentDataStr);
                        if (studentData) {
                            // Update Header Info (Nama & Kelas)
                            if (document.getElementById('headerStudentName')) document.getElementById('headerStudentName').textContent = studentData.nama || 'Siswa';
                            if (document.getElementById('headerClass')) document.getElementById('headerClass').textContent = studentData.kelas || 'X.1';

                            // Update header photo
                            const photoEl = document.getElementById('studentPhoto');
                            if (photoEl) {
                                if (studentData.photo_url) {
                                    photoEl.style.backgroundImage = `url("${studentData.photo_url}")`;
                                } else {
                                    const photoUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(studentData.nama)}&background=13ec6d&color=fff&size=256`;
                                    photoEl.style.backgroundImage = `url("${photoUrl}")`;
                                }
                            }

                            // --- MAPPING KOORDINATOR & FASILITATOR ---
                            // ... (Mapping data remains same) ...
                            const trialMap = {
                                'X.TRIAL-1': { koord: 'Koordinator Trial A', fasil: 'Fasilitator Trial 1' },
                                'X.TRIAL-2': { koord: 'Koordinator Trial A', fasil: 'Fasilitator Trial 2' },
                                'X.TRIAL-3': { koord: 'Koordinator Trial B', fasil: 'Fasilitator Trial 3' }
                            };

                            const realClassMap = {
                                'X.1': { koord: 'Lucia Erviana, S.Pd., M.Pd.', fasil: 'Sukirno, S.Pd. & Ari Muchtrinai N. N, S.Pd.I.' },
                                'X.2': { koord: 'Lucia Erviana, S.Pd., M.Pd.', fasil: 'Handaroh, S.Pd. & Fantas Jaya A, S.Pd.' },
                                'X.3': { koord: 'Lucia Erviana, S.Pd., M.Pd.', fasil: 'Flortentinus Supriyanto, S.Pd. & Nelly Kurniasih, S.Pd.' },
                                'X.4': { koord: 'Ninda Ningtyas, S.Pd., M.Si.', fasil: 'Siti Anita, S.Pd. & Latifatu Anisa, S. Pd.' },
                                'X.5': { koord: 'Vivi Amelia, S.Pd.', fasil: 'Atik Setianingsih, S.Pd. & Lovelya Valentina, S.Pd.' },
                                'X.6': { koord: 'Vivi Amelia, S.Pd.', fasil: 'Wiwik Eko Prihatin, S.Pd., M.M. & Andi Cahya Sanjaya, S.Pd.' },
                                'X.7': { koord: 'Kustiani, S.Pd.', fasil: 'Azuari Dian Prasasti, S.Pd. & Deni Yunarti, S.Pd.' },
                                'X.8': { koord: 'Aprilyan Dona, S.Pd.', fasil: 'Fajar Abdul Majid, S.Pd & Nora Nurhalita, S.Pd.' },
                                'X.9': { koord: 'Aprilyan Dona, S.Pd.', fasil: 'Andree Prasetyo, S.Pd. & Sindy Dwi Pertiwi, M.Pd.' },
                                'X.10': { koord: 'Ika Setiawati, S.Pd', fasil: 'Indah Sulmayanti, M.Pd. & M. Hafiz Sytar, S.Kom.' },
                                'X.11': { koord: 'Anastasiya Candra M, S.Pd.', fasil: 'Pandu Aditya, M.Pd. & Tiar Hajunilato, M.Pd.' },
                                'XI.1': { koord: 'Dr. Didi Franzhardi, M.Pd.', fasil: 'Try Puri anggraini, S.Pd., M.Pd. & Lia Ningrum, S.Pd.' },
                                'XI.2': { koord: 'Dr. Didi Franzhardi, M.Pd.', fasil: 'Hermanto, S.Pd., M.Pd. & Santi Aryanti, S.Pd.' },
                                'XI.3': { koord: 'Ika Setiawati, S.Pd', fasil: 'Nengsi Juita, M.Pd.Si. & Hedi Prawito, S.Pd.' },
                                'XI.4': { koord: 'Kartika Sari, S.Pd.', fasil: 'Anggun Saymona, S.Pd., M.Pd. & Lia Kurniasari, S.Pd.' },
                                'XI.5': { koord: 'Kartika Sari, S.Pd.', fasil: 'Nyoman Kopariyanto, S.Pd. & Etik Prasetyaningsih, S.Pd.' },
                                'XI.6': { koord: 'Kartika Sari, S.Pd.', fasil: 'Abdul Hafiz, S.Pd. & Suhaib Jawahir, S.Pd.' },
                                'XI.7': { koord: 'Neti Diana, M.Pd.', fasil: 'Singgih Sudarmawan, S.Ag. & Suparmono, S.Ag.' },
                                'XI.8': { koord: 'Neti Diana, M.Pd.', fasil: 'Wely Marisa, S.Pd.' },
                                'XI.9': { koord: 'Neti Diana, M.Pd.', fasil: 'A.Thoriq Ganda, S.Pd.' },
                                'XI.10': { koord: 'Maulidiawati, M.Pd.', fasil: 'Ari Yani A M, S.T.' },
                                'XI.11': { koord: 'Agung Saputra, S.Pd.', fasil: 'Bagus Panca Wiratama, S.Pd., M.Pd.' },
                                'XII.1': { koord: 'Chodman Ariyanto, S.Pd.', fasil: 'Tri Tamti Nugraheni, S.Pd. & Yuni Asrina, S.Pd.' },
                                'XII.2': { koord: 'Chodman Ariyanto, S.Pd.', fasil: 'Titin Sumarni, S.Pd. & Sukirok, S.Pd.' },
                                'XII.3': { koord: 'Chodman Ariyanto, S.Pd.', fasil: 'Nur Azizah, S.Pd.I. & Febrianita Prasasti, S.Pd.' },
                                'XII.4': { koord: 'Taufik Hidayat, S.Pd.', fasil: 'Atik Apriliawati, S.Pd. & Ferdinasari, S.pd.' },
                                'XII.5': { koord: 'Taufik Hidayat, S.Pd.', fasil: 'Nur Rohmad Safarudin, M.Pd. & Fery Ardianto, M.Pd.' },
                                'XII.6': { koord: 'Taufik Hidayat, S.Pd.', fasil: 'Ade Ervani M, S.Sn. & Dra. Hj. Endang Suwartijah' },
                                'XII.7': { koord: 'Mas’ud abid, S.Pd., M.Pd.', fasil: 'Ribuwati, M.Pd. & Nasution, S.Pd.' },
                                'XII.8': { koord: 'Mas’ud abid, S.Pd., M.Pd.', fasil: 'Apriana, S.Pd. & Agung Subaryanto, S.Pd.' },
                                'XII.9': { koord: 'Ade Rohmah Apriani, S.Pd.', fasil: 'Ari Astuti, S.Pd. & Erfizah, S.Pd' },
                                'XII.10': { koord: 'Ade Rohmah Apriani, S.Pd.', fasil: 'Muh. Zuhdi, S.Pd. & Ellys Trisnowati, M.Pd.I.' }
                            };

                            const userClass = studentData.kelas;

                            if (trialMap[userClass]) {
                                if (document.getElementById('headerCoord')) document.getElementById('headerCoord').textContent = trialMap[userClass].koord;
                                if (document.getElementById('headerFasil')) document.getElementById('headerFasil').innerHTML = trialMap[userClass].fasil;
                            } else if (realClassMap[userClass]) {
                                const data = realClassMap[userClass];
                                if (document.getElementById('headerCoord')) document.getElementById('headerCoord').textContent = data.koord;
                                const fasils = data.fasil.split('&').map(s => s.trim());
                                if (fasils.length > 1) {
                                    const html = fasils.map((f, i) => `${i + 1}. ${f}`).join('<br>');
                                    if (document.getElementById('headerFasil')) document.getElementById('headerFasil').innerHTML = html;
                                } else {
                                    if (document.getElementById('headerFasil')) document.getElementById('headerFasil').textContent = fasils[0];
                                }
                            }
                        }
                    }

                    loadProgress();
                    updateDashboardUI();
                    checkAllModulesStatus();
                    // Individual checks for modal pre-population
                    checkExistingPemantik();
                    checkExistingMateri();
                    checkExistingVideo();
                    checkExistingDokumentasi();
                } catch (internalError) {
                    console.error('Non-auth error in loadStudentData:', internalError);
                }

            } catch (error) {
                console.error('Critical auth error:', error);
                window.location.href = 'login-siswa.html';
            }
        }

        // Load progress logic
        function loadProgress() {
            const savedProgress = localStorage.getItem('student_progress');
            if (savedProgress) {
                studentProgress = JSON.parse(savedProgress);
                // Sanitize: Migrasi dari 'rangkuman' ke 'dokumentasi' jika ada data lama
                ['day1', 'day2', 'day3'].forEach(d => {
                    if (studentProgress[d] && studentProgress[d].rangkuman !== undefined) {
                        if (studentProgress[d].dokumentasi === undefined) {
                            studentProgress[d].dokumentasi = studentProgress[d].rangkuman;
                        }
                        delete studentProgress[d].rangkuman;
                    }
                    // Pastikan field dokumentasi ada
                    if (studentProgress[d] && studentProgress[d].dokumentasi === undefined) {
                        studentProgress[d].dokumentasi = false;
                    }
                });
            } else {
                studentProgress = JSON.parse(JSON.stringify(defaultProgress));
            }
            calculateGlobalProgress();
        }

        function saveProgress() {
            localStorage.setItem('student_progress', JSON.stringify(studentProgress));
            calculateGlobalProgress();
        }

        // Toggle module completion
        function toggleModule(moduleId) {
            // Override untuk Hari 1
            if (currentDay === 1) {
                if (moduleId === 'mantik' || moduleId === 'pemantik') {
                    openPemantikModal();
                    return;
                }
                if (moduleId === 'materi') {
                    openMateriModal();
                    return;
                }
                if (moduleId === 'dokumentasi') {
                    openDokumentasiModal();
                    return;
                }
                if (moduleId === 'video') {
                    openVideoModal();
                    return;
                }
                if (moduleId === 'asesmen' || moduleId === 'assessment') {
                    openAssessmentModal();
                    return;
                }
            }

            // Override untuk Hari 2 & 3 agar dokumentasi tetap buka modal
            if (moduleId === 'dokumentasi') {
                openDokumentasiModal();
                return;
            }

            const dayKey = `day${currentDay}`;
            // Toggle status
            studentProgress[dayKey][moduleId] = !studentProgress[dayKey][moduleId];
            saveProgress();
            updateModuleUI(moduleId, studentProgress[dayKey][moduleId]);
        }

        // Helper untuk memanggil toggle original dari dalam modal
        function forceCompleteModule(moduleId, score = 0) {
            const dayKey = `day${currentDay}`;
            studentProgress[dayKey][moduleId] = true;
            saveProgress();
            updateModuleUI(moduleId, true, score);
        }

        // Update UI for a single module
        function updateModuleUI(moduleId, isComplete, score = 0) {
            const statusIcon = document.getElementById(`status-${moduleId}`);
            const statusLabel = document.getElementById(`label-${moduleId}`);

            if (!statusIcon || !statusLabel) return;

            if (isComplete) {
                statusIcon.textContent = 'check_circle';
                statusIcon.className = 'material-symbols-outlined !text-[14px] text-emerald-custom';

                if (score > 0) {
                    const starCount = Math.round(score / 20);
                    const stars = '⭐'.repeat(starCount) || '⭐';
                    statusLabel.textContent = `Selesai ${stars}`;
                } else {
                    statusLabel.textContent = 'Selesai';
                }
                statusLabel.className = 'text-[11px] font-semibold text-emerald-custom';
            } else {
                statusIcon.textContent = 'radio_button_unchecked';
                statusIcon.className = 'material-symbols-outlined !text-[14px] text-slate-400';
                statusLabel.textContent = 'Belum Selesai';
                statusLabel.className = 'text-[11px] font-semibold text-slate-400';
            }
        }

        // Update all modules UI based on current day
        function updateDashboardUI() {
            const dayKey = `day${currentDay}`;
            const currentDayProgress = studentProgress[dayKey];

            Object.keys(currentDayProgress).forEach(moduleId => {
                updateModuleUI(moduleId, currentDayProgress[moduleId]);
            });
        }

        // Calculate and update global progress circle
        function calculateGlobalProgress() {
            let totalItems = 0;
            let completedItems = 0;

            // Hitung semua item dari 3 hari
            Object.values(studentProgress).forEach(day => {
                Object.values(day).forEach(status => {
                    totalItems++;
                    if (status) completedItems++;
                });
            });

            const percent = Math.round((completedItems / totalItems) * 100);

            // Update Text
            document.getElementById('progressPercent').textContent = `${percent}%`;

            // Update Circle Gradient
            const degree = Math.round((percent / 100) * 360);
            document.getElementById('progressCircle').style.background = `conic-gradient(#10B981 ${degree}deg, #E2E8F0 0deg)`;

            // Show checkmark if 100%
            const checkmark = document.getElementById('progressCheck');
            if (percent === 100) {
                checkmark.classList.remove('hidden');
            } else {
                checkmark.classList.add('hidden');
            }
        }

        // Switch day tabs
        function switchDay(day) {
            currentDay = day;

            // Update tab styles
            for (let i = 1; i <= 3; i++) {
                const tab = document.getElementById(`tab-day${i}`);
                if (i === day) {
                    tab.className = 'flex-1 py-2.5 rounded-xl text-sm font-semibold bg-white text-emerald-custom shadow-sm transition-all';
                } else {
                    tab.className = 'flex-1 py-2.5 rounded-xl text-sm font-semibold text-slate-500 hover:text-slate-700 transition-all';
                }
            }

            // Update modules display based on new day
            updateDashboardUI();

            // Re-fetch database statuses to ensure sync
            checkAllModulesStatus();
        }

        // SINKRONISASI GLOBAL SEMUA MODUL
        async function checkAllModulesStatus() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                // Ambil semua respon hari ini dalam satu query
                const { data: responses, error } = await supabaseClient
                    .from('module_responses')
                    .select('module_type, status, score')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay);

                if (error) throw error;

                // Reset UI dulu ke progress local
                updateDashboardUI();

                // Timpa dengan data dari database jika ada
                if (responses && responses.length > 0) {
                    responses.forEach(r => {
                        if (r.status === 'submitted') {
                            const icon = document.getElementById(`status-${r.module_type}`);
                            const label = document.getElementById(`label-${r.module_type}`);
                            if (icon && label) {
                                icon.textContent = 'hourglass_top';
                                icon.className = 'material-symbols-outlined !text-[14px] text-yellow-500 animate-pulse';
                                label.textContent = 'Menunggu Feedback';
                                label.className = 'text-[11px] font-semibold text-yellow-500';
                            }
                        } else if (r.status === 'reviewed') {
                            forceCompleteModule(r.module_type, r.score);
                        }
                    });
                }
            } catch (err) {
                console.error("Error checkAllModulesStatus:", err);
            }
        }

        // Logout function
        async function logout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                // Redirect to index.html (Beranda)
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error logging out:', error.message);
                alert('Gagal keluar. Silakan coba lagi.');
            }
        }

        // Load data on page load
        window.addEventListener('load', loadStudentData);

        // ==========================================
        // FITUR PERTANYAAN PEMANTIK
        // ==========================================

        // Buka Modal Pemantik
        function openPemantikModal() {
            const modal = document.getElementById('modalPemantik');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Cek apakah sudah ada jawaban
            checkExistingPemantik();
        }

        // Tutup Modal
        function closePemantikModal() {
            const modal = document.getElementById('modalPemantik');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }


        // ==========================================
        // FITUR MATERI BELAJAR (SLIDE)
        // ==========================================

        let currentMateriSlide = 0;
        const totalMateriSlides = 9;

        function openMateriModal() {
            currentMateriSlide = 0;
            document.getElementById('modalMateri').classList.remove('hidden');
            document.getElementById('modalMateri').classList.add('flex');
            updateMateriSlideUI();
            checkExistingMateri(); // Pastikan status terpanggil
        }

        function closeMateriModal() {
            document.getElementById('modalMateri').classList.add('hidden');
            document.getElementById('modalMateri').classList.remove('flex');
        }

        function nextMateriSlide() {
            if (currentMateriSlide < totalMateriSlides - 1) {
                currentMateriSlide++;
                updateMateriSlideUI();
                // Scroll content ke atas setiap ganti slide
                document.getElementById('materiContentArea').scrollTop = 0;
            }
        }

        function prevMateriSlide() {
            if (currentMateriSlide > 0) {
                currentMateriSlide--;
                updateMateriSlideUI();
                document.getElementById('materiContentArea').scrollTop = 0;
            }
        }

        function goToSlide(n) {
            if (n >= 0 && n < totalMateriSlides) {
                currentMateriSlide = n;
                updateMateriSlideUI();
                document.getElementById('materiContentArea').scrollTop = 0;
            }
        }

        function updateMateriSlideUI() {
            // Hide semua slide
            for (let i = 0; i < totalMateriSlides; i++) {
                const s = document.getElementById(`slide-materi-${i}`);
                if (s) s.classList.add('hidden');
            }
            // Tampilkan slide aktif
            document.getElementById(`slide-materi-${currentMateriSlide}`).classList.remove('hidden');

            // Update Navigation Pills
            for (let i = 0; i < totalMateriSlides; i++) {
                const pill = document.getElementById(`nav-pill-${i}`);
                if (pill) {
                    if (i === currentMateriSlide) {
                        pill.className = "size-7 rounded-lg bg-emerald-500 text-white text-[9px] font-bold flex items-center justify-center shadow-md shadow-emerald-200 transition-all";
                    } else {
                        pill.className = "size-7 rounded-lg bg-slate-50 text-slate-400 text-[9px] font-bold flex items-center justify-center hover:bg-slate-100 transition-all";
                    }
                }
            }

            // Update Progress Bar
            const progress = ((currentMateriSlide + 1) / totalMateriSlides) * 100;
            document.getElementById('materiProgressBar').style.width = `${progress}%`;
            document.getElementById('materiStepText').textContent = `Halaman ${currentMateriSlide + 1} dari ${totalMateriSlides}`;

            // Update Tombol
            const btnPrev = document.getElementById('btnPrevMateri');
            const btnNext = document.getElementById('btnNextMateri');
            const btnFinish = document.getElementById('btnFinishMateri');

            // Tombol Kembali
            if (currentMateriSlide === 0) {
                btnPrev.classList.add('invisible');
            } else {
                btnPrev.classList.remove('invisible');
            }

            // Tombol Lanjut vs Selesai
            if (currentMateriSlide === totalMateriSlides - 1) {
                btnNext.classList.add('hidden');
                btnFinish.classList.remove('hidden');
                updateWordCount(); // Sync button state on show
            } else {
                btnNext.classList.remove('hidden');
                btnFinish.classList.add('hidden');
            }
        }

        function settleMateri() {
            // Check word count first if it's the last slide
            if (currentMateriSlide === totalMateriSlides - 1) {
                submitMateriSummary();
                return;
            }
            // Fallback for older logic if needed
            forceCompleteModule('materi');
            alert('Selamat! Kamu telah menyelesaikan materi hari ini.');
            closeMateriModal();
        }

        function updateWordCount() {
            const textarea = document.getElementById('summaryArea');
            const counter = document.getElementById('wordCounter');
            const text = textarea.value.trim();
            const words = text ? text.split(/\s+/).length : 0;

            counter.textContent = `${words} / 200 kata`;

            const btn = document.getElementById('btnFinishMateri');
            if (textarea.disabled) {
                // Jangan utak-atik tombol jika sudah dikunci (submitted/reviewed)
                btn.classList.add('hidden');
                return;
            }

            if (words >= 200) {
                counter.className = "text-[10px] font-bold text-emerald-500";
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                counter.className = "text-[10px] font-bold text-slate-400";
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        async function submitMateriSummary() {
            const btn = document.getElementById('btnFinishMateri');
            const summary = document.getElementById('summaryArea').value.trim();

            if (summary.split(/\s+/).length < 200) {
                alert('Pesan: Ringkasan minimal harus 200 kata.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'Mengirim...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error('Silakan login ulang.');

                // Gunakan user.id (Auth UID) secara konsisten
                const { error } = await supabaseClient
                    .from('module_responses')
                    .insert({
                        student_id: user.id,
                        day_id: currentDay,
                        module_type: 'materi',
                        answers: [summary],
                        status: 'submitted'
                    });

                if (error) throw error;

                alert('Pesan: Ringkasan berhasil dikirim! Silakan tunggu review dari Fasilitator.');
                // SINKRONKAN status lokal (tetap false agar show hourglass)
                studentProgress[`day${currentDay}`]['materi'] = false;
                saveProgress();
                closeMateriModal();
                checkAllModulesStatus();
                checkExistingMateri();

            } catch (e) {
                console.error(e);
                alert('Gagal mengirim: ' + e.message);
                btn.disabled = false;
                btn.innerHTML = 'Selesaikan Materi';
            }
        }

        async function checkExistingMateri() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data: responses } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id) // Konsisten pakai user.id
                    .eq('day_id', currentDay) // Dinamis sesuai hari aktif
                    .eq('module_type', 'materi')
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (responses && responses.length > 0) {
                    const r = responses[0];
                    // SINKRONKAN ke local progress bar
                    if (r.status === 'reviewed') {
                        forceCompleteModule('materi', r.score);
                    }

                    const area = document.getElementById('summaryArea');
                    const msg = document.getElementById('materiStatusMsg');
                    if (area) {
                        area.value = r.answers[0] || '';
                        if (r.status === 'submitted' || r.status === 'reviewed') {
                            area.disabled = true;
                            area.classList.add('bg-slate-100', 'text-slate-500');
                        }
                        updateWordCount(); // Sync tombol & counter berdasarkan isi
                    }

                    if (msg) {
                        msg.classList.remove('hidden');
                        const btn = document.getElementById('btnFinishMateri');
                        if (r.status === 'submitted') {
                            msg.className = "mb-4 p-4 rounded-3xl text-[11px] font-bold border border-amber-100 bg-amber-50 text-amber-700 animate-pulse";
                            msg.innerHTML = `⏳ Ringkasanmu sedang menunggu review Fasilitator.`;
                            if (btn) btn.classList.add('hidden');
                        } else if (r.status === 'reviewed') {
                            msg.className = "mb-4 p-4 rounded-3xl text-[11px] font-bold border border-emerald-100 bg-emerald-50 text-emerald-700";
                            msg.innerHTML = `✅ Dinilai: ${r.score}/100<br><span class="font-normal text-[10px] mt-1 block">"${r.feedback || 'Bagus sekali!'}"</span>`;
                            if (btn) btn.classList.add('hidden');
                        }
                    }
                } else {
                    // Jika tidak ada data, pastikan tombol muncul & textarea aktif
                    const btn = document.getElementById('btnFinishMateri');
                    const area = document.getElementById('summaryArea');
                    if (btn) btn.classList.remove('hidden');
                    if (area) {
                        area.disabled = false;
                        area.classList.remove('bg-slate-100', 'text-slate-500');
                    }
                }
            } catch (e) { console.error('Error checkExistingMateri:', e); }
        }

        // ==========================================
        // FITUR DOKUMENTASI FOTO (REPLACEMENT RANGKUMAN)
        // ==========================================

        function openDokumentasiModal() {
            document.getElementById('modalDokumentasi').classList.remove('hidden');
            document.getElementById('modalDokumentasi').classList.add('flex');
            checkExistingDokumentasi();
        }

        function closeDokumentasiModal() {
            document.getElementById('modalDokumentasi').classList.add('hidden');
            document.getElementById('modalDokumentasi').classList.remove('flex');
        }

        // Compress image function (Optimized for Documentation)
        async function compressImage(file, maxWidth = 800, quality = 0.5) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function handleDocPhotoSelection(e) {
            const file = e.target.files[0];
            if (!file) return;

            // VALIDASI: Batasan 10MB sebelum kompresi
            const MAX_SIZE = 10 * 1024 * 1024;
            if (file.size > MAX_SIZE) {
                alert(`Pesan: Ukuran file terlalu besar (${Math.round(file.size / 1024 / 1024)}MB). Maksimal 10MB agar tidak memberatkan sistem.`);
                e.target.value = '';
                return;
            }

            const btn = document.getElementById('btnUploadDokumentasi');
            const statusText = document.getElementById('docStatusMsg');
            const preview = document.getElementById('docPreview');

            statusText.classList.remove('hidden');
            statusText.className = "mb-4 p-4 rounded-2xl text-[11px] font-bold border border-blue-100 bg-blue-50 text-blue-700 animate-pulse";
            statusText.innerHTML = "⏳ Sedang mengoptimalkan foto...";
            btn.disabled = true;

            try {
                const compressedBlob = await compressImage(file, 600, 0.6);
                const compressedFile = new File([compressedBlob], `doc_${Date.now()}.jpg`, { type: 'image/jpeg' });

                // Preview
                const reader = new FileReader();
                reader.onload = (re) => {
                    preview.src = re.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(compressedFile);

                statusText.className = "mb-4 p-4 rounded-2xl text-[11px] font-bold border border-emerald-100 bg-emerald-50 text-emerald-700";
                statusText.innerHTML = "✅ Foto siap dikirim (~" + Math.round(compressedBlob.size / 1024) + " KB)";
                btn.disabled = false;

                // Simpan file sementara di window agar bisa diakses submit
                window.selectedDocFile = compressedFile;

            } catch (err) {
                console.error(err);
                statusText.className = "mb-4 p-4 rounded-2xl text-[11px] font-bold border border-red-100 bg-red-50 text-red-700";
                statusText.innerHTML = "❌ Gagal memproses foto.";
            }
        }

        async function submitDokumentasi() {
            const btn = document.getElementById('btnUploadDokumentasi');
            const file = window.selectedDocFile;
            if (!file) {
                alert('Silakan pilih foto terlebih dahulu.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'Mengirim...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error('Silakan login ulang.');

                const fileName = `${user.id}/day${currentDay}_${Date.now()}.jpg`;

                // 1. Upload ke Storage Bucket 'documentation'
                // NOTE: Pastikan bucket ini sudah dibuat di dashboard Supabase
                const { error: uploadError } = await supabaseClient.storage
                    .from('documentation')
                    .upload(fileName, file);

                if (uploadError) throw uploadError;

                const { data: { publicUrl } } = supabaseClient.storage
                    .from('documentation')
                    .getPublicUrl(fileName);

                // 2. Simpan ke module_responses
                const { error: dbError } = await supabaseClient
                    .from('module_responses')
                    .insert({
                        student_id: user.id,
                        day_id: currentDay,
                        module_type: 'dokumentasi',
                        answers: [publicUrl],
                        status: 'submitted'
                    });

                if (dbError) throw dbError;

                alert('✅ Foto dokumentasi berhasil dikirim!');
                // Reset local complete status
                studentProgress[`day${currentDay}`]['dokumentasi'] = false;
                saveProgress();
                closeDokumentasiModal();
                checkAllModulesStatus();
                checkExistingDokumentasi();

            } catch (e) {
                console.error(e);
                alert('Gagal mengirim: ' + e.message);
                btn.disabled = false;
                btn.innerHTML = 'Kirim Dokumentasi';
            }
        }

        async function checkExistingDokumentasi() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data: responses } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'dokumentasi')
                    .order('created_at', { ascending: false })
                    .limit(1);

                const container = document.getElementById('docUploadArea');
                const btn = document.getElementById('btnUploadDokumentasi');
                const statusMsg = document.getElementById('docStatusMsg');
                const preview = document.getElementById('docPreview');

                if (responses && responses.length > 0) {
                    const r = responses[0];

                    if (r.status === 'submitted' || r.status === 'reviewed') {
                        if (r.status === 'reviewed') {
                            forceCompleteModule('dokumentasi', r.score);
                        }
                        if (container) container.classList.add('hidden');
                        if (btn) btn.classList.add('hidden');
                        if (statusMsg) {
                            statusMsg.classList.remove('hidden');
                            statusMsg.className = "mb-4 p-4 rounded-2xl text-[11px] font-bold border border-emerald-100 bg-emerald-50 text-emerald-700";
                            statusMsg.innerHTML = "✅ Dokumentasi hari ini sudah terkirim.";
                        }
                        if (preview && r.answers[0]) {
                            preview.src = r.answers[0];
                            preview.classList.remove('hidden');
                        }
                    }
                } else {
                    if (container) container.classList.remove('hidden');
                    if (btn) {
                        btn.classList.remove('hidden');
                        btn.disabled = true;
                        btn.innerHTML = 'Kirim Dokumentasi';
                    }
                    if (statusMsg) statusMsg.classList.add('hidden');
                    if (preview) {
                        preview.src = '';
                        preview.classList.add('hidden');
                    }
                }
            } catch (e) { console.error('Error checkExistingDokumentasi:', e); }
        }

        // Deprecated: Functions below are now handled by updateModuleUI or specific modal logic

        // Kirim Jawaban
        async function submitPemantik() {
            const btn = document.getElementById('btnSubmitPemantik');
            btn.innerHTML = 'Mengirim...';
            btn.disabled = true;

            // Ambil jawaban dari 5 textarea
            const answers = [];
            for (let i = 1; i <= 5; i++) {
                const val = document.getElementById(`tanya${i}`).value;
                if (!val) {
                    alert(`Jawaban nomor ${i} belum diisi!`);
                    btn.innerHTML = 'Kirim Jawaban';
                    btn.disabled = false;
                    return;
                }
                answers.push(val);
            }

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error("User tidak ditemukan");

                // Simpan ke Supabase
                const { error } = await supabaseClient
                    .from('module_responses')
                    .insert({
                        student_id: user.id,
                        day_id: currentDay, // Gunakan currentDay yang dinamis
                        module_type: 'pemantik',
                        answers: answers,
                        status: 'submitted' // Status awal
                    });

                if (error) throw error;

                // Berhasil
                alert('Jawaban berhasil dikirim! Menunggu feedback dari fasilitator.');

                // SINKRONKAN status lokal
                studentProgress[`day${currentDay}`]['pemantik'] = false;
                saveProgress();
                checkAllModulesStatus(); // Refresh icon dashboard
                closePemantikModal();
                checkExistingPemantik();

            } catch (err) {
                console.error('Gagal kirim:', err);
                alert('Terjadi kesalahan saat mengirim jawaban.');
            } finally {
                btn.innerHTML = 'Kirim Jawaban';
                btn.disabled = false;
            }
        }

        // Cek Status Jawaban (Saat load / buka modal)
        async function checkExistingPemantik() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data, error } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay) // Dinamis sesuai hari aktif
                    .eq('module_type', 'pemantik')
                    .limit(1)
                    .maybeSingle();

                if (data) {
                    // Isi form dengan jawaban lama
                    data.answers.forEach((ans, idx) => {
                        const el = document.getElementById(`tanya${idx + 1}`);
                        if (el) {
                            el.value = ans;
                            el.disabled = true; // Disable edit jika sudah submit
                        }
                    });

                    // Hide tombol kirim jika sudah submit
                    const btn = document.getElementById('btnSubmitPemantik');
                    if (btn) btn.classList.add('hidden');

                    // Show status message
                    const statusMsg = document.getElementById('statusMessage');
                    if (statusMsg) {
                        statusMsg.classList.remove('hidden');

                        if (data.status === 'submitted') {
                            statusMsg.className = "bg-yellow-50 text-yellow-700 p-4 rounded-xl border border-yellow-200 text-xs font-medium mb-4";
                            statusMsg.innerHTML = "⏳ <b>Jawaban Terkirim</b><br>Menunggu feedback dari fasilitator.";
                        } else if (data.status === 'reviewed') {
                            statusMsg.className = "bg-emerald-50 text-emerald-700 p-4 rounded-xl border border-emerald-200 text-xs font-medium mb-4";
                            statusMsg.innerHTML = `✅ <b>Sudah Direview (Skor: ${data.score || 0})</b><br>Feedback: "${data.feedback || '-'}"`;
                        }
                    }
                } else {
                    // Belum ada data
                    const statusMsg = document.getElementById('statusMessage');
                    if (statusMsg) statusMsg.classList.add('hidden');

                    const btn = document.getElementById('btnSubmitPemantik');
                    if (btn) {
                        btn.classList.remove('hidden');
                        btn.innerHTML = 'Kirim Jawaban';
                        btn.disabled = false;
                    }

                    // Enable inputs
                    for (let i = 1; i <= 5; i++) {
                        const el = document.getElementById(`tanya${i}`);
                        if (el) {
                            el.disabled = false;
                            el.value = '';
                        }
                    }
                }
            } catch (err) {
                console.error("Error checkExistingPemantik:", err);
            }
        }

        // Helper: Update Tampilan Icon di Dashboard (Kuning jika pending)
        // Deprecated: Handled by updateModuleUI

    </script>

    <!-- MODAL PERTANYAAN PEMANTIK -->
    <div id="modalPemantik"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2rem] shadow-2xl max-h-[90vh] flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div>
                    <h3 class="text-lg font-black text-slate-800">Pertanyaan Pemantik</h3>
                    <p class="text-xs text-slate-500 font-medium">Hari 1 • Cita Rasa Jajanan Nusantara</p>
                </div>
                <button onclick="closePemantikModal()"
                    class="size-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200 transition-colors">
                    <span class="material-symbols-outlined text-xl">close</span>
                </button>
            </div>

            <!-- Scrollable Content -->
            <div class="p-6 overflow-y-auto no-scrollbar space-y-6">

                <!-- Status Message Area -->
                <div id="statusMessage" class="hidden"></div>

                <!-- Soal 1 -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-700 block leading-relaxed">
                        1. Kapan terakhir kali kamu menikmati jajanan khas Nusantara, dan apa yang membuatmu lebih
                        memilih jajanan tersebut dibandingkan makanan modern atau camilan instan saat itu?
                    </label>
                    <textarea id="tanya1" rows="3"
                        class="w-full text-xs p-3 rounded-xl border border-slate-200 focus:border-emerald-500 focus:ring-emerald-500 bg-slate-50 focus:bg-white transition-all placeholder:text-slate-300"
                        placeholder="Tulis jawabanmu disini..."></textarea>
                </div>

                <!-- Soal 2 -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-700 block leading-relaxed">
                        2. Apa nama jajanan tersebut? Menurut pendapatmu, berasal dari daerah mana makanan tersebut?
                    </label>
                    <textarea id="tanya2" rows="2"
                        class="w-full text-xs p-3 rounded-xl border border-slate-200 focus:border-emerald-500 focus:ring-emerald-500 bg-slate-50 focus:bg-white transition-all placeholder:text-slate-300"
                        placeholder="Jawab..."></textarea>
                </div>

                <!-- Soal 3 -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-700 block leading-relaxed">
                        3. Apa bahan utama pembuat makanan tersebut? Apakah bahannya mudah didapatkan, dan berapa
                        harganya sekarang?
                    </label>
                    <textarea id="tanya3" rows="3"
                        class="w-full text-xs p-3 rounded-xl border border-slate-200 focus:border-emerald-500 focus:ring-emerald-500 bg-slate-50 focus:bg-white transition-all placeholder:text-slate-300"
                        placeholder="Jawab..."></textarea>
                </div>

                <!-- Soal 4 -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-700 block leading-relaxed">
                        4. Apa kandungan gizi dari makanan tersebut? Menurutmu, bahan mana yang memberikan manfaat bagi
                        tubuh dan bahan mana yang jika dikonsumsi berlebih justru berisiko bagi kesehatan? Mengapa?
                    </label>
                    <textarea id="tanya4" rows="4"
                        class="w-full text-xs p-3 rounded-xl border border-slate-200 focus:border-emerald-500 focus:ring-emerald-500 bg-slate-50 focus:bg-white transition-all placeholder:text-slate-300"
                        placeholder="Jawab..."></textarea>
                </div>

                <!-- Soal 5 -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-700 block leading-relaxed">
                        5. Jika jajanan tersebut akan kamu jual di bazar dengan label 'Cita Rasa Jajanan Nusantara -
                        Sehat, Bergizi & Kekinian', inovasi
                        apa yang harus kamu lakukan pada bahan atau cara pengolahannya agar orang tertarik membeli namun
                        tetap mendapatkan manfaat kesehatan?
                    </label>
                    <textarea id="tanya5" rows="4"
                        class="w-full text-xs p-3 rounded-xl border border-slate-200 focus:border-emerald-500 focus:ring-emerald-500 bg-slate-50 focus:bg-white transition-all placeholder:text-slate-300"
                        placeholder="Jawab..."></textarea>
                </div>

            </div>

            <!-- Footer -->
            <div class="p-5 border-t border-slate-100 bg-slate-50/50">
                <button id="btnSubmitPemantik" onclick="submitPemantik()"
                    class="w-full py-3.5 rounded-xl bg-emerald-custom text-white font-bold text-sm shadow-lg shadow-emerald-500/20 active:scale-[0.98] transition-all hover:bg-emerald-600">
                    Kirim Jawaban
                </button>
            </div>
        </div>
    </div>
    <!-- MODAL MATERI BELAJAR (SLIDE) -->
    <div id="modalMateri"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/60 backdrop-blur-md p-0 md:p-4 animate-fade-in">
        <div
            class="bg-white w-full max-w-lg h-full md:h-auto md:max-h-[85vh] md:rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden relative">

            <!-- Progress Top -->
            <div class="absolute top-0 left-0 w-full h-1.5 bg-slate-100">
                <div id="materiProgressBar" class="h-full bg-emerald-500 transition-all duration-500"
                    style="width: 12.5%"></div>
            </div>

            <!-- Header -->
            <div class="px-6 pt-8 pb-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="size-10 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center">
                        <span class="material-symbols-outlined font-icon">menu_book</span>
                    </div>
                    <div>
                        <h3 class="text-sm font-black text-slate-800 leading-tight">Materi Hari 1</h3>
                        <p id="materiStepText" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">
                            Halaman 1 dari 8</p>
                    </div>
                </div>
                <button onclick="closeMateriModal()"
                    class="size-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-slate-100 transition-all">
                    <span class="material-symbols-outlined text-xl">close</span>
                </button>
            </div>

            <!-- Content Area -->
            <div id="materiContentArea" class="flex-1 overflow-y-auto px-6 py-4 no-scrollbar">

                <!-- SLIDE 1: PENGERTIAN -->
                <div id="slide-materi-0" class="animate-slide-up">
                    <div class="flex flex-col items-center text-center mb-6">
                        <span class="material-symbols-outlined text-5xl text-emerald-500 mb-2">info</span>
                        <h4 class="text-lg font-black text-slate-800 uppercase text-center w-full">BAGIAN I : PENGERTIAN
                            DAN RUANG LINGKUP JAJANAN NUSANTARA</h4>
                    </div>
                    <div class="space-y-4 text-sm text-slate-600 leading-relaxed font-medium text-justify">
                        <p>Jajanan Nusantara adalah makanan dan minuman tradisional khas Indonesia yang umumnya
                            dikonsumsi sebagai makanan selingan. Jajanan ini dibuat dari bahan-bahan lokal yang mudah
                            diperoleh di lingkungan sekitar masyarakat, seperti beras, ketan, singkong, ubi, kelapa,
                            gula aren, dan berbagai hasil pertanian lainnya. Proses pembuatannya dilakukan secara
                            sederhana dengan teknik tradisional yang diwariskan secara turun-temurun.</p>

                        <p>Jajanan Nusantara (sering disebut Jajanan Pasar) adalah berbagai jenis penganan atau camilan
                            tradisional khas Indonesia yang pada awalnya diperjualbelikan di pasar-pasar tradisional.
                            Secara terminologi, jajanan ini merupakan produk kuliner skala rumah tangga yang memiliki
                            karakteristik:</p>

                        <div class="bg-emerald-50 p-5 rounded-2xl border border-emerald-100 shadow-sm">
                            <ul class="space-y-3 text-xs text-slate-700">
                                <li class="flex gap-3 items-start">
                                    <span
                                        class="flex-shrink-0 size-5 bg-emerald-500 text-white rounded-full flex items-center justify-center font-bold text-[10px]">1</span>
                                    <span><strong>Porsi kecil (sekali makan).</strong></span>
                                </li>
                                <li class="flex gap-3 items-start">
                                    <span
                                        class="flex-shrink-0 size-5 bg-emerald-500 text-white rounded-full flex items-center justify-center font-bold text-[10px]">2</span>
                                    <span><strong>Harga terjangkau.</strong></span>
                                </li>
                                <li class="flex gap-3 items-start">
                                    <span
                                        class="flex-shrink-0 size-5 bg-emerald-500 text-white rounded-full flex items-center justify-center font-bold text-[10px]">3</span>
                                    <span><strong>Menggunakan bahan baku lokal yang segar tanpa pengawet
                                            kimia.</strong></span>
                                </li>
                                <li class="flex gap-3 items-start">
                                    <span
                                        class="flex-shrink-0 size-5 bg-emerald-500 text-white rounded-full flex items-center justify-center font-bold text-[10px]">4</span>
                                    <span><strong>Memiliki fungsi sosial sebagai sajian tamu, pelengkap upacara adat,
                                            hingga simbol syukur.</strong></span>
                                </li>
                            </ul>
                        </div>

                        <div class="bg-amber-50 p-4 rounded-xl border-l-4 border-amber-400">
                            <p class="text-xs text-slate-700">Jajanan Nusantara tidak hanya memiliki fungsi sebagai
                                pemenuh kebutuhan pangan, tetapi juga memiliki nilai budaya, sosial, dan ekonomi. Dalam
                                kehidupan masyarakat, jajanan tradisional sering disajikan pada acara adat, kegiatan
                                keagamaan, perayaan keluarga, hingga kegiatan gotong royong. Oleh karena itu, jajanan
                                Nusantara merupakan bagian dari warisan budaya bangsa yang perlu dijaga dan
                                dikembangkan.</p>
                        </div>
                    </div>
                </div>

                <!-- SLIDE 2: SEJARAH -->
                <!-- SLIDE 2: SEJARAH -->
                <div id="slide-materi-1" class="hidden animate-slide-up">
                    <div class="flex flex-col items-center text-center mb-6">
                        <span class="material-symbols-outlined text-5xl text-amber-500 mb-2">history</span>
                        <h4 class="text-lg font-black text-slate-800 uppercase text-center w-full">BAGIAN 2: SEJARAH DAN
                            PERKEMBANGAN JAJANAN NUSANTARA</h4>
                    </div>
                    <div class="space-y-4 text-sm text-slate-600 leading-relaxed font-medium text-justify">
                        <p>Sejarah jajanan Nusantara tidak terlepas dari perkembangan peradaban masyarakat Indonesia.
                            Cita rasa jajanan kita tidak lahir di ruang hampa, melainkan hasil perjalanan sejarah yang
                            panjang:</p>

                        <div class="space-y-3">
                            <!-- Era Kerajaan - Lokal -->
                            <div class="relative pl-4 border-l-4 border-emerald-500 bg-emerald-50/50 p-3 rounded-r-xl">
                                <p class="font-black text-emerald-800 text-xs uppercase mb-1 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm">forest</span> 1. Era Kerajaan
                                    (Lokal)
                                </p>
                                <p class="text-xs text-slate-700">Pada masa awal, masyarakat memanfaatkan bahan pangan
                                    yang tersedia di alam, seperti umbi-umbian (singkong, ubi), kelapa, dan gula aren,
                                    untuk memenuhi kebutuhan energi. Ini adalah "akar" rasa asli Nusantara. Teknik
                                    pengolahan yang digunakan masih sangat sederhana, seperti merebus, mengukus, dan
                                    membakar.</p>
                            </div>

                            <!-- Pengaruh Tionghoa -->
                            <div class="relative pl-4 border-l-4 border-red-500 bg-red-50/50 p-3 rounded-r-xl">
                                <p class="font-black text-red-800 text-xs uppercase mb-1 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm">temple_buddhist</span> 2. Pengaruh
                                    Tionghoa (Abad ke-7)
                                </p>
                                <p class="text-xs text-slate-700">Masuknya budaya asing memberikan pengaruh besar
                                    terhadap perkembangan jajanan Nusantara. Pengaruh Tionghoa memperkenalkan penggunaan
                                    tepung, isian kacang-kacangan, serta teknik menggoreng (istilah "Kue" berasal dari
                                    kata Bak-Kue). Beberapa jajanan yang lahir dari akulturasi budaya ini antara lain
                                    Bakpia, Onde-onde, dan Kue Ku.</p>
                            </div>

                            <!-- Pengaruh Eropa -->
                            <div class="relative pl-4 border-l-4 border-blue-500 bg-blue-50/50 p-3 rounded-r-xl">
                                <p class="font-black text-blue-800 text-xs uppercase mb-1 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm">castle</span> 3. Pengaruh Eropa (Era
                                    Kolonial)
                                </p>
                                <p class="text-xs text-slate-700">Pada masa kolonial, pengaruh bangsa Belanda membawa
                                    budaya Indo-Europeesche yang semakin memperkaya ragam jajanan Nusantara. Masyarakat
                                    mulai mengenal penggunaan mentega (butter), susu, telur, serta teknik memanggang
                                    menggunakan oven. Dari pengaruh ini lahirlah kue-kue seperti Lapis Legit,
                                    Klappertaart, dan Pastel.</p>
                            </div>
                        </div>

                        <div class="bg-amber-100 p-4 rounded-xl border-t-4 border-amber-500 shadow-sm text-center">
                            <p class="text-xs font-bold text-amber-900 italic">"Perpaduan berbagai pengaruh budaya
                                tersebut menjadikan jajanan Nusantara memiliki keragaman rasa, bentuk, dan teknik
                                pengolahan yang sangat kaya."</p>
                        </div>
                    </div>
                </div>

                <!-- SLIDE 3: TEKNIK -->
                <div id="slide-materi-2" class="hidden animate-slide-up">
                    <div class="flex flex-col items-center text-center mb-6">
                        <span class="material-symbols-outlined text-5xl text-orange-500 mb-2">cooking</span>
                        <h4 class="text-lg font-black text-slate-800 uppercase text-center w-full">BAGIAN III: TEKNIK
                            PENGOLAHAN JAJANAN TRADISIONAL DAN MODERN</h4>
                    </div>
                    <div class="space-y-4 text-sm text-slate-600 leading-relaxed font-medium text-justify">
                        <p>Teknik pengolahan merupakan faktor penting dalam menentukan rasa, tekstur, aroma, serta
                            kandungan gizi jajanan Nusantara.</p>

                        <!-- A. Teknik Tradisional -->
                        <div class="bg-orange-50 border border-orange-200 rounded-2xl p-4">
                            <h5 class="font-black text-orange-800 text-sm mb-3 flex items-center gap-2">
                                <span class="material-symbols-outlined">skillet</span> A. Teknik Pengolahan Tradisional
                            </h5>
                            <ul class="space-y-3 text-xs text-slate-700">
                                <li>
                                    <strong>Mengukus (Steaming):</strong> Teknik memasak dengan menggunakan uap air
                                    panas. Teknik ini mempertahankan kandungan gizi karena makanan tidak bersentuhan
                                    langsung dengan air. Menghasilkan tekstur lembut dan lembap. <br><span
                                        class="text-orange-600 italic">Contoh: Nagasari, Kue Talam, Putu Ayu, Bolu
                                        Kukus.</span>
                                </li>
                                <li>
                                    <strong>Merebus (Boiling):</strong> Dilakukan dengan memasukkan bahan ke dalam air
                                    mendidih. Teknik ini banyak digunakan untuk jajanan berbahan dasar tepung ketan yang
                                    membutuhkan tekstur kenyal. <br><span class="text-orange-600 italic">Contoh: Klepon,
                                        Cenil, Biji Salak, Kolak.</span>
                                </li>
                                <li>
                                    <strong>Membakar/Memanggang Tradisional:</strong> Teknik ini menggunakan bara api
                                    atau arang dan sering memanfaatkan daun pisang sebagai pembungkus untuk aroma
                                    karbon/smoky yang khas. <br><span class="text-orange-600 italic">Contoh: Lemper
                                        Bakar, Wingko Babat, Kue Pancong.</span>
                                </li>
                                <li>
                                    <strong>Menyangrai (Pan-Toasting):</strong> Memasak bahan tanpa minyak untuk
                                    mendapatkan aroma kacang atau kelapa yang kuat dan memperpanjang daya simpan.
                                    <br><span class="text-orange-600 italic">Contoh: Kue Sagon, Enting-enting
                                        Kacang.</span>
                                </li>
                                <li>
                                    <strong>Menggoreng:</strong> Teknik memasak dengan minyak panas yang menghasilkan
                                    tekstur renyah. <br><span class="text-orange-600 italic">Contoh: Pisang Goreng,
                                        Onde-onde, Pastel.</span>
                                </li>
                            </ul>
                        </div>

                        <!-- B. Teknik Modern -->
                        <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4">
                            <h5 class="font-black text-blue-800 text-sm mb-3 flex items-center gap-2">
                                <span class="material-symbols-outlined">smart_toy</span> B. Teknik Pengolahan Modern
                                (Inovasi)
                            </h5>
                            <ul class="space-y-3 text-xs text-slate-700">
                                <li>
                                    <strong>Pemanggangan Oven:</strong> Menggunakan oven listrik atau gas untuk
                                    menghasilkan kematangan merata. <br><span class="text-blue-600 italic">Contoh:
                                        Brownies Tradisional, Bolu Panggang.</span>
                                </li>
                                <li>
                                    <strong>Air Fryer:</strong> Teknik modern yang menggunakan sirkulasi udara panas
                                    sehingga mengurangi penggunaan minyak secara signifikan. <br><span
                                        class="text-blue-600 italic">Contoh: Rengginang Panggang, Pastel Sehat.</span>
                                </li>
                                <li>
                                    <strong>Blending dan Puree:</strong> Digunakan untuk menghaluskan bahan seperti buah
                                    dan sayuran sebagai campuran adonan untuk nutrisi tambahan. <br><span
                                        class="text-blue-600 italic">Contoh: Dadar Gulung Bayam, Klepon Ubi Ungu.</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- SLIDE 4: ATLAS KULINER -->
                <!-- SLIDE 4: ATLAS KULINER -->
                <div id="slide-materi-3" class="hidden animate-slide-up">
                    <div class="flex flex-col items-center text-center mb-6">
                        <span class="material-symbols-outlined text-5xl text-indigo-500 mb-2">map</span>
                        <h4 class="text-lg font-black text-slate-800 uppercase text-center w-full">BAGIAN IV: JENIS DAN
                            KARAKTERISTIK JAJANAN DAN MINUMAN NUSANTARA</h4>
                    </div>
                    <div class="space-y-4 text-xs font-medium text-slate-600 text-justify">

                        <!-- A. WILAYAH SUMATRA -->
                        <div class="border border-indigo-100 rounded-2xl overflow-hidden">
                            <div class="bg-indigo-50 p-3 border-b border-indigo-100">
                                <h5 class="font-black text-indigo-800 text-sm flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">location_on</span> A. Wilayah
                                    Sumatra
                                </h5>
                            </div>
                            <div class="p-4 space-y-3 bg-white">
                                <div class="grid grid-cols-1 gap-2">
                                    <p><strong class="text-indigo-700">Aceh:</strong> <br>🍽️ Timphan<br>Bahan utama :
                                        tepung ketan, pisang/srikaya, santan<br>☕ Kopi Aceh<br>Bahan utama : biji kopi
                                        arabika</p>
                                    <hr class="border-dashed border-slate-100">
                                    <p><strong class="text-indigo-700">Sumatra Utara:</strong> <br>🍽️ Bika
                                        Ambon<br>Bahan utama : tepung tapioka, telur, santan<br>☕ Bandrek<br>Bahan utama
                                        : jahe, gula aren</p>
                                    <hr class="border-dashed border-slate-100">
                                    <p><strong class="text-indigo-700">Sumatra Barat:</strong> <br>🍽️ Kipang
                                        Kacang<br>Bahan utama : kacang tanah, gula merah<br>☕ Teh Talua<br>Bahan utama :
                                        telur ayam, teh, gula</p>
                                    <hr class="border-dashed border-slate-100">
                                    <p><strong class="text-indigo-700">Riau:</strong> <br>🍽️ Bolu Kemojo<br>Bahan utama
                                        : telur, santan, tepung terigu<br>☕ Air Mata Pengantin<br>Bahan utama : nata de
                                        coco, sirup, selasih</p>
                                    <hr class="border-dashed border-slate-100">
                                    <p><strong class="text-indigo-700">Sumatra Selatan:</strong> <br>🍽️ Kue
                                        Srikaya<br>Bahan utama : telur, santan, gula<br>☕ Es Kacang Merah<br>Bahan utama
                                        : kacang merah, gula</p>
                                    <hr class="border-dashed border-slate-100">
                                    <p><strong class="text-indigo-700">Kep. Bangka Belitung:</strong> <br>🍽️
                                        Kemplang<br>Bahan utama : ikan tenggiri, tepung tapioka<br>☕ Es Jeruk
                                        Kunci<br>Bahan utama : jeruk kunci</p>
                                </div>
                            </div>
                        </div>

                        <!-- B. WILAYAH JAWA -->
                        <div class="border border-emerald-100 rounded-2xl overflow-hidden">
                            <div class="bg-emerald-50 p-3 border-b border-emerald-100">
                                <h5 class="font-black text-emerald-800 text-sm flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">temple_hindu</span> B. Wilayah Jawa
                                </h5>
                            </div>
                            <div class="p-4 space-y-3 bg-white">
                                <div class="grid grid-cols-1 gap-2">
                                    <p><strong class="text-emerald-700">DKI Jakarta:</strong> <br>🍽️ Kue Cucur<br>Bahan
                                        utama : tepung beras, gula merah<br>☕ Bir Pletok<br>Bahan utama : jahe, serai,
                                        kayu secang</p>
                                    <hr class="border-dashed border-slate-100">
                                    <p><strong class="text-emerald-700">Jawa Barat:</strong> <br>🍽️ Peuyeum<br>Bahan
                                        utama : singkong, ragi<br>☕ Bandrek<br>Bahan utama : jahe, gula aren</p>
                                    <hr class="border-dashed border-slate-100">
                                    <p><strong class="text-emerald-700">Jawa Tengah:</strong> <br>🍽️ Getuk<br>Bahan
                                        utama : singkong, gula kelapa<br>☕ Wedang Jahe<br>Bahan utama : jahe, gula merah
                                    </p>
                                    <hr class="border-dashed border-slate-100">
                                    <p><strong class="text-emerald-700">DI Yogyakarta:</strong> <br>🍽️ Kipo<br>Bahan
                                        utama : tepung ketan, kelapa<br>☕ Wedang Uwuh<br>Bahan utama : jahe, kayu secang
                                    </p>
                                    <hr class="border-dashed border-slate-100">
                                    <p><strong class="text-emerald-700">Jawa Timur:</strong> <br>🍽️ Klepon<br>Bahan
                                        utama : tepung ketan, gula merah<br>☕ Sinom<br>Bahan utama : daun asam muda,
                                        kunyit</p>
                                </div>
                            </div>
                        </div>

                        <!-- C. WILAYAH LAINNYA -->
                        <div class="border border-amber-100 rounded-2xl overflow-hidden">
                            <div class="bg-amber-50 p-3 border-b border-amber-100">
                                <h5 class="font-black text-amber-800 text-sm flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">public</span> C. Wilayah Bali,
                                    Sulawesi dan Papua
                                </h5>
                            </div>
                            <div class="p-4 space-y-3 bg-white">
                                <div class="grid grid-cols-1 gap-2">
                                    <p><strong class="text-amber-700">Bali:</strong> <br>🍽️ Jaja Laklak<br>Bahan utama
                                        : tepung beras, kelapa<br>☕ Es Daluman<br>Bahan utama : cincau hijau</p>
                                    <hr class="border-dashed border-slate-100">
                                    <p><strong class="text-amber-700">Sulawesi Utara:</strong> <br>🍽️
                                        Klappertaart<br>Bahan utama : kelapa, susu, telur<br>☕ Sarabba<br>Bahan utama :
                                        jahe, gula aren, santan</p>
                                    <hr class="border-dashed border-slate-100">
                                    <p><strong class="text-amber-700">Papua:</strong> <br>🍽️ Sagu Lempeng<br>Bahan
                                        utama : sagu<br>☕ Kopi Papua<br>Bahan utama : biji kopi</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- SLIDE 5: GIZI -->
                <div id="slide-materi-4" class="hidden animate-slide-up">
                    <div class="flex flex-col items-center text-center mb-6">
                        <span class="material-symbols-outlined text-5xl text-rose-500 mb-2">nutrition</span>
                        <h4 class="text-lg font-black text-slate-800">Bagian V: Analisis Kandungan Gizi</h4>
                    </div>
                    <div class="space-y-4 px-2">
                        <div class="overflow-x-auto rounded-xl border border-slate-200">
                            <table class="w-full text-left text-[9px]">
                                <thead class="bg-slate-50 border-b border-slate-200 text-slate-700">
                                    <tr>
                                        <th class="p-2 font-black">Asal Wilayah/Provinsi</th>
                                        <th class="p-2 font-black">Bahan Utama</th>
                                        <th class="p-2 font-black">Kandungan Utama Zat Gizi</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 font-medium text-slate-600">
                                    <tr>
                                        <td class="p-2">Sumatra Utara (Medan)</td>
                                        <td class="p-2">Kuning telur, santan, tapioka</td>
                                        <td class="p-2">Energi, lemak, karbohidrat sederhana</td>
                                    </tr>
                                    <tr>
                                        <td class="p-2">Sumatra Selatan (Palembang)</td>
                                        <td class="p-2">Kuning telur, santan, gula</td>
                                        <td class="p-2">Protein (telur), karbohidrat</td>
                                    </tr>
                                    <tr>
                                        <td class="p-2">Lampung</td>
                                        <td class="p-2">Kuning telur, mentega, gula</td>
                                        <td class="p-2">Lemak jenuh, energi tinggi</td>
                                    </tr>
                                    <tr>
                                        <td class="p-2">Jawa Barat</td>
                                        <td class="p-2">Tepung beras, santan, kelapa</td>
                                        <td class="p-2">Karbohidrat, serat (kelapa)</td>
                                    </tr>
                                    <tr>
                                        <td class="p-2">Jawa Tengah</td>
                                        <td class="p-2">Singkong, gula jawa</td>
                                        <td class="p-2">Serat pangan, karbohidrat kompleks</td>
                                    </tr>
                                    <tr>
                                        <td class="p-2">Yogyakarta</td>
                                        <td class="p-2">Tepung terigu, kacang hijau</td>
                                        <td class="p-2">Protein nabati, serat</td>
                                    </tr>
                                    <tr>
                                        <td class="p-2">Jawa Timur</td>
                                        <td class="p-2">Tepung beras, kelapa, gula aren</td>
                                        <td class="p-2">Energi, elektrolit (gula kelapa)</td>
                                    </tr>
                                    <tr>
                                        <td class="p-2">Bali</td>
                                        <td class="p-2">Tepung beras, santan</td>
                                        <td class="p-2">Karbohidrat</td>
                                    </tr>
                                    <tr>
                                        <td class="p-2">Sulawesi Selatan</td>
                                        <td class="p-2">Pisang, santan, telur</td>
                                        <td class="p-2">Kalium (pisang), protein</td>
                                    </tr>
                                    <tr>
                                        <td class="p-2">Nusa Tenggara Barat</td>
                                        <td class="p-2">Ubi jalar/singkong, kelapa</td>
                                        <td class="p-2">Serat, karbohidrat kompleks</td>
                                    </tr>
                                    <tr>
                                        <td class="p-2">Papua</td>
                                        <td class="p-2">Pati sagu alami</td>
                                        <td class="p-2">Karbohidrat kompleks, rendah gluten</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <p class="text-[10px] text-slate-500 italic bg-amber-50 p-3 rounded-xl border border-amber-100">
                            Jajanan Nusantara berbasis umbi-umbian (singkong, ubi, sagu) cenderung lebih kaya serat
                            dibandingkan berbasis tepung terigu.</p>
                    </div>
                </div>

                <!-- SLIDE 6: INOVASI -->
                <div id="slide-materi-5" class="hidden animate-slide-up">
                    <div class="flex flex-col items-center text-center mb-6">
                        <span class="material-symbols-outlined text-5xl text-cyan-500 mb-2">lightbulb</span>
                        <h4 class="text-lg font-black text-slate-800">Bagian VI: Strategi Inovasi</h4>
                    </div>
                    <div class="space-y-4 text-sm text-slate-600 leading-relaxed font-medium text-justify">
                        <p>Agar jajanan tradisional lebih sehat, bergizi dan kekinian namun tetap diminati di bazar,
                            diperlukan
                            inovasi di dua sisi:</p>
                        <div class="space-y-3">
                            <div class="p-4 bg-white border-2 border-dashed border-slate-100 rounded-2xl shadow-sm">
                                <p class="text-xs font-black text-cyan-700 uppercase mb-2 flex items-center gap-2"><span
                                        class="material-symbols-outlined text-sm">add_moderator</span> Fortifikasi
                                    Nutrisi</p>
                                <p class="text-[11px]">Menambahkan sayuran (seperti wortel atau bayam goreng halus) ke
                                    isi panada, atau menggunakan puree pisang asli yang lebih banyak untuk Barongko
                                    sebagai pengganti pemanis buatan.</p>
                            </div>
                            <div class="p-4 bg-white border-2 border-dashed border-slate-100 rounded-2xl shadow-sm">
                                <p class="text-xs font-black text-emerald-700 uppercase mb-2 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm">published_with_changes</span>
                                    Substitusi Bahan Lebih Sehat
                                </p>
                                <p class="text-[11px]">Mengganti gula pasir dengan gula aren murni yang rendah indeks
                                    glikemik, atau menggunakan metode "Air Fryer" untuk jajanan yang biasanya digoreng
                                    terendam minyak (deep-fry).</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SLIDE 7: BAZAR -->
                <div id="slide-materi-6" class="hidden animate-slide-up">
                    <div class="flex flex-col items-center text-center mb-6">
                        <span class="material-symbols-outlined text-5xl text-purple-500 mb-2">storefront</span>
                        <h4 class="text-lg font-black text-slate-800">Bagian VII: Manajemen Bazar</h4>
                    </div>
                    <div class="space-y-4 text-sm text-slate-600 leading-relaxed font-medium text-justify">
                        <p>Penjualan di bazar memerlukan perencanaan matang agar produk 'Kuliner Sehat' dilirik
                            pengunjung:</p>
                        <ul class="space-y-2 text-xs">
                            <li class="p-3 bg-slate-50 rounded-xl flex gap-3"><span
                                    class="font-bold text-purple-600">01.</span>
                                <strong>Unique Selling Point
                                    (USP):</strong> Berikan label jelas bahwa jajanan ini adalah versi sehat (misal:
                                "Klepon Gula Aren Murni - Tanpa Pengawet").
                            </li>
                            <li class="p-3 bg-slate-50 rounded-xl flex gap-3"><span
                                    class="font-bold text-purple-600">02.</span>
                                <strong>Visual Display:</strong> Tata
                                stand dengan tema tradisional namun modern (estetika tinggi) untuk menarik perhatian
                                generasi muda.
                            </li>
                            <li class="p-3 bg-slate-50 rounded-xl flex gap-3"><span
                                    class="font-bold text-purple-600">03.</span>
                                <strong>Interaksi & Tester:</strong>
                                Sediakan contoh kecil (tester) dan jelaskan manfaat kesehatan dari inovasi yang telah
                                dilakukan.
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- SLIDE 8: KEMASAN -->
                <div id="slide-materi-7" class="hidden animate-slide-up">
                    <div class="flex flex-col items-center text-center mb-6">
                        <span class="material-symbols-outlined text-5xl text-sky-500 mb-2">package_2</span>
                        <h4 class="text-lg font-black text-slate-800">Bagian VIII: Pengemasan & Labeling</h4>
                    </div>
                    <div class="space-y-4 text-sm text-slate-600 leading-relaxed font-medium text-justify">
                        <p>Kemasan adalah wajah pertama produk Anda. Untuk produk kuliner sehat, kemasan harus memenuhi
                            tiga kriteria:</p>
                        <div class="bg-sky-50 p-5 rounded-3xl border border-sky-100 space-y-4">
                            <div class="flex gap-3">
                                <span class="text-lg">♻️</span>
                                <div>
                                    <p class="font-bold text-sky-900 text-xs">Keamanan & Keberlanjutan</p>
                                    <p class="text-[11px] text-sky-700">Gunakan wadah ramah lingkungan (bambu, daun,
                                        atau wadah bio-degradable) yang aman bagi makanan.</p>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <span class="text-lg">🏷️</span>
                                <div>
                                    <p class="font-bold text-sky-900 text-xs">Informasi Transparan</p>
                                    <p class="text-[11px] text-sky-700">Cantumkan informasi bahan utama dan manfaat
                                        nutrisi pada label untuk meyakinkan pembeli bahwa produk memang sehat.</p>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <span class="text-lg">🎨</span>
                                <div>
                                    <p class="font-bold text-sky-900 text-xs">Design Estetik</p>
                                    <p class="text-[11px] text-sky-700">Gunakan grafis yang menarik yang mencerminkan
                                        kualitas premium produk Anda.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SLIDE 9: RINGKASAN (NEW) -->
                <div id="slide-materi-8" class="hidden animate-slide-up h-full flex flex-col">
                    <div class="flex flex-col items-center text-center mb-4">
                        <span class="material-symbols-outlined text-4xl text-emerald-500 mb-1">edit_document</span>
                        <h4 class="text-lg font-black text-slate-800">Bagian IX: Ringkasan Materi</h4>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Tuliskan apa yang kamu
                            pelajari hari ini</p>
                    </div>

                    <div id="materiStatusMsg" class="hidden mb-4 p-3 rounded-2xl text-[11px] font-medium border"></div>

                    <div class="flex-1 flex flex-col gap-3">
                        <div class="relative flex-1">
                            <textarea id="summaryArea" oninput="updateWordCount()"
                                class="w-full h-full min-h-[200px] bg-slate-50 border border-slate-200 rounded-2xl p-4 text-xs text-slate-700 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all resize-none font-medium leading-relaxed"
                                placeholder="Tuliskan ringkasan materi minimal 200 kata..."></textarea>
                            <div class="absolute bottom-3 right-4">
                                <span id="wordCounter"
                                    class="text-[10px] font-bold text-slate-400 bg-white/80 backdrop-blur px-2 py-1 rounded-lg border border-slate-100">0
                                    / 200 kata</span>
                            </div>
                        </div>

                        <div class="bg-amber-50 p-3 rounded-2xl border border-amber-100/50 flex gap-3">
                            <span class="material-symbols-outlined text-amber-500 text-lg">info</span>
                            <p class="text-[10px] text-amber-700 font-medium leading-relaxed">
                                <b>Penting:</b> Ringkasan ini akan diperiksa oleh Fasilitator. Kamu baru dianggap
                                menyelesaikan materi setelah mendapat review.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slide Navigation Bar -->
            <div class="px-6 pb-2">
                <div
                    class="flex items-center justify-between bg-slate-50/50 p-1.5 rounded-2xl border border-slate-100 overflow-x-auto no-scrollbar gap-1.5">
                    <button id="nav-pill-0" onclick="goToSlide(0)"
                        class="size-7 rounded-lg bg-emerald-500 text-white text-[9px] font-bold flex items-center justify-center shadow-md shadow-emerald-200 transition-all shrink-0">1</button>
                    <button id="nav-pill-1" onclick="goToSlide(1)"
                        class="size-7 rounded-lg bg-slate-50 text-slate-400 text-[9px] font-bold flex items-center justify-center hover:bg-slate-100 transition-all shrink-0">2</button>
                    <button id="nav-pill-2" onclick="goToSlide(2)"
                        class="size-7 rounded-lg bg-slate-50 text-slate-400 text-[9px] font-bold flex items-center justify-center hover:bg-slate-100 transition-all shrink-0">3</button>
                    <button id="nav-pill-3" onclick="goToSlide(3)"
                        class="size-7 rounded-lg bg-slate-50 text-slate-400 text-[9px] font-bold flex items-center justify-center hover:bg-slate-100 transition-all shrink-0">4</button>
                    <button id="nav-pill-4" onclick="goToSlide(4)"
                        class="size-7 rounded-lg bg-slate-50 text-slate-400 text-[9px] font-bold flex items-center justify-center hover:bg-slate-100 transition-all shrink-0">5</button>
                    <button id="nav-pill-5" onclick="goToSlide(5)"
                        class="size-7 rounded-lg bg-slate-50 text-slate-400 text-[9px] font-bold flex items-center justify-center hover:bg-slate-100 transition-all shrink-0">6</button>
                    <button id="nav-pill-6" onclick="goToSlide(6)"
                        class="size-7 rounded-lg bg-slate-50 text-slate-400 text-[9px] font-bold flex items-center justify-center hover:bg-slate-100 transition-all shrink-0">7</button>
                    <button id="nav-pill-7" onclick="goToSlide(7)"
                        class="size-7 rounded-lg bg-slate-50 text-slate-400 text-[9px] font-bold flex items-center justify-center hover:bg-slate-100 transition-all shrink-0">8</button>
                    <button id="nav-pill-8" onclick="goToSlide(8)"
                        class="size-7 rounded-lg bg-slate-50 text-slate-400 text-[9px] font-bold flex items-center justify-center hover:bg-slate-100 transition-all shrink-0">9</button>
                </div>
            </div>

            <!-- Footer Controls -->
            <div class="p-6 border-t border-slate-50 bg-white flex gap-3">
                <button id="btnPrevMateri" onclick="prevMateriSlide()"
                    class="flex-1 py-3.5 rounded-2xl bg-slate-50 text-slate-400 font-bold text-xs transition-all invisible">Kembali</button>
                <button id="btnNextMateri" onclick="nextMateriSlide()"
                    class="flex-[3] py-3.5 rounded-2xl bg-emerald-500 text-white font-bold text-xs shadow-lg shadow-emerald-500/20 active:scale-95">Selanjutnya</button>
                <button id="btnFinishMateri" onclick="settleMateri()"
                    class="flex-[3] py-3.5 rounded-2xl bg-emerald-600 text-white font-bold text-xs shadow-lg shadow-emerald-500/30 transition-all active:scale-95 hidden">Selesaikan
                    Materi</button>
            </div>
        </div>
    </div>

    <!-- MODAL VIDEO PEMBELAJARAN -->
    <div id="modalVideo"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="p-8 border-b flex justify-between items-center bg-red-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-red-500 text-white flex items-center justify-center shadow-lg shadow-red-200">
                        <span class="material-symbols-outlined !text-2xl">play_circle</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">Video Pembelajaran</h3>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Tonton semua &
                            ringkas</p>
                    </div>
                </div>
                <button onclick="closeVideoModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Content -->
            <div class="p-6 overflow-y-auto no-scrollbar flex-1 space-y-6">
                <!-- Video 1 -->
                <div class="space-y-2">
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">Video Pembelajaran 1</p>
                    <div class="aspect-video w-full rounded-2xl overflow-hidden shadow-sm bg-slate-100">
                        <iframe class="w-full h-full" src="https://www.youtube.com/embed/zNq-rD5FFjM" title="Video 1"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen></iframe>
                    </div>
                </div>

                <!-- Video 2 -->
                <div class="space-y-2">
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">Video Pembelajaran 2</p>
                    <div class="aspect-video w-full rounded-2xl overflow-hidden shadow-sm bg-slate-100">
                        <iframe class="w-full h-full" src="https://www.youtube.com/embed/E-Xiiqkuils" title="Video 2"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen></iframe>
                    </div>
                </div>

                <!-- Video 3 -->
                <div class="space-y-2">
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">Video Pembelajaran 3</p>
                    <div class="aspect-video w-full rounded-2xl overflow-hidden shadow-sm bg-slate-100">
                        <iframe class="w-full h-full" src="https://www.youtube.com/embed/qAHQVt7LoTA" title="Video 3"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen></iframe>
                    </div>
                </div>

                <!-- Ringkasan Form -->
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 space-y-3 relative">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-indigo-500 text-lg">edit_note</span>
                            <h4 class="text-sm font-black text-slate-800">Ringkasan Materi</h4>
                        </div>
                        <span id="videoWordCountDisplay"
                            class="text-[10px] font-bold text-red-500 bg-white/50 px-2 py-1 rounded-lg border border-red-100">0
                            / 100 kata</span>
                    </div>
                    <textarea id="videoSummaryInput" rows="4" oninput="updateVideoWordCount()"
                        class="w-full rounded-xl border-slate-200 text-sm focus:border-red-500 focus:ring-red-500 p-3"
                        placeholder="Tuliskan poin-poin penting dari ketiga video di atas (minimal 100 kata)..."></textarea>
                </div>

                <!-- Penilaian Fasil (Dynamic) -->
                <div id="videoStatusSection" class="hidden"></div>

                <!-- Placeholder Penilaian (Hidden if logic above works) -->
                <div id="videoFeedbackPlaceholder"
                    class="bg-amber-50 p-4 rounded-2xl border border-amber-100 flex flex-col items-center gap-2">
                    <p class="text-[10px] font-bold text-amber-700 uppercase tracking-widest">Penilaian Fasilitator</p>
                    <div class="flex gap-1">
                        <span class="material-symbols-outlined text-slate-300 text-2xl">star</span>
                        <span class="material-symbols-outlined text-slate-300 text-2xl">star</span>
                        <span class="material-symbols-outlined text-slate-300 text-2xl">star</span>
                        <span class="material-symbols-outlined text-slate-300 text-2xl">star</span>
                        <span class="material-symbols-outlined text-slate-300 text-2xl">star</span>
                    </div>
                    <p class="text-[10px] text-slate-400">Akan dinilai setelah ringkasan dikirim</p>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-8 bg-white border-t">
                <button id="btnSubmitVideo" onclick="submitVideoLog()" disabled
                    class="w-full py-4 bg-slate-300 text-white rounded-2xl font-black shadow-none transition-all cursor-not-allowed">
                    Simpan Ringkasan & Selesai
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL ASSESSMENT (REPLACEMENT) -->
    <div id="modalAssessment"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="p-6 border-b flex justify-between items-center bg-indigo-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-indigo-500 text-white flex items-center justify-center shadow-lg shadow-indigo-200">
                        <span class="material-symbols-outlined !text-2xl">quiz</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">Assessment</h3>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Uji Pemahamanmu</p>
                    </div>
                </div>
                <button onclick="closeAssessmentModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Content -->
            <div class="p-6 flex-1 overflow-y-auto no-scrollbar relative">
                <!-- Progress -->
                <div class="w-full bg-slate-100 h-2 rounded-full mb-2 overflow-hidden">
                    <div id="assessmentProgressBar" class="h-full bg-indigo-500 w-0 transition-all duration-300"></div>
                </div>
                <p id="assessmentProgressText" class="text-[10px] text-slate-400 font-bold mb-6 text-right">Soal 1 dari
                    50</p>

                <!-- Question Container -->
                <div id="assessmentQuestionContainer" class="animate-slide-up">
                    <!-- Dynamic Question Content Here -->
                </div>

                <!-- Result Container (Hidden initially) -->
                <div id="assessmentResultContainer"
                    class="hidden flex-col items-center justify-center text-center space-y-6 py-10 animate-scale-up">
                    <div class="size-24 bg-amber-100 rounded-full flex items-center justify-center mb-2 mx-auto">
                        <span class="text-6xl">🏆</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-slate-800 mb-2">Luar Biasa!</h2>
                        <p class="text-xs text-slate-500">Kamu telah menyelesaikan assessment.</p>
                    </div>

                    <div id="resultStars" class="flex gap-2 justify-center">
                        <!-- Stars injected here -->
                    </div>

                    <p id="resultScoreText"
                        class="text-lg font-bold text-indigo-600 bg-indigo-50 px-6 py-2 rounded-2xl"></p>

                    <button onclick="closeAssessmentModal()"
                        class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition-all">
                        Tutup & Simpan
                    </button>
                </div>

                <!-- Navigation Button (Outside result) -->
                <button id="btnNextAssessment"
                    class="px-6 py-3 bg-indigo-500 text-white rounded-xl font-bold text-xs shadow-lg shadow-indigo-200 active:scale-95 transition-all w-full mt-6">
                    Selanjutnya
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DOKUMENTASI FOTO (REPLACEMENT RANGKUMAN) -->
    <div id="modalDokumentasi"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-8 border-b flex justify-between items-center bg-slate-50/50">
                <div class="flex items-center gap-4">
                    <div
                        class="size-12 rounded-2xl bg-indigo-500 text-white flex items-center justify-center shadow-lg shadow-indigo-200">
                        <span class="material-symbols-outlined !text-2xl">photo_camera</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800">Dokumentasi Foto</h3>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Hanya 1
                            foto terbaik
                            setiap hari</p>
                    </div>
                </div>
                <button onclick="closeDokumentasiModal()"
                    class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-all">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="p-8 overflow-y-auto no-scrollbar flex-1">
                <div id="docStatusMsg" class="hidden"></div>

                <div id="docUploadArea" class="space-y-6">
                    <div
                        class="p-8 border-2 border-dashed border-slate-200 rounded-[2rem] bg-slate-50 flex flex-col items-center justify-center text-center group hover:border-indigo-400 transition-all cursor-pointer relative">
                        <input type="file" accept="image/*" capture="environment"
                            onchange="handleDocPhotoSelection(event)" class="absolute inset-0 opacity-0 cursor-pointer"
                            id="docInput">
                        <div
                            class="size-16 rounded-full bg-white shadow-sm flex items-center justify-center text-indigo-500 mb-4 group-hover:scale-110 transition-transform">
                            <span class="material-symbols-outlined !text-3xl">add_a_photo</span>
                        </div>
                        <p class="text-sm font-bold text-slate-700">Ambil Foto Kegiatan</p>
                        <p class="text-[11px] text-slate-400 mt-1">Gunakan kamera HP untuk hasil terbaik</p>
                    </div>

                    <div class="bg-amber-50 p-4 rounded-2xl border border-amber-100 flex gap-3">
                        <span class="material-symbols-outlined text-amber-500 text-lg">info</span>
                        <p class="text-[11px] text-amber-700 font-medium leading-relaxed">
                            Foto akan dikompresi otomatis untuk menghemat kuota. Pastikan objek foto
                            terlihat jelas.
                        </p>
                    </div>
                </div>

                <div class="mt-6 flex justify-center">
                    <img id="docPreview"
                        class="hidden w-full max-h-64 object-cover rounded-2xl border-4 border-white shadow-xl" src=""
                        alt="Preview">
                </div>
            </div>

            <div class="p-8 bg-slate-50 border-t">
                <button id="btnUploadDokumentasi" onclick="submitDokumentasi()"
                    class="w-full py-5 bg-indigo-500 text-white rounded-2xl font-black shadow-lg shadow-indigo-200 active:scale-95 transition-all disabled:opacity-50 disabled:active:scale-100">
                    Kirim Dokumentasi
                </button>
            </div>
        </div>
    </div>
    <script>
        // VIDEO MODAL LOGIC
        function openVideoModal() {
            const modal = document.getElementById('modalVideo');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');

                checkExistingVideo(); // Cek status terbaru saat buka modal

                // Load existing summary if any
                const summary = localStorage.getItem(`video_summary_day${currentDay}`) || '';
                if (document.getElementById('videoSummaryInput')) {
                    const input = document.getElementById('videoSummaryInput');
                    input.value = summary;
                    updateVideoWordCount();
                }
            }
        }

        function updateVideoWordCount() {
            const input = document.getElementById('videoSummaryInput');
            const counter = document.getElementById('videoWordCountDisplay');
            const btn = document.getElementById('btnSubmitVideo');

            if (!input || !counter || !btn) return;

            const text = input.value.trim();
            const wordCount = text ? text.split(/\s+/).length : 0;
            const limit = 100;

            counter.textContent = `${wordCount} / ${limit} kata`;

            if (wordCount >= limit) {
                // VALID STATE
                counter.className = "text-[10px] font-bold text-emerald-600 bg-white/50 px-2 py-1 rounded-lg border border-emerald-200 transition-all";
                // Enable Button
                btn.disabled = false;
                btn.className = "w-full py-4 bg-red-500 text-white rounded-2xl font-black shadow-lg shadow-red-200 active:scale-95 transition-all cursor-pointer";
            } else {
                // INVALID STATE
                counter.className = "text-[10px] font-bold text-red-500 bg-white/50 px-2 py-1 rounded-lg border border-red-100 transition-all";
                // Disable Button
                btn.disabled = true;
                btn.className = "w-full py-4 bg-slate-200 text-slate-400 rounded-2xl font-black shadow-none transition-all cursor-not-allowed";
            }
        }

        function closeVideoModal() {
            const modal = document.getElementById('modalVideo');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');

                // Stop videos by resetting src
                const iframes = modal.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    const src = iframe.src;
                    iframe.src = src;
                });
            }
        }

        async function submitVideoLog() {
            const btn = document.getElementById('btnSubmitVideo');
            const summary = document.getElementById('videoSummaryInput').value;
            const wordCount = summary.trim().split(/\s+/).length;

            if (wordCount < 100) {
                alert('Ringkasan belum mencapai 100 kata. Silakan lengkapi lagi.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'Mengirim...';

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) throw new Error("User tidak ditemukan");

                // Save to local storage (backup)
                localStorage.setItem(`video_summary_day${currentDay}`, summary);

                // 1. Simpan ke Supabase
                const { error } = await supabaseClient
                    .from('module_responses')
                    .insert({
                        student_id: user.id,
                        day_id: currentDay,
                        module_type: 'video',
                        answers: [summary],
                        status: 'submitted'
                    });

                if (error) throw error;

                alert('Hebat! Ringkasan berhasil dikirim. Menunggu feedback dari fasilitator.');

                // Update progress lokal agar sinkron
                const dayKey = `day${currentDay}`;
                studentProgress[dayKey]['video'] = false; // Tetap false agar show "Menunggu Feedback"
                saveProgress();

                checkAllModulesStatus(); // Refresh dashboard UI
                closeVideoModal();
                checkExistingVideo(); // Refresh modal content

            } catch (err) {
                console.error('Gagal kirim video summary:', err);
                alert('Terjadi kesalahan saat mengirim ringkasan.');
                btn.disabled = false;
                btn.innerHTML = 'Simpan Ringkasan & Selesai';
            }
        }

        async function checkExistingVideo() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data, error } = await supabaseClient
                    .from('module_responses')
                    .select('*')
                    .eq('student_id', user.id)
                    .eq('day_id', currentDay)
                    .eq('module_type', 'video')
                    .maybeSingle();

                if (data) {
                    const input = document.getElementById('videoSummaryInput');
                    const btn = document.getElementById('btnSubmitVideo');
                    const statusSection = document.getElementById('videoStatusSection');
                    const placeholder = document.getElementById('videoFeedbackPlaceholder');

                    if (input) {
                        input.value = data.answers[0] || '';
                        input.disabled = true;
                    }
                    if (btn) btn.classList.add('hidden');
                    if (placeholder) placeholder.classList.add('hidden');

                    if (statusSection) {
                        statusSection.classList.remove('hidden');
                        if (data.status === 'submitted') {
                            statusSection.innerHTML = `
                                <div class="bg-yellow-50 p-4 rounded-2xl border border-yellow-100 flex items-center gap-3">
                                    <div class="size-8 rounded-full bg-yellow-400 flex items-center justify-center text-white shrink-0 animate-pulse">
                                        <span class="material-symbols-outlined text-sm">hourglass_top</span>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-[10px] font-black text-yellow-700 uppercase tracking-widest">Menunggu Feedback</p>
                                        <p class="text-[10px] text-yellow-600 mt-0.5 font-medium">Fasilitator sedang membaca ringkasanmu.</p>
                                    </div>
                                </div>
                            `;
                        } else if (data.status === 'reviewed') {
                            // Render Stars
                            let starsHtml = '';
                            const score = data.score || 0;
                            const starCount = Math.round(score / 20);
                            for (let i = 1; i <= 5; i++) {
                                starsHtml += `<span class="material-symbols-outlined text-2xl ${i <= starCount ? 'text-amber-400 fill-current' : 'text-slate-200'}">star</span>`;
                            }

                            statusSection.innerHTML = `
                                <div class="bg-emerald-50 p-5 rounded-2xl border border-emerald-100 space-y-3">
                                    <div class="flex items-center justify-between">
                                        <p class="text-[10px] font-black text-emerald-700 uppercase tracking-widest">Dinilai Fasilitator</p>
                                        <div class="flex">${starsHtml}</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-xl border border-emerald-100">
                                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Feedback:</p>
                                        <p class="text-xs text-slate-700 font-medium italic">"${data.feedback || 'Bagus sekali!'}"</p>
                                    </div>
                                </div>
                            `;
                        }
                    }
                }
            } catch (e) {
                console.error('Error checkExistingVideo:', e);
            }
        }

        // ASSESSMENT LOGIC
        let currentQuestionIndex = 0;
        let userAnswers = {}; // { quesID: correctIndex }
        let assessmentScore = 0;
        let shuffledIndices = []; // Stores the randomized order of indices

        function openAssessmentModal() {
            // Load script dynamically if not present, then open
            if (typeof assessmentQuestions === 'undefined') {
                const script = document.createElement('script');
                script.src = 'data/assessment_data.js';
                script.onload = () => {
                    setupAssessment();
                };
                document.body.appendChild(script);
            } else {
                setupAssessment();
            }
        }

        function setupAssessment() {
            const modal = document.getElementById('modalAssessment');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                currentQuestionIndex = 0;
                userAnswers = {};

                // Initialize Shuffle
                initShuffle();

                renderQuestion(0);
            }
        }

        // Initialize or Load Shuffled Order
        function initShuffle() {
            const savedOrder = localStorage.getItem(`assessment_shuffle_order_day${currentDay}`);
            if (savedOrder) {
                shuffledIndices = JSON.parse(savedOrder);
                // Validation: ensure length matches current questions (in case questions updated)
                if (shuffledIndices.length !== assessmentQuestions.length) {
                    generateNewShuffle();
                }
            } else {
                generateNewShuffle();
            }
        }

        function generateNewShuffle() {
            // Create array of indices [0, 1, ... N]
            shuffledIndices = Array.from({ length: assessmentQuestions.length }, (_, i) => i);

            // Fisher-Yates Shuffle
            for (let i = shuffledIndices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledIndices[i], shuffledIndices[j]] = [shuffledIndices[j], shuffledIndices[i]];
            }

            // Save to preserve order for this user/device
            localStorage.setItem(`assessment_shuffle_order_day${currentDay}`, JSON.stringify(shuffledIndices));
        }

        function closeAssessmentModal() {
            const modal = document.getElementById('modalAssessment');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        function renderQuestion(index) {
            if (!assessmentQuestions || !assessmentQuestions[index]) return;

            // Get the Question Object based on SHUFFLED index
            // If shuffledIndices is empty (fail-safe), use index directly
            const realIndex = (shuffledIndices.length > 0) ? shuffledIndices[index] : index;
            const q = assessmentQuestions[realIndex];

            const container = document.getElementById('assessmentQuestionContainer');

            // Progress Bar
            const progressPercent = ((index + 1) / assessmentQuestions.length) * 100;
            document.getElementById('assessmentProgressBar').style.width = `${progressPercent}%`;
            document.getElementById('assessmentProgressText').innerText = `Soal ${index + 1} dari ${assessmentQuestions.length}`;

            // Render
            // Display numbering as 1, 2, 3... even though content is random
            let html = `
                <h4 class="text-sm font-bold text-slate-800 mb-4">${index + 1}. ${q.question}</h4>
                <div class="space-y-3">
            `;

            q.options.forEach((opt, idx) => {
                const isSelected = userAnswers[q.id] === idx;
                const activeClass = isSelected ? 'border-emerald-500 bg-emerald-50 ring-2 ring-emerald-200' : 'border-slate-200 hover:border-indigo-300 hover:bg-slate-50';

                html += `
                    <div onclick="selectOption(${q.id}, ${idx})" 
                        class="p-4 rounded-xl border-2 ${activeClass} cursor-pointer transition-all flex items-center gap-3 group">
                        <div class="size-6 rounded-full border-2 ${isSelected ? 'border-emerald-500 bg-emerald-500' : 'border-slate-300 group-hover:border-indigo-400'} flex items-center justify-center shrink-0">
                            ${isSelected ? '<span class="material-symbols-outlined text-white text-xs">check</span>' : ''}
                        </div>
                        <p class="text-xs font-medium text-slate-700">${opt}</p>
                    </div>
                `;
            });

            html += `</div>`;
            container.innerHTML = html;

            // Button Control
            const btnNext = document.getElementById('btnNextAssessment');
            if (index === assessmentQuestions.length - 1) {
                btnNext.innerText = 'Bintang Saya ?';
                btnNext.onclick = finishAssessment;
                btnNext.className = "px-6 py-3 bg-emerald-500 text-white rounded-xl font-bold text-xs shadow-lg shadow-emerald-200 active:scale-95 transition-all w-full mt-6";
            } else {
                btnNext.innerText = 'Selanjutnya';
                btnNext.className = "px-6 py-3 bg-indigo-500 text-white rounded-xl font-bold text-xs shadow-lg shadow-indigo-200 active:scale-95 transition-all w-full mt-6";
                btnNext.onclick = () => {
                    if (userAnswers[q.id] === undefined) {
                        alert('Pilih jawaban dulu ya!');
                        return;
                    }
                    currentQuestionIndex++;
                    renderQuestion(currentQuestionIndex);
                };
            }
        }

        function selectOption(qId, optIdx) {
            userAnswers[qId] = optIdx;
            // Rerender current to show selection
            renderQuestion(currentQuestionIndex);
        }

        async function finishAssessment() {
            // Get current question using shuffled index mapping to validate answer
            const realIndex = (shuffledIndices.length > 0) ? shuffledIndices[currentQuestionIndex] : currentQuestionIndex;
            const q = assessmentQuestions[realIndex];

            if (userAnswers[q.id] === undefined) {
                alert('Pilih jawaban dulu ya!');
                return;
            }

            // Calculate Score
            let correctCount = 0;
            assessmentQuestions.forEach(ques => {
                if (userAnswers[ques.id] === ques.correctIndex) {
                    correctCount++;
                }
            });

            const score = correctCount * 2; // 50 soal x 2 = 100
            const stars = Math.ceil(score / 20); // 0-100 -> 0-5 stars

            // Show Result
            document.getElementById('assessmentQuestionContainer').classList.add('hidden');
            document.getElementById('assessmentResultContainer').classList.remove('hidden');
            document.getElementById('assessmentResultContainer').classList.add('flex');
            document.getElementById('btnNextAssessment').classList.add('hidden');

            // Render Stars
            let starsHtml = '';
            for (let i = 0; i < 5; i++) {
                if (i < stars) {
                    starsHtml += '<span class="material-symbols-outlined text-4xl text-amber-400 fill-current animate-bounce" style="animation-delay: ' + (i * 100) + 'ms">star</span>';
                } else {
                    starsHtml += '<span class="material-symbols-outlined text-4xl text-slate-200">star</span>';
                }
            }
            document.getElementById('resultStars').innerHTML = starsHtml;
            document.getElementById('resultScoreText').innerText = `Skor Kamu: ${score} / 100`;

            // Save Status Local
            localStorage.setItem(`assessment_video_day${currentDay}_stars`, stars);
            localStorage.setItem(`assessment_video_day${currentDay}_score`, score);
            forceCompleteModule('assessment', score);

            // SAVE TO SUPABASE
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    // Storing plain JSON of user answers
                    const answerData = JSON.stringify(userAnswers);

                    await supabaseClient
                        .from('module_responses')
                        .insert({
                            student_id: user.id,
                            day_id: currentDay,
                            module_type: 'kuis', // 'kuis' maps to 'Asesmen' in facilitator view
                            answers: [answerData],
                            status: 'reviewed',
                            score: score
                        });
                }
            } catch (err) {
                console.error('Failed to save assessment to cloud:', err);
            }

        }
    </script>
</body>

</html>