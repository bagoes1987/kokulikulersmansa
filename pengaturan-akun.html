<!DOCTYPE html>
<html class="light" lang="id">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Pengaturan Akun - SMAN 1 Belitang</title>
    <link rel="icon" href="./logo-sekolah.png" type="image/png">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec6d",
                        "accent-terracotta": "#E2725B",
                        "background-light": "#f6f8f7",
                        "background-dark": "#102218",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        body {
            font-family: 'Lexend', sans-serif;
            min-height: max(884px, 100dvh);
        }

        #photoPreview {
            transition: all 0.3s ease;
        }

        .upload-overlay {
            transition: opacity 0.2s ease;
        }

        .upload-overlay:hover {
            opacity: 1 !important;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-[#111814] dark:text-white min-h-screen">
    <div
        class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden max-w-[430px] mx-auto shadow-2xl bg-white dark:bg-background-dark">
        <!-- TopAppBar -->
        <div
            class="flex items-center bg-white dark:bg-background-dark p-4 pb-2 justify-between sticky top-0 z-10 border-b border-gray-100 dark:border-gray-800">
            <button onclick="goBack()" class="text-[#111814] dark:text-white flex items-center gap-2 shrink-0">
                <span class="material-symbols-outlined text-3xl">arrow_back</span>
                <span class="text-sm font-semibold">Beranda</span>
            </button>
            <h2
                class="text-[#111814] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">
                Pengaturan Akun</h2>
            <div class="flex w-20 items-center justify-end">
                <!-- Spacer -->
            </div>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-auto pb-20">
            <!-- Profile Photo Section -->
            <div class="flex p-6 @container">
                <div class="flex w-full flex-col gap-6 items-center">
                    <div class="flex gap-4 flex-col items-center relative">
                        <div class="relative group">
                            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full min-h-32 w-32 border-4 border-primary/20 shadow-lg"
                                id="photoPreview"
                                style='background-image: url("https://ui-avatars.com/api/?name=Siswa&background=13ec6d&color=fff&size=256");'>
                            </div>
                            <!-- Upload Overlay -->
                            <div
                                class="upload-overlay absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer">
                                <label for="photoInput" class="cursor-pointer flex flex-col items-center gap-1">
                                    <span class="material-symbols-outlined text-white text-3xl">photo_camera</span>
                                    <span class="text-white text-xs font-medium">Ubah Foto</span>
                                </label>
                            </div>
                            <input type="file" id="photoInput" accept="image/jpeg,image/png,image/jpg" class="hidden">
                        </div>
                        <div class="flex flex-col items-center justify-center">
                            <p class="text-[#111814] dark:text-white text-3xl font-bold leading-tight tracking-[-0.015em] text-center"
                                id="studentName">Loading...</p>
                            <p
                                class="text-[#618972] dark:text-primary/70 text-lg font-medium leading-normal text-center">
                                SMAN 1 Belitang</p>
                        </div>
                        <p class="text-[#618972] dark:text-gray-400 text-sm text-center max-w-xs">
                            Klik pada foto untuk mengubah. Foto akan dioptimalkan otomatis.
                        </p>
                        <p class="text-[#618972] dark:text-gray-400 text-xs text-center max-w-xs mt-1">
                            Maksimal ukuran foto: 1 MB
                        </p>
                    </div>
                </div>
            </div>

            <!-- Student Information -->
            <div class="px-4 py-2">
                <h3 class="text-[#111814] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] pb-4">
                    Informasi Akun</h3>

                <div class="flex flex-col gap-3">
                    <!-- Editable Field 1 (Kelas for students, Mapel for facilitators) -->
                    <div id="field1Container"
                        class="flex items-center gap-4 bg-background-light dark:bg-white/5 p-4 rounded-xl border border-gray-100 dark:border-white/10">
                        <div
                            class="text-primary flex items-center justify-center rounded-lg bg-primary/10 shrink-0 size-12">
                            <span class="material-symbols-outlined" id="field1Icon">meeting_room</span>
                        </div>
                        <div class="flex flex-col justify-center flex-1">
                            <p id="field1Label"
                                class="text-[#618972] dark:text-gray-400 text-sm font-normal leading-normal uppercase tracking-wider">
                                Kelas</p>
                            <!-- Changed to Input for Mapel editing -->
                            <input type="text" id="field1Input"
                                class="bg-transparent border-none p-0 text-[#111814] dark:text-white text-lg font-semibold leading-normal focus:ring-0 w-full"
                                value="-" readonly>
                        </div>
                    </div>

                    <!-- Editable Field 2 (NISN for students, NIP for facilitators) -->
                    <div id="field2Container"
                        class="flex items-center gap-4 bg-background-light dark:bg-white/5 p-4 rounded-xl border border-gray-100 dark:border-white/10">
                        <div
                            class="text-primary flex items-center justify-center rounded-lg bg-primary/10 shrink-0 size-12">
                            <span class="material-symbols-outlined" id="field2Icon">badge</span>
                        </div>
                        <div class="flex flex-col justify-center flex-1">
                            <p id="field2Label"
                                class="text-[#618972] dark:text-gray-400 text-sm font-normal leading-normal uppercase tracking-wider">
                                NISN</p>
                            <input type="text" id="field2Input"
                                class="bg-transparent border-none p-0 text-[#111814] dark:text-white text-lg font-semibold leading-normal focus:ring-0 w-full"
                                value="-" readonly>
                        </div>
                    </div>

                    <!-- Extra Field (NIS for students, hidden for facilitators) -->
                    <div id="field3Container"
                        class="flex items-center gap-4 bg-background-light dark:bg-white/5 p-4 rounded-xl border border-gray-100 dark:border-white/10">
                        <div
                            class="text-primary flex items-center justify-center rounded-lg bg-primary/10 shrink-0 size-12">
                            <span class="material-symbols-outlined">tag</span>
                        </div>
                        <div class="flex flex-col justify-center flex-1">
                            <p
                                class="text-[#618972] dark:text-gray-400 text-sm font-normal leading-normal uppercase tracking-wider">
                                NIS</p>
                            <p class="text-[#111814] dark:text-white text-lg font-semibold leading-normal"
                                id="field3Value">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fixed Bottom Actions -->
        <div
            class="fixed bottom-0 left-0 right-0 max-w-[430px] mx-auto bg-white dark:bg-background-dark border-t border-gray-100 dark:border-gray-800 p-4 pb-6">
            <div class="flex gap-3">
                <button onclick="goBack()"
                    class="flex-1 cursor-pointer items-center justify-center overflow-hidden rounded-xl h-14 px-4 bg-gray-100 dark:bg-white/10 text-[#111814] dark:text-white text-base font-bold leading-normal tracking-[0.015em] active:scale-95 transition-transform flex">
                    <span class="truncate">Batal</span>
                </button>
                <button onclick="saveChanges()" id="saveButton"
                    class="flex-1 cursor-pointer items-center justify-center overflow-hidden rounded-xl h-14 px-4 bg-primary text-background-dark text-base font-bold leading-normal tracking-[0.015em] shadow-lg active:scale-95 transition-transform flex">
                    <span class="material-symbols-outlined mr-2" id="saveIcon">save</span>
                    <span class="truncate" id="saveText">Simpan Perubahan</span>
                </button>
            </div>
        </div>

        <!-- iOS Bottom Indicator -->
        <div class="flex justify-center pb-2 pt-2">
            <div class="w-32 h-1 bg-gray-300 dark:bg-gray-700 rounded-full"></div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Inisialisasi Supabase
        const supabaseUrl = 'https://jnsqqswpkigyzewnbvaf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impuc3Fxc3dwa2lneXpld25idmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NjA3NDIsImV4cCI6MjA4NTIzNjc0Mn0.RrjPnddC55Xv9CLCtG8-1RyDmEkYg_04tHeKqRE7pok';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let userRole = null;
        let selectedFile = null;

        // Load user data based on role
        async function loadUserData() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();

                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }

                userRole = session.user.user_metadata.role || 'siswa';

                if (userRole === 'siswa') {
                    const studentDataStr = localStorage.getItem('student_data');
                    if (studentDataStr) {
                        currentUser = JSON.parse(studentDataStr);
                        updateUI();
                    } else {
                        const { data: studentData, error } = await supabaseClient
                            .from('students')
                            .select('*')
                            .eq('id', session.user.id)
                            .single();

                        if (error) throw error;

                        currentUser = studentData;
                        localStorage.setItem('student_data', JSON.stringify(studentData));
                        updateUI();
                    }
                } else {
                    // Fasilitator / Koordinator / Admin use auth metadata
                    currentUser = session.user.user_metadata;
                    currentUser.id = session.user.id;
                    updateUI();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                alert('Gagal memuat data. Silakan login kembali.');
                window.location.href = 'login.html';
            }
        }

        function updateUI() {
            const photoPreview = document.getElementById('photoPreview');
            const saveText = document.getElementById('saveText');

            // Basic Info
            const name = userRole === 'siswa' ? currentUser.nama : currentUser.full_name;
            document.getElementById('studentName').textContent = name;

            // Role specific UI adjustments
            if (userRole === 'fasilitator' || userRole === 'koordinator') {
                document.getElementById('field1Label').textContent = 'Mata Pelajaran';
                const mapelInput = document.getElementById('field1Input');
                mapelInput.value = currentUser.mapel || 'Fasilitator Kokulikuler';
                mapelInput.readOnly = false;
                mapelInput.classList.add('border-b', 'border-gray-200', 'focus:border-primary');

                document.getElementById('field1Icon').textContent = 'menu_book';

                document.getElementById('field2Label').textContent = 'NIP / Identitas';
                const nipInput = document.getElementById('field2Input');
                nipInput.value = currentUser.nip || '-';
                nipInput.readOnly = false;
                nipInput.classList.add('border-b', 'border-gray-200', 'focus:border-primary'); // Make it look editable

                document.getElementById('field3Container').classList.add('hidden');
            } else {
                // Default Siswa
                document.getElementById('field1Input').value = currentUser.kelas;
                document.getElementById('field1Input').readOnly = true;
                document.getElementById('field2Input').value = currentUser.nisn;
                document.getElementById('field3Value').textContent = currentUser.nis;
            }

            // Update photo preview
            const photoUrl = currentUser.photo_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=13ec6d&color=fff&size=256`;
            photoPreview.style.backgroundImage = `url("${photoUrl}")`;
        }

        // Compress image function
        async function compressImage(file, maxWidth = 800, quality = 0.8) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Handle photo selection
        document.getElementById('photoInput').addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.type.match('image/(jpeg|jpg|png)')) {
                alert('❌ Format file tidak didukung. Gunakan JPEG atau PNG.');
                return;
            }

            if (file.size > 2 * 1024 * 1024) { // 2MB limit for better UX
                alert('❌ Ukuran file terlalu besar. Maksimal 2MB.');
                return;
            }

            const saveText = document.getElementById('saveText');
            const originalBtnText = saveText.textContent;
            saveText.textContent = 'Mengoptimalkan...';

            try {
                const compressedBlob = await compressImage(file, 800, 0.8);
                selectedFile = new File([compressedBlob], file.name, { type: 'image/jpeg' });

                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('photoPreview').style.backgroundImage = `url("${e.target.result}")`;
                };
                reader.readAsDataURL(selectedFile);
                saveText.textContent = originalBtnText;
            } catch (error) {
                console.error('Compression error:', error);
                selectedFile = file;
                saveText.textContent = originalBtnText;
            }
        });

        // Save changes
        async function saveChanges() {
            const saveButton = document.getElementById('saveButton');
            const saveIcon = document.getElementById('saveIcon');
            const saveText = document.getElementById('saveText');

            const newNip = document.getElementById('field2Input').value.trim();

            if (!selectedFile && (userRole !== 'fasilitator' || newNip === (currentUser.nip || '-'))) {
                alert('ℹ️ Tidak ada perubahan untuk disimpan.');
                return;
            }

            try {
                saveButton.disabled = true;
                saveButton.classList.add('opacity-50', 'cursor-not-allowed');
                saveIcon.textContent = 'sync';
                saveIcon.classList.add('animate-spin');
                saveText.textContent = 'Menyimpan...';

                let publicUrl = currentUser.photo_url;

                if (selectedFile) {
                    const fileExt = selectedFile.name.split('.').pop();
                    const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;

                    let uploadResult = await supabaseClient.storage
                        .from('avatars')
                        .upload(fileName, selectedFile);

                    let uploadError = uploadResult.error;

                    if (uploadError) {
                        console.warn("Standard upload failed. Switching to Service Role Fallback (Strict Mode)...", uploadError.message);

                        try {
                            const _repairKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impuc3Fxc3dwa2lneXpld25idmFmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTY2MDc0MiwiZXhwIjoyMDg1MjM2NzQyfQ.sJN3LkaB2nmykbItVxWWQPJExeiKBBbWZlgTLeuNo24';

                            // IMPORTANT: Initialize with NO SESSION PERSISTENCE to act as pure Admin
                            const repairClient = supabase.createClient(supabaseUrl, _repairKey, {
                                auth: {
                                    autoRefreshToken: false,
                                    persistSession: false,
                                    detectSessionInUrl: false
                                }
                            });

                            // Fallback: Direct Service Role Upload
                            // Attempt to delete if exists first to avoid upsert RLS weirdness
                            await repairClient.storage.from('avatars').remove([fileName]);

                            const retry = await repairClient.storage.from('avatars').upload(fileName, selectedFile, {
                                upsert: true,
                                contentType: selectedFile.type
                            });

                            if (retry.error) throw retry.error;
                            console.log("Upload success via Service Role!");

                        } catch (repairErr) {
                            throw new Error("Gagal upload foto (Admin Bypass Error): " + repairErr.message);
                        }
                    }

                    const { data: { publicUrl: newUrl } } = supabaseClient.storage
                        .from('avatars')
                        .getPublicUrl(fileName);

                    publicUrl = newUrl;
                }

                if (userRole === 'siswa') {
                    const { error: updateError } = await supabaseClient
                        .from('students')
                        .update({ photo_url: publicUrl })
                        .eq('id', currentUser.id);

                    if (updateError) throw updateError;

                    currentUser.photo_url = publicUrl;
                    localStorage.setItem('student_data', JSON.stringify(currentUser));
                } else {
                    // Update Auth Metadata for Facilitator/Coordinator/Admin
                    const { error: updateError } = await supabaseClient.auth.updateUser({
                        data: {
                            nip: newNip,
                            mapel: document.getElementById('field1Input').value.trim(),
                            photo_url: publicUrl
                        }
                    });

                    if (updateError) throw updateError;
                }

                saveIcon.textContent = 'check_circle';
                saveIcon.classList.remove('animate-spin');
                saveText.textContent = 'Berhasil!';

                setTimeout(() => {
                    goBack();
                }, 1000);

            } catch (error) {
                console.error('Error saving:', error);
                saveButton.disabled = false;
                saveButton.classList.remove('opacity-50', 'cursor-not-allowed');
                saveIcon.textContent = 'save';
                saveIcon.classList.remove('animate-spin');
                saveText.textContent = 'Simpan Perubahan';
                alert('❌ Gagal menyimpan perubahan: ' + error.message);
            }
        }

        function goBack() {
            if (userRole === 'fasilitator') {
                window.location.href = 'dashboard-fasilitator.html';
            } else if (userRole === 'koordinator') {
                window.location.href = 'dashboard-koordinator.html';
            } else if (userRole === 'admin') {
                window.location.href = 'dashboard-admin.html';
            } else {
                window.location.href = 'dashboard-kegiatan.html';
            }
        }

        window.addEventListener('load', loadUserData);
    </script>
</body>

</html>